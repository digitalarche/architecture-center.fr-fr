---
title: Élection du responsable
description: Coordonnez les actions effectuées par un ensemble d’instances de tâche de collaboration dans une application distribuée en élisant l’instance responsable qui sera chargée de gérer les autres instances.
keywords: modèle de conception
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- design-implementation
- resiliency
ms.openlocfilehash: 6cc4b19e889cc9fc692e388498cc16ea56b1c981
ms.sourcegitcommit: 94d50043db63416c4d00cebe927a0c88f78c3219
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/28/2018
ms.locfileid: "47429194"
---
# <a name="leader-election-pattern"></a><span data-ttu-id="8d5d8-104">Modèle d’élection du responsable</span><span class="sxs-lookup"><span data-stu-id="8d5d8-104">Leader Election pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="8d5d8-105">Coordonnez les actions effectuées par un ensemble d’instances de collaboration dans une application distribuée en élisant l’instance responsable qui sera chargée de gérer les autres.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-105">Coordinate the actions performed by a collection of collaborating instances in a distributed application by electing one instance as the leader that assumes responsibility for managing the others.</span></span> <span data-ttu-id="8d5d8-106">Vous pourrez ainsi éviter les conflits entre les instances, la contention pour des ressources partagées ou des interférences inopinées avec le travail effectué par d’autres instances.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-106">This can help to ensure that instances don't conflict with each other, cause contention for shared resources, or inadvertently interfere with the work that other instances are performing.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="8d5d8-107">Contexte et problème</span><span class="sxs-lookup"><span data-stu-id="8d5d8-107">Context and problem</span></span>

<span data-ttu-id="8d5d8-108">Une application cloud type a de nombreuses tâches simultanées à coordonner.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-108">A typical cloud application has many tasks acting in a coordinated manner.</span></span> <span data-ttu-id="8d5d8-109">Ces tâches peuvent toutes être des instances exécutant le même code et accédant aux mêmes ressources. Elles peuvent aussi travailler ensemble en parallèle pour effectuer chacune leur part d’un calcul complexe.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-109">These tasks could all be instances running the same code and requiring access to the same resources, or they might be working together in parallel to perform the individual parts of a complex calculation.</span></span>

<span data-ttu-id="8d5d8-110">Si les instances de tâche s’exécutent la plupart du temps séparément, il peut aussi s’avérer nécessaire de coordonner leurs actions individuelles pour éviter les conflits, la contention pour des ressources partagées ou des interférences inopinées avec le travail effectué par d’autres instances de tâche.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-110">The task instances might run separately for much of the time, but it might also be necessary to coordinate the actions of each instance to ensure that they don’t conflict, cause contention for shared resources, or accidentally interfere with the work that other task instances are performing.</span></span>

<span data-ttu-id="8d5d8-111">Par exemple : </span><span class="sxs-lookup"><span data-stu-id="8d5d8-111">For example:</span></span>

- <span data-ttu-id="8d5d8-112">Dans un système cloud qui implémente une mise à l’échelle horizontale, plusieurs instances d’une même tâche peuvent s’exécuter en même temps, chaque instance servant un utilisateur différent.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-112">In a cloud-based system that implements horizontal scaling, multiple instances of the same task could be running at the same time with each instance serving a different user.</span></span> <span data-ttu-id="8d5d8-113">Si ces instances écrivent dans une ressource partagée, il est nécessaire de coordonner leurs actions pour éviter que chaque instance remplace les modifications apportées par les autres.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-113">If these instances write to a shared resource, it's necessary to coordinate their actions to prevent each instance from overwriting the changes made by the others.</span></span>
- <span data-ttu-id="8d5d8-114">Si les tâches effectuent chacune en parallèle une partie d’un calcul complexe, les résultats doivent être agrégés une fois que toutes les tâches sont terminées.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-114">If the tasks are performing individual elements of a complex calculation in parallel, the results need to be aggregated when they all complete.</span></span>

<span data-ttu-id="8d5d8-115">Les instances de tâche étant toutes des homologues, il n’y a pas de responsable naturel pouvant faire office de coordinateur ou d’agrégateur.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-115">The task instances are all peers, so there isn't a natural leader that can act as the coordinator or aggregator.</span></span>

## <a name="solution"></a><span data-ttu-id="8d5d8-116">Solution</span><span class="sxs-lookup"><span data-stu-id="8d5d8-116">Solution</span></span>

<span data-ttu-id="8d5d8-117">Une instance de tâche unique doit être élue pour remplir le rôle de responsable dans le but de coordonner les actions des autres instances de tâche subordonnée.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-117">A single task instance should be elected to act as the leader, and this instance should coordinate the actions of the other subordinate task instances.</span></span> <span data-ttu-id="8d5d8-118">Si toutes les instances de tâche exécutent le même code, chacune est capable de jouer le rôle de responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-118">If all of the task instances are running the same code, they are each capable of acting as the leader.</span></span> <span data-ttu-id="8d5d8-119">Par conséquent, l’élection doit être gérée avec soin pour éviter que plusieurs instances occupent le rôle de responsable en même temps.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-119">Therefore, the election process must be managed carefully to prevent two or more instances taking over the leader role at the same time.</span></span>

<span data-ttu-id="8d5d8-120">Le mécanisme de sélection du responsable proposé par le système doit être fiable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-120">The system must provide a robust mechanism for selecting the leader.</span></span> <span data-ttu-id="8d5d8-121">Cette méthode doit faire face à certains événements tels que les pannes réseau ou les échecs de processus.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-121">This method has to cope with events such as network outages or process failures.</span></span> <span data-ttu-id="8d5d8-122">Dans bon nombre de solutions, les instances de tâche subordonnée surveillent le responsable via une méthode de vérification des pulsations d’un certain type ou par l’interrogation.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-122">In many solutions, the subordinate task instances monitor the leader through some type of heartbeat method, or by polling.</span></span> <span data-ttu-id="8d5d8-123">Si le responsable désigné s’arrête de manière inattendue ou si les instances de tâche subordonnée ne peuvent plus y accéder du fait d’une défaillance réseau, elles doivent élire un nouveau responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-123">If the designated leader terminates unexpectedly, or a network failure makes the leader unavailable to the subordinate task instances, it's necessary for them to elect a new leader.</span></span>

<span data-ttu-id="8d5d8-124">Il existe plusieurs stratégies pour élire un responsable parmi différentes tâches au sein d’un environnement distribué, à savoir :</span><span class="sxs-lookup"><span data-stu-id="8d5d8-124">There are several strategies for electing a leader among a set of tasks in a distributed environment, including:</span></span>
- <span data-ttu-id="8d5d8-125">Choix de l’instance de tâche dont l’ID de processus ou d’instance est le plus faiblement classé.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-125">Selecting the task instance with the lowest-ranked instance or process ID.</span></span>
- <span data-ttu-id="8d5d8-126">Course à l’acquisition d’un mutex partagé et distribué.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-126">Racing to acquire a shared, distributed mutex.</span></span> <span data-ttu-id="8d5d8-127">La première instance de tâche qui acquiert le mutex est le responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-127">The first task instance that acquires the mutex is the leader.</span></span> <span data-ttu-id="8d5d8-128">Cependant, le système doit garantir que si le responsable s’arrête ou se déconnecte du reste du système, le mutex est libéré pour permettre à une autre instance de tâche de devenir le responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-128">However, the system must ensure that, if the leader terminates or becomes disconnected from the rest of the system, the mutex is released to allow another task instance to become the leader.</span></span>
- <span data-ttu-id="8d5d8-129">Implémentation de l’un des algorithmes d’élection du responsable courants tels que l’[algorithme du plus fort (Bully)](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html) ou l’[algorithme en anneau (Ring)](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span><span class="sxs-lookup"><span data-stu-id="8d5d8-129">Implementing one of the common leader election algorithms such as the [Bully Algorithm](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html) or the [Ring Algorithm](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span></span> <span data-ttu-id="8d5d8-130">Ces algorithmes considèrent que chaque candidat à l’élection possède un ID unique et qu’il peut communiquer de manière fiable avec les autres candidats.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-130">These algorithms assume that each candidate in the election has a unique ID, and that it can communicate with the other candidates reliably.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="8d5d8-131">Problèmes et considérations</span><span class="sxs-lookup"><span data-stu-id="8d5d8-131">Issues and considerations</span></span>

<span data-ttu-id="8d5d8-132">Prenez en compte les points suivants lorsque vous choisissez comment implémenter ce modèle :</span><span class="sxs-lookup"><span data-stu-id="8d5d8-132">Consider the following points when deciding how to implement this pattern:</span></span>
- <span data-ttu-id="8d5d8-133">Le processus d’élection d’un responsable doit être résilient face aux défaillances temporaires et permanentes.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-133">The process of electing a leader should be resilient to transient and persistent failures.</span></span>
- <span data-ttu-id="8d5d8-134">Une défaillance du responsable ou son indisponibilité (par exemple, suite à un échec de communication) doit pouvoir être détectée.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-134">It must be possible to detect when the leader has failed or has become otherwise unavailable (such as due to a communications failure).</span></span> <span data-ttu-id="8d5d8-135">Les exigences de rapidité de détection varient en fonction du système.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-135">How quickly detection is needed is system dependent.</span></span> <span data-ttu-id="8d5d8-136">Certains systèmes peuvent fonctionner sans responsable pendant un bref laps de temps, au cours duquel une défaillance temporaire pourra éventuellement être résolue.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-136">Some systems might be able to function for a short time without a leader, during which a transient fault might be fixed.</span></span> <span data-ttu-id="8d5d8-137">Dans d’autres cas, la défaillance du responsable doit être détectée immédiatement de façon à déclencher une nouvelle élection.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-137">In other cases, it might be necessary to detect leader failure immediately and trigger a new election.</span></span>
- <span data-ttu-id="8d5d8-138">Dans un système qui implémente une mise à l’échelle automatique horizontale, le responsable peut s’arrêter si le système diminue ses capacités et retire certaines ressources informatiques.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-138">In a system that implements horizontal autoscaling, the leader could be terminated if the system scales back and shuts down some of the computing resources.</span></span>
- <span data-ttu-id="8d5d8-139">L’utilisation d’un mutex partagé et distribué crée une dépendance vis-à-vis du service externe qui fournit le mutex.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-139">Using a shared, distributed mutex introduces a dependency on the external service that provides the mutex.</span></span> <span data-ttu-id="8d5d8-140">Le service constitue un point de défaillance unique.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-140">The service constitutes a single point of failure.</span></span> <span data-ttu-id="8d5d8-141">S’il devient inaccessible pour une raison quelconque, le système ne peut plus élire de responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-141">If it becomes unavailable for any reason, the system won't be able to elect a leader.</span></span>
- <span data-ttu-id="8d5d8-142">L’utilisation d’un processus dédié unique comme responsable est une approche simple.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-142">Using a single dedicated process as the leader is a straightforward approach.</span></span> <span data-ttu-id="8d5d8-143">Cependant, si le processus subit une défaillance, son redémarrage risque de prendre beaucoup de temps.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-143">However, if the process fails there could be a significant delay while it's restarted.</span></span> <span data-ttu-id="8d5d8-144">Or, la latence qui en découle peut nuire aux performances et aux temps de réponse des autres processus si ceux-ci attendent que le responsable coordonne une opération.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-144">The resulting latency can affect the performance and response times of other processes if they're waiting for the leader to coordinate an operation.</span></span>
- <span data-ttu-id="8d5d8-145">L’implémentation manuelle de l’un des algorithmes d’élection du responsable offre davantage de souplesse quand il s’agit d’ajuster et d’optimiser le code.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-145">Implementing one of the leader election algorithms manually provides the greatest flexibility for tuning and optimizing the code.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="8d5d8-146">Quand utiliser ce modèle</span><span class="sxs-lookup"><span data-stu-id="8d5d8-146">When to use this pattern</span></span>

<span data-ttu-id="8d5d8-147">Utilisez ce modèle quand les tâches au sein d’une application distribuée, telle qu’une solution hébergé dans le cloud, a besoin d’une coordination minutieuse et qu’il n’existe pas de responsable naturel.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-147">Use this pattern when the tasks in a distributed application, such as a cloud-hosted solution, need careful coordination and there's no natural leader.</span></span>

>  <span data-ttu-id="8d5d8-148">Évitez de faire du responsable un goulot d’étranglement dans le système.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-148">Avoid making the leader a bottleneck in the system.</span></span> <span data-ttu-id="8d5d8-149">Le rôle du responsable est de coordonner le travail lié aux tâches subordonnées. Il n’est pas nécessairement tenu de participer à ce travail proprement dit, même s’il doit être en mesure de le faire si la tâche n’est pas élue responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-149">The purpose of the leader is to coordinate the work of the subordinate tasks, and it doesn't necessarily have to participate in this work itself&mdash;although it should be able to do so if the task isn't elected as the leader.</span></span>

<span data-ttu-id="8d5d8-150">Ce modèle peut ne pas avoir d’utilité dans les cas suivants :</span><span class="sxs-lookup"><span data-stu-id="8d5d8-150">This pattern might not be useful if:</span></span>
- <span data-ttu-id="8d5d8-151">Il existe un responsable naturel ou un processus dédié qui peut toujours faire office de responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-151">There's a natural leader or dedicated process that can always act as the leader.</span></span> <span data-ttu-id="8d5d8-152">Par exemple, il est peut-être possible d’implémenter un processus de singleton qui coordonne les instances de tâche.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-152">For example, it might be possible to implement a singleton process that coordinates the task instances.</span></span> <span data-ttu-id="8d5d8-153">Si ce processus échoue ou devient instable, le système peut l’arrêter et le redémarrer.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-153">If this process fails or becomes unhealthy, the system can shut it down and restart it.</span></span>
- <span data-ttu-id="8d5d8-154">La coordination entre les tâches peut être accomplie en utilisant une méthode plus légère.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-154">The coordination between tasks can be achieved using a more lightweight method.</span></span> <span data-ttu-id="8d5d8-155">Par exemple, si plusieurs instances de tâche ont simplement besoin d’un accès coordonné à une ressource partagée, une meilleure solution est d’utiliser le verrouillage optimiste ou pessimiste pour contrôler l’accès.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-155">For example, if several task instances simply need coordinated access to a shared resource, a better solution is to use optimistic or pessimistic locking to control access.</span></span>
- <span data-ttu-id="8d5d8-156">Une solution tierce est plus appropriée.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-156">A third-party solution is more appropriate.</span></span> <span data-ttu-id="8d5d8-157">Par exemple, le service Microsoft Azure HDInsight (basé sur Apache Hadoop) utilise les services fournis par Apache Zookeeper pour coordonner le mappage et réduire les tâches qui collectent et synthétisent les données.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-157">For example, the Microsoft Azure HDInsight service (based on Apache Hadoop) uses the services provided by Apache Zookeeper to coordinate the map and reduce tasks that collect and summarize data.</span></span>

## <a name="example"></a><span data-ttu-id="8d5d8-158">Exemples</span><span class="sxs-lookup"><span data-stu-id="8d5d8-158">Example</span></span>

<span data-ttu-id="8d5d8-159">Le projet DistributedMutex de la solution LeaderElection (un exemple illustrant ce modèle est disponible sur [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election)) montre comment utiliser un bail sur un objet blob Stockage Microsoft Azure pour fournir un mécanisme permettant d’implémenter un mutex partagé et distribué.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-159">The DistributedMutex project in the LeaderElection solution (a sample that demonstrates this pattern is available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election)) shows how to use a lease on an Azure Storage blob to provide a mechanism for implementing a shared, distributed mutex.</span></span> <span data-ttu-id="8d5d8-160">Ce mutex peut être utilisé pour élire un responsable parmi un groupe d’instances de rôle dans un service cloud Azure.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-160">This mutex can be used to elect a leader among a group of role instances in an Azure cloud service.</span></span> <span data-ttu-id="8d5d8-161">La première instance de rôle à acquérir le bail est élue responsable et le reste jusqu’à ce qu’elle libère le bail ou qu’elle ne puisse pas le renouveler.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-161">The first role instance to acquire the lease is elected the leader, and remains the leader until it releases the lease or isn't able to renew the lease.</span></span> <span data-ttu-id="8d5d8-162">Les autres instances de rôle peuvent continuer à surveiller le bail de l’objet blob si le responsable n’est plus disponible.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-162">Other role instances can continue to monitor the blob lease in case the leader is no longer available.</span></span>

>  <span data-ttu-id="8d5d8-163">Un bail d’objet blob est un verrou d’écriture exclusif sur un objet blob.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-163">A blob lease is an exclusive write lock over a blob.</span></span> <span data-ttu-id="8d5d8-164">Un même objet blob peut être l’objet d’un seul bail à un instant donné.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-164">A single blob can be the subject of only one lease at any point in time.</span></span> <span data-ttu-id="8d5d8-165">Une instance de rôle peut demander un bail sur un objet blob spécifié, qui lui sera accordé si aucune autre instance de rôle ne détient un bail sur le même objet blob.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-165">A role instance can request a lease over a specified blob, and it'll be granted the lease if no other role instance holds a lease over the same blob.</span></span> <span data-ttu-id="8d5d8-166">Dans le cas contraire, la demande lèvera une exception.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-166">Otherwise the request will throw an exception.</span></span>
> 
> <span data-ttu-id="8d5d8-167">Pour éviter qu’une instance de rôle en échec conserve le bail indéfiniment, spécifiez une durée de vie pour le bail.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-167">To avoid a faulted role instance retaining the lease indefinitely, specify a lifetime for the lease.</span></span> <span data-ttu-id="8d5d8-168">Une fois arrivé à expiration, le bail deviendra disponible.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-168">When this expires, the lease becomes available.</span></span> <span data-ttu-id="8d5d8-169">Cependant, une instance de rôle peut demander à ce que le bail qu’elle détient lui soit renouvelé. Il lui est alors accordé pour une période supplémentaire.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-169">However, while a role instance holds the lease it can request that the lease is renewed, and it'll be granted the lease for a further period of time.</span></span> <span data-ttu-id="8d5d8-170">L’instance de rôle peut répéter continuellement ce processus si elle souhaite conserver le bail.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-170">The role instance can continually repeat this process if it wants to retain the lease.</span></span>
> <span data-ttu-id="8d5d8-171">Pour plus d’informations sur la façon de louer un objet blob, consultez [Louer un objet blob (API REST)](https://msdn.microsoft.com/library/azure/ee691972.aspx).</span><span class="sxs-lookup"><span data-stu-id="8d5d8-171">For more information on how to lease a blob, see [Lease Blob (REST API)](https://msdn.microsoft.com/library/azure/ee691972.aspx).</span></span>

<span data-ttu-id="8d5d8-172">La classe `BlobDistributedMutex` dans l’exemple C# suivant contient la méthode `RunTaskWhenMutexAquired` qui permet à une instance de rôle de tenter d’acquérir un bail sur un objet blob spécifié.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-172">The `BlobDistributedMutex` class in the C# example below contains the `RunTaskWhenMutexAquired` method that enables a role instance to attempt to acquire a lease over a specified blob.</span></span> <span data-ttu-id="8d5d8-173">Les détails de l’objet blob (nom, conteneur et compte de stockage) sont passés au constructeur dans un objet `BlobSettings` au moment où l’objet `BlobDistributedMutex` est créé (cet objet est un struct simple qui est inclus dans l’exemple de code).</span><span class="sxs-lookup"><span data-stu-id="8d5d8-173">The details of the blob (the name, container, and storage account) are passed to the constructor in a `BlobSettings` object when the `BlobDistributedMutex` object is created (this object is a simple struct that is included in the sample code).</span></span> <span data-ttu-id="8d5d8-174">Le constructeur accepte aussi un `Task` qui fait référence au code que doit exécuter l’instance de rôle si elle réussit à acquérir le bail sur l’objet blob et est élue responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-174">The constructor also accepts a `Task` that references the code that the role instance should run if it successfully acquires the lease over the blob and is elected the leader.</span></span> <span data-ttu-id="8d5d8-175">Notez que le code qui gère les détails de bas niveau de l’acquisition du bail est implémenté dans une classe d’assistance distincte nommée `BlobLeaseManager`.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-175">Note that the code that handles the low-level details of acquiring the lease is implemented in a separate helper class named `BlobLeaseManager`.</span></span>

```csharp
public class BlobDistributedMutex
{
  ...
  private readonly BlobSettings blobSettings;
  private readonly Func<CancellationToken, Task> taskToRunWhenLeaseAcquired;
  ...

  public BlobDistributedMutex(BlobSettings blobSettings,
           Func<CancellationToken, Task> taskToRunWhenLeaseAquired)
  {
    this.blobSettings = blobSettings;
    this.taskToRunWhenLeaseAquired = taskToRunWhenLeaseAquired;
  }

  public async Task RunTaskWhenMutexAcquired(CancellationToken token)
  {
    var leaseManager = new BlobLeaseManager(blobSettings);
    await this.RunTaskWhenBlobLeaseAcquired(leaseManager, token);
  }
  ...
```

<span data-ttu-id="8d5d8-176">La méthode `RunTaskWhenMutexAquired` dans l’exemple de code ci-dessus appelle la méthode `RunTaskWhenBlobLeaseAcquired` figurant dans l’exemple de code suivant pour acquérir le bail.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-176">The `RunTaskWhenMutexAquired` method in the code sample above invokes the `RunTaskWhenBlobLeaseAcquired` method shown in the following code sample to actually acquire the lease.</span></span> <span data-ttu-id="8d5d8-177">La méthode `RunTaskWhenBlobLeaseAcquired` s’exécute de façon asynchrone.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-177">The `RunTaskWhenBlobLeaseAcquired` method runs asynchronously.</span></span> <span data-ttu-id="8d5d8-178">Si le bail est acquis avec succès, l’instance de rôle est élue responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-178">If the lease is successfully acquired, the role instance has been elected the leader.</span></span> <span data-ttu-id="8d5d8-179">Le rôle du délégué `taskToRunWhenLeaseAcquired` est d’effectuer le travail qui coordonne les autres instances de rôle.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-179">The purpose of the `taskToRunWhenLeaseAcquired` delegate is to perform the work that coordinates the other role instances.</span></span> <span data-ttu-id="8d5d8-180">Si le bail n’est pas acquis, une autre instance de rôle est élue responsable et l’instance de rôle active reste subordonnée.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-180">If the lease isn't acquired, another role instance has been elected as the leader and the current role instance remains a subordinate.</span></span> <span data-ttu-id="8d5d8-181">Notez que `TryAcquireLeaseOrWait` est une méthode d’assistance qui utilise l’objet `BlobLeaseManager` pour acquérir le bail.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-181">Note that the `TryAcquireLeaseOrWait` method is a helper method that uses the `BlobLeaseManager` object to acquire the lease.</span></span>

```csharp
  private async Task RunTaskWhenBlobLeaseAcquired(
    BlobLeaseManager leaseManager, CancellationToken token)
  {
    while (!token.IsCancellationRequested)
    {
      // Try to acquire the blob lease.
      // Otherwise wait for a short time before trying again.
      string leaseId = await this.TryAquireLeaseOrWait(leaseManager, token);

      if (!string.IsNullOrEmpty(leaseId))
      {
        // Create a new linked cancellation token source so that if either the
        // original token is canceled or the lease can't be renewed, the
        // leader task can be canceled.
        using (var leaseCts =
          CancellationTokenSource.CreateLinkedTokenSource(new[] { token }))
        {
          // Run the leader task.
          var leaderTask = this.taskToRunWhenLeaseAquired.Invoke(leaseCts.Token);
          ...
        }
      }
    }
    ...
  }
```

<span data-ttu-id="8d5d8-182">La tâche démarrée par le responsable s’exécute aussi de façon asynchrone.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-182">The task started by the leader also runs asynchronously.</span></span> <span data-ttu-id="8d5d8-183">Pendant l’exécution de cette tâche, la méthode `RunTaskWhenBlobLeaseAquired` figurant dans l’exemple de code suivant tente régulièrement de renouveler le bail.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-183">While this task is running, the `RunTaskWhenBlobLeaseAquired` method shown in the following code sample periodically attempts to renew the lease.</span></span> <span data-ttu-id="8d5d8-184">Cela permet de vérifier que l’instance de rôle est toujours responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-184">This helps to ensure that the role instance remains the leader.</span></span> <span data-ttu-id="8d5d8-185">Dans l’exemple de solution, le délai entre les demandes de renouvellement est inférieur à la durée spécifiée du bail pour empêcher une autre instance de rôle d’être élue responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-185">In the sample solution, the delay between renewal requests is less than the time specified for the duration of the lease in order to prevent another role instance from being elected the leader.</span></span> <span data-ttu-id="8d5d8-186">Si le renouvellement échoue pour une raison quelconque, la tâche est annulée.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-186">If the renewal fails for any reason, the task is canceled.</span></span>

<span data-ttu-id="8d5d8-187">Si le bail ne peut pas être renouvelé ou que la tâche est annulée (peut-être à la suite de l’arrêt de l’instance de rôle), le bail est libéré.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-187">If the lease fails to be renewed or the task is canceled (possibly as a result of the role instance shutting down), the lease is released.</span></span> <span data-ttu-id="8d5d8-188">À ce stade, cette instance de rôle (ou une autre) peut être élue responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-188">At this point, this or another role instance might be elected as the leader.</span></span> <span data-ttu-id="8d5d8-189">L’extrait de code ci-dessous illustre cette partie du processus.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-189">The code extract below shows this part of the process.</span></span>

```csharp
  private async Task RunTaskWhenBlobLeaseAcquired(
    BlobLeaseManager leaseManager, CancellationToken token)
  {
    while (...)
    {
      ...
      if (...)
      {
        ...
        using (var leaseCts = ...)
        {
          ...
          // Keep renewing the lease in regular intervals.
          // If the lease can't be renewed, then the task completes.
          var renewLeaseTask =
            this.KeepRenewingLease(leaseManager, leaseId, leaseCts.Token);

          // When any task completes (either the leader task itself or when it
          // couldn't renew the lease) then cancel the other task.
          await CancelAllWhenAnyCompletes(leaderTask, renewLeaseTask, leaseCts);
        }
      }
    }
  }
  ...
}
```

<span data-ttu-id="8d5d8-190">`KeepRenewingLease` est une méthode d’assistance qui utilise l’objet `BlobLeaseManager` pour renouveler le bail.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-190">The `KeepRenewingLease` method is another helper method that uses the `BlobLeaseManager` object to renew the lease.</span></span> <span data-ttu-id="8d5d8-191">La méthode `CancelAllWhenAnyCompletes` annule les tâches spécifiées comme étant les deux premiers paramètres.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-191">The `CancelAllWhenAnyCompletes` method cancels the tasks specified as the first two parameters.</span></span> <span data-ttu-id="8d5d8-192">Le diagramme suivant illustre l’utilisation de la classe `BlobDistributedMutex` pour élire un responsable et exécuter une tâche qui coordonne les opérations.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-192">The following diagram illustrates using the `BlobDistributedMutex` class to elect a leader and run a task that coordinates operations.</span></span>

![La figure 1 illustre les fonctions de la classe BlobDistributedMutex](./_images/leader-election-diagram.png)


<span data-ttu-id="8d5d8-194">L’exemple de code suivant montre comment utiliser la classe `BlobDistributedMutex` dans un rôle de travail.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-194">The following code example shows how to use the `BlobDistributedMutex` class in a worker role.</span></span> <span data-ttu-id="8d5d8-195">Ce code acquiert un bail sur un objet blob nommé `MyLeaderCoordinatorTask` dans le conteneur du bail au niveau du stockage de développement et indique que le code défini dans la méthode `MyLeaderCoordinatorTask` doit s’exécuter si l’instance de rôle est élue responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-195">This code acquires a lease over a blob named `MyLeaderCoordinatorTask` in the lease's container in development storage, and specifies that the code defined in the `MyLeaderCoordinatorTask` method should run if the role instance is elected the leader.</span></span>

```csharp
var settings = new BlobSettings(CloudStorageAccount.DevelopmentStorageAccount,
  "leases", "MyLeaderCoordinatorTask");
var cts = new CancellationTokenSource();
var mutex = new BlobDistributedMutex(settings, MyLeaderCoordinatorTask);
mutex.RunTaskWhenMutexAcquired(this.cts.Token);
...

// Method that runs if the role instance is elected the leader
private static async Task MyLeaderCoordinatorTask(CancellationToken token)
{
  ...
}
```

<span data-ttu-id="8d5d8-196">Notez les points suivants à propos de l’exemple de solution :</span><span class="sxs-lookup"><span data-stu-id="8d5d8-196">Note the following points about the sample solution:</span></span>
- <span data-ttu-id="8d5d8-197">L’objet blob est potentiellement un point de défaillance unique.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-197">The blob is a potential single point of failure.</span></span> <span data-ttu-id="8d5d8-198">Si le service BLOB devient indisponible ou n’est pas accessible, le responsable ne pourra pas renouveler le bail et aucune autre instance de rôle ne pourra l’acquérir.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-198">If the blob service becomes unavailable, or is inaccessible, the leader won't be able to renew the lease and no other role instance will be able to acquire the lease.</span></span> <span data-ttu-id="8d5d8-199">Dans ce cas, aucune instance de rôle ne pourra jouer le rôle de responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-199">In this case, no role instance will be able to act as the leader.</span></span> <span data-ttu-id="8d5d8-200">Cependant, le service BLOB étant résilient par sa conception, sa défaillance complète est considérée comme très improbable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-200">However, the blob service is designed to be resilient, so complete failure of the blob service is considered to be extremely unlikely.</span></span>
- <span data-ttu-id="8d5d8-201">Si la tâche effectuée par le responsable s’interrompt, il pourra peut-être continuer de renouveler le bail, ce qui empêchera une autre instance de rôle d’acquérir le bail et de s’emparer du rôle de responsable pour coordonner les tâches.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-201">If the task being performed by the leader stalls, the leader might continue to renew the lease, preventing any other role instance from acquiring the lease and taking over the leader role in order to coordinate tasks.</span></span> <span data-ttu-id="8d5d8-202">Dans la réalité, l’intégrité du responsable doit être vérifiée à intervalles fréquents.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-202">In the real world, the health of the leader should be checked at frequent intervals.</span></span>
- <span data-ttu-id="8d5d8-203">Le processus d’élection est non déterministe.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-203">The election process is nondeterministic.</span></span> <span data-ttu-id="8d5d8-204">Vous ne pouvez pas savoir à l’avance laquelle des instances de rôle obtiendra le bail d’objet blob et deviendra responsable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-204">You can't make any assumptions about which role instance will acquire the blob lease and become the leader.</span></span>
- <span data-ttu-id="8d5d8-205">L’objet blob utilisé comme cible du bail d’objet blob ne doit pas être utilisé à d’autres fins.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-205">The blob used as the target of the blob lease shouldn't be used for any other purpose.</span></span> <span data-ttu-id="8d5d8-206">Si une instance de rôle tente de stocker des données dans cet objet blob, ces données ne seront pas accessibles, sauf si l’instance de rôle est responsable et détient le bail d’objet blob.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-206">If a role instance attempts to store data in this blob, this data won't be accessible unless the role instance is the leader and holds the blob lease.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="8d5d8-207">Conseils et modèles connexes</span><span class="sxs-lookup"><span data-stu-id="8d5d8-207">Related patterns and guidance</span></span>

<span data-ttu-id="8d5d8-208">Les recommandations suivantes peuvent aussi s’avérer utiles pendant l’implémentation de ce modèle :</span><span class="sxs-lookup"><span data-stu-id="8d5d8-208">The following guidance might also be relevant when implementing this pattern:</span></span>
- <span data-ttu-id="8d5d8-209">Ce modèle contient un [exemple d’application](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election) téléchargeable.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-209">This pattern has a downloadable [sample application](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election).</span></span>
- <span data-ttu-id="8d5d8-210">[Mise à l’échelle automatique](https://msdn.microsoft.com/library/dn589774.aspx).</span><span class="sxs-lookup"><span data-stu-id="8d5d8-210">[Autoscaling Guidance](https://msdn.microsoft.com/library/dn589774.aspx).</span></span> <span data-ttu-id="8d5d8-211">il est possible de démarrer et d’arrêter des instances des hôtes de tâche à mesure que la charge varie au niveau de l’application.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-211">It's possible to start and stop instances of the task hosts as the load on the application varies.</span></span> <span data-ttu-id="8d5d8-212">La mise à l’échelle automatique peut contribuer à maintenir le débit et les performances pendant les périodes d’intense traitement.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-212">Autoscaling can help to maintain throughput and performance during times of peak processing.</span></span>
- <span data-ttu-id="8d5d8-213">[Recommandations en matière de partitionnement du calcul](https://msdn.microsoft.com/library/dn589773.aspx) :</span><span class="sxs-lookup"><span data-stu-id="8d5d8-213">[Compute Partitioning Guidance](https://msdn.microsoft.com/library/dn589773.aspx).</span></span> <span data-ttu-id="8d5d8-214">ces recommandations expliquent comment allouer des tâches aux hôtes d’un service cloud dans l’optique de minimiser les coûts de fonctionnement tout en préservant la scalabilité, les performances, la disponibilité et la sécurité du service.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-214">This guidance describes how to allocate tasks to hosts in a cloud service in a way that helps to minimize running costs while maintaining the scalability, performance, availability, and security of the service.</span></span>
- <span data-ttu-id="8d5d8-215">[Modèle asynchrone basé sur des tâches](https://msdn.microsoft.com/library/hh873175.aspx) :</span><span class="sxs-lookup"><span data-stu-id="8d5d8-215">The [Task-based Asynchronous Pattern](https://msdn.microsoft.com/library/hh873175.aspx).</span></span>
- <span data-ttu-id="8d5d8-216">exemple illustrant l’[algorithme du plus fort (Bully)](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html).</span><span class="sxs-lookup"><span data-stu-id="8d5d8-216">An example illustrating the [Bully Algorithm](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html).</span></span>
- <span data-ttu-id="8d5d8-217">Exemple illustrant l’[algorithme en anneau (Ring)](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span><span class="sxs-lookup"><span data-stu-id="8d5d8-217">An example illustrating the [Ring Algorithm](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span></span>
- <span data-ttu-id="8d5d8-218">[Apache Curator](https://curator.apache.org/), bibliothèque cliente pour Apache ZooKeeper.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-218">[Apache Curator](https://curator.apache.org/) a client library for Apache ZooKeeper.</span></span>
- <span data-ttu-id="8d5d8-219">Article [Lease Blob (API REST)](https://msdn.microsoft.com/library/azure/ee691972.aspx) sur MSDN.</span><span class="sxs-lookup"><span data-stu-id="8d5d8-219">The article [Lease Blob (REST API)](https://msdn.microsoft.com/library/azure/ee691972.aspx) on MSDN.</span></span>
