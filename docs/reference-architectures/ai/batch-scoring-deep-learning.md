---
title: Scoring par lots pour les modèles d’apprentissage profond
titleSuffix: Azure Reference Architectures
description: Cette architecture de référence montre comment appliquer un transfert de style neuronal à une vidéo à l’aide d’Azure Batch AI.
author: jiata
ms.date: 10/02/2018
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: azcat-ai
ms.openlocfilehash: 27975b42179e87f4520186778610159943a93090
ms.sourcegitcommit: 40f3561cc94f721eca50d33f2d75dc974cb6f92b
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/29/2019
ms.locfileid: "55147244"
---
# <a name="batch-scoring-on-azure-for-deep-learning-models"></a><span data-ttu-id="1cfb7-103">Scoring par lots dans Azure pour les modèles d’apprentissage profond</span><span class="sxs-lookup"><span data-stu-id="1cfb7-103">Batch scoring on Azure for deep learning models</span></span>

<span data-ttu-id="1cfb7-104">Cette architecture de référence montre comment appliquer un transfert de style neuronal à une vidéo à l’aide d’Azure Batch AI.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-104">This reference architecture shows how to apply neural style transfer to a video, using Azure Batch AI.</span></span> <span data-ttu-id="1cfb7-105">Le *transfert de style* est une technique d’apprentissage profond (« deep learning ») qui compose une image existante dans le style d’une autre image.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-105">*Style transfer* is a deep learning technique that composes an existing image in the style of another image.</span></span> <span data-ttu-id="1cfb7-106">Cette architecture peut être généralisée à un scénario qui utilise le scoring par lots avec l’apprentissage profond.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-106">This architecture can be generalized for any scenario that uses batch scoring with deep learning.</span></span> <span data-ttu-id="1cfb7-107">[**Déployez cette solution**](#deploy-the-solution).</span><span class="sxs-lookup"><span data-stu-id="1cfb7-107">[**Deploy this solution**](#deploy-the-solution).</span></span>

![Diagramme d’architecture pour les modèles d’apprentissage profond avec Azure Batch AI](./_images/batch-ai-deep-learning.png)

<span data-ttu-id="1cfb7-109">**Scénario** : une société de multimédia souhaite changer le style d’une vidéo pour qu’elle ressemble à une peinture spécifique.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-109">**Scenario**: A media organization has a video whose style they want to change to look like a specific painting.</span></span> <span data-ttu-id="1cfb7-110">L’objectif est d’appliquer ce style à toutes les images de la vidéo en temps voulu et de façon automatisée.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-110">The organization wants to be able to apply this style to all frames of the video in a timely manner and in an automated fashion.</span></span> <span data-ttu-id="1cfb7-111">Pour plus d’informations sur les algorithmes de transfert de style neuronal, consultez le document [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (PDF).</span><span class="sxs-lookup"><span data-stu-id="1cfb7-111">For more background about neural style transfer algorithms, see [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (PDF).</span></span>

| <span data-ttu-id="1cfb7-112">Image du style :</span><span class="sxs-lookup"><span data-stu-id="1cfb7-112">Style image:</span></span> | <span data-ttu-id="1cfb7-113">Vidéo d’entrée/contenu :</span><span class="sxs-lookup"><span data-stu-id="1cfb7-113">Input/content video:</span></span> | <span data-ttu-id="1cfb7-114">Vidéo de sortie :</span><span class="sxs-lookup"><span data-stu-id="1cfb7-114">Output video:</span></span> |
|--------|--------|---------|
| <img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/style_image.jpg" width="300"> | <span data-ttu-id="1cfb7-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Vidéo d’entrée") *cliquer pour voir la vidéo*</span><span class="sxs-lookup"><span data-stu-id="1cfb7-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Input Video") *click to view video*</span></span> | <span data-ttu-id="1cfb7-116">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Vidéo de sortie") *cliquer pour voir la vidéo*</span><span class="sxs-lookup"><span data-stu-id="1cfb7-116">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Output Video") *click to view video*</span></span> |

<span data-ttu-id="1cfb7-117">Cette architecture de référence a été conçue pour les charges de travail qui sont déclenchées par la présence de nouveaux contenus multimédias dans le stockage Azure.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-117">This reference architecture is designed for workloads that are triggered by the presence of new media in Azure storage.</span></span> <span data-ttu-id="1cfb7-118">Le traitement est constitué des étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="1cfb7-118">Processing involves the following steps:</span></span>

1. <span data-ttu-id="1cfb7-119">Chargez une image de style sélectionnée (comme une peinture de Van Gogh) et un script de transfert de style dans Stockage Blob.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-119">Upload a selected style image (like a Van Gogh painting) and a style transfer script to Blob Storage.</span></span>
1. <span data-ttu-id="1cfb7-120">Créez un cluster Batch AI avec mise à l’échelle automatique, prêt à commencer à accepter des tâches.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-120">Create an autoscaling Batch AI cluster that is ready to start taking work.</span></span>
1. <span data-ttu-id="1cfb7-121">Divisez le fichier vidéo en images individuelles et chargez ces images dans Stockage Blob.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-121">Split the video file into individual frames and upload those frames into Blob Storage.</span></span>
1. <span data-ttu-id="1cfb7-122">Une fois que toutes les images ont été chargées, chargez un fichier déclencheur dans Stockage Blob.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-122">Once all frames are uploaded, upload a trigger file to Blob Storage.</span></span>
1. <span data-ttu-id="1cfb7-123">Ce fichier déclenche une application logique qui crée un conteneur s’exécutant dans Azure Container Instances.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-123">This file triggers a Logic App that creates a container running in Azure Container Instances.</span></span>
1. <span data-ttu-id="1cfb7-124">Le conteneur exécute un script qui crée des tâches Batch AI.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-124">The container runs a script that creates the Batch AI jobs.</span></span> <span data-ttu-id="1cfb7-125">Chaque tâche applique le transfert de style neuronal en parallèle dans tous les nœuds du cluster Batch AI.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-125">Each job applies the neural style transfer in parallel across the nodes of the Batch AI cluster.</span></span>
1. <span data-ttu-id="1cfb7-126">Une fois générées, les images sont enregistrées dans Stockage Blob.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-126">Once the images are generated, they are saved back to Blob Storage.</span></span>
1. <span data-ttu-id="1cfb7-127">Téléchargez les images générées, puis réincorporez-les dans une vidéo.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-127">Download the generated frames, and stitch back the images into a video.</span></span>

## <a name="architecture"></a><span data-ttu-id="1cfb7-128">Architecture</span><span class="sxs-lookup"><span data-stu-id="1cfb7-128">Architecture</span></span>

<span data-ttu-id="1cfb7-129">Cette architecture est constituée des composants suivants.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-129">This architecture consists of the following components.</span></span>

### <a name="compute"></a><span data-ttu-id="1cfb7-130">Calcul</span><span class="sxs-lookup"><span data-stu-id="1cfb7-130">Compute</span></span>

<span data-ttu-id="1cfb7-131">**[Azure Batch AI][batch-ai]** sert à exécuter l’algorithme de transfert de style neuronal.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-131">**[Azure Batch AI][batch-ai]** is used to run the neural style transfer algorithm.</span></span> <span data-ttu-id="1cfb7-132">Batch AI prend en charge les charges de travail d’apprentissage profond en fournissant des environnements conteneurisés qui sont préconfigurés pour les infrastructures d’apprentissage profond, sur des machines virtuelles compatibles avec les GPU.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-132">Batch AI supports deep learning workloads by providing containerized environments that are pre-configured for deep learning frameworks, on GPU-enabled VMs.</span></span> <span data-ttu-id="1cfb7-133">Batch AI peut aussi connecter le cluster de calcul à Stockage Blob.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-133">Batch AI can also connect the compute cluster to Blob storage.</span></span>

> [!NOTE]
> <span data-ttu-id="1cfb7-134">La date du retrait du service Azure Batch AI est fixée au mois de mars 2019 ; ses capacités d’entraînement et de scoring à grande échelle sont désormais disponibles dans [Azure Machine Learning service][amls].</span><span class="sxs-lookup"><span data-stu-id="1cfb7-134">The Azure Batch AI service is retiring March 2019, and its at-scale training and scoring capabilities are now available in [Azure Machine Learning Service][amls].</span></span> <span data-ttu-id="1cfb7-135">Cette architecture de référence sera bientôt actualisée pour utiliser Machine Learning qui offre une cible de calcul managée appelée [Capacité de calcul Azure Machine Learning][aml-compute] pour l’entraînement, le déploiement et le scoring de modèles Machine Learning.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-135">This reference architecture will be updated soon to use Machine Learning, which offers a managed compute target called [Azure Machine Learning Compute][aml-compute] for training, deploying, and scoring machine learning models.</span></span>

### <a name="storage"></a><span data-ttu-id="1cfb7-136">Stockage</span><span class="sxs-lookup"><span data-stu-id="1cfb7-136">Storage</span></span>

<span data-ttu-id="1cfb7-137">**[Stockage Blob][blob-storage]** sert à stocker toutes les images (images d’entrée, images de style et images de sortie), ainsi que tous les journaux générés à partir de Batch AI.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-137">**[Blob storage][blob-storage]** is used to store all images (input images, style images, and output images) as well as all logs produced from Batch AI.</span></span> <span data-ttu-id="1cfb7-138">Stockage Blob s’intègre à Batch AI via [blobfuse][blobfuse], système de fichiers virtuel open source reposant sur Stockage Blob.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-138">Blob storage integrates with Batch AI via [blobfuse][blobfuse], an open-source virtual filesystem that is backed by Blob storage.</span></span> <span data-ttu-id="1cfb7-139">Stockage Blob se montre aussi très économique par rapport aux performances qu’exige cette charge de travail.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-139">Blob storage is also very cost-effective for the performance that this workload requires.</span></span>

### <a name="trigger--scheduling"></a><span data-ttu-id="1cfb7-140">Déclenchement/planification</span><span class="sxs-lookup"><span data-stu-id="1cfb7-140">Trigger / scheduling</span></span>

<span data-ttu-id="1cfb7-141">**[Azure Logic Apps][logic-apps]** sert à déclencher le workflow.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-141">**[Azure Logic Apps][logic-apps]** is used to trigger the workflow.</span></span> <span data-ttu-id="1cfb7-142">Quand l’application logique détecte qu’un objet blob a été ajouté au conteneur, elle déclenche le processus Batch AI.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-142">When the Logic App detects that a blob has been added to the container, it triggers the Batch AI process.</span></span> <span data-ttu-id="1cfb7-143">Logic Apps est parfaitement adapté à cette architecture de référence, car il permet de détecter facilement les modifications apportées à Stockage Blob et propose un processus simple pour modifier le déclencheur.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-143">Logic Apps is a good fit for this reference architecture because it's an easy way to detect changes to blob storage and provides an easy process for changing the trigger.</span></span>

<span data-ttu-id="1cfb7-144">**[Azure Container Instances][container-instances]** sert à exécuter les scripts Python qui créent les tâches Batch AI.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-144">**[Azure Container Instances][container-instances]** is used to run the Python scripts that create the Batch AI jobs.</span></span> <span data-ttu-id="1cfb7-145">L’exécution de ces scripts à l’intérieur d’un conteneur Docker est un moyen pratique de les exécuter à la demande.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-145">Running these scripts inside a Docker container is a convenient way to run them on demand.</span></span> <span data-ttu-id="1cfb7-146">Pour cette architecture, nous utilisons Container Instances, car il existe un connecteur d’application logique prédéfini qui permet à l’application logique de déclencher la tâche Batch AI.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-146">For this architecture, we use Container Instances because there is a pre-built Logic App connector for it, which allows the Logic App to trigger the Batch AI job.</span></span> <span data-ttu-id="1cfb7-147">Container Instances peut faire tourner rapidement les processus sans état.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-147">Container Instances can spin up stateless processes quickly.</span></span>

<span data-ttu-id="1cfb7-148">**[DockerHub][dockerhub]** sert à stocker l’image Docker utilisée par Container Instances pour exécuter le processus de création de tâche.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-148">**[DockerHub][dockerhub]** is used to store the Docker image that Container Instances uses to execute the job creation process.</span></span> <span data-ttu-id="1cfb7-149">DockerHub a été choisi pour cette architecture, car il est simple d’utilisation et constitue le référentiel d’images par défaut des utilisateurs de Docker.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-149">DockerHub was chosen for this architecture because it's easy to use and is the default image repository for Docker users.</span></span> <span data-ttu-id="1cfb7-150">[Azure Container Registry][container-registry] peut aussi être utilisé.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-150">[Azure Container Registry][container-registry] can also be used.</span></span>

### <a name="data-preparation"></a><span data-ttu-id="1cfb7-151">Préparation des données</span><span class="sxs-lookup"><span data-stu-id="1cfb7-151">Data preparation</span></span>

<span data-ttu-id="1cfb7-152">Cette architecture de référence utilise la séquence vidéo d’un orang-outan dans un arbre.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-152">This reference architecture uses video footage of an orangutan in a tree.</span></span> <span data-ttu-id="1cfb7-153">Vous pouvez télécharger la séquence [ici][source-video] et la traiter pour le workflow en suivant ces étapes :</span><span class="sxs-lookup"><span data-stu-id="1cfb7-153">You can download the footage from [here][source-video] and process it for the workflow by following these steps:</span></span>

1. <span data-ttu-id="1cfb7-154">Utilisez [AzCopy][azcopy] pour télécharger la vidéo à partir de l’objet blob public.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-154">Use [AzCopy][azcopy] to download the video from the public blob.</span></span>
2. <span data-ttu-id="1cfb7-155">Utilisez [FFmpeg][ffmpeg] pour extraire le fichier audio en vue de le réincorporer par la suite dans la vidéo de sortie.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-155">Use [FFmpeg][ffmpeg] to extract the audio file, so that the audio file can be stitched back into the output video later.</span></span>
3. <span data-ttu-id="1cfb7-156">Utilisez FFmpeg pour découper la vidéo en images individuelles.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-156">Use FFmpeg to break the video into individual frames.</span></span> <span data-ttu-id="1cfb7-157">Les images seront traitées indépendamment, en parallèle.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-157">The frames will be processed independently, in parallel.</span></span>
4. <span data-ttu-id="1cfb7-158">Utilisez AzCopy pour copier les images individuelles dans votre conteneur d’objets blob.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-158">Use AzCopy to copy the individual frames into your blob container.</span></span>

<span data-ttu-id="1cfb7-159">À ce stade, la séquence vidéo se trouve dans un format utilisable pour le transfert de style neuronal.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-159">At this stage, the video footage is in a form that can be used for neural style transfer.</span></span>

## <a name="performance-considerations"></a><span data-ttu-id="1cfb7-160">Considérations relatives aux performances</span><span class="sxs-lookup"><span data-stu-id="1cfb7-160">Performance considerations</span></span>

### <a name="gpu-vs-cpu"></a><span data-ttu-id="1cfb7-161">GPU et CPU</span><span class="sxs-lookup"><span data-stu-id="1cfb7-161">GPU vs CPU</span></span>

<span data-ttu-id="1cfb7-162">Pour les charges de travail d’apprentissage profond, les GPU (processeurs graphiques) sont généralement beaucoup plus performants que les CPU (processeurs centraux), dans la mesure où il faut un cluster de CPU important pour obtenir des performances comparables.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-162">For deep learning workloads, GPUs will generally out-perform CPUs by a considerable amount, to the extent that a sizeable cluster of CPUs is usually needed to get comparable performance.</span></span> <span data-ttu-id="1cfb7-163">Bien qu’il soit possible d’utiliser uniquement des CPU dans cette architecture, les GPU offrent un bien meilleur rapport coût/performances.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-163">While it's an option to use only CPUs in this architecture, GPUs will provide a much better cost/performance profile.</span></span> <span data-ttu-id="1cfb7-164">Nous vous recommandons d’utiliser les dernières machines virtuelles optimisées pour les GPU [série NCv3] vm-sizes-gpu.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-164">We recommend using the latest [NCv3 series]vm-sizes-gpu of GPU optimized VMs.</span></span>

<span data-ttu-id="1cfb7-165">Les GPU ne sont pas compatibles par défaut dans toutes les régions.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-165">GPUs are not enabled by default in all regions.</span></span> <span data-ttu-id="1cfb7-166">Veillez à sélectionner une région compatible avec les GPU.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-166">Make sure to select a region with GPUs enabled.</span></span> <span data-ttu-id="1cfb7-167">Par ailleurs, les abonnements ont un quota par défaut de zéro cœur pour les machines virtuelles optimisées pour les GPU.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-167">In addition, subscriptions have a default quota of zero cores for GPU-optimized VMs.</span></span> <span data-ttu-id="1cfb7-168">Vous pouvez augmenter ce quota en formulant une demande de support.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-168">You can raise this quota by opening a support request.</span></span> <span data-ttu-id="1cfb7-169">Vérifiez que votre abonnement dispose d’un quota suffisant pour exécuter votre charge de travail.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-169">Make sure that your subscription has enough quota to run your workload.</span></span>

### <a name="parallelizing-across-vms-vs-cores"></a><span data-ttu-id="1cfb7-170">Parallélisation dans les machines virtuelles et les cœurs</span><span class="sxs-lookup"><span data-stu-id="1cfb7-170">Parallelizing across VMs vs cores</span></span>

<span data-ttu-id="1cfb7-171">Quand vous exécutez un processus de transfert de style en tant que traitement par lots, les tâches qui s’exécutent principalement sur les GPU doivent être parallélisées dans toutes les machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-171">When running a style transfer process as a batch job, the jobs that run primarily on GPUs will have to be parallelized across VMs.</span></span> <span data-ttu-id="1cfb7-172">Deux approches sont possibles : vous pouvez soit créer un cluster plus grand contenant des machines virtuelles avec un seul GPU, soit créer un cluster plus petit contenant des machines virtuelles avec un grand nombre de GPU.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-172">Two approaches are possible: You can create a larger cluster using VMs that have a single GPU, or create a smaller cluster using VMs with many GPUs.</span></span>

<span data-ttu-id="1cfb7-173">Pour cette charge de travail, ces deux options offrent des performances comparables.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-173">For this workload, these two options will have comparable performance.</span></span> <span data-ttu-id="1cfb7-174">Le fait d’utiliser moins de machines virtuelles avec plus de GPU par machine virtuelle peut contribuer à réduire le déplacement de données.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-174">Using fewer VMs with more GPUs per VM can help to reduce data movement.</span></span> <span data-ttu-id="1cfb7-175">Cependant, le volume de données par tâche pour cette charge de travail n’étant pas très important, la limitation imposée par Stockage Blob n’est pas significative.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-175">However, the data volume per job for this workload is not very big, so you won't observe much throttling by blob storage.</span></span>

### <a name="images-batch-size-per-batch-ai-job"></a><span data-ttu-id="1cfb7-176">Taille de lot d’images par tâche Batch AI</span><span class="sxs-lookup"><span data-stu-id="1cfb7-176">Images batch size per Batch AI job</span></span>

<span data-ttu-id="1cfb7-177">Un autre paramètre qui doit être configuré est le nombre d’images à traiter par tâche Batch AI.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-177">Another parameter that must be configured is the number of images to process per Batch AI job.</span></span> <span data-ttu-id="1cfb7-178">D’un côté, vous voulez faire en sorte que la tâche soit plus ou moins bien répartie entre les nœuds et qu’en cas d’échec d’une tâche, vous n’ayez pas besoin de réessayer avec un trop grand nombre d’images.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-178">On the one hand, you want to ensure that work is spread broadly across the nodes and that if a job fails, you don't have to retry too many images.</span></span> <span data-ttu-id="1cfb7-179">Cela laisse entrevoir un nombre important de tâches Batch AI et donc peu d’images à traiter par tâche.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-179">That points to having many Batch AI jobs and thus a low number of images to process per job.</span></span> <span data-ttu-id="1cfb7-180">D’un autre côté, si trop peu d’images sont traitées par tâche, le temps de configuration/démarrage devient exagérément long.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-180">On the other hand, if too few images are processed per job, the setup/startup time becomes disproportionately large.</span></span> <span data-ttu-id="1cfb7-181">Vous pouvez définir un nombre de tâches égal au nombre maximal de nœuds présents dans le cluster.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-181">You can set the number of jobs to equal the maximum number of nodes in the cluster.</span></span> <span data-ttu-id="1cfb7-182">Il s’agit de la solution la plus performante à condition qu’aucune tâche n’échoue, car le coût de configuration/démarrage est limité.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-182">This will be the most performant assuming that no jobs fail, because it minimizes the amount of setup/startup cost.</span></span> <span data-ttu-id="1cfb7-183">En revanche, si une tâche échoue, beaucoup d’images risquent de devoir être retraitées.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-183">However, if a job fails, a large number of images might need to be reprocessed.</span></span>

### <a name="file-servers"></a><span data-ttu-id="1cfb7-184">Serveurs de fichiers</span><span class="sxs-lookup"><span data-stu-id="1cfb7-184">File servers</span></span>

<span data-ttu-id="1cfb7-185">Quand vous utilisez Batch AI, vous pouvez choisir plusieurs options de stockage, selon le débit nécessaire à votre scénario.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-185">When using Batch AI, you can choose multiple storage options depending on the throughput needed for your scenario.</span></span> <span data-ttu-id="1cfb7-186">Pour les charges de travail qui demandent peu de débit, l’utilisation de Stockage Blob (via blobfuse) doit suffire.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-186">For workloads with low throughput requirements, using blob storage (via blobfuse) should be enough.</span></span> <span data-ttu-id="1cfb7-187">Sinon, Batch AI prend aussi en charge un serveur de fichiers Batch AI, un système NFS à un seul nœud géré, qui peut être monté automatiquement sur les nœuds du cluster pour fournir un emplacement de stockage accessible de façon centralisée pour les tâches.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-187">Alternatively, Batch AI also supports a Batch AI File Server, a managed single-node NFS, which can be automatically mounted on cluster nodes to provide a centrally accessible storage location for jobs.</span></span> <span data-ttu-id="1cfb7-188">Dans la plupart des cas, un seul serveur de fichiers s’avère nécessaire dans un espace de travail, et vous pouvez répartir les données de vos travaux d’entraînement dans différents répertoires.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-188">For most cases, only one file server is needed in a workspace, and you can separate data for your training jobs into different directories.</span></span> <span data-ttu-id="1cfb7-189">Si un système NFS à un seul nœud ne convient pas pour vos charges de travail, Batch AI prend en charge d’autres options de stockage, dont Azure Files ou les solutions personnalisées que sont le système de fichiers Gluster ou Lustre.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-189">If a single-node NFS isn't appropriate for your workloads, Batch AI supports other storage options, including Azure Files or custom solutions such as a Gluster or Lustre file system.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="1cfb7-190">Considérations relatives à la sécurité</span><span class="sxs-lookup"><span data-stu-id="1cfb7-190">Security considerations</span></span>

### <a name="restricting-access-to-azure-blob-storage"></a><span data-ttu-id="1cfb7-191">Limitation de l’accès à Stockage Blob Azure</span><span class="sxs-lookup"><span data-stu-id="1cfb7-191">Restricting access to Azure blob storage</span></span>

<span data-ttu-id="1cfb7-192">Dans cette architecture de référence, Stockage Blob Azure est le composant de stockage principal qui doit être protégé.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-192">In this reference architecture, Azure blob storage is the main storage component that needs to be protected.</span></span> <span data-ttu-id="1cfb7-193">Le déploiement de référence présenté dans le dépôt GitHub utilise des clés de compte de stockage pour accéder à Stockage Blob.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-193">The baseline deployment shown in the GitHub repo uses storage account keys to access the blob storage.</span></span> <span data-ttu-id="1cfb7-194">Pour une protection et un contrôle accrus, envisagez d’utiliser une signature d’accès partagé (SAP).</span><span class="sxs-lookup"><span data-stu-id="1cfb7-194">For further control and protection, consider using a shared access signature (SAS) instead.</span></span> <span data-ttu-id="1cfb7-195">Elle octroie un accès limité aux objets contenus dans le stockage, sans qu’il soit nécessaire de coder en dur les clés de compte ou de les enregistrer en texte clair.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-195">This grants limited access to objects in storage, without needing to hard code the account keys or save them in plaintext.</span></span> <span data-ttu-id="1cfb7-196">Cette approche est particulièrement utile, car les clés de compte sont visibles en texte clair à l’intérieur de l’interface du concepteur de l’application logique.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-196">This approach is especially useful because account keys are visible in plaintext inside of Logic App's designer interface.</span></span> <span data-ttu-id="1cfb7-197">L’utilisation d’une signature SAP permet aussi de s’assurer que le compte de stockage obéit à une gouvernance appropriée et que l’accès est octroyé uniquement aux personnes censées en bénéficier.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-197">Using an SAS also helps to ensure that the storage account has proper governance, and that access is granted only to the people intended to have it.</span></span>

<span data-ttu-id="1cfb7-198">Dans les scénarios faisant intervenir des données plus sensibles, veillez à ce que toutes vos clés de stockage soient protégées, car elles octroient un accès complet à toutes les données d’entrée et de sortie de la charge de travail.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-198">For scenarios with more sensitive data, make sure that all of your storage keys are protected, because these keys grant full access to all input and output data from the workload.</span></span>

### <a name="data-encryption-and-data-movement"></a><span data-ttu-id="1cfb7-199">Chiffrement des données et déplacement des données</span><span class="sxs-lookup"><span data-stu-id="1cfb7-199">Data encryption and data movement</span></span>

<span data-ttu-id="1cfb7-200">Cette architecture de référence utilise le transfert de style comme exemple de processus de scoring par lots.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-200">This reference architecture uses style transfer as an example of a batch scoring process.</span></span> <span data-ttu-id="1cfb7-201">Pour les scénarios avec des données plus sensibles, les données contenues dans le stockage doivent être chiffrées au repos.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-201">For more data-sensitive scenarios, the data in storage should be encrypted at rest.</span></span> <span data-ttu-id="1cfb7-202">Chaque fois que des données sont déplacées d’un emplacement à l’autre, utilisez SSL pour sécuriser le transfert de données.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-202">Each time data is moved from one location to the next, use SSL to secure the data transfer.</span></span> <span data-ttu-id="1cfb7-203">Pour plus d’informations, consultez le [guide de sécurité Stockage Azure][storage-security].</span><span class="sxs-lookup"><span data-stu-id="1cfb7-203">For more information, see [Azure Storage security guide][storage-security].</span></span>

### <a name="securing-data-in-a-virtual-network"></a><span data-ttu-id="1cfb7-204">Sécurisation des données dans un réseau virtuel</span><span class="sxs-lookup"><span data-stu-id="1cfb7-204">Securing data in a virtual network</span></span>

<span data-ttu-id="1cfb7-205">Au moment de déployer votre cluster Batch AI, vous pouvez le configurer afin qu’il soit provisionné à l’intérieur d’un sous-réseau de réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-205">When deploying your Batch AI cluster, you can configure your cluster to be provisioned inside a subnet of a virtual network.</span></span> <span data-ttu-id="1cfb7-206">Les nœuds de calcul du cluster peuvent ainsi communiquer de façon sécurisée avec d’autres machines virtuelles, voire avec un réseau local.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-206">This allows the compute nodes in the cluster to communicate securely with other virtual machines, or even with an on-premises network.</span></span> <span data-ttu-id="1cfb7-207">Vous pouvez aussi utiliser des [points de terminaison de service][service-endpoints] avec Stockage Blob pour octroyer un accès à partir d’un réseau virtuel ou utiliser un système NFS à un seul nœud à l’intérieur du réseau virtuel avec Batch AI pour assurer une protection permanente des données.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-207">You can also use [service endpoints][service-endpoints] with blob storage to grant access from a virtual network or use a single-node NFS inside the VNET with Batch AI to ensure that the data is always protected.</span></span>

### <a name="protecting-against-malicious-activity"></a><span data-ttu-id="1cfb7-208">Protection contre les activités malveillantes</span><span class="sxs-lookup"><span data-stu-id="1cfb7-208">Protecting against malicious activity</span></span>

<span data-ttu-id="1cfb7-209">Dans les scénarios à plusieurs utilisateurs, veillez à ce que les données sensibles soient protégées contre les activités malveillantes.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-209">In scenarios where there are multiple users, make sure that sensitive data is protected against malicious activity.</span></span> <span data-ttu-id="1cfb7-210">Si l’accès à ce déploiement est octroyé à d’autres utilisateurs pour leur permettre de personnaliser les données d’entrée, prenez note des précautions et des considérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="1cfb7-210">If other users are given access to this deployment to customize the input data, take note of the following precautions and considerations:</span></span>

- <span data-ttu-id="1cfb7-211">Utilisez RBAC pour limiter l’accès des utilisateurs aux seules ressources dont ils ont besoin.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-211">Use RBAC to limit users' access to only the resources they need.</span></span>
- <span data-ttu-id="1cfb7-212">Provisionnez deux comptes de stockage distincts.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-212">Provision two separate storage accounts.</span></span> <span data-ttu-id="1cfb7-213">Stockez les données d’entrée et de sortie dans le premier compte.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-213">Store input and output data in the first account.</span></span> <span data-ttu-id="1cfb7-214">L’accès à ce compte peut être octroyé à des utilisateurs externes.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-214">External users can be given access to this account.</span></span> <span data-ttu-id="1cfb7-215">Stockez les scripts exécutables et les fichiers journaux de sortie dans l’autre compte.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-215">Store executable scripts and output log files in the other account.</span></span> <span data-ttu-id="1cfb7-216">Les utilisateurs externes ne doivent pas avoir accès à ce compte.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-216">External users should not have access to this account.</span></span> <span data-ttu-id="1cfb7-217">Ainsi, les utilisateurs externes ne pourront pas modifier les fichiers exécutables (pour injecter du code malveillant) ni accéder aux fichiers journaux, qui peuvent contenir des informations sensibles.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-217">This will ensure that external users cannot modify any executable files (to inject malicious code), and don't have access to logfiles, which could hold sensitive information.</span></span>
- <span data-ttu-id="1cfb7-218">Les utilisateurs malveillants peuvent lancer une attaque DDOS à l’encontre de la file d’attente des travaux ou injecter dans celle-ci des messages incohérents mal formés, entraînant ainsi le blocage du système ou des erreurs de retrait de la file d’attente.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-218">Malicious users can DDOS the job queue or inject malformed poison messages in the job queue, causing the system to lock up or causing dequeuing errors.</span></span>

## <a name="monitoring-and-logging"></a><span data-ttu-id="1cfb7-219">Supervision et journalisation</span><span class="sxs-lookup"><span data-stu-id="1cfb7-219">Monitoring and logging</span></span>

### <a name="monitoring-batch-ai-jobs"></a><span data-ttu-id="1cfb7-220">Supervision des tâches Batch AI</span><span class="sxs-lookup"><span data-stu-id="1cfb7-220">Monitoring Batch AI jobs</span></span>

<span data-ttu-id="1cfb7-221">Pendant que vous exécutez votre tâche, il est important de superviser la progression et de vérifier que tout fonctionne comme prévu.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-221">While running your job, it's important to monitor the progress and make sure that things are working as expected.</span></span> <span data-ttu-id="1cfb7-222">Cependant, superviser un cluster de nœuds actifs peut s’avérer ardu.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-222">However, it can be a challenge to monitor across a cluster of active nodes.</span></span>

<span data-ttu-id="1cfb7-223">Pour vous faire une idée de l’état global du cluster, accédez au panneau Batch AI du portail Azure pour inspecter l’état des nœuds du cluster.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-223">To get a sense of the overall state of the cluster, go to the Batch AI blade of the Azure Portal to inspect the state of the nodes in the cluster.</span></span> <span data-ttu-id="1cfb7-224">Si un nœud est inactif ou si une tâche a échoué, les journaux d’erreurs sont enregistrés dans Stockage Blob et sont aussi accessibles dans le panneau Tâches du portail Azure.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-224">If a node is inactive or a job has failed, the error logs are saved to blob storage, and are also accessible in the Jobs blade in the Azure Portal.</span></span>

<span data-ttu-id="1cfb7-225">La supervision peut encore être enrichie en connectant les journaux à Application Insights ou en exécutant des processus distincts pour demander l’état du cluster Batch AI et de ses tâches.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-225">Monitoring can be further enriched by connecting logs to Application Insights or by running separate processes to poll for the state of the Batch AI cluster and its jobs.</span></span>

### <a name="logging-in-batch-ai"></a><span data-ttu-id="1cfb7-226">Journalisation dans Batch AI</span><span class="sxs-lookup"><span data-stu-id="1cfb7-226">Logging in Batch AI</span></span>

<span data-ttu-id="1cfb7-227">Batch AI journalise automatiquement tous les stdout/stderr dans le compte Stockage Blob associé.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-227">Batch AI will automatically log all stdout/stderr to the associate blob storage account.</span></span> <span data-ttu-id="1cfb7-228">L’utilisation d’un outil de navigation de stockage comme l’Explorateur Stockage facilite nettement l’expérience de navigation dans les fichiers journaux.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-228">Using a storage navigation tool such as Storage Explorer will provide a much easier experience for navigating log files.</span></span>

<span data-ttu-id="1cfb7-229">Les étapes de déploiement pour cette architecture de référence montrent aussi comment configurer un système de journalisation plus simple, de sorte que tous les journaux des différentes tâches soient enregistrés dans un même répertoire de votre conteneur d’objets blob, comme illustré ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-229">The deployment steps for this reference architecture also shows how to set up a more simple logging system, such that all the logs across the different jobs are saved to the same directory in your blob container, as shown below.</span></span> <span data-ttu-id="1cfb7-230">Ces journaux s’avèrent utiles pour superviser la durée de traitement de chaque tâche et de chaque image.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-230">Use these logs to monitor how long it takes for each job and each image to process.</span></span> <span data-ttu-id="1cfb7-231">Vous pouvez ainsi vous faire une idée plus précise de la façon de mieux optimiser le processus.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-231">This will give you a better sense of how to optimize the process even further.</span></span>

![Capture d’écran de la journalisation pour Azure Batch AI](./_images/batch-ai-logging.png)

## <a name="cost-considerations"></a><span data-ttu-id="1cfb7-233">Considérations relatives au coût</span><span class="sxs-lookup"><span data-stu-id="1cfb7-233">Cost considerations</span></span>

<span data-ttu-id="1cfb7-234">Par rapport aux composants de stockage et de planification, les ressources de calcul utilisées dans cette architecture de référence s’avèrent nettement plus coûteuses.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-234">Compared to the storage and scheduling components, the compute resources used in this reference architecture by far dominate in terms of costs.</span></span> <span data-ttu-id="1cfb7-235">L’une des principales difficultés est de paralléliser efficacement les tâches dans un cluster de machines compatibles avec les GPU.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-235">One of the main challenges is effectively parallelizing the work across a cluster of GPU-enabled machines.</span></span>

<span data-ttu-id="1cfb7-236">La taille du cluster Batch AI peut être mise automatiquement à l’échelle à la hausse ou à la baisse en fonction des tâches présentes dans la file d’attente.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-236">The Batch AI cluster size can automatically scale up and down depending on the jobs in the queue.</span></span> <span data-ttu-id="1cfb7-237">Avec Batch AI, vous pouvez activer la mise à l’échelle automatique de deux façons différentes.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-237">You can enable auto-scale with Batch AI in one of two ways.</span></span> <span data-ttu-id="1cfb7-238">Vous pouvez le faire programmatiquement, ce que vous pouvez configurer dans le fichier `.env` lors des [étapes de déploiement][deployment], ou vous pouvez changer la formule de mise à l’échelle directement dans le portail une fois le cluster créé.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-238">You can do so programmatically, which can be configured in the `.env` file that is part of the [deployment steps][deployment], or you can change the scale formula directly in the portal after the cluster is created.</span></span>

<span data-ttu-id="1cfb7-239">Pour les tâches qui ne nécessitent pas un traitement immédiat, configurez la formule de mise à l’échelle automatique de sorte que l’état par défaut (minimum) soit un cluster sans nœud.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-239">For work that doesn't require immediate processing, configure the auto-scale formula so the default state (minimum) is a cluster of zero nodes.</span></span> <span data-ttu-id="1cfb7-240">Avec cette configuration, le cluster démarre sans nœud et ne monte en puissance que s’il détecte des tâches dans la file d’attente.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-240">With this configuration, the cluster starts with zero nodes and only scales up when it detects jobs in the queue.</span></span> <span data-ttu-id="1cfb7-241">Si le processus de scoring par lots ne s’enclenche que quelques fois par jour, ce paramètre permet de réaliser des économies significatives.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-241">If the batch scoring process only happens a few times a day or less, this setting enables significant cost savings.</span></span>

<span data-ttu-id="1cfb7-242">La mise à l’échelle peut ne pas convenir pour les tâches Batch trop rapprochées les unes des autres.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-242">Auto-scaling may not be appropriate for batch jobs that happen too close to each other.</span></span> <span data-ttu-id="1cfb7-243">Le temps nécessaire au lancement et à l’arrêt d’un cluster a aussi un coût. De ce fait, si une charge de travail Batch commence seulement quelques minutes après la fin de la tâche précédente, il peut être plus rentable de laisser le cluster s’exécuter entre les tâches.</span><span class="sxs-lookup"><span data-stu-id="1cfb7-243">The time that it takes for a cluster to spin up and spin down also incur a cost, so if a batch workload begins only a few minutes after the previous job ends, it might be more cost effective to keep the cluster running between jobs.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="1cfb7-244">Déployer la solution</span><span class="sxs-lookup"><span data-stu-id="1cfb7-244">Deploy the solution</span></span>

<span data-ttu-id="1cfb7-245">Pour déployer cette architecture de référence, suivez les étapes décrites dans le [dépôt GitHub][deployment].</span><span class="sxs-lookup"><span data-stu-id="1cfb7-245">To deploy this reference architecture, follow the steps described in the [GitHub repo][deployment].</span></span>

<!-- links -->

[aml-compute]: /azure/machine-learning/service/how-to-set-up-training-targets#amlcompute
[amls]: /azure/machine-learning/service/overview-what-is-azure-ml
[azcopy]: /azure/storage/common/storage-use-azcopy-linux
[batch-ai]: /azure/batch-ai/
[blobfuse]: https://github.com/Azure/azure-storage-fuse
[blob-storage]: /azure/storage/blobs/storage-blobs-introduction
[container-instances]: /azure/container-instances/
[container-registry]: /azure/container-registry/
[deployment]: https://github.com/Azure/batch-scoring-for-dl-models
[dockerhub]: https://hub.docker.com/
[ffmpeg]: https://www.ffmpeg.org/
[image-style-transfer]: https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf
[logic-apps]: /azure/logic-apps/
[service-endpoints]: /azure/storage/common/storage-network-security?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network
[source-video]: https://happypathspublic.blob.core.windows.net/videos/orangutan.mp4
[storage-security]: /azure/storage/common/storage-security-guide
[vm-sizes-gpu]: /azure/virtual-machines/windows/sizes-gpu
