---
title: Nivellement de la charge basé sur une file d’attente
description: Utilisez une file d’attente qui agit comme mémoire tampon entre une tâche et un service qu’elle appelle, afin d’atténuer les surcharges intermittentes.
keywords: modèle de conception
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- messaging
- availability
- performance-scalability
- resiliency
ms.openlocfilehash: 99b226511fe14bffdab3cdcf65d4e6cffe89bba6
ms.sourcegitcommit: 8ab30776e0c4cdc16ca0dcc881960e3108ad3e94
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 12/08/2017
---
# <a name="queue-based-load-leveling-pattern"></a><span data-ttu-id="af65f-104">Modèle de nivellement de charge basé sur une file d’attente</span><span class="sxs-lookup"><span data-stu-id="af65f-104">Queue-Based Load Leveling pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="af65f-105">Utilisez une file d’attente qui agit comme une mémoire tampon entre une tâche et un service qu’elle appelle, afin d’atténuer les surcharges intermittentes qui entraînent l’échec du service ou l’expiration de la tâche. Cela permet de réduire l’impact des pics de demande sur la disponibilité et la réactivité de la tâche et du service.</span><span class="sxs-lookup"><span data-stu-id="af65f-105">Use a queue that acts as a buffer between a task and a service it invokes in order to smooth intermittent heavy loads that can cause the service to fail or the task to time out. This can help to minimize the impact of peaks in demand on availability and responsiveness for both the task and the service.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="af65f-106">Contexte et problème</span><span class="sxs-lookup"><span data-stu-id="af65f-106">Context and problem</span></span>

<span data-ttu-id="af65f-107">De nombreuses solutions cloud impliquent l’exécution de tâches qui appellent des services.</span><span class="sxs-lookup"><span data-stu-id="af65f-107">Many solutions in the cloud involve running tasks that invoke services.</span></span> <span data-ttu-id="af65f-108">Dans cet environnement, si un service est soumis à des surcharges intermittentes, cela peut provoquer des problèmes de performances et de fiabilité.</span><span class="sxs-lookup"><span data-stu-id="af65f-108">In this environment, if a service is subjected to intermittent heavy loads, it can cause performance or reliability issues.</span></span>

<span data-ttu-id="af65f-109">Un service peut faire partie de la même solution que les tâches qui l’utilisent, ou il peut s’agir d’un service tiers offrant un accès aux ressources fréquemment utilisées, telles qu’un cache ou un service de stockage.</span><span class="sxs-lookup"><span data-stu-id="af65f-109">A service could be part of the same solution as the tasks that use it, or it could be a third-party service providing access to frequently used resources such as a cache or a storage service.</span></span> <span data-ttu-id="af65f-110">Si le même service est utilisé par plusieurs tâches qui s’exécutent simultanément, il peut être difficile de prévoir le volume de requêtes destinées au service un moment donné.</span><span class="sxs-lookup"><span data-stu-id="af65f-110">If the same service is used by a number of tasks running concurrently, it can be difficult to predict the volume of requests to the service at any time.</span></span>

<span data-ttu-id="af65f-111">Un service peut connaître des pics de demande qui entraînent sa surcharge et son incapacité à répondre aux requêtes en temps voulu.</span><span class="sxs-lookup"><span data-stu-id="af65f-111">A service might experience peaks in demand that cause it to overload and be unable to respond to requests in a timely manner.</span></span> <span data-ttu-id="af65f-112">L’envoi à un service d’un grand nombre de requêtes simultanées peut également entraîner l’échec du service si celui-ci n’est pas en mesure de gérer le conflit causé par ces requêtes.</span><span class="sxs-lookup"><span data-stu-id="af65f-112">Flooding a service with a large number of concurrent requests can also result in the service failing if it's unable to handle the contention these requests cause.</span></span>

## <a name="solution"></a><span data-ttu-id="af65f-113">Solution</span><span class="sxs-lookup"><span data-stu-id="af65f-113">Solution</span></span>

<span data-ttu-id="af65f-114">Refactorisez la solution et introduisez une file d’attente entre la tâche et le service.</span><span class="sxs-lookup"><span data-stu-id="af65f-114">Refactor the solution and introduce a queue between the task and the service.</span></span> <span data-ttu-id="af65f-115">La tâche et le service s’exécutent de façon asynchrone.</span><span class="sxs-lookup"><span data-stu-id="af65f-115">The task and the service run asynchronously.</span></span> <span data-ttu-id="af65f-116">La tâche publie un message contenant les données requises par le service dans une file d’attente.</span><span class="sxs-lookup"><span data-stu-id="af65f-116">The task posts a message containing the data required by the service to a queue.</span></span> <span data-ttu-id="af65f-117">La file d’attente agit comme une mémoire tampon : elle stocke le message jusqu'à ce qu’il soit récupéré par le service.</span><span class="sxs-lookup"><span data-stu-id="af65f-117">The queue acts as a buffer, storing the message until it's retrieved by the service.</span></span> <span data-ttu-id="af65f-118">Le service récupère les messages dans la file d’attente et les traite.</span><span class="sxs-lookup"><span data-stu-id="af65f-118">The service retrieves the messages from the queue and processes them.</span></span> <span data-ttu-id="af65f-119">Les requêtes issues d’un certain nombre de tâches, qui peuvent être générées à une fréquence très variable, peuvent être transmises au service de la même file d’attente de messages.</span><span class="sxs-lookup"><span data-stu-id="af65f-119">Requests from a number of tasks, which can be generated at a highly variable rate, can be passed to the service through the same message queue.</span></span> <span data-ttu-id="af65f-120">Cette illustration montre l’utilisation d’une file d’attente pour niveler la charge sur un service.</span><span class="sxs-lookup"><span data-stu-id="af65f-120">This figure shows using a queue to level the load on a service.</span></span>

![Illustration 1 : utilisation d’une file d’attente pour niveler la charge sur un service](./_images/queue-based-load-leveling-pattern.png)

<span data-ttu-id="af65f-122">La file d’attente dissocie les tâches du service, et le service peut gérer les messages à son propre rythme, quel que soit le volume de requêtes des tâches simultanées.</span><span class="sxs-lookup"><span data-stu-id="af65f-122">The queue decouples the tasks from the service, and the service can handle the messages at its own pace regardless of the volume of requests from concurrent tasks.</span></span> <span data-ttu-id="af65f-123">En outre, il n’y a pas de retard pour une tâche si le service n’est pas disponible au moment de la publication du message dans la file d’attente.</span><span class="sxs-lookup"><span data-stu-id="af65f-123">Additionally, there's no delay to a task if the service isn't available at the time it posts a message to the queue.</span></span>

<span data-ttu-id="af65f-124">Ce modèle permet de bénéficier des avantages suivants :</span><span class="sxs-lookup"><span data-stu-id="af65f-124">This pattern provides the following benefits:</span></span>

- <span data-ttu-id="af65f-125">Il permet d’optimiser la disponibilité, car les retards de services n’ont pas d’impact immédiat et direct sur l’application, qui peut continuer à envoyer des messages à la file d’attente même lorsque le service n’est pas disponible ou ne traite pas actuellement de messages.</span><span class="sxs-lookup"><span data-stu-id="af65f-125">It can help to maximize availability because delays arising in services won't have an immediate and direct impact on the application, which can continue to post messages to the queue even when the service isn't available or isn't currently processing messages.</span></span>
- <span data-ttu-id="af65f-126">Il permet d’optimiser l’évolutivité, car à la fois le nombre de files d’attente et le nombre de services peuvent être modifiés pour répondre à la demande.</span><span class="sxs-lookup"><span data-stu-id="af65f-126">It can help to maximize scalability because both the number of queues and the number of services can be varied to meet demand.</span></span>
- <span data-ttu-id="af65f-127">Il permet de contrôler les coûts, car le nombre d’instances de service déployées doit uniquement être suffisant pour répondre à une charge moyenne plutôt qu’à la charge maximale.</span><span class="sxs-lookup"><span data-stu-id="af65f-127">It can help to control costs because the number of service instances deployed only have to be adequate to meet average load rather than the peak load.</span></span>

    >  <span data-ttu-id="af65f-128">Certains services implémentent une limitation lorsque la demande atteint un seuil au-delà duquel il existe un risque d’échec du système.</span><span class="sxs-lookup"><span data-stu-id="af65f-128">Some services implement throttling when demand reaches a threshold beyond which the system could fail.</span></span> <span data-ttu-id="af65f-129">La limitation peut restreindre les fonctionnalités disponibles.</span><span class="sxs-lookup"><span data-stu-id="af65f-129">Throttling can reduce the functionality available.</span></span> <span data-ttu-id="af65f-130">Vous pouvez implémenter le nivellement de la charge avec ces services pour vous assurer que ce seuil n’est pas atteint.</span><span class="sxs-lookup"><span data-stu-id="af65f-130">You can implement load leveling with these services to ensure that this threshold isn't reached.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="af65f-131">Problèmes et considérations</span><span class="sxs-lookup"><span data-stu-id="af65f-131">Issues and considerations</span></span>

<span data-ttu-id="af65f-132">Prenez en compte les points suivants lorsque vous choisissez comment implémenter ce modèle :</span><span class="sxs-lookup"><span data-stu-id="af65f-132">Consider the following points when deciding how to implement this pattern:</span></span>

- <span data-ttu-id="af65f-133">Il est nécessaire d’implémenter la logique d’application qui contrôle la fréquence à laquelle les services traitent les messages pour éviter de surcharger la ressource cible.</span><span class="sxs-lookup"><span data-stu-id="af65f-133">It's necessary to implement application logic that controls the rate at which services handle messages to avoid overwhelming the target resource.</span></span> <span data-ttu-id="af65f-134">Évitez de transférer des pics de demande à l’étape suivante du système.</span><span class="sxs-lookup"><span data-stu-id="af65f-134">Avoid passing spikes in demand to the next stage of the system.</span></span> <span data-ttu-id="af65f-135">Testez le système avec la charge pour vous assurer qu’il fournit le niveau requise, puis ajustez le nombre de files d’attente et le nombre d’instances de service qui traitent les messages pour obtenir le résultat souhaité.</span><span class="sxs-lookup"><span data-stu-id="af65f-135">Test the system under load to ensure that it provides the required leveling, and adjust the number of queues and the number of service instances that handle messages to achieve this.</span></span>
- <span data-ttu-id="af65f-136">Les files d’attente de messages constituent un mécanisme de communication unidirectionnelle.</span><span class="sxs-lookup"><span data-stu-id="af65f-136">Message queues are a one-way communication mechanism.</span></span> <span data-ttu-id="af65f-137">Si une tâche attend une réponse d’un service, il peut être nécessaire implémenter un mécanisme que le service peut utiliser pour envoyer une réponse.</span><span class="sxs-lookup"><span data-stu-id="af65f-137">If a task expects a reply from a service, it might be necessary to implement a mechanism that the service can use to send a response.</span></span> <span data-ttu-id="af65f-138">Pour en savoir plus, voir [Primer de messagerie asynchrone](https://msdn.microsoft.com/library/dn589781.aspx).</span><span class="sxs-lookup"><span data-stu-id="af65f-138">For more information, see the [Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx).</span></span>
- <span data-ttu-id="af65f-139">Soyez prudent si vous appliquez la mise à l’échelle automatique aux services qui écoutent les requêtes sur la file d’attente.</span><span class="sxs-lookup"><span data-stu-id="af65f-139">Be careful if you apply autoscaling to services that are listening for requests on the queue.</span></span> <span data-ttu-id="af65f-140">Cela peut entraîner une augmentation des conflits pour les ressources partagées par ces services et diminuer l’efficacité de la file d’attente pour niveler la charge.</span><span class="sxs-lookup"><span data-stu-id="af65f-140">This can result in increased contention for any resources that these services share and diminish the effectiveness of using the queue to level the load.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="af65f-141">Quand utiliser ce modèle</span><span class="sxs-lookup"><span data-stu-id="af65f-141">When to use this pattern</span></span>

<span data-ttu-id="af65f-142">Ce modèle est utile pour toute application qui utilise des services soumis à une surcharge.</span><span class="sxs-lookup"><span data-stu-id="af65f-142">This pattern is useful to any application that uses services that are subject to overloading.</span></span>

<span data-ttu-id="af65f-143">Ce modèle n’est pas utile si l’application attend une réponse du service avec une latence minimale.</span><span class="sxs-lookup"><span data-stu-id="af65f-143">This pattern isn't useful if the application expects a response from the service with minimal latency.</span></span>

## <a name="example"></a><span data-ttu-id="af65f-144">exemples</span><span class="sxs-lookup"><span data-stu-id="af65f-144">Example</span></span>

<span data-ttu-id="af65f-145">Un rôle web Microsoft Azure stocke les données à l’aide d’un service de stockage distinct.</span><span class="sxs-lookup"><span data-stu-id="af65f-145">A Microsoft Azure web role stores data using a separate storage service.</span></span> <span data-ttu-id="af65f-146">Si un grand nombre d’instances du rôle web s’exécutent simultanément, le service de stockage risque de ne pas répondre aux requêtes assez vite pour les empêcher d’expirer ou d’échouer.</span><span class="sxs-lookup"><span data-stu-id="af65f-146">If a large number of instances of the web role run concurrently, it's possible that the storage service will be unable to respond to requests quickly enough to prevent these requests from timing out or failing.</span></span> <span data-ttu-id="af65f-147">Cette illustration met en évidence un service saturé par un grand nombre de requêtes simultanées émises des instances de rôle web.</span><span class="sxs-lookup"><span data-stu-id="af65f-147">This figure highlights a service being overwhelmed by a large number of concurrent requests from instances of a web role.</span></span>

![Illustration 2 : service saturé par un grand nombre de requêtes simultanées émises des instances de rôle web](./_images/queue-based-load-leveling-overwhelmed.png)


<span data-ttu-id="af65f-149">Pour résoudre ce problème, vous pouvez utiliser une file d’attente pour niveler la charge entre les instances de rôle web et le service de stockage.</span><span class="sxs-lookup"><span data-stu-id="af65f-149">To resolve this, you can use a queue to level the load between the web role instances and the storage service.</span></span> <span data-ttu-id="af65f-150">Toutefois, le service de stockage est conçu pour accepter des requêtes synchrones et ne peut pas être facilement modifié pour lire les messages et gérer le débit.</span><span class="sxs-lookup"><span data-stu-id="af65f-150">However, the storage service is designed to accept synchronous requests and can't be easily modified to read messages and manage throughput.</span></span> <span data-ttu-id="af65f-151">Vous pouvez introduire un rôle de travail agissant en tant que service proxy, qui reçoit des requêtes de la file d’attente et les transmet au service de stockage.</span><span class="sxs-lookup"><span data-stu-id="af65f-151">You can introduce a worker role to act as a proxy service that receives requests from the queue and forwards them to the storage service.</span></span> <span data-ttu-id="af65f-152">La logique d’application du rôle de travail peut contrôler la fréquence à laquelle les requêtes sont transmises au service de stockage pour empêcher la surcharge de ce dernier.</span><span class="sxs-lookup"><span data-stu-id="af65f-152">The application logic in the worker role can control the rate at which it passes requests to the storage service to prevent the storage service from being overwhelmed.</span></span> <span data-ttu-id="af65f-153">Cette figure illustre l’utilisation d’une file d’attente et d’un rôle de travail pour niveler la charge entre les instances du rôle Web et le service.</span><span class="sxs-lookup"><span data-stu-id="af65f-153">This figure illustrates using a queue and a worker role to level the load between instances of the web role and the service.</span></span>

![Illustration 3 : utilisation d’une file d’attente et d’un rôle de travail pour niveler la charge entre les instances du rôle web et le service](./_images/queue-based-load-leveling-worker-role.png)

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="af65f-155">Conseils et modèles connexes</span><span class="sxs-lookup"><span data-stu-id="af65f-155">Related patterns and guidance</span></span>

<span data-ttu-id="af65f-156">Les modèles et les conseils suivants peuvent aussi présenter un intérêt quand il s’agit d’implémenter ce modèle :</span><span class="sxs-lookup"><span data-stu-id="af65f-156">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="af65f-157">[Primer de messagerie asynchrone](https://msdn.microsoft.com/library/dn589781.aspx).</span><span class="sxs-lookup"><span data-stu-id="af65f-157">[Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx).</span></span> <span data-ttu-id="af65f-158">Les files d’attente sont par nature asynchrones.</span><span class="sxs-lookup"><span data-stu-id="af65f-158">Message queues are inherently asynchronous.</span></span> <span data-ttu-id="af65f-159">Il peut être nécessaire de reconcevoir la logique d’application dans une tâche si elle est adaptée de sorte à ne plus communiquer directement avec un service mais à utiliser une file d’attente.</span><span class="sxs-lookup"><span data-stu-id="af65f-159">It might be necessary to redesign the application logic in a task if it's adapted from communicating directly with a service to using a message queue.</span></span> <span data-ttu-id="af65f-160">De même, il peut être nécessaire de refactoriser un service pour accepter les requêtes provenant d’une file d’attente.</span><span class="sxs-lookup"><span data-stu-id="af65f-160">Similarly, it might be necessary to refactor a service to accept requests from a message queue.</span></span> <span data-ttu-id="af65f-161">Sinon, il est parfois possible d’implémenter un service proxy, comme décrit dans l’exemple.</span><span class="sxs-lookup"><span data-stu-id="af65f-161">Alternatively, it might be possible to implement a proxy service, as described in the example.</span></span>
- <span data-ttu-id="af65f-162">[Modèle des consommateurs concurrents](competing-consumers.md).</span><span class="sxs-lookup"><span data-stu-id="af65f-162">[Competing Consumers pattern](competing-consumers.md).</span></span> <span data-ttu-id="af65f-163">Il est parfois possible d’exécuter plusieurs instances d’un service, chacune agissant comme un consommateur de messages à partir de la file d’attente de nivellement de charge.</span><span class="sxs-lookup"><span data-stu-id="af65f-163">It might be possible to run multiple instances of a service, each acting as a message consumer from the load-leveling queue.</span></span> <span data-ttu-id="af65f-164">Vous pouvez utiliser cette approche pour ajuster la fréquence à laquelle les messages sont reçus et transmis à un service.</span><span class="sxs-lookup"><span data-stu-id="af65f-164">You can use this approach to adjust the rate at which messages are received and passed to a service.</span></span>
- <span data-ttu-id="af65f-165">[Modèle de limitation](throttling.md).</span><span class="sxs-lookup"><span data-stu-id="af65f-165">[Throttling pattern](throttling.md).</span></span> <span data-ttu-id="af65f-166">Un moyen simple d’implémenter la limitation avec un service consiste à utiliser le nivellement de charge basé sur la file d’attente et à acheminer toutes les requêtes vers un service via une file d’attente de messages.</span><span class="sxs-lookup"><span data-stu-id="af65f-166">A simple way to implement throttling with a service is to use queue-based load leveling and route all requests to a service through a message queue.</span></span> <span data-ttu-id="af65f-167">Le service peut traiter des requêtes à un rythme qui garantit que les ressources requises par le service ne sont pas épuisées, de façon à réduire le nombre de conflits éventuels.</span><span class="sxs-lookup"><span data-stu-id="af65f-167">The service can process requests at a rate that ensures that resources required by the service aren't exhausted, and to reduce the amount of contention that could occur.</span></span>
- <span data-ttu-id="af65f-168">[Concepts du service de file d’attente](https://msdn.microsoft.com/library/azure/dd179353.aspx).</span><span class="sxs-lookup"><span data-stu-id="af65f-168">[Queue Service Concepts](https://msdn.microsoft.com/library/azure/dd179353.aspx).</span></span> <span data-ttu-id="af65f-169">Informations sur le choix d’un mécanisme de messagerie et de file d’attente dans les applications Azure.</span><span class="sxs-lookup"><span data-stu-id="af65f-169">Information about choosing a messaging and queuing mechanism in Azure applications.</span></span>
