---
title: Architecture des microservices sur AKS (Azure Kubernetes Service)
description: Déployer une architecture de microservices sur AKS (Azure Kubernetes Service)
author: MikeWasson
ms.date: 12/10/2018
ms.topic: reference-architecture
ms.service: architecture-center
ms.subservice: reference-architecture
ms.custom: microservices
ms.openlocfilehash: c8ce4c77666ab7b9c55e6f144d514fadc6b6ad73
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 03/20/2019
ms.locfileid: "58246080"
---
# <a name="microservices-architecture-on-azure-kubernetes-service-aks"></a><span data-ttu-id="41c8a-103">Architecture des microservices sur AKS (Azure Kubernetes Service)</span><span class="sxs-lookup"><span data-stu-id="41c8a-103">Microservices architecture on Azure Kubernetes Service (AKS)</span></span>

<span data-ttu-id="41c8a-104">Cette architecture de référence montre une application de microservices déployée sur AKS (Azure Kubernetes Service).</span><span class="sxs-lookup"><span data-stu-id="41c8a-104">This reference architectures shows a microservices application deployed to Azure Kubernetes Service (AKS).</span></span> <span data-ttu-id="41c8a-105">Elle illustre une configuration AKS de base qui peut être le point de départ de la plupart des déploiements.</span><span class="sxs-lookup"><span data-stu-id="41c8a-105">It shows a basic AKS configuration that can be the starting point for most deployments.</span></span> <span data-ttu-id="41c8a-106">Les options plus avancées, concernant notamment la mise en réseau, sont abordées dans une architecture de référence distincte.</span><span class="sxs-lookup"><span data-stu-id="41c8a-106">More advanced options, including advanced networking options, will be covered in a separate reference architecture.</span></span>

<span data-ttu-id="41c8a-107">Cet article suppose une connaissance élémentaire de Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-107">This article assumes basic knowledge of Kubernetes.</span></span> <span data-ttu-id="41c8a-108">Il se concentre principalement sur l’infrastructure et les considérations DevOps liées à l’exécution d’une architecture de microservices sur AKS.</span><span class="sxs-lookup"><span data-stu-id="41c8a-108">The article focuses mainly on the infrastructure and DevOps considerations of running a microservices architecture on AKS.</span></span> <span data-ttu-id="41c8a-109">Pour obtenir des conseils sur la conception de microservices dans le cadre d’une conception pilotée par le domaine, consultez [Conception, génération et exploitation de microservices sur Azure](/azure/architecture/microservices).</span><span class="sxs-lookup"><span data-stu-id="41c8a-109">For guidance on how to design microservices from a Domain Driven Design (DDD) perspective, see [Designing, building, and operating microservices on Azure](/azure/architecture/microservices).</span></span>

![Architecture de référence AKS](./_images/aks.png)

## <a name="architecture"></a><span data-ttu-id="41c8a-111">Architecture</span><span class="sxs-lookup"><span data-stu-id="41c8a-111">Architecture</span></span>

<span data-ttu-id="41c8a-112">L’architecture est constituée des composants suivants.</span><span class="sxs-lookup"><span data-stu-id="41c8a-112">The architecture consists of the following components.</span></span>

<span data-ttu-id="41c8a-113">**Azure Kubernetes Service** (AKS).</span><span class="sxs-lookup"><span data-stu-id="41c8a-113">**Azure Kubernetes Service** (AKS).</span></span> <span data-ttu-id="41c8a-114">AKS est un service Azure qui déploie un cluster Kubernetes managé.</span><span class="sxs-lookup"><span data-stu-id="41c8a-114">AKS is an Azure service that deploys a managed Kubernetes cluster.</span></span> 

<span data-ttu-id="41c8a-115">**Cluster Kubernetes**.</span><span class="sxs-lookup"><span data-stu-id="41c8a-115">**Kubernetes cluster**.</span></span> <span data-ttu-id="41c8a-116">AKS est responsable du déploiement du cluster Kubernetes et de la gestion des maîtres Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-116">AKS is responsible for deploying the Kubernetes cluster and for managing the Kubernetes masters.</span></span> <span data-ttu-id="41c8a-117">Vous ne gérez que les nœuds d’agent.</span><span class="sxs-lookup"><span data-stu-id="41c8a-117">You only manage the agent nodes.</span></span>

<span data-ttu-id="41c8a-118">**Réseau virtuel**.</span><span class="sxs-lookup"><span data-stu-id="41c8a-118">**Virtual network**.</span></span> <span data-ttu-id="41c8a-119">Par défaut, AKS crée un réseau virtuel en vue d’y déployer les nœuds d’agent.</span><span class="sxs-lookup"><span data-stu-id="41c8a-119">By default, AKS creates a virtual network to deploy the agent nodes into.</span></span> <span data-ttu-id="41c8a-120">Pour les scénarios plus avancés, vous pouvez commencer par créer le réseau virtuel et contrôler ainsi la configuration des sous-réseaux, la connectivité locale et l’adressage IP, entre autres éléments.</span><span class="sxs-lookup"><span data-stu-id="41c8a-120">For more advanced scenarios, you can create the virtual network first, which lets you control things like how the subnets are configured, on-premises connectivity, and IP addressing.</span></span> <span data-ttu-id="41c8a-121">Pour plus d’informations, consultez [Configurer la mise en réseau avancée dans AKS (Azure Kubernetes Service)](/azure/aks/configure-advanced-networking).</span><span class="sxs-lookup"><span data-stu-id="41c8a-121">For more information, see [Configure advanced networking in Azure Kubernetes Service (AKS)](/azure/aks/configure-advanced-networking).</span></span>

<span data-ttu-id="41c8a-122">**Entrée**.</span><span class="sxs-lookup"><span data-stu-id="41c8a-122">**Ingress**.</span></span> <span data-ttu-id="41c8a-123">Une entrée expose des routes HTTP(S) aux services à l’intérieur du cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-123">An ingress exposes HTTP(S) routes to services inside the cluster.</span></span> <span data-ttu-id="41c8a-124">Pour plus d’informations, consultez la section [Passerelle API](#api-gateway) ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="41c8a-124">For more information, see the section [API Gateway](#api-gateway) below.</span></span>

<span data-ttu-id="41c8a-125">**Magasins de données externes**.</span><span class="sxs-lookup"><span data-stu-id="41c8a-125">**External data stores**.</span></span> <span data-ttu-id="41c8a-126">Les microservices étant généralement sans état, ils écrivent l’état dans des magasins de données externes, tels qu’Azure SQL Database ou Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="41c8a-126">Microservices are typically stateless and write state to external data stores, such as Azure SQL Database or Cosmos DB.</span></span>

<span data-ttu-id="41c8a-127">**Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="41c8a-127">**Azure Active Directory**.</span></span> <span data-ttu-id="41c8a-128">AKS utilise une identité Azure Active Directory (Azure AD) pour créer et gérer d’autres ressources Azure telles que les équilibreurs de charge Azure.</span><span class="sxs-lookup"><span data-stu-id="41c8a-128">AKS uses an Azure Active Directory (Azure AD) identity to create and manage other Azure resources such as Azure load balancers.</span></span> <span data-ttu-id="41c8a-129">Azure AD est également recommandé pour l’authentification de l’utilisateur dans les applications clientes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-129">Azure AD is also recommended for user authentication in client applications.</span></span>

<span data-ttu-id="41c8a-130">**Azure Container Registry**.</span><span class="sxs-lookup"><span data-stu-id="41c8a-130">**Azure Container Registry**.</span></span> <span data-ttu-id="41c8a-131">Utilisez Container Registry pour stocker les images Docker privées, qui sont déployées sur le cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-131">Use Container Registry to store private Docker images, which are deployed to the cluster.</span></span> <span data-ttu-id="41c8a-132">AKS peut s’authentifier auprès de Container Registry à l’aide de son identité Azure AD.</span><span class="sxs-lookup"><span data-stu-id="41c8a-132">AKS can authenticate with Container Registry using its Azure AD identity.</span></span> <span data-ttu-id="41c8a-133">Notez qu’AKS ne nécessite pas Azure Container Registry.</span><span class="sxs-lookup"><span data-stu-id="41c8a-133">Note that AKS does not require Azure Container Registry.</span></span> <span data-ttu-id="41c8a-134">Vous pouvez utiliser d’autres registres de conteneurs, tels que Docker Hub.</span><span class="sxs-lookup"><span data-stu-id="41c8a-134">You can use other container registries, such as Docker Hub.</span></span>

<span data-ttu-id="41c8a-135">**Azure Pipelines**.</span><span class="sxs-lookup"><span data-stu-id="41c8a-135">**Azure Pipelines**.</span></span> <span data-ttu-id="41c8a-136">Les pipelines font partie d’Azure DevOps Services et exécutent des générations, tests et déploiements automatisés.</span><span class="sxs-lookup"><span data-stu-id="41c8a-136">Pipelines is part of Azure DevOps Services and runs automated builds, tests, and deployments.</span></span> <span data-ttu-id="41c8a-137">Vous pouvez également utiliser des solutions CI/CD tierces telles que Jenkins.</span><span class="sxs-lookup"><span data-stu-id="41c8a-137">You can also use third-party CI/CD solutions such as Jenkins.</span></span> 

<span data-ttu-id="41c8a-138">**Helm**.</span><span class="sxs-lookup"><span data-stu-id="41c8a-138">**Helm**.</span></span> <span data-ttu-id="41c8a-139">Faisant office de gestionnaire de package pour Kubernetes, Helm permet de regrouper les objets Kubernetes en une seule unité que vous pouvez publier, déployer, mettre à jour et dont vous pouvez contrôler la version.</span><span class="sxs-lookup"><span data-stu-id="41c8a-139">Helm is as a package manager for Kubernetes &mdash; a way to bundle Kubernetes objects into a single unit that you can publish, deploy, version, and update.</span></span>

<span data-ttu-id="41c8a-140">**Azure Monitor**.</span><span class="sxs-lookup"><span data-stu-id="41c8a-140">**Azure Monitor**.</span></span> <span data-ttu-id="41c8a-141">Azure Monitor recueille et stocke les métriques et journaux, notamment les métriques de plateforme pour les services Azure dans les données de télémétrie d’application et de solution.</span><span class="sxs-lookup"><span data-stu-id="41c8a-141">Azure Monitor collects and stores metrics and logs, including platform metrics for the Azure services in the solution and application telemetry.</span></span> <span data-ttu-id="41c8a-142">Utilisez ces données pour superviser l’application, définir des alertes et des tableaux de bord et effectuer une analyse de la cause racine des échecs.</span><span class="sxs-lookup"><span data-stu-id="41c8a-142">Use this data to monitor the application, set up alerts and dashboards, and perform root cause analysis of failures.</span></span> <span data-ttu-id="41c8a-143">Azure Monitor s’intègre à AKS pour collecter des métriques à partir des contrôleurs, nœuds et conteneurs ainsi que des journaux de conteneurs et des journaux des nœuds principaux.</span><span class="sxs-lookup"><span data-stu-id="41c8a-143">Azure Monitor integrates with AKS to collect metrics from controllers, nodes, and containers, as well as container logs and master node logs.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="41c8a-144">Remarques relatives à la conception</span><span class="sxs-lookup"><span data-stu-id="41c8a-144">Design considerations</span></span>

<span data-ttu-id="41c8a-145">Cette architecture de référence se concentre sur les architectures de microservices, bien que la plupart des pratiques recommandées concernent d’autres charges de travail s’exécutant sur AKS.</span><span class="sxs-lookup"><span data-stu-id="41c8a-145">This reference architecture is focused on microservices architectures, although many of the recommended practices will apply to other workloads running on AKS.</span></span>

### <a name="microservices"></a><span data-ttu-id="41c8a-146">Microservices</span><span class="sxs-lookup"><span data-stu-id="41c8a-146">Microservices</span></span>

<span data-ttu-id="41c8a-147">L’objet Service Kubernetes est une façon naturelle de modéliser les microservices dans Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-147">The Kubernetes Service object is a natural way to model microservices in Kubernetes.</span></span> <span data-ttu-id="41c8a-148">Un microservice est une unité faiblement couplée, pouvant être déployée indépendamment du code.</span><span class="sxs-lookup"><span data-stu-id="41c8a-148">A microservice is a loosely coupled, independently deployable unit of code.</span></span> <span data-ttu-id="41c8a-149">Communiquant généralement par le biais d’API bien définies, les microservices peuvent être détectés par le biais d’une découverte de services.</span><span class="sxs-lookup"><span data-stu-id="41c8a-149">Microservices typically communicate through well-defined APIs, and are discoverable through some form of service discovery.</span></span> <span data-ttu-id="41c8a-150">L’objet Service Kubernetes fournit un ensemble de fonctionnalités qui répondent à ces exigences :</span><span class="sxs-lookup"><span data-stu-id="41c8a-150">The Kubernetes Service object provides a set of capabilities that match these requirements:</span></span>

- <span data-ttu-id="41c8a-151">Adresse IP.</span><span class="sxs-lookup"><span data-stu-id="41c8a-151">IP address.</span></span> <span data-ttu-id="41c8a-152">L’objet Service fournit une adresse IP interne statique pour un groupe de pods (ReplicaSet).</span><span class="sxs-lookup"><span data-stu-id="41c8a-152">The Service object provides a static internal IP address for a group of pods (ReplicaSet).</span></span> <span data-ttu-id="41c8a-153">Quand des pods sont créés ou déplacés, le service est toujours accessible à cette adresse IP interne.</span><span class="sxs-lookup"><span data-stu-id="41c8a-153">As pods are created or moved around, the service is always reachable at this internal IP address.</span></span>

- <span data-ttu-id="41c8a-154">Équilibrage de charge :</span><span class="sxs-lookup"><span data-stu-id="41c8a-154">Load balancing.</span></span> <span data-ttu-id="41c8a-155">Le trafic envoyé à l’adresse IP du service fait l’objet d’un équilibrage de charge sur les pods.</span><span class="sxs-lookup"><span data-stu-id="41c8a-155">Traffic sent to the service's IP address is load balanced to the pods.</span></span> 

- <span data-ttu-id="41c8a-156">Découverte des services.</span><span class="sxs-lookup"><span data-stu-id="41c8a-156">Service discovery.</span></span> <span data-ttu-id="41c8a-157">Les services se voient assigner des entrées DNS internes par le service DNS Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-157">Services are assigned internal DNS entries by the Kubernetes DNS service.</span></span> <span data-ttu-id="41c8a-158">Cela signifie que la passerelle API peut appeler un service back-end en utilisant le nom DNS.</span><span class="sxs-lookup"><span data-stu-id="41c8a-158">That means the API gateway can call a backend service using the DNS name.</span></span> <span data-ttu-id="41c8a-159">Le même mécanisme peut être utilisé pour la communication de service à service.</span><span class="sxs-lookup"><span data-stu-id="41c8a-159">The same mechanism can be used for service-to-service communication.</span></span> <span data-ttu-id="41c8a-160">Les entrées DNS étant organisées par espace de noms, si vos espaces de noms correspondent à des contextes délimités, le nom DNS pour un service est naturellement mappé au domaine d’application.</span><span class="sxs-lookup"><span data-stu-id="41c8a-160">The DNS entries are organized by namespace, so if your namespaces correspond to bounded contexts, then the DNS name for a service will map naturally to the application domain.</span></span>

<span data-ttu-id="41c8a-161">Le diagramme suivant montre la relation conceptuelle entre les services et les pods.</span><span class="sxs-lookup"><span data-stu-id="41c8a-161">The following diagram show the conceptual relation between services and pods.</span></span> <span data-ttu-id="41c8a-162">Le mappage réel aux ports et adresses IP de point de terminaison est effectué par kube-proxy, proxy de réseau Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-162">The actual mapping to endpoint IP addresses and ports is done by kube-proxy, the Kubernetes network proxy.</span></span>

![Services et pods](./_images/aks-services.png)

### <a name="api-gateway"></a><span data-ttu-id="41c8a-164">API Gateway</span><span class="sxs-lookup"><span data-stu-id="41c8a-164">API Gateway</span></span>

<span data-ttu-id="41c8a-165">Une *passerelle API* est une passerelle qui se trouve entre les clients externes et les microservices.</span><span class="sxs-lookup"><span data-stu-id="41c8a-165">An *API gateway* is a gateway that sits between external clients and the microservices.</span></span> <span data-ttu-id="41c8a-166">Elle fait office de proxy inverse, acheminant les demandes des clients vers les microservices.</span><span class="sxs-lookup"><span data-stu-id="41c8a-166">It acts as a reverse proxy, routing requests from clients to microservices.</span></span> <span data-ttu-id="41c8a-167">Elle peut également effectuer diverses tâches transversales telles que l’authentification, l’arrêt SSL et la limitation du débit.</span><span class="sxs-lookup"><span data-stu-id="41c8a-167">It may also perform various cross-cutting tasks such as authentication, SSL termination, and rate limiting.</span></span> 

<span data-ttu-id="41c8a-168">Les fonctionnalités fournies par une passerelle peuvent être regroupées comme suit :</span><span class="sxs-lookup"><span data-stu-id="41c8a-168">Functionality provided by a gateway can be grouped as follows:</span></span>

- <span data-ttu-id="41c8a-169">[Routage de passerelle](../../patterns/gateway-routing.md) : routage des demandes clientes vers les services back-end appropriés.</span><span class="sxs-lookup"><span data-stu-id="41c8a-169">[Gateway Routing](../../patterns/gateway-routing.md): Routing client requests to the right backend services.</span></span> <span data-ttu-id="41c8a-170">Ce processus fournit un point de terminaison unique pour les clients et permet de découpler ces derniers des services.</span><span class="sxs-lookup"><span data-stu-id="41c8a-170">This provides a single endpoint for clients, and helps to decouple clients from services.</span></span>

- <span data-ttu-id="41c8a-171">[Agrégation de passerelle](../../patterns/gateway-aggregation.md) : agrégation de plusieurs demandes en une seule, pour réduire les échanges excessifs entre le client et le back-end.</span><span class="sxs-lookup"><span data-stu-id="41c8a-171">[Gateway Aggregation](../../patterns/gateway-aggregation.md): Aggregation of multiple requests into a single request, to reduce chattiness between the client and the backend.</span></span>

- <span data-ttu-id="41c8a-172">[Déchargement de passerelle](../../patterns/gateway-offloading.md) :</span><span class="sxs-lookup"><span data-stu-id="41c8a-172">[Gateway Offloading](../../patterns/gateway-offloading.md).</span></span> <span data-ttu-id="41c8a-173">Une passerelle peut décharger des fonctionnalités à partir des services back-end, telles que la terminaison SSL, l’authentification, la mise en liste verte d’adresses IP ou la limitation du débit client.</span><span class="sxs-lookup"><span data-stu-id="41c8a-173">A gateway can offload functionality from the backend services, such as SSL termination, authentication, IP whitelisting, or client rate limiting (throttling).</span></span>

<span data-ttu-id="41c8a-174">Les passerelles API sont un [modèle de conception de microservices](https://microservices.io/patterns/apigateway.html) général.</span><span class="sxs-lookup"><span data-stu-id="41c8a-174">API gateways are a general [microservices design pattern](https://microservices.io/patterns/apigateway.html).</span></span> <span data-ttu-id="41c8a-175">Elles peuvent être implémentées à l’aide de nombreuses technologies.</span><span class="sxs-lookup"><span data-stu-id="41c8a-175">They can be implemented using a number of different technologies.</span></span> <span data-ttu-id="41c8a-176">L’implémentation la plus courante consiste probablement à déployer un routeur de périphérie ou proxy inverse, tel que Nginx, HAProxy ou Traefik, à l’intérieur du cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-176">Probably the most common implementation is to deploy an edge router or reverse proxy, such as Nginx, HAProxy, or Traefik, inside the cluster.</span></span> 

<span data-ttu-id="41c8a-177">Autres options disponibles :</span><span class="sxs-lookup"><span data-stu-id="41c8a-177">Other options include:</span></span>

- <span data-ttu-id="41c8a-178">Azure Application Gateway et/ou Gestion des API Azure, deux services managés résidant hors du cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-178">Azure Application Gateway and/or Azure API-Management, which are both managed services that reside outside of the cluster.</span></span> <span data-ttu-id="41c8a-179">Un contrôleur d’entrée Application Gateway est en version bêta.</span><span class="sxs-lookup"><span data-stu-id="41c8a-179">An Application Gateway Ingress Controller is currently in beta.</span></span>

- <span data-ttu-id="41c8a-180">Azure Functions Proxies.</span><span class="sxs-lookup"><span data-stu-id="41c8a-180">Azure Functions Proxies.</span></span> <span data-ttu-id="41c8a-181">Les proxys peuvent modifier les demandes et réponses et acheminer les demandes en fonction de l’URL.</span><span class="sxs-lookup"><span data-stu-id="41c8a-181">Proxies can modify requests and responses and route requests based on URL.</span></span>

<span data-ttu-id="41c8a-182">Le type de ressource **Entrée** Kubernetes abstrait les paramètres de configuration d’un serveur proxy.</span><span class="sxs-lookup"><span data-stu-id="41c8a-182">The Kubernetes **Ingress** resource type abstracts the configuration settings for a proxy server.</span></span> <span data-ttu-id="41c8a-183">Il fonctionne conjointement avec un contrôleur d’entrée, qui fournit l’implémentation sous-jacente de l’entrée.</span><span class="sxs-lookup"><span data-stu-id="41c8a-183">It works in conjunction with an ingress controller, which provides the underlying implementation of the Ingress.</span></span> <span data-ttu-id="41c8a-184">Il existe des contrôleurs d’entrée pour Nginx, HAProxy, Traefik et Application Gateway (préversion), entre autres.</span><span class="sxs-lookup"><span data-stu-id="41c8a-184">There are ingress controllers for Nginx, HAProxy, Traefik, and Application Gateway (preview), among others.</span></span>

<span data-ttu-id="41c8a-185">Le contrôleur d’entrée gère la configuration des serveurs proxy.</span><span class="sxs-lookup"><span data-stu-id="41c8a-185">The ingress controller handles configuring the proxy server.</span></span> <span data-ttu-id="41c8a-186">Ceux-ci nécessitant souvent des fichiers de configuration complexes dont le paramétrage peut s’avérer difficiles pour un non-expert, le contrôleur d’entrée constitue une abstraction intéressante.</span><span class="sxs-lookup"><span data-stu-id="41c8a-186">Often these require complex configuration files, which can be hard to tune if you aren't an expert, so the ingress controller is a nice abstraction.</span></span> <span data-ttu-id="41c8a-187">En outre, le contrôleur d’entrée a accès à l’API Kubernetes, ce qui lui permet de prendre des décisions intelligentes sur le routage et l’équilibrage de charge.</span><span class="sxs-lookup"><span data-stu-id="41c8a-187">In addition, the Ingress Controller has access to the Kubernetes API, so it can make intelligent decisions about routing and load balancing.</span></span> <span data-ttu-id="41c8a-188">Par exemple, le contrôleur d’entrée Nginx contourne le proxy réseau kube-proxy.</span><span class="sxs-lookup"><span data-stu-id="41c8a-188">For example, the Nginx ingress controller bypasses the kube-proxy network proxy.</span></span>

<span data-ttu-id="41c8a-189">En revanche, si vous avez besoin de contrôler totalement les paramètres, vous pouvez passer outre cette abstraction et configurer le serveur proxy manuellement.</span><span class="sxs-lookup"><span data-stu-id="41c8a-189">On the other hand, if you need complete control over the settings, you may want to bypass this abstraction and configure the proxy server manually.</span></span> 

<span data-ttu-id="41c8a-190">Un serveur proxy inverse est un point de défaillance unique ou un goulot d’étranglement potentiel. Déployez donc toujours au moins deux réplicas pour une haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="41c8a-190">A reverse proxy server is a potential bottleneck or single point of failure, so always deploy at least two replicas for high availability.</span></span>

### <a name="data-storage"></a><span data-ttu-id="41c8a-191">Stockage des données</span><span class="sxs-lookup"><span data-stu-id="41c8a-191">Data storage</span></span>

<span data-ttu-id="41c8a-192">Dans une architecture de microservices, les services ne doivent pas partager le stockage de données.</span><span class="sxs-lookup"><span data-stu-id="41c8a-192">In a microservices architecture, services should not share data storage.</span></span> <span data-ttu-id="41c8a-193">Chaque service doit conserver ses propres données privées dans un stockage logique distinct, afin d’éviter des dépendances masquées entre services.</span><span class="sxs-lookup"><span data-stu-id="41c8a-193">Each service should own its own private data in a separate logical storage, to avoid hidden dependencies among services.</span></span> <span data-ttu-id="41c8a-194">En effet, il convient d’éviter tout couplage non intentionnel entre les services, problème qui peut se produire dans les cas de figure où les services partagent des schémas de données sous-jacents.</span><span class="sxs-lookup"><span data-stu-id="41c8a-194">The reason is to avoid unintentional coupling between services, which can happen when services share the same underlying data schemas.</span></span> <span data-ttu-id="41c8a-195">En outre, quand les services gèrent leurs propres magasins de données, ils peuvent utiliser le magasin de données adapté à leurs besoins.</span><span class="sxs-lookup"><span data-stu-id="41c8a-195">Also, when services manage their own data stores, they can use the right data store for their particular requirements.</span></span> <span data-ttu-id="41c8a-196">Pour plus d’informations, consultez [Conception des microservices : Considérations relatives aux données](/azure/architecture/microservices/data-considerations).</span><span class="sxs-lookup"><span data-stu-id="41c8a-196">For more information, see [Designing microservices: Data considerations](/azure/architecture/microservices/data-considerations).</span></span>

<span data-ttu-id="41c8a-197">Évitez de stocker des données persistantes dans l’espace de stockage en cluster local, car celui-ci lie les données au nœud.</span><span class="sxs-lookup"><span data-stu-id="41c8a-197">Avoid storing persistent data in local cluster storage, because that ties the data to the node.</span></span> <span data-ttu-id="41c8a-198">Au lieu de cela :</span><span class="sxs-lookup"><span data-stu-id="41c8a-198">Instead,</span></span> 

- <span data-ttu-id="41c8a-199">Utilisez un service externe tel qu’Azure SQL Database ou Cosmos DB, *ou*</span><span class="sxs-lookup"><span data-stu-id="41c8a-199">Use an external service such as Azure SQL Database or Cosmos DB, *or*</span></span>

- <span data-ttu-id="41c8a-200">Montez un volume persistant à l’aide d’Azure Disks ou d’Azure Files.</span><span class="sxs-lookup"><span data-stu-id="41c8a-200">Mount a persistent volume using Azure Disks or Azure Files.</span></span> <span data-ttu-id="41c8a-201">Utiliser Azure Files si le même volume doit être partagé par plusieurs pods.</span><span class="sxs-lookup"><span data-stu-id="41c8a-201">Use Azure Files if the same volume needs to be shared by multiple pods.</span></span>

### <a name="namespaces"></a><span data-ttu-id="41c8a-202">Espaces de noms</span><span class="sxs-lookup"><span data-stu-id="41c8a-202">Namespaces</span></span>

<span data-ttu-id="41c8a-203">Utilisez des espaces de noms pour organiser les services au sein du cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-203">Use namespaces to organize services within the cluster.</span></span> <span data-ttu-id="41c8a-204">Chaque objet dans un cluster Kubernetes appartient à un espace de noms.</span><span class="sxs-lookup"><span data-stu-id="41c8a-204">Every object in a Kubernetes cluster belongs to a namespace.</span></span> <span data-ttu-id="41c8a-205">Par défaut, quand vous créez un objet, il est placé dans l’espace de noms `default`.</span><span class="sxs-lookup"><span data-stu-id="41c8a-205">By default, when you create a new object, it goes into the `default` namespace.</span></span> <span data-ttu-id="41c8a-206">Nous vous conseillons toutefois de créer des espaces de noms plus descriptifs afin d’organiser aisément les ressources dans le cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-206">But it's a good practice to create namespaces that are more descriptive to help organize the resources in the cluster.</span></span>

<span data-ttu-id="41c8a-207">Tout d’abord, les espaces de noms vous aident à empêcher les collisions de noms.</span><span class="sxs-lookup"><span data-stu-id="41c8a-207">First, namespaces help prevent naming collisions.</span></span> <span data-ttu-id="41c8a-208">Quand plusieurs équipes déploient des microservices sur le même cluster, opération pouvant impliquer des centaines de microservices, il devient difficile de savoir s’ils peuvent tous être placés dans le même espace de noms.</span><span class="sxs-lookup"><span data-stu-id="41c8a-208">When multiple teams deploy microservices into the same cluster, with possibly hundreds of microservices, it gets hard to manage if they all go into the same namespace.</span></span> <span data-ttu-id="41c8a-209">En outre, les espaces de noms vous permettent d’effectuer les opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="41c8a-209">In addition, namespaces allow you to:</span></span>

- <span data-ttu-id="41c8a-210">Appliquer des contraintes de ressources à un espace de noms, afin que l’ensemble total de pods assignés à cet espace de noms ne dépasse pas le quota de ressources de l’espace de noms</span><span class="sxs-lookup"><span data-stu-id="41c8a-210">Apply resource constraints to a namespace, so that the total set of pods assigned to that namespace cannot exceed the resource quota of the namespace.</span></span>

- <span data-ttu-id="41c8a-211">Appliquer des stratégies au niveau de l’espace de noms, notamment des stratégies RBAC et de sécurité</span><span class="sxs-lookup"><span data-stu-id="41c8a-211">Apply policies at the namespace level, including RBAC and security policies.</span></span>

<span data-ttu-id="41c8a-212">Pour une architecture de microservices, envisagez d’organiser les microservices en contextes délimités et de créer des espaces de noms pour chaque contexte délimité.</span><span class="sxs-lookup"><span data-stu-id="41c8a-212">For a microservices architecture, considering organizing the microservices into bounded contexts, and creating namespaces for each bounded context.</span></span> <span data-ttu-id="41c8a-213">Par exemple, tous les microservices liés au contexte délimité « Traitement des commandes » peuvent être placés dans le même espace de noms.</span><span class="sxs-lookup"><span data-stu-id="41c8a-213">For example, all microservices related to the "Order Fulfillment" bounded context could go into the same namespace.</span></span> <span data-ttu-id="41c8a-214">Vous pouvez également créer un espace de noms pour chaque équipe de développement.</span><span class="sxs-lookup"><span data-stu-id="41c8a-214">Alternatively, create a namespace for each development team.</span></span>

<span data-ttu-id="41c8a-215">Placez les services d’utilitaire dans leur propre espace de noms.</span><span class="sxs-lookup"><span data-stu-id="41c8a-215">Place utility services into their own separate namespace.</span></span> <span data-ttu-id="41c8a-216">Par exemple, vous pouvez déployer Elasticsearch ou Prometheus pour la supervision des clusters ou Tiller pour Helm.</span><span class="sxs-lookup"><span data-stu-id="41c8a-216">For example, you might deploy Elasticsearch or Prometheus for cluster monitoring, or Tiller for Helm.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="41c8a-217">Considérations relatives à l’extensibilité</span><span class="sxs-lookup"><span data-stu-id="41c8a-217">Scalability considerations</span></span>

<span data-ttu-id="41c8a-218">Kubernetes prend en charge un scale-out à deux niveaux :</span><span class="sxs-lookup"><span data-stu-id="41c8a-218">Kubernetes supports scale-out at two levels:</span></span>

- <span data-ttu-id="41c8a-219">Mise à l’échelle du nombre de pods alloués à un déploiement.</span><span class="sxs-lookup"><span data-stu-id="41c8a-219">Scale the number of pods allocated to a deployment.</span></span>
- <span data-ttu-id="41c8a-220">Mise à l’échelle des nœuds du cluster, pour augmenter les ressources de calcul totales disponibles pour le cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-220">Scale the nodes in the cluster, to increase the total compute resources available to the cluster.</span></span>

<span data-ttu-id="41c8a-221">Bien que vous puissiez effectuer un scale-out des pods et des nœuds manuellement, nous vous recommandons d’utiliser la mise à l’échelle automatique pour réduire les risques que les services manquent de ressources sous une charge élevée.</span><span class="sxs-lookup"><span data-stu-id="41c8a-221">Although you can scale out pods and nodes manually, we recommend using autoscaling, to minimize the chance that services will become resource starved under high load.</span></span> <span data-ttu-id="41c8a-222">Une stratégie de mise à l’échelle automatique doit tenir compte à la fois des pods et des nœuds.</span><span class="sxs-lookup"><span data-stu-id="41c8a-222">An autoscaling strategy must take both pods and nodes into account.</span></span> <span data-ttu-id="41c8a-223">Si vous effectuez simplement un scale-out des pods, vous allez finir par atteindre les limites de ressources des nœuds.</span><span class="sxs-lookup"><span data-stu-id="41c8a-223">If you just scale out the pods, eventually you will reach the resource limits of the nodes.</span></span> 

### <a name="pod-autoscaling"></a><span data-ttu-id="41c8a-224">Mise à l’échelle automatique des pods</span><span class="sxs-lookup"><span data-stu-id="41c8a-224">Pod autoscaling</span></span>

<span data-ttu-id="41c8a-225">L’autoscaler de pods élastique met à l’échelle les pods en fonction des métriques d’UC, de mémoire ou personnalisées observées.</span><span class="sxs-lookup"><span data-stu-id="41c8a-225">The Horizontal Pod Autoscaler (HPA) scales pods based on observed CPU, memory, or custom metrics.</span></span> <span data-ttu-id="41c8a-226">Pour configurer la mise à l’échelle élastique des pods, vous spécifiez une métrique cible (par exemple, 70 % de l’UC) et les nombres minimal et maximal de réplicas.</span><span class="sxs-lookup"><span data-stu-id="41c8a-226">To configure horizontal pod scaling, you specify a target metric (for example, 70% of CPU), and the minimum and maximum number of replicas.</span></span> <span data-ttu-id="41c8a-227">Vous devez effectuer un test de charge de vos services pour dériver ces nombres.</span><span class="sxs-lookup"><span data-stu-id="41c8a-227">You should load test your services to derive these numbers.</span></span>

<span data-ttu-id="41c8a-228">Un effet secondaire de la mise à l’échelle automatique est que les pods peuvent être créés ou supprimés plus fréquemment, à mesure que se produisent les événements de scale-out et de scale-in.</span><span class="sxs-lookup"><span data-stu-id="41c8a-228">A side-effect of autoscaling is that pods may be created or evicted more frequently, as scale-out and scale-in events happen.</span></span> <span data-ttu-id="41c8a-229">Pour en atténuer les effets :</span><span class="sxs-lookup"><span data-stu-id="41c8a-229">To mitigate the effects of this:</span></span>

- <span data-ttu-id="41c8a-230">Utilisez des probes readiness pour que Kubernetes sache quand un nouveau pod est prêt à accepter du trafic.</span><span class="sxs-lookup"><span data-stu-id="41c8a-230">Use readiness probes to let Kubernetes know when a new pod is ready to accept traffic.</span></span>
- <span data-ttu-id="41c8a-231">Utilisez des budgets d’interruption de pod pour limiter le nombre de pods pouvant être supprimés d’un service simultanément.</span><span class="sxs-lookup"><span data-stu-id="41c8a-231">Use pod disruption budgets to limit how many pods can be evicted from a service at a time.</span></span>

### <a name="cluster-autoscaling"></a><span data-ttu-id="41c8a-232">Mise à l’échelle automatique du cluster</span><span class="sxs-lookup"><span data-stu-id="41c8a-232">Cluster autoscaling</span></span>

<span data-ttu-id="41c8a-233">L’autoscaler de cluster met à l’échelle le nombre de nœuds.</span><span class="sxs-lookup"><span data-stu-id="41c8a-233">The cluster autoscaler scales the number of nodes.</span></span> <span data-ttu-id="41c8a-234">Si des contraintes de ressources empêchent la planification de pods, l’autoscaler de cluster provisionne davantage de nœuds.</span><span class="sxs-lookup"><span data-stu-id="41c8a-234">If pods can't be scheduled because of resource constraints, the cluster autoscaler will provision more nodes.</span></span>  <span data-ttu-id="41c8a-235">(Remarque : L’intégration entre AKS et l’autoscaler de cluster est en préversion.)</span><span class="sxs-lookup"><span data-stu-id="41c8a-235">(Note: Integration between AKS and the cluster autoscaler is currently in preview.)</span></span>

<span data-ttu-id="41c8a-236">Tandis que l’autoscaler de pods élastique examine les ressources réelles consommées ou d’autres métriques à partir des pods en cours d’exécution, l’autoscaler de cluster provisionne les nœuds pour les pods qui ne sont pas encore planifiés.</span><span class="sxs-lookup"><span data-stu-id="41c8a-236">Whereas HPA looks at actual resources consumed or other metrics from running pods, the cluster autoscaler is provisioning nodes for pods that aren't scheduled yet.</span></span> <span data-ttu-id="41c8a-237">Ainsi, il examine les ressources demandées, comme indiqué dans la spécification des pods Kubernetes pour un déploiement.</span><span class="sxs-lookup"><span data-stu-id="41c8a-237">Therefore, it looks at the requested resources, as specified in the Kubernetes pod spec for a deployment.</span></span> <span data-ttu-id="41c8a-238">Pour ajuster ces valeurs, utilisez un test de charge.</span><span class="sxs-lookup"><span data-stu-id="41c8a-238">Use load testing to fine-tune these values.</span></span>

<span data-ttu-id="41c8a-239">Comme vous ne pouvez pas changer la taille des machines virtuelles une fois que vous avez créé le cluster, vous devez commencer par planifier la capacité afin de choisir une taille de machine virtuelle appropriée pour les nœuds d’agent quand vous créez le cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-239">You can't change the VM size after you create the cluster, so you should do some initial capacity planning to choose an appropriate VM size for the agent nodes when you create the cluster.</span></span> 

## <a name="availability-considerations"></a><span data-ttu-id="41c8a-240">Considérations relatives à la disponibilité</span><span class="sxs-lookup"><span data-stu-id="41c8a-240">Availability considerations</span></span>

### <a name="health-probes"></a><span data-ttu-id="41c8a-241">Sondes d’intégrité</span><span class="sxs-lookup"><span data-stu-id="41c8a-241">Health probes</span></span>

<span data-ttu-id="41c8a-242">Kubernetes définit deux types de probe d’intégrité qu’un pod peut exposer :</span><span class="sxs-lookup"><span data-stu-id="41c8a-242">Kubernetes defines two types of health probe that a pod can expose:</span></span>

- <span data-ttu-id="41c8a-243">Probe readiness : indique à Kubernetes si le pod est prêt à accepter des demandes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-243">Readiness probe: Tells Kubernetes whether the pod is ready to accept requests.</span></span>

- <span data-ttu-id="41c8a-244">Probe liveness : indique à Kubernetes si un pod doit être supprimé et une nouvelle instance démarrée.</span><span class="sxs-lookup"><span data-stu-id="41c8a-244">Liveness probe: Tells Kubernetes whether a pod should be removed and a new instance started.</span></span>

<span data-ttu-id="41c8a-245">Quand vous vous penchez sur les probes, pensez à la façon dont fonctionne un service dans Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-245">When thinking about probes, it's useful to recall how a service works in Kubernetes.</span></span> <span data-ttu-id="41c8a-246">Un service a un sélecteur d’étiquette qui correspond à un ensemble de pods (zéro ou plus).</span><span class="sxs-lookup"><span data-stu-id="41c8a-246">A service has a label selector that matches a set of (zero or more) pods.</span></span> <span data-ttu-id="41c8a-247">Kubernetes équilibre la charge du trafic vers les pods qui correspondent au sélecteur.</span><span class="sxs-lookup"><span data-stu-id="41c8a-247">Kubernetes load balances traffic to the pods that match the selector.</span></span> <span data-ttu-id="41c8a-248">Seuls les pods qui ont correctement démarré et qui sont sains reçoivent du trafic.</span><span class="sxs-lookup"><span data-stu-id="41c8a-248">Only pods that started successfully and are healthy receive traffic.</span></span> <span data-ttu-id="41c8a-249">Si un conteneur plante, Kubernetes supprime le pod et planifie un remplacement.</span><span class="sxs-lookup"><span data-stu-id="41c8a-249">If a container crashes, Kubernetes kills the pod and schedules a replacement.</span></span>

<span data-ttu-id="41c8a-250">Il peut arriver qu’un pod ne soit pas prêt à recevoir du trafic, même s’il a démarré correctement.</span><span class="sxs-lookup"><span data-stu-id="41c8a-250">Sometimes, a pod may not be ready to receive traffic, even though the pod started successfully.</span></span> <span data-ttu-id="41c8a-251">Ce peut être le cas à l’occasion de tâches d’initialisation pendant lesquelles l’application en cours d’exécution dans le conteneur charge des éléments en mémoire ou lit des données de configuration.</span><span class="sxs-lookup"><span data-stu-id="41c8a-251">For example, there may be initialization tasks, where the application running in the container loads things into memory or reads configuration data.</span></span> <span data-ttu-id="41c8a-252">Pour indiquer qu’un pod est sain mais qu’il n’est pas prêt à recevoir du trafic, définissez une probe readiness.</span><span class="sxs-lookup"><span data-stu-id="41c8a-252">To indicate that a pod is healthy but not ready to receive traffic, define a readiness probe.</span></span> 

<span data-ttu-id="41c8a-253">Les probes liveness traitent le cas où un pod, bien qu’en cours d’exécution, doit être recyclé, car il n’est pas sain.</span><span class="sxs-lookup"><span data-stu-id="41c8a-253">Liveness probes handle the case where a pod is still running, but is unhealthy and should be recycled.</span></span> <span data-ttu-id="41c8a-254">Par exemple, supposons qu’un conteneur sert des requêtes HTTP, mais se bloque pour une raison quelconque.</span><span class="sxs-lookup"><span data-stu-id="41c8a-254">For example, suppose that a container is serving HTTP requests but hangs for some reason.</span></span> <span data-ttu-id="41c8a-255">Le conteneur ne plante pas, mais il a arrêté de servir les requêtes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-255">The container doesn't crash, but it has stopped serving any requests.</span></span> <span data-ttu-id="41c8a-256">Si vous définissez une probe liveness HTTP, celle-ci ne répond plus et indique à Kubernetes de redémarrer le pod.</span><span class="sxs-lookup"><span data-stu-id="41c8a-256">If you define an HTTP liveness probe, the probe will stop responding and that informs Kubernetes to restart the pod.</span></span>

<span data-ttu-id="41c8a-257">Voici quelques considérations liées à la conception des probes :</span><span class="sxs-lookup"><span data-stu-id="41c8a-257">Here are some considerations when designing probes:</span></span>

- <span data-ttu-id="41c8a-258">Si votre code met du temps à démarrer, il existe un risque que la probe liveness signale un échec avant la fin du démarrage.</span><span class="sxs-lookup"><span data-stu-id="41c8a-258">If your code has a long startup time, there is a danger that a liveness probe will report failure before the startup completes.</span></span> <span data-ttu-id="41c8a-259">Pour éviter cette situation, utilisez le paramètre initialDelaySeconds, qui retarde le démarrage de la probe.</span><span class="sxs-lookup"><span data-stu-id="41c8a-259">To prevent this, use the initialDelaySeconds setting, which delays the probe from starting.</span></span>

- <span data-ttu-id="41c8a-260">Une probe liveness n’est utile que si le redémarrage du pod est susceptible de restaurer celui-ci dans un état sain.</span><span class="sxs-lookup"><span data-stu-id="41c8a-260">A liveness probe doesn't help unless restarting the pod is likely to restore it to a healthy state.</span></span> <span data-ttu-id="41c8a-261">Vous pouvez utiliser une probe liveness pour éviter les fuites de mémoire ou les blocages inattendus, mais il est inutile de redémarrer un pod susceptible de rééchouer immédiatement.</span><span class="sxs-lookup"><span data-stu-id="41c8a-261">You can use a liveness probe to mitigate against memory leaks or unexpected deadlocks, but there's no point in restarting a pod that's going to immediately fail again.</span></span>

- <span data-ttu-id="41c8a-262">Parfois, les probes readiness peuvent servir à vérifier les services dépendants.</span><span class="sxs-lookup"><span data-stu-id="41c8a-262">Sometimes readiness probes are used to check dependent services.</span></span> <span data-ttu-id="41c8a-263">Par exemple, si un pod a une dépendance sur une base de données, la probe liveness peut vérifier la connexion de base de données.</span><span class="sxs-lookup"><span data-stu-id="41c8a-263">For example, if a pod has a dependency on a database, the liveness probe might check the database connection.</span></span> <span data-ttu-id="41c8a-264">Toutefois, cette approche peut engendrer des problèmes inattendus.</span><span class="sxs-lookup"><span data-stu-id="41c8a-264">However, this approach can create unexpected problems.</span></span> <span data-ttu-id="41c8a-265">Un service externe peut être temporairement indisponible pour une raison quelconque.</span><span class="sxs-lookup"><span data-stu-id="41c8a-265">An external service might be temporarily unavailable for some reason.</span></span> <span data-ttu-id="41c8a-266">Cette situation entraîne l’échec de la probe readiness pour tous les pods dans votre service, puis la suppression de ces derniers de l’équilibrage de charge, suivie de défaillances en cascade en amont.</span><span class="sxs-lookup"><span data-stu-id="41c8a-266">That will cause the readiness probe to fail for all the pods in your service, causing all of them to be removed from load balancing, and thus creating cascading failures upstream.</span></span> <span data-ttu-id="41c8a-267">Une meilleure approche consiste à implémenter la gestion de nouvelle tentative au sein de votre service, afin que celui-ci puisse récupérer correctement après des défaillances temporaires.</span><span class="sxs-lookup"><span data-stu-id="41c8a-267">A better approach is to implement retry handling within your service, so that your service can recover correctly from transient failures.</span></span>

### <a name="resource-constraints"></a><span data-ttu-id="41c8a-268">Contraintes de ressources</span><span class="sxs-lookup"><span data-stu-id="41c8a-268">Resource constraints</span></span>

<span data-ttu-id="41c8a-269">La contention de ressources peut affecter la disponibilité d’un service.</span><span class="sxs-lookup"><span data-stu-id="41c8a-269">Resource contention can affect the availability of a service.</span></span> <span data-ttu-id="41c8a-270">Définissez des contraintes de ressources pour les conteneurs, afin qu’un seul conteneur ne puisse pas surcharger les ressources de cluster (UC et mémoire).</span><span class="sxs-lookup"><span data-stu-id="41c8a-270">Define resource constraints for containers, so that a single container cannot overwhelm the cluster resources (memory and CPU).</span></span> <span data-ttu-id="41c8a-271">Pour les ressources non-conteneur, telles que les threads ou les connexions réseau, envisagez d’utiliser le [modèle de cloisonnement](/azure/architecture/patterns/bulkhead) pour les isoler.</span><span class="sxs-lookup"><span data-stu-id="41c8a-271">For non-container resources, such as threads or network connections, consider using the [Bulkhead Pattern](/azure/architecture/patterns/bulkhead) to isolate resources.</span></span>

<span data-ttu-id="41c8a-272">Utilisez des quotas de ressources afin de limiter les ressources totales autorisées pour un espace de noms.</span><span class="sxs-lookup"><span data-stu-id="41c8a-272">Use resource quotas to limit the total resources allowed for a namespace.</span></span> <span data-ttu-id="41c8a-273">De cette façon, le front-end ne peut pas priver les services back-end de ressources ou vice versa.</span><span class="sxs-lookup"><span data-stu-id="41c8a-273">That way, the front end can't starve the backend services for resources or vice-versa.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="41c8a-274">Considérations relatives à la sécurité</span><span class="sxs-lookup"><span data-stu-id="41c8a-274">Security considerations</span></span>

### <a name="role-based-access-control-rbac"></a><span data-ttu-id="41c8a-275">Contrôle d’accès en fonction du rôle (RBAC)</span><span class="sxs-lookup"><span data-stu-id="41c8a-275">Role based access control (RBAC)</span></span>

<span data-ttu-id="41c8a-276">Kubernetes et Azure disposent de mécanismes de contrôle d’accès en fonction du rôle (RBAC) :</span><span class="sxs-lookup"><span data-stu-id="41c8a-276">Kubernetes and Azure both have mechanisms for role-based access control (RBAC):</span></span>

- <span data-ttu-id="41c8a-277">RBAC Azure contrôle l’accès aux ressources dans Azure, y compris la possibilité de créer des ressources Azure.</span><span class="sxs-lookup"><span data-stu-id="41c8a-277">Azure RBAC controls access to resources in Azure, including the ability to create new Azure resources.</span></span> <span data-ttu-id="41c8a-278">Ces autorisations peuvent être assignées aux utilisateurs, groupes ou principaux de service.</span><span class="sxs-lookup"><span data-stu-id="41c8a-278">Permissions can be assigned to users, groups, or service principals.</span></span> <span data-ttu-id="41c8a-279">(Un principal de service est une identité de sécurité utilisée par les applications.)</span><span class="sxs-lookup"><span data-stu-id="41c8a-279">(A service principal is a security identity used by applications.)</span></span>

- <span data-ttu-id="41c8a-280">Kubernetes RBAC contrôle les autorisations sur l’API Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-280">Kubernetes RBAC controls permissions to the Kubernetes API.</span></span> <span data-ttu-id="41c8a-281">Par exemple, la création de pods et le listage de pods sont des actions qui peuvent être accordées (ou refusées) à un utilisateur au moyen de RBAC.</span><span class="sxs-lookup"><span data-stu-id="41c8a-281">For example, creating pods and listing pods are actions that can be authorized (or denied) to a user through RBAC.</span></span> <span data-ttu-id="41c8a-282">Pour assigner des autorisations Kubernetes à des utilisateurs, vous créez des *rôles* et des *liaisons de rôle* :</span><span class="sxs-lookup"><span data-stu-id="41c8a-282">To assign Kubernetes permissions to users, you create *roles* and *role bindings*:</span></span>

  - <span data-ttu-id="41c8a-283">Un rôle est un jeu d’autorisations qui s’appliquent au sein d’un espace de noms.</span><span class="sxs-lookup"><span data-stu-id="41c8a-283">A Role is a set of permissions that apply within a namespace.</span></span> <span data-ttu-id="41c8a-284">Les autorisations sont définies sous forme de verbes (obtenir, mettre à jour, créer, supprimer) appliqués à des ressources (pods, déploiements, etc.).</span><span class="sxs-lookup"><span data-stu-id="41c8a-284">Permissions are defined as verbs (get, update, create, delete) on resources (pods, deployments, etc.).</span></span>

  - <span data-ttu-id="41c8a-285">Une liaison de rôle (RoleBinding) assigne des utilisateurs ou groupes à un rôle.</span><span class="sxs-lookup"><span data-stu-id="41c8a-285">A RoleBinding assigns users or groups to a Role.</span></span>

  - <span data-ttu-id="41c8a-286">Il existe également un objet ClusterRole, qui est similaire à un rôle, mais s’applique à l’ensemble du cluster, sur tous les espaces de noms.</span><span class="sxs-lookup"><span data-stu-id="41c8a-286">There is also a ClusterRole object, which is like a Role but applies to the entire cluster, across all namespaces.</span></span> <span data-ttu-id="41c8a-287">Pour assigner des utilisateurs ou des groupes à un rôle de cluster (ClusterRole), créez une liaison de rôle de cluster (ClusterRoleBinding).</span><span class="sxs-lookup"><span data-stu-id="41c8a-287">To assign users or groups to a ClusterRole, create a ClusterRoleBinding.</span></span>

<span data-ttu-id="41c8a-288">AKS intègre ces deux mécanismes RBAC.</span><span class="sxs-lookup"><span data-stu-id="41c8a-288">AKS integrates these two RBAC mechanisms.</span></span> <span data-ttu-id="41c8a-289">Quand vous créez un cluster AKS, vous pouvez le configurer afin d’utiliser Azure AD pour l’authentification utilisateur.</span><span class="sxs-lookup"><span data-stu-id="41c8a-289">When you create an AKS cluster, you can configure it to use Azure AD for user authentication.</span></span> <span data-ttu-id="41c8a-290">Pour plus d’informations sur la façon d’effectuer cette configuration, consultez [Intégrer Azure Active Directory dans Azure Kubernetes Service](/azure/aks/aad-integration).</span><span class="sxs-lookup"><span data-stu-id="41c8a-290">For details on how to set this up, see [Integrate Azure Active Directory with Azure Kubernetes Service](/azure/aks/aad-integration).</span></span>

<span data-ttu-id="41c8a-291">Une fois cette configuration effectuée, un utilisateur qui souhaite accéder à l’API Kubernetes (par exemple, via kubectl) doit se connecter à l’aide de ses informations d’identification Azure AD.</span><span class="sxs-lookup"><span data-stu-id="41c8a-291">Once this is configured, a user who wants to access the Kubernetes API (for example, through kubectl) must sign in using their Azure AD credentials.</span></span>

<span data-ttu-id="41c8a-292">Par défaut, un utilisateur Azure AD n’a pas accès au cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-292">By default, an Azure AD user has no access to the cluster.</span></span> <span data-ttu-id="41c8a-293">Pour accorder l’accès, l’administrateur de cluster crée des liaisons de rôle qui font référence à des utilisateurs ou groupes Azure AD.</span><span class="sxs-lookup"><span data-stu-id="41c8a-293">To grant access, the cluster administrator creates RoleBindings that refer to Azure AD users or groups.</span></span> <span data-ttu-id="41c8a-294">Si un utilisateur ne dispose pas d’autorisations pour une opération particulière, celle-ci échoue.</span><span class="sxs-lookup"><span data-stu-id="41c8a-294">If a user doesn't have permissions for a particular operation, it will fail.</span></span>

<span data-ttu-id="41c8a-295">Si les utilisateurs n’ont par défaut aucun accès, comment l’administrateur de cluster peut-il créer les liaisons de rôle initialement ?</span><span class="sxs-lookup"><span data-stu-id="41c8a-295">If users have no access by default, how does the cluster admin have permission to create the role bindings in the first place?</span></span> <span data-ttu-id="41c8a-296">Un cluster AKS a en fait deux types d’informations d’identification pour appeler le serveur d’API Kubernetes : utilisateur de cluster et administrateur de cluster. Les informations d’identification d’administrateur de cluster accordent un accès complet au cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-296">An AKS cluster actually has two types of credentials for calling the Kubernetes API server: cluster user and cluster admin. The cluster admin credentials grant full access to the cluster.</span></span> <span data-ttu-id="41c8a-297">La commande Azure CLI `az aks get-credentials --admin` télécharge les informations d’identification d’administrateur de cluster et les enregistre dans votre fichier kubeconfig.</span><span class="sxs-lookup"><span data-stu-id="41c8a-297">The Azure CLI command `az aks get-credentials --admin` downloads the cluster admin credentials and saves them into your kubeconfig file.</span></span> <span data-ttu-id="41c8a-298">L’administrateur de cluster peut utiliser ce fichier kubeconfig pour créer des rôles et des liaisons de rôle.</span><span class="sxs-lookup"><span data-stu-id="41c8a-298">The cluster administrator can use this kubeconfig to create roles and role bindings.</span></span>

<span data-ttu-id="41c8a-299">Les informations d’identification d’administrateur de cluster étant particulièrement puissantes, utilisez RBAC Azure pour restreindre l’accès à ces dernières :</span><span class="sxs-lookup"><span data-stu-id="41c8a-299">Because the cluster admin credentials are so powerful, use Azure RBAC to restrict access to them:</span></span>

- <span data-ttu-id="41c8a-300">Le « Rôle administrateur de cluster du service Azure Kubernetes » est autorisé à télécharger les informations d’identification d’administrateur de cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-300">The "Azure Kubernetes Service Cluster Admin Role" has permission to download the cluster admin credentials.</span></span> <span data-ttu-id="41c8a-301">Seuls les administrateurs de cluster doivent être assignés à ce rôle.</span><span class="sxs-lookup"><span data-stu-id="41c8a-301">Only cluster administrators should be assigned to this role.</span></span>

- <span data-ttu-id="41c8a-302">Le « Rôle utilisateur de cluster du service Azure Kubernetes » est autorisé à télécharger les informations d’identification d’utilisateur de cluster.</span><span class="sxs-lookup"><span data-stu-id="41c8a-302">The "Azure Kubernetes Service Cluster User Role" has permission to download the cluster user credentials.</span></span> <span data-ttu-id="41c8a-303">Les utilisateurs non-administrateurs peuvent être assignés à ce rôle.</span><span class="sxs-lookup"><span data-stu-id="41c8a-303">Non-admin users can be assigned to this role.</span></span> <span data-ttu-id="41c8a-304">Ce rôle ne donne pas d’autorisations spécifiques sur les ressources Kubernetes à l’intérieur du cluster &mdash; il permet simplement à un utilisateur de se connecter au serveur d’API.</span><span class="sxs-lookup"><span data-stu-id="41c8a-304">This role does not give any particular permissions on Kubernetes resources inside the cluster &mdash; it just allows a user to connect to the API server.</span></span> 

<span data-ttu-id="41c8a-305">Quand vous définissez vos stratégies RBAC (Kubernetes et Azure), pensez aux rôles dans votre organisation :</span><span class="sxs-lookup"><span data-stu-id="41c8a-305">When you define your RBAC policies (both Kubernetes and Azure), think about the roles in your organization:</span></span>

- <span data-ttu-id="41c8a-306">Qui peut créer ou supprimer un cluster AKS et télécharger les informations d’identification d’administrateur ?</span><span class="sxs-lookup"><span data-stu-id="41c8a-306">Who can create or delete an AKS cluster and download the admin credentials?</span></span>
- <span data-ttu-id="41c8a-307">Qui peut administrer un cluster ?</span><span class="sxs-lookup"><span data-stu-id="41c8a-307">Who can administer a cluster?</span></span>
- <span data-ttu-id="41c8a-308">Qui peut créer ou mettre à jour des ressources au sein d’un espace de noms ?</span><span class="sxs-lookup"><span data-stu-id="41c8a-308">Who can create or update resources within a namespace?</span></span>

<span data-ttu-id="41c8a-309">Nous vous conseillons de définir les autorisations RBAC Kubernetes à l’échelle des espaces de noms, en utilisant des rôles et liaisons de rôle, plutôt que des rôles de cluster (ClusterRoles) et des liaisons de rôle de cluster (ClusterRoleBindings).</span><span class="sxs-lookup"><span data-stu-id="41c8a-309">It's a good practice to scope Kubernetes RBAC permissions by namespace, using Roles and RoleBindings, rather than ClusterRoles and ClusterRoleBindings.</span></span>

<span data-ttu-id="41c8a-310">Enfin, vous devez déterminer les autorisations dont dispose le cluster AKS pour créer et gérer des ressources Azure, telles que les équilibreurs de charge, le réseau ou le stockage.</span><span class="sxs-lookup"><span data-stu-id="41c8a-310">Finally, there is the question of what permissions the AKS cluster has to create and manage Azure resources, such as load balancers, networking, or storage.</span></span> <span data-ttu-id="41c8a-311">Pour s’authentifier auprès des API Azure, le cluster utilise un principal de service Azure AD.</span><span class="sxs-lookup"><span data-stu-id="41c8a-311">To authenticate itself with Azure APIs, the cluster uses an Azure AD service principal.</span></span> <span data-ttu-id="41c8a-312">Si vous ne spécifiez pas de principal de service quand vous créez le cluster, un principal de service est créé automatiquement.</span><span class="sxs-lookup"><span data-stu-id="41c8a-312">If you don't specify a service principal when you create the cluster, one is created automatically.</span></span> <span data-ttu-id="41c8a-313">Toutefois, pour des raisons de sécurité, nous vous recommandons de créer le principal de service dès le départ, puis de lui assigner les autorisations RBAC minimales.</span><span class="sxs-lookup"><span data-stu-id="41c8a-313">However, it's a good security practice to create the service principal first and assign the minimal RBAC permissions to it.</span></span> <span data-ttu-id="41c8a-314">Pour plus d’informations, consultez [Principaux de service avec Azure Kubernetes Service](/azure/aks/kubernetes-service-principal).</span><span class="sxs-lookup"><span data-stu-id="41c8a-314">For more information, see [Service principals with Azure Kubernetes Service](/azure/aks/kubernetes-service-principal).</span></span>

### <a name="secrets-management-and-application-credentials"></a><span data-ttu-id="41c8a-315">Gestion des secrets et informations d’identification d’application</span><span class="sxs-lookup"><span data-stu-id="41c8a-315">Secrets management and application credentials</span></span>

<span data-ttu-id="41c8a-316">Les applications et services ont souvent besoin d’informations d’identification leur permettant de se connecter à des services externes tels que Stockage Azure ou SQL Database.</span><span class="sxs-lookup"><span data-stu-id="41c8a-316">Applications and services often need credentials that allow them to connect to external services such as Azure Storage or SQL Database.</span></span> <span data-ttu-id="41c8a-317">Le défi consiste à assurer la sécurité de ces informations d’identification et à les protéger de toute fuite.</span><span class="sxs-lookup"><span data-stu-id="41c8a-317">The challenge is to keep these credentials safe and not leak them.</span></span> 

<span data-ttu-id="41c8a-318">Pour les ressources Azure, vous pouvez utiliser des identités managées.</span><span class="sxs-lookup"><span data-stu-id="41c8a-318">For Azure resources, one option is to use managed identities.</span></span> <span data-ttu-id="41c8a-319">Une identité managée repose sur l’idée qu’une application ou un service a une identité stockée dans Azure AD et utilise cette identité auprès d’un service Azure.</span><span class="sxs-lookup"><span data-stu-id="41c8a-319">The idea of a managed identity is that an application or service has an identity stored in Azure AD, and uses this identity to authenticate with an Azure service.</span></span> <span data-ttu-id="41c8a-320">Un principal de service est créé dans Azure AD pour l’application ou le service, qui s’authentifie à l’aide de jetons OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="41c8a-320">The application or service has a Service Principal created for it in Azure AD, and authenticates using OAuth 2.0 tokens.</span></span> <span data-ttu-id="41c8a-321">Le processus en cours d’exécution appelle une adresse localhost pour obtenir le jeton.</span><span class="sxs-lookup"><span data-stu-id="41c8a-321">The executing process calls a localhost address to get the token.</span></span> <span data-ttu-id="41c8a-322">Ainsi, vous n’avez pas besoin de stocker de mots de passe ou de chaînes de connexion.</span><span class="sxs-lookup"><span data-stu-id="41c8a-322">That way, you don't need to store any passwords or connection strings.</span></span> <span data-ttu-id="41c8a-323">Vous pouvez utiliser des identités managées dans AKS en assignant des identités à des pods individuels, à l’aide du projet [aad-pod-identity](https://github.com/Azure/aad-pod-identity).</span><span class="sxs-lookup"><span data-stu-id="41c8a-323">You can use managed identities in AKS by assigning identities to individual pods, using the [aad-pod-identity](https://github.com/Azure/aad-pod-identity) project.</span></span>

<span data-ttu-id="41c8a-324">Tous les services Azure ne prennent pas en charge l’authentification à l’aide d’identités managées.</span><span class="sxs-lookup"><span data-stu-id="41c8a-324">Currently, not all Azure services support authentication using managed identities.</span></span> <span data-ttu-id="41c8a-325">Pour obtenir une liste, consultez [Services Azure qui prennent en charge l’authentification Azure AD](/azure/active-directory/managed-identities-azure-resources/services-support-msi).</span><span class="sxs-lookup"><span data-stu-id="41c8a-325">For a list, see [Azure services that support Azure AD authentication](/azure/active-directory/managed-identities-azure-resources/services-support-msi).</span></span>

<span data-ttu-id="41c8a-326">Même avec des identités managées, vous devrez probablement stocker certaines informations d’identification ou d’autres secrets d’application, que ce soit pour des services Azure qui ne prennent pas en charge les identités managées, des services tiers, des clés API, etc.</span><span class="sxs-lookup"><span data-stu-id="41c8a-326">Even with managed identities, you'll probably need to store some credentials or other application secrets, whether for Azure services that don't support managed identities, third-party services, API keys, and so on.</span></span> <span data-ttu-id="41c8a-327">Voici quelques options pour stocker des secrets de manière sécurisée :</span><span class="sxs-lookup"><span data-stu-id="41c8a-327">Here are some options for storing secrets securely:</span></span>

- <span data-ttu-id="41c8a-328">Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="41c8a-328">Azure Key Vault.</span></span> <span data-ttu-id="41c8a-329">Dans AKS, vous pouvez monter un ou plusieurs secrets à partir de Key Vault en tant que volume.</span><span class="sxs-lookup"><span data-stu-id="41c8a-329">In AKS, you can mount one or more secrets from Key Vault as a volume.</span></span> <span data-ttu-id="41c8a-330">Le volume lit les secrets dans Key Vault.</span><span class="sxs-lookup"><span data-stu-id="41c8a-330">The volume reads the secrets from Key Vault.</span></span> <span data-ttu-id="41c8a-331">Le pod peut ensuite lire les secrets comme un volume normal.</span><span class="sxs-lookup"><span data-stu-id="41c8a-331">The pod can then read the secrets just like a regular volume.</span></span> <span data-ttu-id="41c8a-332">Pour plus d’informations, consultez le projet [Kubernetes-KeyVault-FlexVolume](https://github.com/Azure/kubernetes-keyvault-flexvol) sur GitHub.</span><span class="sxs-lookup"><span data-stu-id="41c8a-332">For more information, see the [Kubernetes-KeyVault-FlexVolume](https://github.com/Azure/kubernetes-keyvault-flexvol) project on GitHub.</span></span>

    <span data-ttu-id="41c8a-333">Le pod s’authentifie à l’aide d’une identité de pod (décrite plus haut) ou d’un principal de service Azure AD avec un secret client.</span><span class="sxs-lookup"><span data-stu-id="41c8a-333">The pod authenticates itself by using either a pod identity (described above) or by using an Azure AD Service Principal along with a client secret.</span></span> <span data-ttu-id="41c8a-334">L’utilisation d’identités de pod est recommandée, car le secret client n’est pas nécessaire dans ce cas.</span><span class="sxs-lookup"><span data-stu-id="41c8a-334">Using pod identities is recommended because the client secret isn't needed in that case.</span></span> 

- <span data-ttu-id="41c8a-335">HashiCorp Vault.</span><span class="sxs-lookup"><span data-stu-id="41c8a-335">HashiCorp Vault.</span></span> <span data-ttu-id="41c8a-336">Les applications Kubernetes peuvent s’authentifier auprès de HashiCorp Vault à l’aide d’identités Azure AD managées.</span><span class="sxs-lookup"><span data-stu-id="41c8a-336">Kubernetes applications can authenticate with HashiCorp Vault using Azure AD managed identities.</span></span> <span data-ttu-id="41c8a-337">Consultez [HashiCorp Vault speaks Azure Active Directory](https://open.microsoft.com/2018/04/10/scaling-tips-hashicorp-vault-azure-active-directory/).</span><span class="sxs-lookup"><span data-stu-id="41c8a-337">See [HashiCorp Vault speaks Azure Active Directory](https://open.microsoft.com/2018/04/10/scaling-tips-hashicorp-vault-azure-active-directory/).</span></span> <span data-ttu-id="41c8a-338">Vous pouvez déployer le coffre proprement dit sur Kubernetes, mais nous vous recommandons de l’exécuter dans un cluster dédié distinct du cluster de votre application.</span><span class="sxs-lookup"><span data-stu-id="41c8a-338">You can deploy Vault itself to Kubernetes, but it's recommend to run it in a separate dedicated cluster from your application cluster.</span></span> 

- <span data-ttu-id="41c8a-339">Secrets Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-339">Kubernetes secrets.</span></span> <span data-ttu-id="41c8a-340">Une autre option consiste simplement à utiliser des secrets Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-340">Another option is simply to use Kubernetes secrets.</span></span> <span data-ttu-id="41c8a-341">Cette option est la plus facile à configurer, mais présente quelques défis.</span><span class="sxs-lookup"><span data-stu-id="41c8a-341">This option is the easiest to configure but has some challenges.</span></span> <span data-ttu-id="41c8a-342">Les secrets sont stockés dans etcd, magasin de clés/valeurs distribué.</span><span class="sxs-lookup"><span data-stu-id="41c8a-342">Secrets are stored in etcd, which is a distributed key-value store.</span></span> <span data-ttu-id="41c8a-343">AKS [chiffre etcd au repos](https://github.com/Azure/kubernetes-kms#azure-kubernetes-service-aks).</span><span class="sxs-lookup"><span data-stu-id="41c8a-343">AKS [encrypts etcd at rest](https://github.com/Azure/kubernetes-kms#azure-kubernetes-service-aks).</span></span> <span data-ttu-id="41c8a-344">Microsoft gère les clés de chiffrement.</span><span class="sxs-lookup"><span data-stu-id="41c8a-344">Microsoft manages the encryption keys.</span></span>

<span data-ttu-id="41c8a-345">L’utilisation d’un système comme HashiCorp Vault ou Azure Key Vault offre plusieurs avantages, tels que les suivants :</span><span class="sxs-lookup"><span data-stu-id="41c8a-345">Using a system like HashiCorp Vault or Azure Key Vault provides several advantages, such as:</span></span>

- <span data-ttu-id="41c8a-346">Contrôle centralisé des secrets</span><span class="sxs-lookup"><span data-stu-id="41c8a-346">Centralized control of secrets.</span></span>
- <span data-ttu-id="41c8a-347">Garantie que tous les secrets sont chiffrés au repos</span><span class="sxs-lookup"><span data-stu-id="41c8a-347">Ensuring that all secrets are encrypted at rest.</span></span>
- <span data-ttu-id="41c8a-348">Gestion centralisée des clés</span><span class="sxs-lookup"><span data-stu-id="41c8a-348">Centralized key management.</span></span>
- <span data-ttu-id="41c8a-349">Contrôle d’accès des secrets</span><span class="sxs-lookup"><span data-stu-id="41c8a-349">Access control of secrets.</span></span>
- <span data-ttu-id="41c8a-350">Audit</span><span class="sxs-lookup"><span data-stu-id="41c8a-350">Auditing</span></span>

### <a name="pod-and-container-security"></a><span data-ttu-id="41c8a-351">Sécurité des conteneurs et des pods</span><span class="sxs-lookup"><span data-stu-id="41c8a-351">Pod and container security</span></span>

<span data-ttu-id="41c8a-352">Cette liste n’est certainement pas exhaustive, mais voici quelques pratiques recommandées pour protéger vos pods et conteneurs :</span><span class="sxs-lookup"><span data-stu-id="41c8a-352">This list is certainly not exhaustive, but here are some recommended practices for securing your pods and containers:</span></span> 

<span data-ttu-id="41c8a-353">N’exécutez pas les conteneurs en mode privilégié.</span><span class="sxs-lookup"><span data-stu-id="41c8a-353">Don't run containers in privileged mode.</span></span> <span data-ttu-id="41c8a-354">Le mode privilégié donne à un conteneur l’accès à tous les appareils sur l’hôte.</span><span class="sxs-lookup"><span data-stu-id="41c8a-354">Privileged mode gives a container access to all devices on the host.</span></span> <span data-ttu-id="41c8a-355">Vous pouvez définir la stratégie de sécurité des pods de manière à empêcher l’exécution des conteneurs en mode privilégié.</span><span class="sxs-lookup"><span data-stu-id="41c8a-355">You can set Pod Security Policy to disallow containers from running in privileged mode.</span></span> 

<span data-ttu-id="41c8a-356">Dans la mesure du possible, évitez d’exécuter des processus en tant qu’utilisateur root à l’intérieur des conteneurs.</span><span class="sxs-lookup"><span data-stu-id="41c8a-356">When possible, avoid running processes as root inside containers.</span></span> <span data-ttu-id="41c8a-357">Les conteneurs n’offrent pas une isolation totale du point de vue de la sécurité ; il est donc préférable d’exécuter un processus de conteneur en tant qu’utilisateur non privilégié.</span><span class="sxs-lookup"><span data-stu-id="41c8a-357">Containers do not provide complete isolation from a security standpoint, so it's better to run a container process as a non-privileged user.</span></span> 

<span data-ttu-id="41c8a-358">Stockez les images dans un registre privé approuvé, tel qu’Azure Container Registry ou Docker Trusted Registry.</span><span class="sxs-lookup"><span data-stu-id="41c8a-358">Store images in a trusted private registry, such as Azure Container Registry or Docker Trusted Registry.</span></span> <span data-ttu-id="41c8a-359">Utilisez un webhook d’admission de validation dans Kubernetes pour vous assurer que les pods ne peuvent extraire des images que du registre approuvé.</span><span class="sxs-lookup"><span data-stu-id="41c8a-359">Use a validating admission webhook in Kubernetes to ensure that pods can only pull images from the trusted registry.</span></span>

<span data-ttu-id="41c8a-360">Analysez les images pour déterminer si elles présentent des vulnérabilités connues, à l’aide d’une solution d’analyse telle que Twistlock et Aqua, qui sont disponibles par le biais de la Place de marché Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="41c8a-360">Scan images for known vulnerabilities, using a scanning solution such as Twistlock and Aqua, which are available through the Azure Marketplace.</span></span>

<span data-ttu-id="41c8a-361">Automatisez la mise à jour corrective des images à l’aide d’ACR Tasks, fonctionnalité d’Azure Container Registry.</span><span class="sxs-lookup"><span data-stu-id="41c8a-361">Automate image patching using ACR Tasks, a feature of Azure Container Registry.</span></span> <span data-ttu-id="41c8a-362">Une image conteneur est développée à partir de couches.</span><span class="sxs-lookup"><span data-stu-id="41c8a-362">A container image is built up from layers.</span></span> <span data-ttu-id="41c8a-363">Les couches de base incluent l’image de système d’exploitation et les images de framework d’application, par exemple ASP.NET Core ou Node.js.</span><span class="sxs-lookup"><span data-stu-id="41c8a-363">The base layers include the OS image and application framework images, such as ASP.NET Core or Node.js.</span></span> <span data-ttu-id="41c8a-364">Les images de base sont généralement créées en amont des développeurs d’applications et sont gérées par d’autres mainteneurs du projet.</span><span class="sxs-lookup"><span data-stu-id="41c8a-364">The base images are typically created upstream from the application developers, and are maintained by other project maintainers.</span></span> <span data-ttu-id="41c8a-365">Quand ces images sont corrigées en amont, il est important que vous mettiez à jour, testiez et redéployiez vos propres images, afin qu’elles soient exemptes de vulnérabilités de sécurité connues.</span><span class="sxs-lookup"><span data-stu-id="41c8a-365">When these images are patched upstream, it's important to update, test, and redeploy your own images, so that you don't leave any known security vulnerabilities.</span></span> <span data-ttu-id="41c8a-366">ACR Tasks peut aider à automatiser ce processus.</span><span class="sxs-lookup"><span data-stu-id="41c8a-366">ACR Tasks can help to automate this process.</span></span>

## <a name="deployment-cicd-considerations"></a><span data-ttu-id="41c8a-367">Points à prendre en considération pour le déploiement (CI/CD)</span><span class="sxs-lookup"><span data-stu-id="41c8a-367">Deployment (CI/CD) considerations</span></span>

<span data-ttu-id="41c8a-368">Voici certains objectifs d’un processus CI/CD robuste pour une architecture de microservices :</span><span class="sxs-lookup"><span data-stu-id="41c8a-368">Here are some goals of a robust CI/CD process for a microservices architecture:</span></span>

- <span data-ttu-id="41c8a-369">Chaque équipe peut générer et déployer ses propres services de manière indépendante, sans affecter ou interrompre d’autres équipes.</span><span class="sxs-lookup"><span data-stu-id="41c8a-369">Each team can build and deploy the services that it owns independently, without affecting or disrupting other teams.</span></span>

- <span data-ttu-id="41c8a-370">Avant d’être déployée en production, une nouvelle version d’un service est déployée sur les environnements de développement/test/assurance qualité à des fins de validation.</span><span class="sxs-lookup"><span data-stu-id="41c8a-370">Before a new version of a service is deployed to production, it gets deployed to dev/test/QA environments for validation.</span></span> <span data-ttu-id="41c8a-371">Des critères de qualité sont appliqués à chaque étape.</span><span class="sxs-lookup"><span data-stu-id="41c8a-371">Quality gates are enforced at each stage.</span></span>

- <span data-ttu-id="41c8a-372">Une nouvelle version d’un service peut être déployée côte à côte avec la version précédente.</span><span class="sxs-lookup"><span data-stu-id="41c8a-372">A new version of a service can be deployed side-by-side with the previous version.</span></span>

- <span data-ttu-id="41c8a-373">Des stratégies de contrôle d’accès suffisantes sont en place.</span><span class="sxs-lookup"><span data-stu-id="41c8a-373">Sufficient access control policies are in place.</span></span>

- <span data-ttu-id="41c8a-374">Vous pouvez approuver les images conteneur qui sont déployées en production.</span><span class="sxs-lookup"><span data-stu-id="41c8a-374">You can trust the container images that are deployed to production.</span></span>

### <a name="isolation-of-environments"></a><span data-ttu-id="41c8a-375">Isolation des environnements</span><span class="sxs-lookup"><span data-stu-id="41c8a-375">Isolation of environments</span></span>

<span data-ttu-id="41c8a-376">Vous avez plusieurs environnements sur lesquels vous déployez les services, notamment des environnements de développement, de test de détection de fumée, de test d’intégration, de test de chargement et, enfin, de production.</span><span class="sxs-lookup"><span data-stu-id="41c8a-376">You will have multiple environments where you deploy services, including environments for development, smoke testing, integration testing, load testing, and finally production.</span></span> <span data-ttu-id="41c8a-377">Ces environnements ont besoin d’un certain niveau d’isolation.</span><span class="sxs-lookup"><span data-stu-id="41c8a-377">These environments need some level of isolation.</span></span> <span data-ttu-id="41c8a-378">Dans Kubernetes, vous avez le choix entre l’isolation physique et l’isolation logique.</span><span class="sxs-lookup"><span data-stu-id="41c8a-378">In Kubernetes, you have a choice between physical isolation and logical isolation.</span></span> <span data-ttu-id="41c8a-379">Dans le cadre de l’isolation physique, le déploiement est effectué sur des clusters distincts.</span><span class="sxs-lookup"><span data-stu-id="41c8a-379">Physical isolation means deploying to separate clusters.</span></span> <span data-ttu-id="41c8a-380">L’isolation logique utilise des espaces de noms et des stratégies, comme décrit précédemment.</span><span class="sxs-lookup"><span data-stu-id="41c8a-380">Logical isolation makes use of namespaces and policies, as described earlier.</span></span>

<span data-ttu-id="41c8a-381">Nous vous recommandons de créer un cluster de production dédié ainsi qu’un cluster distinct pour vos environnements de développement/test.</span><span class="sxs-lookup"><span data-stu-id="41c8a-381">Our recommendation is to create a dedicated production cluster along with a separate cluster for your dev/test environments.</span></span> <span data-ttu-id="41c8a-382">L’isolation logique permet de séparer les environnements au sein du cluster de développement/test.</span><span class="sxs-lookup"><span data-stu-id="41c8a-382">Use logical isolation to separate environments within the dev/test cluster.</span></span> <span data-ttu-id="41c8a-383">Les services déployés sur le cluster de développement/test ne doivent jamais avoir accès à des magasins de données qui contiennent des données métier.</span><span class="sxs-lookup"><span data-stu-id="41c8a-383">Services deployed to the dev/test cluster should never have access to data stores that hold business data.</span></span> 

### <a name="helm"></a><span data-ttu-id="41c8a-384">Helm</span><span class="sxs-lookup"><span data-stu-id="41c8a-384">Helm</span></span>

<span data-ttu-id="41c8a-385">Envisagez d’utiliser Helm pour gérer la génération et le déploiement des services.</span><span class="sxs-lookup"><span data-stu-id="41c8a-385">Consider using Helm to manage building and deploying services.</span></span> <span data-ttu-id="41c8a-386">Voici quelques-unes des fonctionnalités de Helm qui facilitent l’intégration et le déploiement continus :</span><span class="sxs-lookup"><span data-stu-id="41c8a-386">Some of the features of Helm that help with CI/CD include:</span></span>

- <span data-ttu-id="41c8a-387">Organisation de tous les objets Kubernetes pour un microservice spécifique en un chart Helm unique</span><span class="sxs-lookup"><span data-stu-id="41c8a-387">Organizing all of the Kubernetes objects for a particular microservice into a single Helm chart.</span></span>
- <span data-ttu-id="41c8a-388">Déploiement du chart en tant que commande helm unique, plutôt que série de commandes kubectl</span><span class="sxs-lookup"><span data-stu-id="41c8a-388">Deploying the chart as a single helm command, rather than a series of kubectl commands.</span></span>
- <span data-ttu-id="41c8a-389">Suivi des mises à jour et des révisions, à l’aide du contrôle de version sémantique, avec possibilité de restaurer une version précédente</span><span class="sxs-lookup"><span data-stu-id="41c8a-389">Tracking updates and revisions, using semantic versioning, along with the ability to roll back to a previous version.</span></span>
- <span data-ttu-id="41c8a-390">Utilisation de modèles pour éviter la duplication d’informations, telles que les étiquettes et les sélecteurs, dans plusieurs fichiers</span><span class="sxs-lookup"><span data-stu-id="41c8a-390">The use of templates to avoid duplicating information, such as labels and selectors, across many files.</span></span>
- <span data-ttu-id="41c8a-391">Gestion des dépendances entre charts</span><span class="sxs-lookup"><span data-stu-id="41c8a-391">Managing dependencies between charts.</span></span>
- <span data-ttu-id="41c8a-392">Publication des charts dans un dépôt Helm, tel qu’Azure Container Registry, et intégration de ces derniers au pipeline de build</span><span class="sxs-lookup"><span data-stu-id="41c8a-392">Publishing charts to a Helm repository, such as Azure Container Registry, and integrating them with the build pipeline.</span></span>

<span data-ttu-id="41c8a-393">Pour plus d’informations sur l’utilisation de Container Registry comme dépôt Helm, consultez [Utiliser Azure Container Registry comme référentiel Helm pour les graphiques de votre application](/azure/container-registry/container-registry-helm-repos).</span><span class="sxs-lookup"><span data-stu-id="41c8a-393">For more information about using Container Registry as a Helm repository, see [Use Azure Container Registry as a Helm repository for your application charts](/azure/container-registry/container-registry-helm-repos).</span></span>

### <a name="cicd-workflow"></a><span data-ttu-id="41c8a-394">Workflow CI/CD</span><span class="sxs-lookup"><span data-stu-id="41c8a-394">CI/CD workflow</span></span>

<span data-ttu-id="41c8a-395">Avant de créer un workflow CI/CD, vous devez savoir comment la base de code est structurée et gérée.</span><span class="sxs-lookup"><span data-stu-id="41c8a-395">Before creating a CI/CD workflow, you must know how the code base will be structured and managed.</span></span>

- <span data-ttu-id="41c8a-396">Les équipes travaillent-elles dans des dépôts distincts ou dans un même dépôt (un dépôt unique) ?</span><span class="sxs-lookup"><span data-stu-id="41c8a-396">Do teams work in separate respositories or in a monorepo (single respository)?</span></span>
- <span data-ttu-id="41c8a-397">Quelle est votre stratégie de création de branche ?</span><span class="sxs-lookup"><span data-stu-id="41c8a-397">What is your branching strategy?</span></span>
- <span data-ttu-id="41c8a-398">Qui peut envoyer (push) du code en production ?</span><span class="sxs-lookup"><span data-stu-id="41c8a-398">Who can push code to production?</span></span> <span data-ttu-id="41c8a-399">Existe-t-il un rôle de gestionnaire de mise en production ?</span><span class="sxs-lookup"><span data-stu-id="41c8a-399">Is there a release manager role?</span></span>

<span data-ttu-id="41c8a-400">L’approche « dépôt unique » est de plus en plus utilisée, mais les deux approches ont des avantages et des inconvénients.</span><span class="sxs-lookup"><span data-stu-id="41c8a-400">The monorepo approach has been gaining favor but there are advantages and disadvantages to both.</span></span>

| &nbsp; | <span data-ttu-id="41c8a-401">Dépôt unique</span><span class="sxs-lookup"><span data-stu-id="41c8a-401">Monorepo</span></span> | <span data-ttu-id="41c8a-402">Dépôts multiples</span><span class="sxs-lookup"><span data-stu-id="41c8a-402">Multiple repos</span></span> |
|--------|----------|----------------|
| <span data-ttu-id="41c8a-403">**Avantages**</span><span class="sxs-lookup"><span data-stu-id="41c8a-403">**Advantages**</span></span> | <span data-ttu-id="41c8a-404">Partage du code</span><span class="sxs-lookup"><span data-stu-id="41c8a-404">Code sharing</span></span><br/><span data-ttu-id="41c8a-405">Code et outils plus faciles à standardiser</span><span class="sxs-lookup"><span data-stu-id="41c8a-405">Easier to standardize code and tooling</span></span><br/><span data-ttu-id="41c8a-406">Code plus facile à refactoriser</span><span class="sxs-lookup"><span data-stu-id="41c8a-406">Easier to refactor code</span></span><br/><span data-ttu-id="41c8a-407">Découvrabilité - une même vue du code</span><span class="sxs-lookup"><span data-stu-id="41c8a-407">Discoverability - single view of the code</span></span><br/> | <span data-ttu-id="41c8a-408">Propriété clairement établie par équipe</span><span class="sxs-lookup"><span data-stu-id="41c8a-408">Clear ownership per team</span></span><br/><span data-ttu-id="41c8a-409">Potentiellement moins de conflits de fusion</span><span class="sxs-lookup"><span data-stu-id="41c8a-409">Potentially fewer merge conflicts</span></span><br/><span data-ttu-id="41c8a-410">Aide à appliquer le découplage des microservices</span><span class="sxs-lookup"><span data-stu-id="41c8a-410">Helps to enforce decoupling of microservices</span></span> |
| <span data-ttu-id="41c8a-411">**Défis**</span><span class="sxs-lookup"><span data-stu-id="41c8a-411">**Challenges**</span></span> | <span data-ttu-id="41c8a-412">Les modifications apportées au code partagé peuvent affecter plusieurs microservices</span><span class="sxs-lookup"><span data-stu-id="41c8a-412">Changes to shared code can affect multiple microservices</span></span><br/><span data-ttu-id="41c8a-413">Plus grand risque de conflits de fusion</span><span class="sxs-lookup"><span data-stu-id="41c8a-413">Greater potential for merge conflicts</span></span><br/><span data-ttu-id="41c8a-414">Les outils doivent être adaptés pour une grande base de code</span><span class="sxs-lookup"><span data-stu-id="41c8a-414">Tooling must scale to a large code base</span></span><br/><span data-ttu-id="41c8a-415">Contrôle d’accès</span><span class="sxs-lookup"><span data-stu-id="41c8a-415">Access control</span></span><br/><span data-ttu-id="41c8a-416">Processus de déploiement plus complexe</span><span class="sxs-lookup"><span data-stu-id="41c8a-416">More complex deployment process</span></span> | <span data-ttu-id="41c8a-417">Partage du code plus difficile</span><span class="sxs-lookup"><span data-stu-id="41c8a-417">Harder to share code</span></span><br/><span data-ttu-id="41c8a-418">Standards de codage plus difficiles à appliquer</span><span class="sxs-lookup"><span data-stu-id="41c8a-418">Harder to enforce coding standards</span></span><br/><span data-ttu-id="41c8a-419">Gestion des dépendances</span><span class="sxs-lookup"><span data-stu-id="41c8a-419">Dependency management</span></span><br/><span data-ttu-id="41c8a-420">Base de code diffuse, découvrabilité faible</span><span class="sxs-lookup"><span data-stu-id="41c8a-420">Diffuse code base, poor discoverability</span></span><br/><span data-ttu-id="41c8a-421">Manque d’infrastructure partagée</span><span class="sxs-lookup"><span data-stu-id="41c8a-421">Lack of shared infrastructure</span></span>

<span data-ttu-id="41c8a-422">Dans cette section, nous présentons un workflow CI/CD possible, basé sur les hypothèses suivantes :</span><span class="sxs-lookup"><span data-stu-id="41c8a-422">In this section, we present a possible CI/CD workflow, based on the following assumptions:</span></span>

- <span data-ttu-id="41c8a-423">Le dépôt de code est un « dépôt unique », avec des dossiers organisés par microservice.</span><span class="sxs-lookup"><span data-stu-id="41c8a-423">The code repository is monorepo, with folders organized by microservice.</span></span>
- <span data-ttu-id="41c8a-424">La stratégie de création de branche de l’équipe est basée sur un [développement de type tronc](https://trunkbaseddevelopment.com/).</span><span class="sxs-lookup"><span data-stu-id="41c8a-424">The team's branching strategy is based on [trunk-based development](https://trunkbaseddevelopment.com/).</span></span>
- <span data-ttu-id="41c8a-425">L’équipe utilise [Azure Pipelines](/azure/devops/pipelines) pour effectuer le processus CI/CD.</span><span class="sxs-lookup"><span data-stu-id="41c8a-425">The team uses [Azure Pipelines](/azure/devops/pipelines) to run the CI/CD process.</span></span>
- <span data-ttu-id="41c8a-426">L’équipe utilise des [espaces de noms](/azure/container-registry/container-registry-best-practices#repository-namespaces) dans Azure Container Registry pour isoler les images approuvées pour la production des images qui sont toujours en cours de test.</span><span class="sxs-lookup"><span data-stu-id="41c8a-426">The team uses [namespaces](/azure/container-registry/container-registry-best-practices#repository-namespaces) in Azure Container Registry to isolate images that are approved for production from images that are still being tested.</span></span>

<span data-ttu-id="41c8a-427">Dans cet exemple, un développeur travaille sur un microservice appelé « Delivery Service ».</span><span class="sxs-lookup"><span data-stu-id="41c8a-427">In this example, a developer is working on a microservice called Delivery Service.</span></span> <span data-ttu-id="41c8a-428">(Le nom provient de l’implémentation de référence décrite [ici](../../microservices/design/index.md#scenario).) Lors du développement d’une nouvelle fonctionnalité, le développeur archive le code dans une branche de fonctionnalité.</span><span class="sxs-lookup"><span data-stu-id="41c8a-428">(The name comes from the reference implementation described [here](../../microservices/design/index.md#scenario).) While developing a new feature, the developer checks code into a feature branch.</span></span>

![Workflow CI/CD](./_images/aks-cicd-1.png)

<span data-ttu-id="41c8a-430">Le fait d’envoyer (push) des validations vers cette branche déclenche une build CI pour le microservice.</span><span class="sxs-lookup"><span data-stu-id="41c8a-430">Pushing commits to this branch tiggers a CI build for the microservice.</span></span> <span data-ttu-id="41c8a-431">Par convention, les branches de fonctionnalité sont nommées `feature/*`.</span><span class="sxs-lookup"><span data-stu-id="41c8a-431">By convention, feature branches are named `feature/*`.</span></span> <span data-ttu-id="41c8a-432">Le [fichier de définition de build](/azure/devops/pipelines/yaml-schema) inclut un déclencheur qui filtre par nom de branche et par chemin source.</span><span class="sxs-lookup"><span data-stu-id="41c8a-432">The [build definition file](/azure/devops/pipelines/yaml-schema) includes a trigger that filters by the branch name and the source path.</span></span> <span data-ttu-id="41c8a-433">Avec cette approche, chaque équipe peut avoir son propre du pipeline de build.</span><span class="sxs-lookup"><span data-stu-id="41c8a-433">Using this approach, each team can have its own build pipeline.</span></span>

```yaml
trigger:
  batch: true
  branches:
    include:
    - master
    - feature/*

    exclude:
    - feature/experimental/*

  paths:
     include:
     - /src/shipping/delivery/
```

<span data-ttu-id="41c8a-434">À ce stade du workflow , la build CI exécute une vérification minimale du code :</span><span class="sxs-lookup"><span data-stu-id="41c8a-434">At this point in the workflow, the CI build runs some minimal code verification:</span></span>

1. <span data-ttu-id="41c8a-435">Générer le code</span><span class="sxs-lookup"><span data-stu-id="41c8a-435">Build code</span></span>
1. <span data-ttu-id="41c8a-436">Exécuter des tests unitaires</span><span class="sxs-lookup"><span data-stu-id="41c8a-436">Run unit tests</span></span>

<span data-ttu-id="41c8a-437">L’idée consiste ici à avoir des durées de génération courtes, de façon à ce que le développeur obtienne un feedback rapide.</span><span class="sxs-lookup"><span data-stu-id="41c8a-437">The idea here is to keep the build times short so the developer can get quick feedback.</span></span> <span data-ttu-id="41c8a-438">Quand la fonctionnalité est prête à être fusionnée dans la branche master, le développeur ouvre une demande de tirage.</span><span class="sxs-lookup"><span data-stu-id="41c8a-438">When the feature is ready to merge into master, the developer opens a PR.</span></span> <span data-ttu-id="41c8a-439">Cette action déclenche une autre build CI qui effectue des vérifications supplémentaires :</span><span class="sxs-lookup"><span data-stu-id="41c8a-439">This triggers another CI build that performs some additional checks:</span></span>

1. <span data-ttu-id="41c8a-440">Générer le code</span><span class="sxs-lookup"><span data-stu-id="41c8a-440">Build code</span></span>
1. <span data-ttu-id="41c8a-441">Exécuter des tests unitaires</span><span class="sxs-lookup"><span data-stu-id="41c8a-441">Run unit tests</span></span>
1. <span data-ttu-id="41c8a-442">Générer l’image du conteneur d’exécution</span><span class="sxs-lookup"><span data-stu-id="41c8a-442">Build the runtime container image</span></span>
1. <span data-ttu-id="41c8a-443">Effectuer des analyses de vulnérabilité sur l’image</span><span class="sxs-lookup"><span data-stu-id="41c8a-443">Run vulnerability scans on the image</span></span>

![Workflow CI/CD](./_images/aks-cicd-2.png)

> [!NOTE]
> <span data-ttu-id="41c8a-445">Dans Azure Repos, vous pouvez définir des [stratégies](/azure/devops/repos/git/branch-policies) pour protéger les branches.</span><span class="sxs-lookup"><span data-stu-id="41c8a-445">In Azure Repos, you can define [policies](/azure/devops/repos/git/branch-policies) to protect branches.</span></span> <span data-ttu-id="41c8a-446">Par exemple, la stratégie peut exiger une build CI réussie ainsi qu’une validation d’un approbateur pour fusionner dans la branche master.</span><span class="sxs-lookup"><span data-stu-id="41c8a-446">For example, the policy could require a successful CI build plus a sign-off from an approver in order to merge into master.</span></span>

<span data-ttu-id="41c8a-447">À un moment donné, l’équipe est prête à déployer une nouvelle version du service « Delivery ».</span><span class="sxs-lookup"><span data-stu-id="41c8a-447">At some point, the team is ready to deploy a new version of the Delivery service.</span></span> <span data-ttu-id="41c8a-448">Pour cela, le gestionnaire de versions crée une branche à partir de la branche master avec ce modèle de nommage : `release/<microservice name>/<semver>`.</span><span class="sxs-lookup"><span data-stu-id="41c8a-448">To do so, the release manager creates a branch from master with this naming pattern: `release/<microservice name>/<semver>`.</span></span> <span data-ttu-id="41c8a-449">Par exemple : `release/delivery/v1.0.2`.</span><span class="sxs-lookup"><span data-stu-id="41c8a-449">For example, `release/delivery/v1.0.2`.</span></span>
<span data-ttu-id="41c8a-450">Cela déclenche une build CI complète qui exécute toutes les étapes précédentes, plus ceci :</span><span class="sxs-lookup"><span data-stu-id="41c8a-450">This triggers a full CI build that runs all the previous steps plus:</span></span>

1. <span data-ttu-id="41c8a-451">Envoyer l’image Docker vers Azure Container Registry.</span><span class="sxs-lookup"><span data-stu-id="41c8a-451">Push the Docker image to Azure Container Registry.</span></span> <span data-ttu-id="41c8a-452">L’image est étiquetée avec le numéro de version tiré du nom de la branche.</span><span class="sxs-lookup"><span data-stu-id="41c8a-452">The image is tagged with the version number taken from the branch name.</span></span>
2. <span data-ttu-id="41c8a-453">Exécuter `helm package` pour empaqueter le chart Helm</span><span class="sxs-lookup"><span data-stu-id="41c8a-453">Run `helm package` to package the Helm chart</span></span>
3. <span data-ttu-id="41c8a-454">Envoyer le package Helm à Container Registry en exécutant `az acr helm push`.</span><span class="sxs-lookup"><span data-stu-id="41c8a-454">Push the Helm package to Container Registry by running `az acr helm push`.</span></span>

<span data-ttu-id="41c8a-455">Si cette build réussit, elle déclenche un processus de déploiement avec un [pipeline de mise en production](/azure/devops/pipelines/release/what-is-release-management) Azure Pipelines.</span><span class="sxs-lookup"><span data-stu-id="41c8a-455">Assuming this build succeeds, it triggers a deployment process using an Azure Pipelines [release pipeline](/azure/devops/pipelines/release/what-is-release-management).</span></span> <span data-ttu-id="41c8a-456">Ce pipeline</span><span class="sxs-lookup"><span data-stu-id="41c8a-456">This pipeline</span></span>

1. <span data-ttu-id="41c8a-457">exécute `helm upgrade` pour déployer le chart Helm sur un environnement d’assurance qualité.</span><span class="sxs-lookup"><span data-stu-id="41c8a-457">Run `helm upgrade` to deploy the Helm chart to a QA environment.</span></span>
1. <span data-ttu-id="41c8a-458">Un approbateur effectue une validation avant que le package passe en production.</span><span class="sxs-lookup"><span data-stu-id="41c8a-458">An approver signs off before the package moves to production.</span></span> <span data-ttu-id="41c8a-459">Consultez [Contrôler le déploiement de mise en production avec des approbations](/azure/devops/pipelines/release/approvals/approvals).</span><span class="sxs-lookup"><span data-stu-id="41c8a-459">See [Release deployment control using approvals](/azure/devops/pipelines/release/approvals/approvals).</span></span>
1. <span data-ttu-id="41c8a-460">Réappliquez une étiquette à l’image Docker pour l’espace de noms de production dans Azure Container Registry.</span><span class="sxs-lookup"><span data-stu-id="41c8a-460">Re-tag the Docker image for the production namespace in Azure Container Registry.</span></span> <span data-ttu-id="41c8a-461">Par exemple, si l’étiquette actuelle est `myrepo.azurecr.io/delivery:v1.0.2`, l’étiquette de production est `myrepo.azurecr.io/prod/delivery:v1.0.2`.</span><span class="sxs-lookup"><span data-stu-id="41c8a-461">For example, if the current tag is `myrepo.azurecr.io/delivery:v1.0.2`, the production tag is `myrepo.azurecr.io/prod/delivery:v1.0.2`.</span></span>
1. <span data-ttu-id="41c8a-462">Exécutez `helm upgrade` pour déployer le chart Helm sur l’environnement de production.</span><span class="sxs-lookup"><span data-stu-id="41c8a-462">Run `helm upgrade` to deploy the Helm chart to the production environment.</span></span>

![Workflow CI/CD](./_images/aks-cicd-3.png)

<span data-ttu-id="41c8a-464">Il est important de se rappeler que même dans un dépôt unique, ces tâches peuvent être limitées à des microservices individuels, afin que les équipes puissent effectuer des déploiements très rapidement.</span><span class="sxs-lookup"><span data-stu-id="41c8a-464">It's important to remember that even in a monorepo, these tasks can be scoped to individual microservices, so that teams can deploy with high velocity.</span></span> <span data-ttu-id="41c8a-465">Le processus comprend quelques étapes manuelles : Approbation des demandes de tirage, création de branches de mise en production et approbation des déploiements sur le cluster de production.</span><span class="sxs-lookup"><span data-stu-id="41c8a-465">There are some manual steps in the process: Approving PRs, creating release branches, and approving deployments into the production cluster.</span></span> <span data-ttu-id="41c8a-466">Ces étapes sont définies comme « manuelles » par la stratégie : elles peuvent cependant être entièrement automatisées si l’organisation le préfère.</span><span class="sxs-lookup"><span data-stu-id="41c8a-466">These steps are manual by policy &mdash; they could be completely automated if the organization prefers.</span></span>
