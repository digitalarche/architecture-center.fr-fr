---
title: Intégration et livraison continues pour les microservices
description: Intégration et livraison continues pour les microservices
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: 7d8a81b7bc236e50d722a68a0115b9220d4e094f
ms.sourcegitcommit: 786bafefc731245414c3c1510fc21027afe303dc
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 12/12/2017
---
# <a name="designing-microservices-continuous-integration"></a><span data-ttu-id="5c919-103">Conception des microservices : Intégration continue</span><span class="sxs-lookup"><span data-stu-id="5c919-103">Designing microservices: Continuous integration</span></span>

<span data-ttu-id="5c919-104">L’intégration et la livraison continues sont une condition essentielle à la réussite des microservices.</span><span class="sxs-lookup"><span data-stu-id="5c919-104">Continuous integration and continuous delivery (CI/CD) are a key requirement for achieving success with microservices.</span></span> <span data-ttu-id="5c919-105">Sans processus efficace d’intégration et de livraison continues, vous n’obtiendrez pas l’agilité attendue des microservices.</span><span class="sxs-lookup"><span data-stu-id="5c919-105">Without a good CI/CD process, you will not achieve the agility that microservices promise.</span></span> <span data-ttu-id="5c919-106">Certaines des difficultés du processus appliqué aux microservices proviennent de la multiplication des bases de code et de l’hétérogénéité des environnements de génération pour les divers services.</span><span class="sxs-lookup"><span data-stu-id="5c919-106">Some of the CI/CD challenges for microservices arise from having multiple code bases and heterogenous build environments for the various services.</span></span> <span data-ttu-id="5c919-107">Ce chapitre décrit ces obstacles et recommande certaines stratégies pour les surmonter.</span><span class="sxs-lookup"><span data-stu-id="5c919-107">This chapter describes the challenges and recommends some approaches to the problem.</span></span>

![](./images/ci-cd.png)

<span data-ttu-id="5c919-108">L’accélération des cycles de version constitue l’un des motifs principaux d’adoption d’une architecture de microservices.</span><span class="sxs-lookup"><span data-stu-id="5c919-108">Faster release cycles are one of the biggest reasons to adopt a microservices architecture.</span></span> 

<span data-ttu-id="5c919-109">Dans une application purement monolithique, un pipeline unique de conception génère le fichier exécutable de l’application.</span><span class="sxs-lookup"><span data-stu-id="5c919-109">In a purely monolithic application, there is a single build pipeline whose output is the application executable.</span></span> <span data-ttu-id="5c919-110">L’ensemble des tâches de développement alimentent ce pipeline.</span><span class="sxs-lookup"><span data-stu-id="5c919-110">All development work feeds into this pipeline.</span></span> <span data-ttu-id="5c919-111">Si un bogue de priorité élevée est identifié, un correctif doit être intégré, testé puis publié, ce qui peut retarder la sortie des nouvelles fonctionnalités.</span><span class="sxs-lookup"><span data-stu-id="5c919-111">If a high-priority bug is found, a fix must be integrated, tested, and published, which can delay the release of new features.</span></span> <span data-ttu-id="5c919-112">Il est vrai que vous pouvez atténuer ces problèmes en vous dotant de modules correctement rationalisés et en valorisant des branches de fonctionnalités destinées à réduire l’incidence des modifications de code.</span><span class="sxs-lookup"><span data-stu-id="5c919-112">It's true that you can mitigate these problems by having well-factored modules and using feature branches to minimize the impact of code changes.</span></span> <span data-ttu-id="5c919-113">Toutefois, à mesure que l’application devient plus complexe, en parallèle de l’ajout des fonctionnalités, le processus de publication d’un monolithe a tendance à se fragiliser et présente des risques de rupture.</span><span class="sxs-lookup"><span data-stu-id="5c919-113">But as the application grows more complex, and more features are added, the release process for a monolith tends to become more brittle and likely to break.</span></span> 

<span data-ttu-id="5c919-114">Si une approche de microservices est suivie, vous ne déplorez jamais une longue chaîne de publication au sein de laquelle les équipes interviennent tour à tour.</span><span class="sxs-lookup"><span data-stu-id="5c919-114">Following the microservices philosophy, there should never be a long release train where every team has to get in line.</span></span> <span data-ttu-id="5c919-115">L’équipe qui développe le service « A » peut publier une mise à jour à tout moment, sans attendre que les modifications de l’équipe du service « B » soient fusionnées, testées et déployées.</span><span class="sxs-lookup"><span data-stu-id="5c919-115">The team that builds service "A" can release an update at any time, without waiting for changes in service "B" to be merged, tested, and deployed.</span></span> <span data-ttu-id="5c919-116">Le processus d’intégration et de livraison continues est essentiel à cette approche.</span><span class="sxs-lookup"><span data-stu-id="5c919-116">The CI/CD process is critical to making this possible.</span></span> <span data-ttu-id="5c919-117">Votre pipeline de publication doit être automatisé et hautement fiable, de manière à réduire au maximum les risques liés au déploiement des mises à jour.</span><span class="sxs-lookup"><span data-stu-id="5c919-117">Your release pipeline must be automated and highly reliable, so that the risks of deploying updates are minimized.</span></span> <span data-ttu-id="5c919-118">Si vous publiez une production tous les jours ou plusieurs fois par jour, les régressions et les interruptions de service doivent être très rares.</span><span class="sxs-lookup"><span data-stu-id="5c919-118">If you are releasing to production daily or multiple times a day, regressions or service disruptions must be very rare.</span></span> <span data-ttu-id="5c919-119">En même temps, en cas de déploiement d’une mauvaise mise à jour, vous devez disposer d’un moyen fiable pour revenir vers une version antérieure du service.</span><span class="sxs-lookup"><span data-stu-id="5c919-119">At the same time, if a bad update does get deployed, you must have a reliable way to quickly roll back or roll forward to a previous version of a service.</span></span>

![](./images/cicd-monolith.png)

<span data-ttu-id="5c919-120">Le processus dont nous parlons traite de plusieurs processus associés : intégration continue, livraison continue et déploiement continu.</span><span class="sxs-lookup"><span data-stu-id="5c919-120">When we talk about CI/CD, we are really talking about several related processes: Continuous integration, continuous delivery, and continuous deployment.</span></span>

- <span data-ttu-id="5c919-121">L’intégration continue implique que les modifications du code sont fréquemment fusionnées dans la branche principale, à l’aide de processus automatisés de génération et de test qui garantissent que le code de la branche principale présente toujours une qualité acceptable pour la production.</span><span class="sxs-lookup"><span data-stu-id="5c919-121">Continuous integration means that code changes are frequently merged into the main branch, using automated build and test processes to ensure that  code in the main branch is always production-quality.</span></span>

- <span data-ttu-id="5c919-122">Avec la livraison continue, les modifications de code sont automatiquement publiées sur un environnement de type production.</span><span class="sxs-lookup"><span data-stu-id="5c919-122">Continuous delivery means that code changes that pass the CI process are automatically published to a production-like environment.</span></span> <span data-ttu-id="5c919-123">Si le déploiement au sein de l’environnement de production réelle peut nécessiter une approbation manuelle, il est automatisé.</span><span class="sxs-lookup"><span data-stu-id="5c919-123">Deployment into the live production environment may require manual approval, but is otherwise automated.</span></span> <span data-ttu-id="5c919-124">L’objectif est de toujours disposer d’un code *prêt* à être déployé en production.</span><span class="sxs-lookup"><span data-stu-id="5c919-124">The goal is that your code should always be *ready* to deploy into production.</span></span>

- <span data-ttu-id="5c919-125">Avec le déploiement continu, les modifications de code traitées par le processus sont automatiquement déployées en production.</span><span class="sxs-lookup"><span data-stu-id="5c919-125">Continuous deployment means that code changes that pass the CI/CD process are automatically deployed into production.</span></span>

<span data-ttu-id="5c919-126">Dans le contexte de Kubernetes et des microservices, l’intégration continue consiste en la génération et le test d’images de conteneurs, et en leur transmission vers un registre de conteneurs.</span><span class="sxs-lookup"><span data-stu-id="5c919-126">In the context of Kubernetes and microservices, the CI stage is concerned with building and testing container images, and pushing those images to a container registry.</span></span> <span data-ttu-id="5c919-127">Durant la phase de déploiement, les spécifications de pod sont mises à jour pour récupérer l’image de production la plus récente.</span><span class="sxs-lookup"><span data-stu-id="5c919-127">In the deployment stage, pod specs are updated to pick up the latest production image.</span></span>

## <a name="challenges"></a><span data-ttu-id="5c919-128">Défis</span><span class="sxs-lookup"><span data-stu-id="5c919-128">Challenges</span></span>

- <span data-ttu-id="5c919-129">**De nombreuses bases de code indépendantes et réduites**.</span><span class="sxs-lookup"><span data-stu-id="5c919-129">**Many small independent code bases**.</span></span> <span data-ttu-id="5c919-130">Chaque équipe est responsable de la création de son propre service, associé à un pipeline de génération spécifique.</span><span class="sxs-lookup"><span data-stu-id="5c919-130">Each team is responsible for building its own service, with its own build pipeline.</span></span> <span data-ttu-id="5c919-131">Dans certaines organisations, les équipes peuvent utiliser des référentiels de code séparés.</span><span class="sxs-lookup"><span data-stu-id="5c919-131">In some organizations, teams may use separate code repositories.</span></span> <span data-ttu-id="5c919-132">Ainsi, parfois, l’expertise en matière de génération du système est partagée entre les équipes, sans que quiconque au sein de l’organisation ne sache comment déployer l’application entière.</span><span class="sxs-lookup"><span data-stu-id="5c919-132">This could lead to a situation where the knowledge of how to build the system is spread across teams, and nobody in the organization knows how to deploy the entire application.</span></span> <span data-ttu-id="5c919-133">Par exemple, que se passe-t-il en cas de récupération d’urgence, si vous devez déployer rapidement vers un nouveau cluster ?</span><span class="sxs-lookup"><span data-stu-id="5c919-133">For example, what happens in a disaster recovery scenario, if you need to quickly deploy to a new cluster?</span></span>   

- <span data-ttu-id="5c919-134">**Langues et infrastructures multiples**.</span><span class="sxs-lookup"><span data-stu-id="5c919-134">**Multiple languages and frameworks**.</span></span> <span data-ttu-id="5c919-135">Si chaque équipe utilise sa propre combinaison de technologies, il peut s’avérer difficile de créer un processus de génération unique fonctionnant dans tous les services de l’organisation.</span><span class="sxs-lookup"><span data-stu-id="5c919-135">With each team using its own mix of technologies, it can be difficult to create a single build process that works across the organization.</span></span> <span data-ttu-id="5c919-136">Le processus de génération doit être suffisamment souple pour que chaque équipe puisse opter pour la langue ou l’infrastructure de son choix.</span><span class="sxs-lookup"><span data-stu-id="5c919-136">The build process must be flexible enough that every team can adapt it for their choice of language or framework.</span></span> 

- <span data-ttu-id="5c919-137">**Intégration et test de charge**.</span><span class="sxs-lookup"><span data-stu-id="5c919-137">**Integration and load testing**.</span></span> <span data-ttu-id="5c919-138">Chaque équipe publiant les mises à jour à son propre rythme, la mise en œuvre d’une approche de test robuste de bout en bout peut présenter des difficultés, plus particulièrement quand des interdépendances entre services sont identifiées.</span><span class="sxs-lookup"><span data-stu-id="5c919-138">With teams releasing updates at their own pace, it can be challenging to design robust end-to-end testing, especially when services have dependencies on other services.</span></span> <span data-ttu-id="5c919-139">En outre, l’exécution d’un cluster de production intégral peut s’avérer onéreuse. Aussi, il est peu probable que l’ensemble des équipes soient en mesure d’exécuter leur propre cluster à l’échelle de la production, simplement pour la phase de test.</span><span class="sxs-lookup"><span data-stu-id="5c919-139">Moreover, running a full production cluster can be expensive, so it's unlikely that every team will be able to run its own full cluster at production scales, just for testing.</span></span> 

- <span data-ttu-id="5c919-140">**Gestion des mises en production**.</span><span class="sxs-lookup"><span data-stu-id="5c919-140">**Release management**.</span></span> <span data-ttu-id="5c919-141">Chaque équipe doit être capable de déployer une mise à jour en production.</span><span class="sxs-lookup"><span data-stu-id="5c919-141">Every team should have the ability to deploy an update to production.</span></span> <span data-ttu-id="5c919-142">Cela ne signifie pas que tous les membres doivent être autorisés à le faire.</span><span class="sxs-lookup"><span data-stu-id="5c919-142">That doesn't mean that every team member has permissions to do so.</span></span> <span data-ttu-id="5c919-143">Cependant, une organisation disposant d’un rôle centralisé de gestionnaire des versions peut constater un ralentissement de ses déploiements.</span><span class="sxs-lookup"><span data-stu-id="5c919-143">But having a centralized Release Manager role can reduce the velocity of deployments.</span></span> <span data-ttu-id="5c919-144">Plus le processus d’intégration et de livraison continue est automatisé et fiable, moins la nécessité d’une autorité centrale se fait sentir.</span><span class="sxs-lookup"><span data-stu-id="5c919-144">The more that your CI/CD process is automated and reliable, the less there should be a need for a central authority.</span></span> <span data-ttu-id="5c919-145">Ceci dit, vous pouvez avoir plusieurs stratégies, adaptées à la fois à la publication des modifications majeures de fonctionnalités et des correctifs mineurs.</span><span class="sxs-lookup"><span data-stu-id="5c919-145">That said, you might have different policies for releasing major feature updates versus minor bug fixes.</span></span> <span data-ttu-id="5c919-146">La décentralisation ne signifie pas qu’il n’existe plus aucune trace de gouvernance.</span><span class="sxs-lookup"><span data-stu-id="5c919-146">Being decentralized does not mean there should be zero governance.</span></span>

- <span data-ttu-id="5c919-147">**Gestion des versions d’images de conteneur**.</span><span class="sxs-lookup"><span data-stu-id="5c919-147">**Container image versioning**.</span></span> <span data-ttu-id="5c919-148">Durant le cycle de développement et de test, le processus d’intégration et de livraison continue génère de nombreuses images de conteneur.</span><span class="sxs-lookup"><span data-stu-id="5c919-148">During the development and test cycle, the CI/CD process will build many container images.</span></span> <span data-ttu-id="5c919-149">Seulement une partie de ces instances sont candidates à la publication, puis un nouvel écrémage filtre les éléments transmis en phase de production.</span><span class="sxs-lookup"><span data-stu-id="5c919-149">Only some of those are candidates for release, and then only some of those release candidates will get pushed into production.</span></span> <span data-ttu-id="5c919-150">Vous devez disposer d’une stratégie claire de gestion des versions, qui vous permettent de savoir quelles images sont déployées à un instant t en production, et ainsi de revenir à une version antérieure si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="5c919-150">You should have a clear versioning strategy, so that you know which images are currently deployed to production, and can roll back to a previous version if necessary.</span></span> 

- <span data-ttu-id="5c919-151">**Mises à jour de service**.</span><span class="sxs-lookup"><span data-stu-id="5c919-151">**Service updates**.</span></span> <span data-ttu-id="5c919-152">Lorsque vous mettez à jour un service vers une nouvelle version, il ne doit pas perturber les autres services qui en dépendent.</span><span class="sxs-lookup"><span data-stu-id="5c919-152">When you update a service to a new version, it shouldn't break other services that depend on it.</span></span> <span data-ttu-id="5c919-153">Si vous procédez à une mise à jour propagée, une combinaison de versions différentes sera exécutée sur un intervalle ponctuel.</span><span class="sxs-lookup"><span data-stu-id="5c919-153">If you do a rolling update, there will be a period of time when a mix of versions is running.</span></span> 
 
<span data-ttu-id="5c919-154">Ces enjeux reflètent une problématique centrale.</span><span class="sxs-lookup"><span data-stu-id="5c919-154">These challenges reflect a fundamental tension.</span></span> <span data-ttu-id="5c919-155">D’une part, les équipes doivent travailler aussi indépendamment que possible.</span><span class="sxs-lookup"><span data-stu-id="5c919-155">On the one hand, teams need to work as independently as possible.</span></span> <span data-ttu-id="5c919-156">Malgré tout, une certaine coordination est requise, de manière à ce qu’une personne donnée puisse effectuer des tâches variées, comme l’exécution du test d’intégration, le redéploiement de la solution entière vers un nouveau cluster ou l’annulation d’une mauvaise mise à jour.</span><span class="sxs-lookup"><span data-stu-id="5c919-156">On the other hand, some coordination is needed so that a single person can do tasks like running an integration test, redeploying the entire solution to a new cluster, or rolling back a bad update.</span></span> 
 
## <a name="cicd-approaches-for-microservices"></a><span data-ttu-id="5c919-157">Approches d’intégration/livraison continues pour les microservices</span><span class="sxs-lookup"><span data-stu-id="5c919-157">CI/CD approaches for microservices</span></span>

<span data-ttu-id="5c919-158">Il est recommandé que chaque équipe de service héberge son environnement de génération au sein d’un conteneur.</span><span class="sxs-lookup"><span data-stu-id="5c919-158">It's a good practice for every service team to containerize their build environment.</span></span> <span data-ttu-id="5c919-159">Ce conteneur doit comporter tous les outils nécessaires pour le développement des artefacts de code dédiés au service considéré.</span><span class="sxs-lookup"><span data-stu-id="5c919-159">This container should have all of the build tools necessary to build the code artifacts for their service.</span></span> <span data-ttu-id="5c919-160">Bien souvent, vous pouvez trouver une image Docker officielle pour votre langue et votre infrastructure.</span><span class="sxs-lookup"><span data-stu-id="5c919-160">Often you can find an official Docker image for your language and framework.</span></span> <span data-ttu-id="5c919-161">Vous pouvez ensuite recourir à `docker run` ou à Docker Compose pour exécuter la version.</span><span class="sxs-lookup"><span data-stu-id="5c919-161">Then you can use `docker run` or Docker Compose to run the build.</span></span> 

<span data-ttu-id="5c919-162">Avec cette approche, il est très facile de configurer un nouvel environnement de génération.</span><span class="sxs-lookup"><span data-stu-id="5c919-162">With this approach, it's trivial to set up a new build environment.</span></span> <span data-ttu-id="5c919-163">Un développeur souhaitant générer votre code n’a pas besoin d’installer un jeu d’outils de génération ; il lui suffit d’exécuter l’image de conteneur.</span><span class="sxs-lookup"><span data-stu-id="5c919-163">A developer who wants to build your code doesn't need to install a set of build tools, but simply runs the container image.</span></span> <span data-ttu-id="5c919-164">Plus important encore peut-être, votre serveur de builds peut être configuré pour effectuer la même chose.</span><span class="sxs-lookup"><span data-stu-id="5c919-164">Perhaps more importantly, your build server can be configured to do the same thing.</span></span> <span data-ttu-id="5c919-165">De cette manière, vous n’avez pas à installer ces outils sur le serveur de builds, ni à gérer des versions en conflit des outils.</span><span class="sxs-lookup"><span data-stu-id="5c919-165">That way, you don't need to install those tools onto the build server, or manage conflicting versions of tools.</span></span> 

<span data-ttu-id="5c919-166">Pour les opérations locales de développement et de test, utilisez Docker pour exécuter le service au sein d’un conteneur.</span><span class="sxs-lookup"><span data-stu-id="5c919-166">For local development and testing, use Docker to run the service inside a container.</span></span> <span data-ttu-id="5c919-167">Dans le cadre de ce processus, vous devrez peut-être exécuter d’autres conteneurs prenant en charge des services fictifs ou des bases de données test nécessaires pour le test en local.</span><span class="sxs-lookup"><span data-stu-id="5c919-167">As part of this process, you may need to run other containers that have mock services or test databases needed for local testing.</span></span> <span data-ttu-id="5c919-168">Vous pourriez utiliser Docker Compose pour coordonner ces conteneurs, ou Minikube pour exécuter Kubernetes en local.</span><span class="sxs-lookup"><span data-stu-id="5c919-168">You could use Docker Compose to coordinate these containers, or use Minikube to run Kubernetes locally.</span></span> 

<span data-ttu-id="5c919-169">Lorsque le code est prêt, ouvrez une requête d’extraction et procédez à une fusion dans les données de références.</span><span class="sxs-lookup"><span data-stu-id="5c919-169">When the code is ready, open a pull request and merge into master.</span></span> <span data-ttu-id="5c919-170">Cela déclenche une tâche sur le serveur de builds :</span><span class="sxs-lookup"><span data-stu-id="5c919-170">This will start a job on the build server:</span></span>

1. <span data-ttu-id="5c919-171">Générez les ressources du code.</span><span class="sxs-lookup"><span data-stu-id="5c919-171">Build the code assets.</span></span> 
2. <span data-ttu-id="5c919-172">Exécutez des tests unitaires sur le code.</span><span class="sxs-lookup"><span data-stu-id="5c919-172">Run unit tests against the code.</span></span>
3. <span data-ttu-id="5c919-173">Générez l’image de conteneur.</span><span class="sxs-lookup"><span data-stu-id="5c919-173">Build the container image.</span></span>
4. <span data-ttu-id="5c919-174">Testez l’image de conteneur en exécutant des tests fonctionnels sur un conteneur en exécution.</span><span class="sxs-lookup"><span data-stu-id="5c919-174">Test the container image by running functional tests on a running container.</span></span> <span data-ttu-id="5c919-175">Durant cette phase, des erreurs peuvent être identifiées dans le fichier Docker, comme un mauvais point d’entrée.</span><span class="sxs-lookup"><span data-stu-id="5c919-175">This step can catch errors in the Docker file, such as a bad entry point.</span></span>
5. <span data-ttu-id="5c919-176">Envoyez l’image dans un registre de conteneurs.</span><span class="sxs-lookup"><span data-stu-id="5c919-176">Push the image to a container registry.</span></span>
6. <span data-ttu-id="5c919-177">Mettez à jour le cluster de test avec la nouvelle image avant d’exécuter les tests d’intégration.</span><span class="sxs-lookup"><span data-stu-id="5c919-177">Update the test cluster with the new image to run integration tests.</span></span>

<span data-ttu-id="5c919-178">Lorsque l’image est prête à passer en production, mettez à jour les fichiers de déploiement en fonction de l’image la plus récente, en tenant compte des éventuels fichiers de configuration Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="5c919-178">When the image is ready to go into production, update the deployment files as needed to specify the latest image, including any Kubernetes configuration files.</span></span> <span data-ttu-id="5c919-179">Appliquez ensuite la mise à jour sur le cluster de production.</span><span class="sxs-lookup"><span data-stu-id="5c919-179">Then apply the update to the production cluster.</span></span>

<span data-ttu-id="5c919-180">Voici quelques recommandations pour optimiser la fiabilité des déploiements :</span><span class="sxs-lookup"><span data-stu-id="5c919-180">Here are some recommendations for making deployments more reliable:</span></span>
 
- <span data-ttu-id="5c919-181">Définissez des conventions d’organisation pour les balises de conteneurs, la gestion des versions et des conventions de d’affectation de noms pour les ressources déployées sur le cluster (pod, services, etc.).</span><span class="sxs-lookup"><span data-stu-id="5c919-181">Define organization-wide conventions for container tags, versioning, and naming conventions for resources deployed to the cluster (pods, services, and so on).</span></span> <span data-ttu-id="5c919-182">Cela peut simplifier le diagnostic des problèmes de déploiement.</span><span class="sxs-lookup"><span data-stu-id="5c919-182">That can make it easier to diagnose deployment issues.</span></span> 

- <span data-ttu-id="5c919-183">Créez 2 registres distincts de conteneur, un dédié au développement/au test et un à la production.</span><span class="sxs-lookup"><span data-stu-id="5c919-183">Create two separate container registries, one for development/testing and one for production.</span></span> <span data-ttu-id="5c919-184">N’envoyez pas l’image dans le registre de production avant d’être prêt à la déployer en phase de production.</span><span class="sxs-lookup"><span data-stu-id="5c919-184">Don't push an image to the production registry until you're ready to deploy it into production.</span></span> <span data-ttu-id="5c919-185">Si vous combinez cette pratique à la gestion sémantique des versions des images de conteneurs, vous pouvez réduire les risques de déploiement accidentel d’une version non approuvée pour publication.</span><span class="sxs-lookup"><span data-stu-id="5c919-185">If you combine this practice with semantic versioning of container images, it can reduce the chance of accidentally deploying a version that wasn't approved for release.</span></span>

## <a name="updating-services"></a><span data-ttu-id="5c919-186">Mise à jour des services</span><span class="sxs-lookup"><span data-stu-id="5c919-186">Updating services</span></span>

<span data-ttu-id="5c919-187">Il existe différentes stratégies de mise à jour d’un service déjà en production.</span><span class="sxs-lookup"><span data-stu-id="5c919-187">There are various strategies for updating a service that's already in production.</span></span> <span data-ttu-id="5c919-188">Nous présentons ici 3 options courantes : mise à jour propagée, déploiement bleu-vert et contrôle de la validité de la mise en production.</span><span class="sxs-lookup"><span data-stu-id="5c919-188">Here we discuss three common options: Rolling update, blue-green deployment, and canary release.</span></span>

### <a name="rolling-update"></a><span data-ttu-id="5c919-189">Mise à jour propagée</span><span class="sxs-lookup"><span data-stu-id="5c919-189">Rolling update</span></span> 

<span data-ttu-id="5c919-190">Dans une mise à jour propagée, vous déployez de nouvelles instances d’un service ; ces nouvelles instances reçoivent immédiatement les requêtes.</span><span class="sxs-lookup"><span data-stu-id="5c919-190">In a rolling update, you deploy new instances of a service, and the new instances start receiving requests right away.</span></span> <span data-ttu-id="5c919-191">À mesure que les nouvelles instances arrivent, les anciennes instances sont supprimées.</span><span class="sxs-lookup"><span data-stu-id="5c919-191">As the new instances come up, the previous instances are removed.</span></span>

<span data-ttu-id="5c919-192">Les mises à jour propagées correspondent au comportement par défaut dans Kubernetes, quand vous mettez à jour les spécifications des pods pour un déploiement.</span><span class="sxs-lookup"><span data-stu-id="5c919-192">Rolling updates are the default behavior in Kubernetes when you update the pod spec for a Deployment.</span></span> <span data-ttu-id="5c919-193">Le contrôleur de déploiement crée un nouveau jeu de réplicas pour les pods mis à jour.</span><span class="sxs-lookup"><span data-stu-id="5c919-193">The Deployment controller creates a new ReplicaSet for the updated pods.</span></span> <span data-ttu-id="5c919-194">Ensuite, il promeut le nouveau jeu en rétrogradant l’ancien, ceci pour garantir le maintien d’un nombre souhaité de réplicas.</span><span class="sxs-lookup"><span data-stu-id="5c919-194">Then it scales up the new ReplicaSet while scaling down the old one, to maintain the desired replica count.</span></span> <span data-ttu-id="5c919-195">Les anciens pods ne sont pas supprimés avant que les nouveaux ne soient prêts.</span><span class="sxs-lookup"><span data-stu-id="5c919-195">It doesn't delete old pods until the new ones are ready.</span></span> <span data-ttu-id="5c919-196">Kubernetes conserve un historique de la mise à jour, ce qui vous permet d’utiliser kubectl pour annuler une opération, au besoin.</span><span class="sxs-lookup"><span data-stu-id="5c919-196">Kubernetes keeps a history of the update, so you can use kubectl to roll back an update if needed.</span></span> 

<span data-ttu-id="5c919-197">Si votre service effectue une tâche de démarrage longue, vous pouvez définir une détection de préparation.</span><span class="sxs-lookup"><span data-stu-id="5c919-197">If your service performs a long startup task, you can define a readiness probe.</span></span> <span data-ttu-id="5c919-198">Cette sonde de préparation signale quand le conteneur est prêt à recevoir le trafic.</span><span class="sxs-lookup"><span data-stu-id="5c919-198">The readiness probe reports when the container is ready to start receiving traffic.</span></span> <span data-ttu-id="5c919-199">Kubernetes n’envoie aucun trafic au pod avant l’aval de la sonde.</span><span class="sxs-lookup"><span data-stu-id="5c919-199">Kubernetes won't send traffic to the pod until the probe reports success.</span></span> 

<span data-ttu-id="5c919-200">L’une des difficultés liées aux mises à jour propagées est la confusion régnant durant le processus de mise à jour. À ce stade, une combinaison de versions anciennes et nouvelles exécute et reçoit le trafic.</span><span class="sxs-lookup"><span data-stu-id="5c919-200">One challenge of rolling updates is that during the update process, a mix of old and new versions are running and receiving traffic.</span></span> <span data-ttu-id="5c919-201">Pendant cette période, une requête peut être dirigée vers l’une ou l’autre des versions.</span><span class="sxs-lookup"><span data-stu-id="5c919-201">During this period, any request could get routed to either of the two versions.</span></span> <span data-ttu-id="5c919-202">Cela peut provoquer des problèmes, en fonction de l’ampleur des changements entre les deux versions.</span><span class="sxs-lookup"><span data-stu-id="5c919-202">That may or may not cause problems, depending on the scope of the changes between the two versions.</span></span> 

### <a name="blue-green-deployment"></a><span data-ttu-id="5c919-203">Déploiement bleu-vert</span><span class="sxs-lookup"><span data-stu-id="5c919-203">Blue-green deployment</span></span>

<span data-ttu-id="5c919-204">Dans un déploiement bleu-vert, il est possible de déployer la nouvelle version en parallèle de la version précédente.</span><span class="sxs-lookup"><span data-stu-id="5c919-204">In a blue-green deployment, you deploy the new version alongside the previous version.</span></span> <span data-ttu-id="5c919-205">Une fois la nouvelle version validée, vous basculez simultanément l’ensemble du trafic de l’ancienne version vers la nouvelle.</span><span class="sxs-lookup"><span data-stu-id="5c919-205">After you validate the new version, you switch all traffic at once from the previous version to the new version.</span></span> <span data-ttu-id="5c919-206">Après le basculement, vous vérifiez l’absence de problèmes dans l’application.</span><span class="sxs-lookup"><span data-stu-id="5c919-206">After the switch, you monitor the application for any problems.</span></span> <span data-ttu-id="5c919-207">Si une erreur survient, vous pouvez revenir à l’ancienne version.</span><span class="sxs-lookup"><span data-stu-id="5c919-207">If something goes wrong, you can swap back to the old version.</span></span> <span data-ttu-id="5c919-208">En supposant qu’il n’existe aucun problème, vous pouvez supprimer l’ancienne version.</span><span class="sxs-lookup"><span data-stu-id="5c919-208">Assuming there are no problems, you can delete the old version.</span></span>

<span data-ttu-id="5c919-209">Avec une application monolithique ou multiniveau plus traditionnelle, un déploiement bleu-vert est généralement synonyme d’approvisionnement de deux environnements identiques.</span><span class="sxs-lookup"><span data-stu-id="5c919-209">With a more traditional monolithic or N-tier application, blue-green deployment generally meant provisioning two identical environments.</span></span> <span data-ttu-id="5c919-210">Vous déployez alors la nouvelle version dans un environnement intermédiaire, avant de rediriger le trafic client vers l’environnement intermédiaire, par exemple, en échangeant les adresses IP virtuelles.</span><span class="sxs-lookup"><span data-stu-id="5c919-210">You would deploy the new version to a staging environment, then redirect client traffic to the staging environment &mdash; for example, by swapping VIP addresses.</span></span>

<span data-ttu-id="5c919-211">Dans Kubernetes, il n’est pas nécessaire d’approvisionner un cluster distinct pour procéder à des déploiements bleu-vert.</span><span class="sxs-lookup"><span data-stu-id="5c919-211">In Kubernetes, you don't need to provision a separate cluster to do blue-green deployments.</span></span> <span data-ttu-id="5c919-212">Ici, vous pouvez valoriser des sélecteurs.</span><span class="sxs-lookup"><span data-stu-id="5c919-212">Instead, you can take advantage of selectors.</span></span> <span data-ttu-id="5c919-213">Créez une nouvelle ressource de déploiement avec une nouvelle spécification de pods et un jeu différent d’étiquettes.</span><span class="sxs-lookup"><span data-stu-id="5c919-213">Create a new Deployment resource with a new pod spec and a different set of labels.</span></span> <span data-ttu-id="5c919-214">Créez ce déploiement, sans supprimer le déploiement précédent ni modifier le service pointant vers lui.</span><span class="sxs-lookup"><span data-stu-id="5c919-214">Create this deployment, without deleting the previous deployment or modifying the service that points to it.</span></span> <span data-ttu-id="5c919-215">Une fois que les nouveaux pods sont exécutés, vous pouvez mettre à jour le sélecteur du service en fonction du nouveau déploiement.</span><span class="sxs-lookup"><span data-stu-id="5c919-215">Once the new pods are running, you can update the service's selector to match the new deployment.</span></span> 

<span data-ttu-id="5c919-216">Avec les déploiements bleu-vert, le service bascule l’ensemble des pods au même moment.</span><span class="sxs-lookup"><span data-stu-id="5c919-216">An advantage of blue-green deployments is that the service switches all the pods at the same time.</span></span> <span data-ttu-id="5c919-217">Une fois que le service est mis à jour, toutes les nouvelles requêtes sont acheminées vers la nouvelle version.</span><span class="sxs-lookup"><span data-stu-id="5c919-217">After the service is updated, all new requests get routed to the new version.</span></span> <span data-ttu-id="5c919-218">L’un des inconvénients est que pendant la mise à jour, vous exécutez deux fois plus de pods pour le service (l’actuel et le suivant).</span><span class="sxs-lookup"><span data-stu-id="5c919-218">One drawback is that during the update, you are running twice as many pods for the service (current and next).</span></span> <span data-ttu-id="5c919-219">Si les pods nécessitent un volume important d’UC ou de ressources de mémoire, il vous faudra éventuellement augmenter temporairement la taille du cluster pour prendre en charge efficacement la consommation de ressources.</span><span class="sxs-lookup"><span data-stu-id="5c919-219">If the pods require a lot of CPU or memory resources, you may need to scale out the cluster temporarily to handle the resource consumption.</span></span> 

### <a name="canary-release"></a><span data-ttu-id="5c919-220">Contrôle la validité de la mise en production</span><span class="sxs-lookup"><span data-stu-id="5c919-220">Canary release</span></span>

<span data-ttu-id="5c919-221">Durant un contrôle de la validité de la mise en production, vous déployez une version mise à jour à un nombre réduit de clients.</span><span class="sxs-lookup"><span data-stu-id="5c919-221">In a canary release, you roll out an updated version to a small number of clients.</span></span> <span data-ttu-id="5c919-222">Ensuite, vous analysez le comportement du nouveau service avant de procéder à un déploiement plus large vers l’ensemble des clients.</span><span class="sxs-lookup"><span data-stu-id="5c919-222">Then you monitor the behavior of the new service before rolling it out to all clients.</span></span> <span data-ttu-id="5c919-223">Ainsi, vous contrôlez la mise en œuvre progressive du processus, observez les données réelles et identifiez les problèmes avant que l’ensemble des clients ne soient affectés.</span><span class="sxs-lookup"><span data-stu-id="5c919-223">This lets you do a slow rollout in a controlled fashion, observe real data, and spot problems before all customers are affected.</span></span>

<span data-ttu-id="5c919-224">La gestion de cette version est plus complexe que celle des versions bleu-vert et propagée, dans la mesure où vous devez diriger dynamiquement les requêtes vers différentes versions du service.</span><span class="sxs-lookup"><span data-stu-id="5c919-224">A canary release is more complex to manage than either blue-green or rolling update, because you must dynamically route requests to different versions of the service.</span></span> <span data-ttu-id="5c919-225">Dans Kubernetes, vous pouvez configurer un service pour une prise en charge de deux jeux de réplicas (un pour chaque version), avant de modifier manuellement au besoin la quantité de réplicas.</span><span class="sxs-lookup"><span data-stu-id="5c919-225">In Kubernetes, you can configure a Service to span two replica sets (one for each version) and adjust the replica counts manually.</span></span> <span data-ttu-id="5c919-226">Toutefois, cette approche présente une granularité plutôt grossière, en raison de la manière dont la charge de Kubernetes s’équilibre entre les pods.</span><span class="sxs-lookup"><span data-stu-id="5c919-226">However, this approach is rather coarse-grained, because of the way Kubernetes load balances across pods.</span></span> <span data-ttu-id="5c919-227">Par exemple, si vous disposez d’au total dix réplicas, vous pouvez modifier le trafic en incrément de 10 % uniquement.</span><span class="sxs-lookup"><span data-stu-id="5c919-227">For example, if you have a total of ten replicas, you can only shift traffic in 10% increments.</span></span> <span data-ttu-id="5c919-228">Si vous avez recours à une maille de service, vous pouvez solliciter les règles d’acheminement dédiées pour implémenter une stratégie de publication plus sophistiquée.</span><span class="sxs-lookup"><span data-stu-id="5c919-228">If you are using a service mesh, you can use the service mesh routing rules to implement a more sophisticated canary release strategy.</span></span> <span data-ttu-id="5c919-229">Voici quelques ressources qui peuvent vous être utiles :</span><span class="sxs-lookup"><span data-stu-id="5c919-229">Here are some resources that may be helpful:</span></span>

- <span data-ttu-id="5c919-230">Kubernetes sans maille de service : [contrôles de la validité de la mise en production](https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments)</span><span class="sxs-lookup"><span data-stu-id="5c919-230">Kubernetes without service mesh: [Canary deployments](https://kubernetes.io/docs/concepts/cluster-administration/manage-deployment/#canary-deployments)</span></span>
- <span data-ttu-id="5c919-231">Linkerd : [acheminement dynamique des requêtes](https://linkerd.io/features/routing/)</span><span class="sxs-lookup"><span data-stu-id="5c919-231">Linkerd: [Dynamic request routing](https://linkerd.io/features/routing/)</span></span>
- <span data-ttu-id="5c919-232">Istio : [contrôles de la validité de la mise en production à l’aide d’Istio](https://istio.io/blog/canary-deployments-using-istio.html)</span><span class="sxs-lookup"><span data-stu-id="5c919-232">Istio: [Canary Deployments using Istio](https://istio.io/blog/canary-deployments-using-istio.html)</span></span>

## <a name="conclusion"></a><span data-ttu-id="5c919-233">Conclusion</span><span class="sxs-lookup"><span data-stu-id="5c919-233">Conclusion</span></span>

<span data-ttu-id="5c919-234">Au cours des récentes années, le marché a subi une refonte majeure, en passant d’un modèle de développement de *systèmes d’enregistrement* à un modèle de mise en œuvre de *systèmes d’engagement*.</span><span class="sxs-lookup"><span data-stu-id="5c919-234">In recent years, there has been a sea change in the industry, a movement from building *systems of record* to building *systems of engagement*.</span></span>

<span data-ttu-id="5c919-235">Les systèmes d’enregistrement sont des applications traditionnelles de gestion des données back-office.</span><span class="sxs-lookup"><span data-stu-id="5c919-235">Systems of record are traditional back-office data management applications.</span></span> <span data-ttu-id="5c919-236">Au cœur de ces systèmes est bien souvent hébergé un système SGBDR, qui est le cas échéant la source unique de vérité.</span><span class="sxs-lookup"><span data-stu-id="5c919-236">At the heart of these systems there often sits an RDBMS that is the single source of truth.</span></span> <span data-ttu-id="5c919-237">L’expression « système d’engagement » a été inventée par Geoffrey Moore, dans son article paru en 2011 *Systems of Engagement and the Future of Enterprise IT* (Systèmes d’engagement et l’avenir de l’informatique d’entreprise).</span><span class="sxs-lookup"><span data-stu-id="5c919-237">The term "system of engagement" is credited to Geoffrey Moore, in his 2011 paper *Systems of Engagement and the Future of Enterprise IT*.</span></span> <span data-ttu-id="5c919-238">Les systèmes d’engagement sont des applications axées sur la communication et la collaboration.</span><span class="sxs-lookup"><span data-stu-id="5c919-238">Systems of engagement are applications focused on communication and collaboration.</span></span> <span data-ttu-id="5c919-239">Ils connectent les personnes en temps réel.</span><span class="sxs-lookup"><span data-stu-id="5c919-239">They connect people in real time.</span></span> <span data-ttu-id="5c919-240">Ils doivent être disponibles 24h/24 et 7j/7.</span><span class="sxs-lookup"><span data-stu-id="5c919-240">They must be available 24/7.</span></span> <span data-ttu-id="5c919-241">De nouvelles fonctionnalités sont régulièrement introduites, sans mise hors connexion des applications.</span><span class="sxs-lookup"><span data-stu-id="5c919-241">New features are introduced regularly without taking the application offline.</span></span> <span data-ttu-id="5c919-242">Les utilisateurs sont davantage exigeants et plus impatients vis-à-vis des délais inattendus ou des périodes d’interruption.</span><span class="sxs-lookup"><span data-stu-id="5c919-242">Users expect more and are less patient of unexpected delays or downtime.</span></span>

<span data-ttu-id="5c919-243">Au sein du marché de la consommation, une amélioration de l’expérience utilisateur peut constituer une valeur métier quantifiable.</span><span class="sxs-lookup"><span data-stu-id="5c919-243">In the consumer space, a better user experience can have measurable business value.</span></span> <span data-ttu-id="5c919-244">La durée pendant laquelle un utilisateur interagit avec une application peut se traduire directement en revenus.</span><span class="sxs-lookup"><span data-stu-id="5c919-244">The amount of time that a user engages with an application may translate directly into revenue.</span></span> <span data-ttu-id="5c919-245">Dans l’univers des systèmes d’entreprise, les attentes des utilisateurs ont évolué.</span><span class="sxs-lookup"><span data-stu-id="5c919-245">And in the realm of business systems, users' expectations have changed.</span></span> <span data-ttu-id="5c919-246">Si ces systèmes visent à encourager la communication et la collaboration, ils doivent être inspirés des applications orientées consommateur.</span><span class="sxs-lookup"><span data-stu-id="5c919-246">If these systems aim to foster communication and collaboration, they must take their cue from consumer-facing applications.</span></span>

<span data-ttu-id="5c919-247">Les microservices sont une réponse à cette évolution.</span><span class="sxs-lookup"><span data-stu-id="5c919-247">Microservices are a response to this changing landscape.</span></span> <span data-ttu-id="5c919-248">En décomposant une application monolithique en groupe de services sommairement liés, nous sommes en mesure de réguler la publication de chaque service et de mettre en œuvre des mises à jour fréquentes sans déplorer de périodes d’interruption ni bouleversement fondamental.</span><span class="sxs-lookup"><span data-stu-id="5c919-248">By decomposing a monolithic application into a group of loosely coupled services, we can control the release cycle of each service, and enable frequent updates without downtime or breaking changes.</span></span> <span data-ttu-id="5c919-249">Les microservices, par ailleurs, présentent des avantages en matière d’évolutivité, d’isolation des défaillances et de résilience.</span><span class="sxs-lookup"><span data-stu-id="5c919-249">Microservices also help with scalability, failure isolation, and resiliency.</span></span> <span data-ttu-id="5c919-250">Parallèlement, les plateformes cloud simplifient le développement et l’exécution des microservices, avec un approvisionnement automatisé des ressources de calcul, des orchestrateurs de conteneur en tant que service et des environnements sans serveur basés sur les événements.</span><span class="sxs-lookup"><span data-stu-id="5c919-250">Meanwhile, cloud platforms are making it easier to build and run microservices, with automated provisioning of compute resources, container orchestrators as a service, and event-driven serverless environments.</span></span>

<span data-ttu-id="5c919-251">Cependant, comme nous l’avons vu, les architectures de microservices présentent de nombreuses difficultés.</span><span class="sxs-lookup"><span data-stu-id="5c919-251">But as we've seen, microservices architectures also being a lot of challenges.</span></span> <span data-ttu-id="5c919-252">Pour réussir, vous devez partir d’une conception robuste.</span><span class="sxs-lookup"><span data-stu-id="5c919-252">To succeed, you must start from a solid design.</span></span> <span data-ttu-id="5c919-253">Il est nécessaire d’analyser soigneusement le domaine, et de prendre soin de bien choisir les technologies, modéliser les données et concevoir les API tout en veillant à instaurer une culture DevOps mature.</span><span class="sxs-lookup"><span data-stu-id="5c919-253">You must put careful thought into analyzing the domain, choosing technologies, modeling data, designing APIs, and building a mature DevOps culture.</span></span> <span data-ttu-id="5c919-254">Nous espérons que ce guide et l’[implémentation de référence](https://github.com/mspnp/microservices-reference-implementation) associée vous ont éclairé la voie sur le chemin de la réussite.</span><span class="sxs-lookup"><span data-stu-id="5c919-254">We hope that this guide, and the accompanying [reference implementation](https://github.com/mspnp/microservices-reference-implementation), has helped to illuminate the journey.</span></span> 

