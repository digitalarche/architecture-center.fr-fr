---
title: Application multiniveau multirégion pour une haute disponibilité
titleSuffix: Azure Reference Architectures
description: Déployez une application sur des machines virtuelles Azure dans plusieurs régions pour bénéficier d’une haute disponibilité et d’un haut niveau de résilience.
author: MikeWasson
ms.date: 07/19/2018
ms.custom: seodec18
ms.openlocfilehash: 5036d8c74dbf92d9547ab866b15b1576df48e3eb
ms.sourcegitcommit: 88a68c7e9b6b772172b7faa4b9fd9c061a9f7e9d
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 12/08/2018
ms.locfileid: "53119997"
---
# <a name="run-an-n-tier-application-in-multiple-azure-regions-for-high-availability"></a><span data-ttu-id="3d9a5-103">Exécuter une application multiniveau dans plusieurs régions pour une haute disponibilité</span><span class="sxs-lookup"><span data-stu-id="3d9a5-103">Run an N-tier application in multiple Azure regions for high availability</span></span>

<span data-ttu-id="3d9a5-104">Cette architecture de référence présente un ensemble de pratiques éprouvées pour l’exécution d’une application multiniveau dans plusieurs régions Azure, afin de bénéficier d’une haute disponibilité et d’une infrastructure de récupération d’urgence fiable.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-104">This reference architecture shows a set of proven practices for running an N-tier application in multiple Azure regions, in order to achieve availability and a robust disaster recovery infrastructure.</span></span>

![Architecture réseau à haute disponibilité pour les applications multiniveaux Azure"](./images/multi-region-sql-server.png)

<span data-ttu-id="3d9a5-106">*Téléchargez un [fichier Visio][visio-download] de cette architecture.*</span><span class="sxs-lookup"><span data-stu-id="3d9a5-106">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="3d9a5-107">Architecture</span><span class="sxs-lookup"><span data-stu-id="3d9a5-107">Architecture</span></span>

<span data-ttu-id="3d9a5-108">Cette architecture repose sur celle décrite dans l’article [Application multiniveau avec SQL Server](n-tier-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="3d9a5-108">This architecture builds on the one shown in [N-tier application with SQL Server](n-tier-sql-server.md).</span></span>

- <span data-ttu-id="3d9a5-109">**Régions primaires et secondaires**.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-109">**Primary and secondary regions**.</span></span> <span data-ttu-id="3d9a5-110">Pour obtenir une plus haute disponibilité, utilisez deux régions.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-110">Use two regions to achieve higher availability.</span></span> <span data-ttu-id="3d9a5-111">L’une est la région primaire,</span><span class="sxs-lookup"><span data-stu-id="3d9a5-111">One is the primary region.</span></span> <span data-ttu-id="3d9a5-112">tandis que l’autre sert au basculement.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-112">The other region is for failover.</span></span>

- <span data-ttu-id="3d9a5-113">**Azure Traffic Manager**.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-113">**Azure Traffic Manager**.</span></span> <span data-ttu-id="3d9a5-114">[Traffic Manager][traffic-manager] achemine les requêtes entrantes vers l’une des régions.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-114">[Traffic Manager][traffic-manager] routes incoming requests to one of the regions.</span></span> <span data-ttu-id="3d9a5-115">Pendant le fonctionnement normal, il achemine les requêtes vers la région primaire.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-115">During normal operations, it routes requests to the primary region.</span></span> <span data-ttu-id="3d9a5-116">Si cette région n’est plus disponible, Traffic Manager bascule vers la région secondaire.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-116">If that region becomes unavailable, Traffic Manager fails over to the secondary region.</span></span> <span data-ttu-id="3d9a5-117">Pour plus d’informations, consultez la section [Configuration de Traffic Manager](#traffic-manager-configuration).</span><span class="sxs-lookup"><span data-stu-id="3d9a5-117">For more information, see the section [Traffic Manager configuration](#traffic-manager-configuration).</span></span>

- <span data-ttu-id="3d9a5-118">**Groupes de ressources**.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-118">**Resource groups**.</span></span> <span data-ttu-id="3d9a5-119">Créez des [groupes de ressources][resource groups] distincts pour la région primaire, la région secondaire et Traffic Manager.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-119">Create separate [resource groups][resource groups] for the primary region, the secondary region, and for Traffic Manager.</span></span> <span data-ttu-id="3d9a5-120">Vous obtenez ainsi la flexibilité nécessaire pour gérer chaque région comme une collection de ressources unique.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-120">This gives you the flexibility to manage each region as a single collection of resources.</span></span> <span data-ttu-id="3d9a5-121">Par exemple, vous pourriez redéployer une région sans arrêter l’autre.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-121">For example, you could redeploy one region, without taking down the other one.</span></span> <span data-ttu-id="3d9a5-122">[Liez les groupes de ressources][resource-group-links] afin de pouvoir exécuter une requête pour répertorier toutes les ressources de l’application.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-122">[Link the resource groups][resource-group-links], so that you can run a query to list all the resources for the application.</span></span>

- <span data-ttu-id="3d9a5-123">**Réseaux virtuels**.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-123">**VNets**.</span></span> <span data-ttu-id="3d9a5-124">Créez un réseau virtuel distinct pour chaque région.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-124">Create a separate VNet for each region.</span></span> <span data-ttu-id="3d9a5-125">Vérifiez que les espaces d’adressage ne se chevauchent pas.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-125">Make sure the address spaces do not overlap.</span></span>

- <span data-ttu-id="3d9a5-126">**Groupe de disponibilité SQL Server AlwaysOn**.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-126">**SQL Server Always On Availability Group**.</span></span> <span data-ttu-id="3d9a5-127">Si vous utilisez SQL Server, nous vous recommandons d’utiliser des [groupes de disponibilité AlwaysOn SQL][sql-always-on] pour la haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-127">If you are using SQL Server, we recommend [SQL Always On Availability Groups][sql-always-on] for high availability.</span></span> <span data-ttu-id="3d9a5-128">Créez un groupe de disponibilité unique qui comprend les instances de SQL Server dans les deux régions.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-128">Create a single availability group that includes the SQL Server instances in both regions.</span></span>

    > [!NOTE]
    > <span data-ttu-id="3d9a5-129">Vous pouvez aussi utiliser [Azure SQL Database][azure-sql-db], qui fournit une base de données relationnelle en tant que service cloud.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-129">Also consider [Azure SQL Database][azure-sql-db], which provides a relational database as a cloud service.</span></span> <span data-ttu-id="3d9a5-130">Avec SQL Database, vous n’avez pas besoin de configurer de groupe de disponibilité ni de gérer le basculement.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-130">With SQL Database, you don't need to configure an availability group or manage failover.</span></span>
    >

- <span data-ttu-id="3d9a5-131">**Passerelles VPN**.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-131">**VPN Gateways**.</span></span> <span data-ttu-id="3d9a5-132">Créez une [passerelle VPN][vpn-gateway] dans chaque réseau virtuel et configurez une [connexion de réseau virtuel à réseau virtuel][vnet-to-vnet] afin d’autoriser le trafic réseau entre les deux réseaux virtuels.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-132">Create a [VPN gateway][vpn-gateway] in each VNet, and configure a [VNet-to-VNet connection][vnet-to-vnet], to enable network traffic between the two VNets.</span></span> <span data-ttu-id="3d9a5-133">Ceci est obligatoire pour le groupe de disponibilité AlwaysOn SQL.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-133">This is required for the SQL Always On Availability Group.</span></span>

## <a name="recommendations"></a><span data-ttu-id="3d9a5-134">Recommandations</span><span class="sxs-lookup"><span data-stu-id="3d9a5-134">Recommendations</span></span>

<span data-ttu-id="3d9a5-135">Une architecture multirégion peut offrir une meilleure disponibilité qu’un déploiement dans une seule région.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-135">A multi-region architecture can provide higher availability than deploying to a single region.</span></span> <span data-ttu-id="3d9a5-136">Si une interruption de service régionale affecte la région primaire, vous pouvez utiliser [Traffic Manager][traffic-manager] pour basculer vers la région secondaire.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-136">If a regional outage affects the primary region, you can use [Traffic Manager][traffic-manager] to fail over to the secondary region.</span></span> <span data-ttu-id="3d9a5-137">Cette architecture peut également se révéler utile en cas de défaillance d’un sous-système spécifique de l’application.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-137">This architecture can also help if an individual subsystem of the application fails.</span></span>

<span data-ttu-id="3d9a5-138">Plusieurs approches générales permettent de bénéficier d’une haute disponibilité dans l’ensemble des régions :</span><span class="sxs-lookup"><span data-stu-id="3d9a5-138">There are several general approaches to achieving high availability across regions:</span></span>

- <span data-ttu-id="3d9a5-139">Mode actif/passif avec serveur de secours.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-139">Active/passive with hot standby.</span></span> <span data-ttu-id="3d9a5-140">Le trafic est dirigé vers une région, tandis que l’autre région est en attente sur le serveur de secours.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-140">Traffic goes to one region, while the other waits on hot standby.</span></span> <span data-ttu-id="3d9a5-141">Le terme « serveur de secours » signifie que les machines virtuelles de la région secondaire sont allouées et en cours d’exécution en permanence.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-141">Hot standby means the VMs in the secondary region are allocated and running at all times.</span></span>
- <span data-ttu-id="3d9a5-142">Mode actif/passif avec reprise progressive.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-142">Active/passive with cold standby.</span></span> <span data-ttu-id="3d9a5-143">Le trafic est dirigé vers une région, tandis que l’autre région est en attente sur le centre de données de reprise progressive.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-143">Traffic goes to one region, while the other waits on cold standby.</span></span> <span data-ttu-id="3d9a5-144">Le terme « reprise progressive » signifie que les machines virtuelles de la région secondaire ne sont pas allouées tant qu’elles ne sont pas requises pour le basculement.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-144">Cold standby means the VMs in the secondary region are not allocated until needed for failover.</span></span> <span data-ttu-id="3d9a5-145">La mise en œuvre de cette approche se révèle moins coûteuse, mais nécessite davantage de temps en cas de défaillance.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-145">This approach costs less to run, but will generally take longer to come online during a failure.</span></span>
- <span data-ttu-id="3d9a5-146">Mode actif/actif.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-146">Active/active.</span></span> <span data-ttu-id="3d9a5-147">Les deux régions sont actives, et la charge de travail des requêtes est équilibrée entre les régions.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-147">Both regions are active, and requests are load balanced between them.</span></span> <span data-ttu-id="3d9a5-148">Si l’une des régions n’est plus disponible, elle est mise hors service.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-148">If one region becomes unavailable, it is taken out of rotation.</span></span>

<span data-ttu-id="3d9a5-149">Cette architecture de référence est axée sur le mode actif/passif avec serveur de secours, et utilise Traffic Manager pour le basculement.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-149">This reference architecture focuses on active/passive with hot standby, using Traffic Manager for failover.</span></span> <span data-ttu-id="3d9a5-150">Notez que vous pouvez déployer un petit nombre de machines virtuelles pour le serveur de secours, puis monter en charge en fonction des besoins.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-150">Note that you could deploy a small number of VMs for hot standby and then scale out as needed.</span></span>

### <a name="regional-pairing"></a><span data-ttu-id="3d9a5-151">Association régionale</span><span class="sxs-lookup"><span data-stu-id="3d9a5-151">Regional pairing</span></span>

<span data-ttu-id="3d9a5-152">Chaque région Azure est associée à une autre région de la même zone géographique.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-152">Each Azure region is paired with another region within the same geography.</span></span> <span data-ttu-id="3d9a5-153">En général, vous devez choisir des régions de la même paire régionale (par exemple, USA Est 2 et USA Centre).</span><span class="sxs-lookup"><span data-stu-id="3d9a5-153">In general, choose regions from the same regional pair (for example, East US 2 and US Central).</span></span> <span data-ttu-id="3d9a5-154">Cette approche offre les avantages suivants :</span><span class="sxs-lookup"><span data-stu-id="3d9a5-154">Benefits of doing so include:</span></span>

- <span data-ttu-id="3d9a5-155">En cas d’interruption de service générale, la récupération d’au moins une région de chaque paire est prioritaire.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-155">If there is a broad outage, recovery of at least one region out of every pair is prioritized.</span></span>
- <span data-ttu-id="3d9a5-156">Les mises à jour planifiées du système Azure sont déployées dans les régions associées de manière séquentielle, afin de minimiser les temps d’arrêt possibles.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-156">Planned Azure system updates are rolled out to paired regions sequentially, to minimize possible downtime.</span></span>
- <span data-ttu-id="3d9a5-157">Les paires régionales appartiennent à la même zone géographique, afin de répondre aux exigences en matière de résidence des données.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-157">Pairs reside within the same geography, to meet data residency requirements.</span></span>

<span data-ttu-id="3d9a5-158">Toutefois, vous devez vérifier que les deux régions prennent en charge tous les services Azure nécessaires pour votre application (voir [Services par région][services-by-region]).</span><span class="sxs-lookup"><span data-stu-id="3d9a5-158">However, make sure that both regions support all of the Azure services needed for your application (see [Services by region][services-by-region]).</span></span> <span data-ttu-id="3d9a5-159">Pour plus d’informations sur les régions jumelées, consultez l’article [Continuité des activités et récupération d’urgence (BCDR) : régions jumelées d’Azure][regional-pairs].</span><span class="sxs-lookup"><span data-stu-id="3d9a5-159">For more information about regional pairs, see [Business continuity and disaster recovery (BCDR): Azure Paired Regions][regional-pairs].</span></span>

### <a name="traffic-manager-configuration"></a><span data-ttu-id="3d9a5-160">Configuration de Traffic Manager</span><span class="sxs-lookup"><span data-stu-id="3d9a5-160">Traffic Manager configuration</span></span>

<span data-ttu-id="3d9a5-161">Considérez les points suivants lors de la configuration de Traffic Manager :</span><span class="sxs-lookup"><span data-stu-id="3d9a5-161">Consider the following points when configuring Traffic Manager:</span></span>

- <span data-ttu-id="3d9a5-162">**Routage**.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-162">**Routing**.</span></span> <span data-ttu-id="3d9a5-163">Traffic Manager prend en charge plusieurs [algorithmes de routage][tm-routing].</span><span class="sxs-lookup"><span data-stu-id="3d9a5-163">Traffic Manager supports several [routing algorithms][tm-routing].</span></span> <span data-ttu-id="3d9a5-164">Pour le scénario décrit dans cet article, utilisez le routage *par priorité* (auparavant désigné sous le terme de routage *par basculement*).</span><span class="sxs-lookup"><span data-stu-id="3d9a5-164">For the scenario described in this article, use *priority* routing (formerly called *failover* routing).</span></span> <span data-ttu-id="3d9a5-165">Quand cette méthode de routage est configurée, Traffic Manager envoie toutes les requêtes à la région primaire, sauf si elle devient inaccessible.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-165">With this setting, Traffic Manager sends all requests to the primary region, unless the primary region becomes unreachable.</span></span> <span data-ttu-id="3d9a5-166">À ce moment-là, les requêtes basculent automatiquement vers la région secondaire.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-166">At that point, it automatically fails over to the secondary region.</span></span> <span data-ttu-id="3d9a5-167">Consultez [Configurer la méthode de routage de basculement][tm-configure-failover].</span><span class="sxs-lookup"><span data-stu-id="3d9a5-167">See [Configure Failover routing method][tm-configure-failover].</span></span>
- <span data-ttu-id="3d9a5-168">**Sonde d’intégrité**.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-168">**Health probe**.</span></span> <span data-ttu-id="3d9a5-169">Traffic Manager utilise une [sonde][tm-monitoring] HTTP (ou HTTPS) pour surveiller la disponibilité de chaque région.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-169">Traffic Manager uses an HTTP (or HTTPS) [probe][tm-monitoring] to monitor the availability of each region.</span></span> <span data-ttu-id="3d9a5-170">La sonde vérifie la présence d’une réponse HTTP 200 pour un chemin d’URL spécifié.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-170">The probe checks for an HTTP 200 response for a specified URL path.</span></span> <span data-ttu-id="3d9a5-171">Une bonne pratique consiste à créer un point de terminaison qui signale l’intégrité globale de l’application et à utiliser ce point de terminaison pour la sonde d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-171">As a best practice, create an endpoint that reports the overall health of the application, and use this endpoint for the health probe.</span></span> <span data-ttu-id="3d9a5-172">Dans le cas contraire, la sonde risque de signaler un point de terminaison intègre alors que des parties critiques de l’application sont défaillantes.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-172">Otherwise, the probe might report a healthy endpoint when critical parts of the application are actually failing.</span></span> <span data-ttu-id="3d9a5-173">Pour plus d’informations, consultez [Modèle de surveillance de point de terminaison d’intégrité][health-endpoint-monitoring-pattern].</span><span class="sxs-lookup"><span data-stu-id="3d9a5-173">For more information, see [Health Endpoint Monitoring Pattern][health-endpoint-monitoring-pattern].</span></span>

<span data-ttu-id="3d9a5-174">Quand Traffic Manager déclenche un basculement, l’application reste inaccessible aux clients pendant un certain laps de temps.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-174">When Traffic Manager fails over there is a period of time when clients cannot reach the application.</span></span> <span data-ttu-id="3d9a5-175">Ce laps de temps dépend des facteurs suivants :</span><span class="sxs-lookup"><span data-stu-id="3d9a5-175">The duration is affected by the following factors:</span></span>

- <span data-ttu-id="3d9a5-176">La sonde d’intégrité doit détecter que la région primaire est devenue inaccessible.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-176">The health probe must detect that the primary region has become unreachable.</span></span>
- <span data-ttu-id="3d9a5-177">Les serveurs DNS (Domain Name Service) doivent mettre à jour les enregistrements DNS mis en cache pour l’adresse IP, qui dépend de la durée de vie (TTL) DNS.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-177">DNS servers must update the cached DNS records for the IP address, which depends on the DNS time-to-live (TTL).</span></span> <span data-ttu-id="3d9a5-178">La valeur TTL par défaut est de 300 secondes (5 minutes), mais vous pouvez configurer cette valeur quand vous créez le profil Traffic Manager.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-178">The default TTL is 300 seconds (5 minutes), but you can configure this value when you create the Traffic Manager profile.</span></span>

<span data-ttu-id="3d9a5-179">Pour plus d’informations, consultez [À propos de la surveillance de Traffic Manager][tm-monitoring].</span><span class="sxs-lookup"><span data-stu-id="3d9a5-179">For details, see [About Traffic Manager Monitoring][tm-monitoring].</span></span>

<span data-ttu-id="3d9a5-180">En cas de basculement de Traffic Manager, nous vous recommandons de procéder à une restauration manuelle plutôt que d’implémenter une restauration automatique.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-180">If Traffic Manager fails over, we recommend performing a manual failback rather than implementing an automatic failback.</span></span> <span data-ttu-id="3d9a5-181">Dans le cas contraire, l’application risque d’alterner continuellement entre les régions.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-181">Otherwise, you can create a situation where the application flips back and forth between regions.</span></span> <span data-ttu-id="3d9a5-182">Vérifiez que tous les sous-systèmes de l’application sont intègres avant d’effectuer la restauration automatique.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-182">Verify that all application subsystems are healthy before failing back.</span></span>

<span data-ttu-id="3d9a5-183">Notez que Traffic Manager procède à une restauration automatique par défaut.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-183">Note that Traffic Manager automatically fails back by default.</span></span> <span data-ttu-id="3d9a5-184">Pour éviter cela, diminuez manuellement la priorité de la région primaire après un événement de basculement.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-184">To prevent this, manually lower the priority of the primary region after a failover event.</span></span> <span data-ttu-id="3d9a5-185">Par exemple, supposez que la région primaire a la priorité 1, et que la base de données secondaire a la priorité 2.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-185">For example, suppose the primary region is priority 1 and the secondary is priority 2.</span></span> <span data-ttu-id="3d9a5-186">Après un basculement, définissez la priorité de la région primaire sur la valeur 3 afin d’empêcher la restauration automatique.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-186">After a failover, set the primary region to priority 3, to prevent automatic failback.</span></span> <span data-ttu-id="3d9a5-187">Quand vous êtes prêt à rebasculer vers cette région, redéfinissez sa priorité sur la valeur 1.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-187">When you are ready to switch back, update the priority to 1.</span></span>

<span data-ttu-id="3d9a5-188">La commande [Azure CLI][azure-cli] suivante met à jour la priorité :</span><span class="sxs-lookup"><span data-stu-id="3d9a5-188">The following [Azure CLI][azure-cli] command updates the priority:</span></span>

```azurecli
az network traffic-manager endpoint update --resource-group <resource-group> --profile-name <profile>
    --name <endpoint-name> --type azureEndpoints --priority 3
```

<span data-ttu-id="3d9a5-189">Une autre approche consiste à désactiver temporairement le point de terminaison jusqu’à ce que vous soyez prêt à effectuer la restauration automatique :</span><span class="sxs-lookup"><span data-stu-id="3d9a5-189">Another approach is to temporarily disable the endpoint until you are ready to fail back:</span></span>

```azurecli
az network traffic-manager endpoint update --resource-group <resource-group> --profile-name <profile>
    --name <endpoint-name> --type azureEndpoints --endpoint-status Disabled
```

<span data-ttu-id="3d9a5-190">En fonction de la cause d’un basculement, vous devrez peut-être redéployer les ressources au sein d’une région.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-190">Depending on the cause of a failover, you might need to redeploy the resources within a region.</span></span> <span data-ttu-id="3d9a5-191">Avant d’effectuer une restauration automatique, exécutez un test de disponibilité opérationnelle.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-191">Before failing back, perform an operational readiness test.</span></span> <span data-ttu-id="3d9a5-192">Le test doit vérifier entre autres ce qui suit :</span><span class="sxs-lookup"><span data-stu-id="3d9a5-192">The test should verify things like:</span></span>

- <span data-ttu-id="3d9a5-193">Les machines virtuelles sont configurées correctement.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-193">VMs are configured correctly.</span></span> <span data-ttu-id="3d9a5-194">(Tous les logiciels nécessaires sont installés, IIS est en cours d’exécution, et ainsi de suite.)</span><span class="sxs-lookup"><span data-stu-id="3d9a5-194">(All required software is installed, IIS is running, and so on.)</span></span>
- <span data-ttu-id="3d9a5-195">Les sous-systèmes d’application sont intègres.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-195">Application subsystems are healthy.</span></span>
- <span data-ttu-id="3d9a5-196">Test fonctionnel.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-196">Functional testing.</span></span> <span data-ttu-id="3d9a5-197">(Par exemple, le niveau de la base de données est accessible à partir du niveau Web.)</span><span class="sxs-lookup"><span data-stu-id="3d9a5-197">(For example, the database tier is reachable from the web tier.)</span></span>

### <a name="configure-sql-server-always-on-availability-groups"></a><span data-ttu-id="3d9a5-198">Configurer les groupes de disponibilité SQL Server AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="3d9a5-198">Configure SQL Server Always On Availability Groups</span></span>

<span data-ttu-id="3d9a5-199">Avec les versions antérieures à Windows Server 2016, les groupes de disponibilité SQL Server AlwaysOn nécessitent un contrôleur de domaine et tous les nœuds du groupe de disponibilité doivent être dans le même domaine Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="3d9a5-199">Prior to Windows Server 2016, SQL Server Always On Availability Groups require a domain controller, and all nodes in the availability group must be in the same Active Directory (AD) domain.</span></span>

<span data-ttu-id="3d9a5-200">Pour configurer le groupe de disponibilité</span><span class="sxs-lookup"><span data-stu-id="3d9a5-200">To configure the availability group:</span></span>

- <span data-ttu-id="3d9a5-201">Au minimum, placez deux contrôleurs de domaine dans chaque région.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-201">At a minimum, place two domain controllers in each region.</span></span>
- <span data-ttu-id="3d9a5-202">Donnez à chaque contrôleur de domaine une adresse IP statique.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-202">Give each domain controller a static IP address.</span></span>
- <span data-ttu-id="3d9a5-203">Créez une connexion de réseau virtuel à réseau virtuel pour permettre la communication entre les réseaux virtuels.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-203">Create a VNet-to-VNet connection to enable communication between the VNets.</span></span>
- <span data-ttu-id="3d9a5-204">Pour chaque réseau virtuel, ajoutez les adresses IP des contrôleurs de domaine (des deux régions) à la liste des serveurs DNS.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-204">For each VNet, add the IP addresses of the domain controllers (from both regions) to the DNS server list.</span></span> <span data-ttu-id="3d9a5-205">Vous pouvez utiliser la commande CLI suivante.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-205">You can use the following CLI command.</span></span> <span data-ttu-id="3d9a5-206">Pour plus d’informations, consultez [Modifier les serveurs DNS][vnet-dns].</span><span class="sxs-lookup"><span data-stu-id="3d9a5-206">For more information, see [Change DNS servers][vnet-dns].</span></span>

    ```azurecli
    az network vnet update --resource-group <resource-group> --name <vnet-name> --dns-servers "10.0.0.4,10.0.0.6,172.16.0.4,172.16.0.6"
    ```

- <span data-ttu-id="3d9a5-207">Créez un cluster [WSFC (Clustering de basculement Windows Server)][wsfc] qui inclut les instances de SQL Server dans les deux régions.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-207">Create a [Windows Server Failover Clustering][wsfc] (WSFC) cluster that includes the SQL Server instances in both regions.</span></span>
- <span data-ttu-id="3d9a5-208">Créez un groupe de disponibilité SQL Server AlwaysOn qui inclut les instances de SQL Server dans les régions primaire et secondaire.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-208">Create a SQL Server Always On Availability Group that includes the SQL Server instances in both the primary and secondary regions.</span></span> <span data-ttu-id="3d9a5-209">Pour connaître les étapes, consultez [Extending AlwaysOn Availability Group to Remote Azure Datacenter (PowerShell) (Extension de groupe de disponibilité AlwaysOn à un centre de données Azure à distance (PowerShell)](https://blogs.msdn.microsoft.com/sqlcat/2014/09/22/extending-alwayson-availability-group-to-remote-azure-datacenter-powershell/).</span><span class="sxs-lookup"><span data-stu-id="3d9a5-209">See [Extending Always On Availability Group to Remote Azure Datacenter (PowerShell)](https://blogs.msdn.microsoft.com/sqlcat/2014/09/22/extending-alwayson-availability-group-to-remote-azure-datacenter-powershell/) for the steps.</span></span>

  - <span data-ttu-id="3d9a5-210">Placez le réplica principal dans la région primaire.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-210">Put the primary replica in the primary region.</span></span>
  - <span data-ttu-id="3d9a5-211">Placez un ou plusieurs réplicas secondaires dans la région primaire.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-211">Put one or more secondary replicas in the primary region.</span></span> <span data-ttu-id="3d9a5-212">Configurez-les pour qu’ils utilisent la validation synchrone avec basculement automatique.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-212">Configure these to use synchronous commit with automatic failover.</span></span>
  - <span data-ttu-id="3d9a5-213">Placez un ou plusieurs réplicas secondaires dans la région secondaire.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-213">Put one or more secondary replicas in the secondary region.</span></span> <span data-ttu-id="3d9a5-214">Pour des raisons de performances, configurez-les afin qu’ils utilisent la validation *asynchrone*.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-214">Configure these to use *asynchronous* commit, for performance reasons.</span></span> <span data-ttu-id="3d9a5-215">(Dans le cas contraire, toutes les transactions T-SQL doivent attendre un aller-retour sur le réseau vers la région secondaire.)</span><span class="sxs-lookup"><span data-stu-id="3d9a5-215">(Otherwise, all T-SQL transactions have to wait on a round trip over the network to the secondary region.)</span></span>

    > [!NOTE]
    > <span data-ttu-id="3d9a5-216">Les réplicas avec validation asynchrone ne prennent pas en charge le basculement automatique.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-216">Asynchronous commit replicas do not support automatic failover.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="3d9a5-217">Considérations relatives à la disponibilité</span><span class="sxs-lookup"><span data-stu-id="3d9a5-217">Availability considerations</span></span>

<span data-ttu-id="3d9a5-218">Avec une application multiniveau complexe, vous n’aurez peut-être pas besoin de répliquer l’ensemble de l’application dans la région secondaire.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-218">With a complex N-tier app, you may not need to replicate the entire application in the secondary region.</span></span> <span data-ttu-id="3d9a5-219">Au lieu de cela, vous pourrez simplement répliquer un sous-système critique nécessaire pour prendre en charge la continuité d’activité.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-219">Instead, you might just replicate a critical subsystem that is needed to support business continuity.</span></span>

<span data-ttu-id="3d9a5-220">Traffic Manager est un point de défaillance possible dans le système.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-220">Traffic Manager is a possible failure point in the system.</span></span> <span data-ttu-id="3d9a5-221">Si le service Traffic Manager échoue, les clients ne peuvent plus accéder à votre application pendant le temps d’arrêt.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-221">If the Traffic Manager service fails, clients cannot access your application during the downtime.</span></span> <span data-ttu-id="3d9a5-222">Examinez le [Contrat de niveau de service (SLA) pour Traffic Manager][tm-sla] et déterminez si Traffic Manager peut à lui seul répondre à vos exigences métiers en matière de haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-222">Review the [Traffic Manager SLA][tm-sla], and determine whether using Traffic Manager alone meets your business requirements for high availability.</span></span> <span data-ttu-id="3d9a5-223">Si ce n’est pas le cas, ajoutez une autre solution de gestion du trafic en tant que restauration automatique.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-223">If not, consider adding another traffic management solution as a failback.</span></span> <span data-ttu-id="3d9a5-224">Si le service Azure Traffic Manager échoue, modifiez vos enregistrements CNAME dans DNS pour qu’ils pointent vers l’autre service de gestion du trafic.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-224">If the Azure Traffic Manager service fails, change your CNAME records in DNS to point to the other traffic management service.</span></span> <span data-ttu-id="3d9a5-225">(Cette opération doit être effectuée manuellement, et votre application reste inaccessible tant que ces modifications DNS n’ont pas été propagées.)</span><span class="sxs-lookup"><span data-stu-id="3d9a5-225">(This step must be performed manually, and your application will be unavailable until the DNS changes are propagated.)</span></span>

<span data-ttu-id="3d9a5-226">Pour le cluster SQL Server, deux scénarios de basculement doivent être pris en compte :</span><span class="sxs-lookup"><span data-stu-id="3d9a5-226">For the SQL Server cluster, there are two failover scenarios to consider:</span></span>

- <span data-ttu-id="3d9a5-227">Tous les réplicas de base de données SQL Server dans la région primaire échouent.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-227">All of the SQL Server database replicas in the primary region fail.</span></span> <span data-ttu-id="3d9a5-228">Cela peut par exemple se produire pendant une panne régionale.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-228">For example, this could happen during a regional outage.</span></span> <span data-ttu-id="3d9a5-229">Dans ce cas, vous devez faire basculer manuellement le groupe de disponibilité, même si Traffic Manager bascule automatiquement vers le frontend.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-229">In that case, you must manually fail over the availability group, even though Traffic Manager automatically fails over on the front end.</span></span> <span data-ttu-id="3d9a5-230">Suivez les étapes de l’article [Perform a Forced Manual Failover of a SQL Server Availability Group](https://msdn.microsoft.com/library/ff877957.aspx) (Effectuer un basculement manuel forcé d’un groupe de disponibilité SQL Server), qui explique comment effectuer un basculement forcé à l’aide de SQL Server Management Studio, Transact-SQL ou PowerShell dans SQL Server 2016.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-230">Follow the steps in [Perform a Forced Manual Failover of a SQL Server Availability Group](https://msdn.microsoft.com/library/ff877957.aspx), which describes how to perform a forced failover by using SQL Server Management Studio, Transact-SQL, or PowerShell in SQL Server 2016.</span></span>

   > [!WARNING]
   > <span data-ttu-id="3d9a5-231">Avec le basculement forcé, il existe un risque de perte de données.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-231">With forced failover, there is a risk of data loss.</span></span> <span data-ttu-id="3d9a5-232">Une fois la région primaire de nouveau en ligne, prenez un instantané de la base de données et utilisez [tablediff] pour rechercher les différences.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-232">Once the primary region is back online, take a snapshot of the database and use [tablediff] to find the differences.</span></span>

- <span data-ttu-id="3d9a5-233">Traffic Manager bascule vers la région secondaire, mais le réplica de base de données SQL Server principal est toujours disponible.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-233">Traffic Manager fails over to the secondary region, but the primary SQL Server database replica is still available.</span></span> <span data-ttu-id="3d9a5-234">Par exemple, le niveau frontend peut échouer sans affecter les machines virtuelles SQL Server.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-234">For example, the front-end tier might fail, without affecting the SQL Server VMs.</span></span> <span data-ttu-id="3d9a5-235">Dans ce cas, le trafic Internet est acheminé vers la région secondaire, et cette région peut toujours se connecter au réplica principal.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-235">In that case, Internet traffic is routed to the secondary region, and that region can still connect to the primary replica.</span></span> <span data-ttu-id="3d9a5-236">Toutefois, il y aura une latence accrue, car les connexions SQL Server traversent différentes régions.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-236">However, there will be increased latency, because the SQL Server connections are going across regions.</span></span> <span data-ttu-id="3d9a5-237">Dans ce cas, vous devez effectuer un basculement manuel comme suit :</span><span class="sxs-lookup"><span data-stu-id="3d9a5-237">In this situation, you should perform a manual failover as follows:</span></span>

   1. <span data-ttu-id="3d9a5-238">Faites basculer temporairement un réplica de base de données SQL Server dans la région secondaire sur la validation *synchrone*.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-238">Temporarily switch a SQL Server database replica in the secondary region to *synchronous* commit.</span></span> <span data-ttu-id="3d9a5-239">Ainsi, vous ne perdrez aucune donnée pendant le basculement.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-239">This ensures there won't be data loss during the failover.</span></span>
   2. <span data-ttu-id="3d9a5-240">Basculez vers ce réplica.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-240">Fail over to that replica.</span></span>
   3. <span data-ttu-id="3d9a5-241">Quand vous rebasculez vers la région primaire, restaurez le paramètre de validation asynchrone.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-241">When you fail back to the primary region, restore the asynchronous commit setting.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="3d9a5-242">Considérations relatives à la facilité de gestion</span><span class="sxs-lookup"><span data-stu-id="3d9a5-242">Manageability considerations</span></span>

<span data-ttu-id="3d9a5-243">Quand vous mettez à jour votre déploiement, mettez à jour une seule région à la fois, afin de réduire le risque de défaillance globale due à une configuration incorrecte ou à une erreur dans l’application.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-243">When you update your deployment, update one region at a time to reduce the chance of a global failure from an incorrect configuration or an error in the application.</span></span>

<span data-ttu-id="3d9a5-244">Testez la résilience aux défaillances du système.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-244">Test the resiliency of the system to failures.</span></span> <span data-ttu-id="3d9a5-245">Voici quelques scénarios courants de défaillance à tester :</span><span class="sxs-lookup"><span data-stu-id="3d9a5-245">Here are some common failure scenarios to test:</span></span>

- <span data-ttu-id="3d9a5-246">Arrêt des instances de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-246">Shut down VM instances.</span></span>
- <span data-ttu-id="3d9a5-247">Pression sur les ressources telles que le processeur et la mémoire.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-247">Pressure resources such as CPU and memory.</span></span>
- <span data-ttu-id="3d9a5-248">Déconnexion/délai de réseau.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-248">Disconnect/delay network.</span></span>
- <span data-ttu-id="3d9a5-249">Blocage de processus.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-249">Crash processes.</span></span>
- <span data-ttu-id="3d9a5-250">Expiration de certificats.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-250">Expire certificates.</span></span>
- <span data-ttu-id="3d9a5-251">Simulation de défaillances matérielles.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-251">Simulate hardware faults.</span></span>
- <span data-ttu-id="3d9a5-252">Arrêt du service DNS sur les contrôleurs de domaine.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-252">Shut down the DNS service on the domain controllers.</span></span>

<span data-ttu-id="3d9a5-253">Mesurez les temps de récupération et vérifiez qu’ils répondent aux besoins de votre entreprise.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-253">Measure the recovery times and verify they meet your business requirements.</span></span> <span data-ttu-id="3d9a5-254">Testez également des combinaisons de défaillances.</span><span class="sxs-lookup"><span data-stu-id="3d9a5-254">Test combinations of failure modes, as well.</span></span>

<!-- links -->

[hybrid-vpn]: ../hybrid-networking/vpn.md
[azure-dns]: /azure/dns/dns-overview
[azure-sla]: https://azure.microsoft.com/support/legal/sla/
[azure-sql-db]: https://azure.microsoft.com/documentation/services/sql-database/
[health-endpoint-monitoring-pattern]: https://msdn.microsoft.com/library/dn589789.aspx
[azure-cli]: /cli/azure/
[regional-pairs]: /azure/best-practices-availability-paired-regions
[resource groups]: /azure/azure-resource-manager/resource-group-overview
[resource-group-links]: /azure/resource-group-link-resources
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview
[services-by-region]: https://azure.microsoft.com/regions/#services
[sql-always-on]: https://msdn.microsoft.com/library/hh510230.aspx
[tablediff]: https://msdn.microsoft.com/library/ms162843.aspx
[tm-configure-failover]: /azure/traffic-manager/traffic-manager-configure-failover-routing-method
[tm-monitoring]: /azure/traffic-manager/traffic-manager-monitoring
[tm-routing]: /azure/traffic-manager/traffic-manager-routing-methods
[tm-sla]: https://azure.microsoft.com/support/legal/sla/traffic-manager
[traffic-manager]: https://azure.microsoft.com/services/traffic-manager
[visio-download]: https://archcenter.blob.core.windows.net/cdn/vm-reference-architectures.vsdx
[vnet-dns]: /azure/virtual-network/manage-virtual-network#change-dns-servers
[vnet-to-vnet]: /azure/vpn-gateway/vpn-gateway-vnet-vnet-rm-ps
[vpn-gateway]: /azure/vpn-gateway/vpn-gateway-about-vpngateways
[wsfc]: https://msdn.microsoft.com/library/hh270278.aspx
