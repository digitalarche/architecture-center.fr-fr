---
title: Déployer des appliances virtuelles réseau hautement disponibles
titleSuffix: Azure Reference Architectures
description: Déployez des appliances virtuelles réseau dans un environnement à haute disponibilité.
author: telmosampaio
ms.date: 12/08/2018
ms.custom: seodec18
ms.openlocfilehash: 646721f80d19f493b7674884f8108762d743201b
ms.sourcegitcommit: 680c9cef945dff6fee5e66b38e24f07804510fa9
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/04/2019
ms.locfileid: "54011087"
---
# <a name="deploy-highly-available-network-virtual-appliances"></a><span data-ttu-id="1fbce-103">Déployer des appliances virtuelles réseau hautement disponibles</span><span class="sxs-lookup"><span data-stu-id="1fbce-103">Deploy highly available network virtual appliances</span></span>

<span data-ttu-id="1fbce-104">Cet article explique comment déployer des appliances virtuelles réseau pour la haute disponibilité dans Azure.</span><span class="sxs-lookup"><span data-stu-id="1fbce-104">This article shows how to deploy a set of network virtual appliances (NVAs) for high availability in Azure.</span></span> <span data-ttu-id="1fbce-105">Une appliance virtuelle réseau est généralement utilisée pour contrôler le flux de trafic réseau à partir d’un réseau de périmètre, également appelé DMZ, vers d’autres réseaux ou sous-réseaux.</span><span class="sxs-lookup"><span data-stu-id="1fbce-105">An NVA is typically used to control the flow of network traffic from a perimeter network, also known as a DMZ, to other networks or subnets.</span></span> <span data-ttu-id="1fbce-106">Pour en savoir plus sur l’implémentation d’une zone DMZ dans Azure, consultez [Microsoft cloud services and network security][cloud-security] (Services de cloud computing Microsoft et sécurité réseau).</span><span class="sxs-lookup"><span data-stu-id="1fbce-106">To learn about implementing a DMZ in Azure, see [Microsoft cloud services and network security][cloud-security].</span></span> <span data-ttu-id="1fbce-107">L’article inclut des exemples d’architecture pour l’entrée ou la sortie uniquement, et pour les deux à la fois.</span><span class="sxs-lookup"><span data-stu-id="1fbce-107">The article includes example architectures for ingress only, egress only, and both ingress and egress.</span></span>

<span data-ttu-id="1fbce-108">**Configuration requise :** Cet article nécessite une connaissance élémentaire des réseaux Azure, des [équilibreurs de charge Azure][lb-overview] et des [routes définies par l’utilisateur][udr-overview].</span><span class="sxs-lookup"><span data-stu-id="1fbce-108">**Prerequisites:** This article assumes a basic understanding of Azure networking, [Azure load balancers][lb-overview], and [user-defined routes][udr-overview] (UDRs).</span></span>

## <a name="architecture-diagrams"></a><span data-ttu-id="1fbce-109">Diagrammes architecturaux</span><span class="sxs-lookup"><span data-stu-id="1fbce-109">Architecture diagrams</span></span>

<span data-ttu-id="1fbce-110">Une appliance virtuelle réseau peut être déployée sur une zone DMZ dans bon nombre d’architectures différentes.</span><span class="sxs-lookup"><span data-stu-id="1fbce-110">An NVA can be deployed to a DMZ in many different architectures.</span></span> <span data-ttu-id="1fbce-111">Par exemple, l’exemple suivant illustre l’utilisation d’une [appliance virtuelle réseau] [ nva-scenario] pour l’entrée.</span><span class="sxs-lookup"><span data-stu-id="1fbce-111">For example, the following figure illustrates the use of a [single NVA][nva-scenario] for ingress.</span></span>

<span data-ttu-id="1fbce-112">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="1fbce-112">![[0]][0]</span></span>

<span data-ttu-id="1fbce-113">Dans cette architecture, l’appliance virtuelle réseau assure une limite réseau sécurisée par la vérification de l’ensemble du trafic réseau entrant et sortant et la transmission uniquement du trafic répondant aux règles de sécurité du réseau.</span><span class="sxs-lookup"><span data-stu-id="1fbce-113">In this architecture, the NVA provides a secure network boundary by checking all inbound and outbound network traffic and passing only the traffic that meets network security rules.</span></span> <span data-ttu-id="1fbce-114">Toutefois, le fait que tout le trafic réseau doive traverser l’appliance virtuelle réseau signifie que cette dernière est un point unique de défaillance au sein du réseau.</span><span class="sxs-lookup"><span data-stu-id="1fbce-114">However, the fact that all network traffic must pass through the NVA means that the NVA is a single point of failure in the network.</span></span> <span data-ttu-id="1fbce-115">Si celle-ci échoue, il n’existe aucun autre chemin d’accès pour le trafic réseau et tous les sous-réseaux principaux sont indisponibles.</span><span class="sxs-lookup"><span data-stu-id="1fbce-115">If the NVA fails, there is no other path for network traffic and all the back-end subnets are unavailable.</span></span>

<span data-ttu-id="1fbce-116">Pour rendre une appliance virtuelle réseau hautement disponible, déployez plusieurs appliances virtuelles réseau dans un groupe à haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="1fbce-116">To make an NVA highly available, deploy more than one NVA into an availability set.</span></span>

<span data-ttu-id="1fbce-117">Les architectures suivantes décrivent les ressources et la configuration nécessaire pour des appliances virtuelles réseau hautement disponibles :</span><span class="sxs-lookup"><span data-stu-id="1fbce-117">The following architectures describe the resources and configuration necessary for highly available NVAs:</span></span>

<!-- markdownlint-disable MD033 -->

| <span data-ttu-id="1fbce-118">Solution</span><span class="sxs-lookup"><span data-stu-id="1fbce-118">Solution</span></span> | <span data-ttu-id="1fbce-119">Avantages</span><span class="sxs-lookup"><span data-stu-id="1fbce-119">Benefits</span></span> | <span data-ttu-id="1fbce-120">Considérations</span><span class="sxs-lookup"><span data-stu-id="1fbce-120">Considerations</span></span> |
| --- | --- | --- |
| <span data-ttu-id="1fbce-121">[Entrée avec appliances virtuelles réseau de couche 7][ingress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="1fbce-121">[Ingress with layer 7 NVAs][ingress-with-layer-7]</span></span> |<span data-ttu-id="1fbce-122">Tous les nœuds d’appliance virtuelle réseau sont actifs.</span><span class="sxs-lookup"><span data-stu-id="1fbce-122">All NVA nodes are active</span></span> |<span data-ttu-id="1fbce-123">Nécessite une appliance virtuelle réseau pouvant arrêter les connexions et utiliser SNAT</span><span class="sxs-lookup"><span data-stu-id="1fbce-123">Requires an NVA that can terminate connections and use SNAT</span></span><br/> <span data-ttu-id="1fbce-124">Requiert un ensemble distinct d’appliances virtuelles réseau pour le trafic provenant d’Internet et d’Azure</span><span class="sxs-lookup"><span data-stu-id="1fbce-124">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> <br/> <span data-ttu-id="1fbce-125">Peut uniquement être utilisé pour le trafic provenant de l’extérieur d’Azure</span><span class="sxs-lookup"><span data-stu-id="1fbce-125">Can only be used for traffic originating outside Azure</span></span> |
| <span data-ttu-id="1fbce-126">[Sortie avec appliances virtuelles réseau de couche 7][egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="1fbce-126">[Egress with layer 7 NVAs][egress-with-layer-7]</span></span> |<span data-ttu-id="1fbce-127">Tous les nœuds d’appliance virtuelle réseau sont actifs.</span><span class="sxs-lookup"><span data-stu-id="1fbce-127">All NVA nodes are active</span></span> | <span data-ttu-id="1fbce-128">Nécessite une appliance virtuelle réseau pouvant arrêter les connexions et implémente la traduction des adresses réseau source (SNAT)</span><span class="sxs-lookup"><span data-stu-id="1fbce-128">Requires an NVA that can terminate connections and implements source network address translation (SNAT)</span></span>
| <span data-ttu-id="1fbce-129">[Entrée-sortie avec appliances virtuelles réseau de couche 7][ingress-egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="1fbce-129">[Ingress-Egress with layer 7 NVAs][ingress-egress-with-layer-7]</span></span> |<span data-ttu-id="1fbce-130">Tous les nœuds sont actifs.</span><span class="sxs-lookup"><span data-stu-id="1fbce-130">All nodes are active</span></span><br/><span data-ttu-id="1fbce-131">Capable de gérer le trafic provenant d’Azure.</span><span class="sxs-lookup"><span data-stu-id="1fbce-131">Able to handle traffic originated in Azure</span></span> |<span data-ttu-id="1fbce-132">Nécessite une appliance virtuelle réseau pouvant arrêter les connexions et utiliser SNAT</span><span class="sxs-lookup"><span data-stu-id="1fbce-132">Requires an NVA that can terminate connections and use SNAT</span></span><br/><span data-ttu-id="1fbce-133">Requiert un ensemble distinct d’appliances virtuelles réseau pour le trafic provenant d’Internet et d’Azure</span><span class="sxs-lookup"><span data-stu-id="1fbce-133">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> |
| <span data-ttu-id="1fbce-134">[Commutateur PIP-UDR][pip-udr-switch]</span><span class="sxs-lookup"><span data-stu-id="1fbce-134">[PIP-UDR switch][pip-udr-switch]</span></span> |<span data-ttu-id="1fbce-135">Ensemble unique d’appliances virtuelles réseau pour tout le trafic</span><span class="sxs-lookup"><span data-stu-id="1fbce-135">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="1fbce-136">Peut gérer tout le trafic (aucune limite sur les règles de port)</span><span class="sxs-lookup"><span data-stu-id="1fbce-136">Can handle all traffic (no limit on port rules)</span></span> |<span data-ttu-id="1fbce-137">Actif/Passif</span><span class="sxs-lookup"><span data-stu-id="1fbce-137">Active-passive</span></span><br/><span data-ttu-id="1fbce-138">Requiert un processus de basculement</span><span class="sxs-lookup"><span data-stu-id="1fbce-138">Requires a failover process</span></span> |
| [<span data-ttu-id="1fbce-139">PIP-UDR sans SNAT</span><span class="sxs-lookup"><span data-stu-id="1fbce-139">PIP-UDR without SNAT</span></span>](#pip-udr-nvas-without-snat) | <span data-ttu-id="1fbce-140">Ensemble unique d’appliances virtuelles réseau pour tout le trafic</span><span class="sxs-lookup"><span data-stu-id="1fbce-140">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="1fbce-141">Peut gérer tout le trafic (aucune limite sur les règles de port)</span><span class="sxs-lookup"><span data-stu-id="1fbce-141">Can handle all traffic (no limit on port rules)</span></span><br/><span data-ttu-id="1fbce-142">Ne nécessite pas de configuration SNAT pour les requêtes entrantes</span><span class="sxs-lookup"><span data-stu-id="1fbce-142">Does not require configuring SNAT for inbound requests</span></span> |<span data-ttu-id="1fbce-143">Actif/Passif</span><span class="sxs-lookup"><span data-stu-id="1fbce-143">Active-passive</span></span><br/><span data-ttu-id="1fbce-144">Requiert un processus de basculement</span><span class="sxs-lookup"><span data-stu-id="1fbce-144">Requires a failover process</span></span><br/><span data-ttu-id="1fbce-145">Le sondage et la logique de basculement sont exécutés en dehors du réseau virtuel</span><span class="sxs-lookup"><span data-stu-id="1fbce-145">Probing and failover logic run outside the virtual network</span></span> |

<!-- markdown-enable MD033 -->

## <a name="ingress-with-layer-7-nvas"></a><span data-ttu-id="1fbce-146">Entrée avec appliances virtuelles réseau de couche 7</span><span class="sxs-lookup"><span data-stu-id="1fbce-146">Ingress with layer 7 NVAs</span></span>

<span data-ttu-id="1fbce-147">La figure suivante montre une architecture à haute disponibilité qui implémente une zone DMZ d’entrée derrière un équilibreur de charge accessible sur Internet.</span><span class="sxs-lookup"><span data-stu-id="1fbce-147">The following figure shows a high availability architecture that implements an ingress DMZ behind an internet-facing load balancer.</span></span> <span data-ttu-id="1fbce-148">Cette architecture est conçue pour fournir une connectivité HTTP ou HTTPS aux charges de travail Azure pour le trafic de couche 7 :</span><span class="sxs-lookup"><span data-stu-id="1fbce-148">This architecture is designed to provide connectivity to Azure workloads for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="1fbce-149">![[1]][1]</span><span class="sxs-lookup"><span data-stu-id="1fbce-149">![[1]][1]</span></span>

<span data-ttu-id="1fbce-150">L’avantage de cette architecture réside dans le fait que toutes les appliances virtuelles réseau sont actives et qu’en cas d’échec de l’une d’entre elles l’équilibreur de charge dirige le trafic réseau vers l’autre appliance virtuelle.</span><span class="sxs-lookup"><span data-stu-id="1fbce-150">The benefit of this architecture is that all NVAs are active, and if one fails the load balancer directs network traffic to the other NVA.</span></span> <span data-ttu-id="1fbce-151">Les deux appliances virtuelles réseau acheminent le trafic vers l’équilibreur de charge interne. Ainsi, le trafic est maintenu tant que l’une d’entre elles est active.</span><span class="sxs-lookup"><span data-stu-id="1fbce-151">Both NVAs route traffic to the internal load balancer so as long as one NVA is active, traffic continues to flow.</span></span> <span data-ttu-id="1fbce-152">Les appliances virtuelles réseau doivent arrêter le trafic SSL destiné aux machines virtuelles de la couche web.</span><span class="sxs-lookup"><span data-stu-id="1fbce-152">The NVAs are required to terminate SSL traffic intended for the web tier VMs.</span></span> <span data-ttu-id="1fbce-153">Ces appliances virtuelles réseau ne peuvent pas être étendues pour gérer le trafic local, car celui-ci nécessite un autre ensemble dédié d’appliances virtuelles réseau possédant leurs propres itinéraires réseau.</span><span class="sxs-lookup"><span data-stu-id="1fbce-153">These NVAs cannot be extended to handle on-premises traffic because on-premises traffic requires another dedicated set of NVAs with their own network routes.</span></span>

> [!NOTE]
> <span data-ttu-id="1fbce-154">Cette architecture est utilisée dans l’architecture de référence de la [zone DMZ située entre Azure et votre centre de données local][dmz-on-prem] et celle de la [zone DMZ située entre Azure et Internet][dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="1fbce-154">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="1fbce-155">Chacune de ces architectures de référence inclue une solution de déploiement utilisable.</span><span class="sxs-lookup"><span data-stu-id="1fbce-155">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="1fbce-156">Suivez les liens ci-après pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="1fbce-156">Follow the links for more information.</span></span>

## <a name="egress-with-layer-7-nvas"></a><span data-ttu-id="1fbce-157">Sortie avec appliances virtuelles réseau de couche 7</span><span class="sxs-lookup"><span data-stu-id="1fbce-157">Egress with layer 7 NVAs</span></span>

<span data-ttu-id="1fbce-158">L’architecture précédente peut être développée de manière à fournir une zone DMZ de sortie pour les requêtes provenant de la charge de travail Azure.</span><span class="sxs-lookup"><span data-stu-id="1fbce-158">The previous architecture can be expanded to provide an egress DMZ for requests originating in the Azure workload.</span></span> <span data-ttu-id="1fbce-159">L’architecture suivante est conçue pour assurer une haute disponibilité des appliances virtuelles réseau de la zone DMZ pour le trafic de couche 7, tel que HTTP ou HTTPS :</span><span class="sxs-lookup"><span data-stu-id="1fbce-159">The following architecture is designed to provide high availability of the NVAs in the DMZ for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="1fbce-160">![[2]][2]</span><span class="sxs-lookup"><span data-stu-id="1fbce-160">![[2]][2]</span></span>

<span data-ttu-id="1fbce-161">Dans cette architecture, tout le trafic provenant d’Azure est acheminé vers un équilibreur de charge interne.</span><span class="sxs-lookup"><span data-stu-id="1fbce-161">In this architecture, all traffic originating in Azure is routed to an internal load balancer.</span></span> <span data-ttu-id="1fbce-162">Ce dernier répartit les requêtes sortantes entre un ensemble d’appliances virtuelles réseau.</span><span class="sxs-lookup"><span data-stu-id="1fbce-162">The load balancer distributes outgoing requests between a set of NVAs.</span></span> <span data-ttu-id="1fbce-163">Celles-ci dirigent le trafic vers Internet à l’aide de leurs adresses IP publiques individuelles.</span><span class="sxs-lookup"><span data-stu-id="1fbce-163">These NVAs direct traffic to the Internet using their individual public IP addresses.</span></span>

> [!NOTE]
> <span data-ttu-id="1fbce-164">Cette architecture est utilisée dans l’architecture de référence de la [zone DMZ située entre Azure et votre centre de données local][dmz-on-prem] et celle de la [zone DMZ située entre Azure et Internet][dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="1fbce-164">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="1fbce-165">Chacune de ces architectures de référence inclue une solution de déploiement utilisable.</span><span class="sxs-lookup"><span data-stu-id="1fbce-165">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="1fbce-166">Suivez les liens ci-après pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="1fbce-166">Follow the links for more information.</span></span>

## <a name="ingress-egress-with-layer-7-nvas"></a><span data-ttu-id="1fbce-167">Entrée-sortie avec appliances virtuelles réseau de couche 7</span><span class="sxs-lookup"><span data-stu-id="1fbce-167">Ingress-egress with layer 7 NVAs</span></span>

<span data-ttu-id="1fbce-168">Les deux architectures précédentes comportaient une zone DMZ distincte pour l’entrée et la sortie.</span><span class="sxs-lookup"><span data-stu-id="1fbce-168">In the two previous architectures, there was a separate DMZ for ingress and egress.</span></span> <span data-ttu-id="1fbce-169">L’architecture suivante montre comment créer une zone DMZ pouvant être utilisée pour l’entrée et la sortie du trafic de couche 7, tel que HTTP ou HTTPS :</span><span class="sxs-lookup"><span data-stu-id="1fbce-169">The following architecture demonstrates how to create a DMZ that can be used for both ingress and egress for layer 7 traffic, such as HTTP or HTTPS:</span></span>

![[4]][4]

<span data-ttu-id="1fbce-171">Dans cette architecture, les appliances virtuelles réseau traitent les requêtes entrantes à partir de la passerelle d’application.</span><span class="sxs-lookup"><span data-stu-id="1fbce-171">In this architecture, the NVAs process incoming requests from the application gateway.</span></span> <span data-ttu-id="1fbce-172">Les appliances virtuelles réseau traitent également des requêtes sortantes issues des machines virtuelles de la charge de travail du pool principal de l’équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="1fbce-172">The NVAs also process outgoing requests from the workload VMs in the back-end pool of the load balancer.</span></span> <span data-ttu-id="1fbce-173">Étant donné que le trafic entrant est routé avec une passerelle d’application et que le trafic sortant est routé avec un équilibreur de charge, les appliances virtuelles réseau sont responsables du maintien de l’affinité de session.</span><span class="sxs-lookup"><span data-stu-id="1fbce-173">Because incoming traffic is routed with an application gateway and outgoing traffic is routed with a load balancer, the NVAs are responsible for maintaining session affinity.</span></span> <span data-ttu-id="1fbce-174">Autrement dit, la passerelle d’application gère un mappage de requêtes entrantes et sortantes afin de pouvoir envoyer la réponse correcte au demandeur d’origine.</span><span class="sxs-lookup"><span data-stu-id="1fbce-174">That is, the application gateway maintains a mapping of inbound and outbound requests so it can forward the correct response to the original requestor.</span></span> <span data-ttu-id="1fbce-175">Toutefois, l’équilibreur de charge interne n’a pas accès aux mappages de la passerelle d’application et utilise sa propre logique pour envoyer des réponses aux appliances virtuelles réseau.</span><span class="sxs-lookup"><span data-stu-id="1fbce-175">However, the internal load balancer does not have access to the application gateway mappings, and uses its own logic to send responses to the NVAs.</span></span> <span data-ttu-id="1fbce-176">Il est possible que l’équilibreur de charge puisse envoyer une réponse à une appliance virtuelle réseau qui n’a pas initialement reçu la requête issue de la passerelle d’application.</span><span class="sxs-lookup"><span data-stu-id="1fbce-176">It's possible the load balancer could send a response to an NVA that did not initially receive the request from the application gateway.</span></span> <span data-ttu-id="1fbce-177">Dans ce cas, les appliances virtuelles réseau doivent communiquer et se transférer la réponse entre elles afin que l’appliance virtuelle réseau appropriée puisse transférer la réponse vers la passerelle d’application.</span><span class="sxs-lookup"><span data-stu-id="1fbce-177">In this case, the NVAs must communicate and transfer the response between them so the correct NVA can forward the response to the application gateway.</span></span>

> [!NOTE]
> <span data-ttu-id="1fbce-178">Vous pouvez également résoudre le problème de routage asymétrique en s’assurant que les appliances virtuelles réseau effectuent la traduction des adresses réseau sources entrantes (SNAT).</span><span class="sxs-lookup"><span data-stu-id="1fbce-178">You can also solve the asymmetric routing issue by ensuring the NVAs perform inbound source network address translation (SNAT).</span></span> <span data-ttu-id="1fbce-179">Cela remplacerait l’IP source d’origine du demandeur par une des adresses IP de l’appliance virtuelle réseau utilisée sur le flux entrant.</span><span class="sxs-lookup"><span data-stu-id="1fbce-179">This would replace the original source IP of the requestor to one of the IP addresses of the NVA used on the inbound flow.</span></span> <span data-ttu-id="1fbce-180">Cela garantit de pouvoir utiliser plusieurs appliances virtuelles réseau à la fois, tout en conservant la symétrie de l’itinéraire.</span><span class="sxs-lookup"><span data-stu-id="1fbce-180">This ensures that you can use multiple NVAs at a time, while preserving the route symmetry.</span></span>

## <a name="pip-udr-switch-with-layer-4-nvas"></a><span data-ttu-id="1fbce-181">Commutateur PIP-UDR avec appliances virtuelles réseau de couche 4</span><span class="sxs-lookup"><span data-stu-id="1fbce-181">PIP-UDR switch with layer 4 NVAs</span></span>

<span data-ttu-id="1fbce-182">L’architecture suivante illustre une architecture comportant une appliance virtuelle réseau active et une autre appliance passive.</span><span class="sxs-lookup"><span data-stu-id="1fbce-182">The following architecture demonstrates an architecture with one active and one passive NVA.</span></span> <span data-ttu-id="1fbce-183">Cette architecture gère à la fois l’entrée et la sortie pour le trafic de couche 4 :</span><span class="sxs-lookup"><span data-stu-id="1fbce-183">This architecture handles both ingress and egress for layer 4 traffic:</span></span>

<span data-ttu-id="1fbce-184">![[3]][3]</span><span class="sxs-lookup"><span data-stu-id="1fbce-184">![[3]][3]</span></span>

> [!TIP]
> <span data-ttu-id="1fbce-185">Pour cette architecture, une solution complète est disponible sur [GitHub][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="1fbce-185">A complete solution for this architecture is available on [GitHub][pnp-ha-nva].</span></span>

<span data-ttu-id="1fbce-186">Cette architecture est similaire à la première architecture abordée dans cet article.</span><span class="sxs-lookup"><span data-stu-id="1fbce-186">This architecture is similar to the first architecture discussed in this article.</span></span> <span data-ttu-id="1fbce-187">Cette architecture incluait une seule appliance virtuelle réseau acceptant et filtrant les requêtes entrantes de couche 4.</span><span class="sxs-lookup"><span data-stu-id="1fbce-187">That architecture included a single NVA accepting and filtering incoming layer 4 requests.</span></span> <span data-ttu-id="1fbce-188">Cette architecture ajoute une deuxième appliance virtuelle réseau pour garantir une haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="1fbce-188">This architecture adds a second passive NVA to provide high availability.</span></span> <span data-ttu-id="1fbce-189">Si l’appliance virtuelle réseau échoue, l’appliance virtuelle réseau passive est activée et les UDR et PIP sont modifiés de manière à pointer vers les cartes d’interface réseau de l’appliance virtuelle réseau active.</span><span class="sxs-lookup"><span data-stu-id="1fbce-189">If the active NVA fails, the passive NVA is made active and the UDR and PIP are changed to point to the NICs on the now active NVA.</span></span> <span data-ttu-id="1fbce-190">Ces modifications apportées à l’UDR et au PIP peuvent être effectuées manuellement ou à l’aide d’un processus automatisé.</span><span class="sxs-lookup"><span data-stu-id="1fbce-190">These changes to the UDR and PIP can either be done manually or using an automated process.</span></span> <span data-ttu-id="1fbce-191">Le processus automatisé est généralement un démon ou tout autre service d’analyse s’exécutant dans Azure.</span><span class="sxs-lookup"><span data-stu-id="1fbce-191">The automated process is typically daemon or other monitoring service running in Azure.</span></span> <span data-ttu-id="1fbce-192">Il interroge une sonde d’intégrité située sur l’appliance virtuelle réseau active et déclenche le commutateur UDR et PIP lorsqu’il détecte un échec de cette dernière.</span><span class="sxs-lookup"><span data-stu-id="1fbce-192">It queries a health probe on the active NVA and performs the UDR and PIP switch when it detects a failure of the NVA.</span></span>

<span data-ttu-id="1fbce-193">L’illustration précédente montre un exemple de cluster [ZooKeeper][zookeeper] proposant un démon à haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="1fbce-193">The preceding figure shows an example [ZooKeeper][zookeeper] cluster providing a high availability daemon.</span></span> <span data-ttu-id="1fbce-194">Au sein du cluster ZooKeeper, un quorum de nœuds choisit une amorce de début.</span><span class="sxs-lookup"><span data-stu-id="1fbce-194">Within the ZooKeeper cluster, a quorum of nodes elects a leader.</span></span> <span data-ttu-id="1fbce-195">Si l’amorce de début échoue, les nœuds restants en élisent une nouvelle.</span><span class="sxs-lookup"><span data-stu-id="1fbce-195">If the leader fails, the remaining nodes hold an election to elect a new leader.</span></span> <span data-ttu-id="1fbce-196">Pour cette architecture, le nœud de l’amorce de début exécute le démon qui interroge le point de terminaison d’intégrité situé sur l’appliance virtuelle réseau.</span><span class="sxs-lookup"><span data-stu-id="1fbce-196">For this architecture, the leader node executes the daemon that queries the health endpoint on the NVA.</span></span> <span data-ttu-id="1fbce-197">Si l’appliance virtuelle réseau ne répond pas à la sonde d’intégrité, le démon active l’appliance virtuelle réseau.</span><span class="sxs-lookup"><span data-stu-id="1fbce-197">If the NVA fails to respond to the health probe, the daemon activates the passive NVA.</span></span> <span data-ttu-id="1fbce-198">Le démon appelle ensuite l’API REST Azure pour retirer le PIP de l’appliance virtuelle réseau défaillante et l’associe à l’appliance virtuelle réseau qui vient d’être activée.</span><span class="sxs-lookup"><span data-stu-id="1fbce-198">The daemon then calls the Azure REST API to remove the PIP from the failed NVA and attaches it to newly activated NVA.</span></span> <span data-ttu-id="1fbce-199">Le démon modifie ensuite l’UDR de manière à pointer vers l’adresse IP interne de l’appliance virtuelle réseau venant d’être activée.</span><span class="sxs-lookup"><span data-stu-id="1fbce-199">The daemon then modifies the UDR to point to the newly activated NVA's internal IP address.</span></span>

<span data-ttu-id="1fbce-200">N’incluez pas les nœuds Zookeeper dans un sous-réseau uniquement accessible à l’aide d’un itinéraire incluant l’appliance virtuelle réseau.</span><span class="sxs-lookup"><span data-stu-id="1fbce-200">Do not include the ZooKeeper nodes in a subnet that is only accessible using a route that includes the NVA.</span></span> <span data-ttu-id="1fbce-201">Dans le cas contraire, les nœuds Zookeeper sont inaccessibles en cas d’échec de l’appliance virtuelle réseau.</span><span class="sxs-lookup"><span data-stu-id="1fbce-201">Otherwise, the ZooKeeper nodes are inaccessible if the NVA fails.</span></span> <span data-ttu-id="1fbce-202">Si le démon échoue pour une raison quelconque, vous ne pourrez accéder à aucun des nœuds ZooKeeper pour diagnostiquer le problème.</span><span class="sxs-lookup"><span data-stu-id="1fbce-202">Should the daemon fail for any reason, you won't be able to access any of the ZooKeeper nodes to diagnose the problem.</span></span>

<span data-ttu-id="1fbce-203">Pour voir la solution complète, y compris un exemple de code, consultez les fichiers du [dépôt GitHub][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="1fbce-203">To see the complete solution including sample code, see the files in the [GitHub repository][pnp-ha-nva].</span></span>

## <a name="pip-udr-nvas-without-snat"></a><span data-ttu-id="1fbce-204">Appliances virtuelles réseau PIP-UDR sans SNAT</span><span class="sxs-lookup"><span data-stu-id="1fbce-204">PIP-UDR NVAs without SNAT</span></span>

<span data-ttu-id="1fbce-205">Cette architecture utilise deux machines virtuelles Azure pour héberger le pare-feu d’appliance virtuelle réseau dans une configuration de type actif-passif qui prend en charge le basculement automatisé, mais qui ne nécessite pas de SNAT (Source Network Address Translation).</span><span class="sxs-lookup"><span data-stu-id="1fbce-205">This architecture uses two Azure virtual machines to host the NVA firewall in an active-passive configuration that supports automated failover but does not require Source Network Address Translation (SNAT).</span></span>

![Appliances virtuelles réseau PIP-UDR sans architecture SNAT](./images/nva-ha/pip-udr-without-snat.png)

> [!TIP]
> <span data-ttu-id="1fbce-207">Pour cette architecture, une solution complète est disponible sur [GitHub][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="1fbce-207">A complete solution for this architecture is available on [GitHub][ha-nva-fo].</span></span>

<span data-ttu-id="1fbce-208">Cette solution est conçue pour les clients Azure qui ne peuvent pas configurer le SNAT pour les requêtes dans leur pare-feu d’appliance virtuelle réseau.</span><span class="sxs-lookup"><span data-stu-id="1fbce-208">This solution is designed for Azure customers who cannot configure SNAT for inbound requests on their NVA firewalls.</span></span> <span data-ttu-id="1fbce-209">Le SNAT masque l’adresse IP client source d’origine.</span><span class="sxs-lookup"><span data-stu-id="1fbce-209">SNAT hides the original source client IP address.</span></span> <span data-ttu-id="1fbce-210">Si vous devez journaliser les adresses IP d’origine ou les utiliser dans d’autres composants de sécurité multiniveau situés derrière vos appliances virtuelles réseau, cette solution offre une approche de base.</span><span class="sxs-lookup"><span data-stu-id="1fbce-210">If you need to log the original IPs or used them within other layered security components behind your NVAs, this solution offers a basic approach.</span></span>

<span data-ttu-id="1fbce-211">Le basculement des entrées de la table de routes définies par l’utilisateur est automatisé par une adresse de tronçon suivant qui est définie sur l’adresse IP d’une interface, sur la machine virtuelle où le pare-feu d’appliance virtuelle réseau est actif.</span><span class="sxs-lookup"><span data-stu-id="1fbce-211">The failover of UDR table entries is automated by a next-hop address set to the IP address of an interface on the active NVA firewall virtual machine.</span></span> <span data-ttu-id="1fbce-212">La logique du basculement automatisé est hébergée dans une application de fonction que vous créez à l’aide d’[Azure Functions](/azure/azure-functions/).</span><span class="sxs-lookup"><span data-stu-id="1fbce-212">The automated failover logic is hosted in a function app that you create using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="1fbce-213">Le code de basculement s’exécute comme une fonction serverless dans Azure Functions.</span><span class="sxs-lookup"><span data-stu-id="1fbce-213">The failover code runs as a serverless function inside Azure Functions.</span></span> <span data-ttu-id="1fbce-214">Le déploiement est pratique, économique ainsi que facile à gérer et à personnaliser.</span><span class="sxs-lookup"><span data-stu-id="1fbce-214">Deployment is convenient, cost-effective, and easy to maintain and customize.</span></span> <span data-ttu-id="1fbce-215">En outre, l’application de fonction est hébergée dans Azure Functions.Elle n’a donc aucune dépendance au réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="1fbce-215">In addition, the function app is hosted within Azure Functions, so it has no dependencies on the virtual network.</span></span> <span data-ttu-id="1fbce-216">Si les modifications apportées au réseau virtuel impactent les pare-feu d’appliance virtuelle réseau, l’application de fonction continue de s’exécuter indépendamment.</span><span class="sxs-lookup"><span data-stu-id="1fbce-216">If changes to the virtual network impact the NVA firewalls, the function app continues to run independently.</span></span> <span data-ttu-id="1fbce-217">Les tests sont également plus précis, car ils ont lieu en dehors du réseau virtuel et utilisent la même route que les requêtes client entrantes.</span><span class="sxs-lookup"><span data-stu-id="1fbce-217">Testing is more accurate as well, because it takes place outside the virtual network using the same route as the inbound client requests.</span></span>

<span data-ttu-id="1fbce-218">Pour vérifier la disponibilité du pare-feu d’appliance virtuelle réseau, le code de l’application de fonction le sonde de deux manières :</span><span class="sxs-lookup"><span data-stu-id="1fbce-218">To check the availability of the NVA firewall, the function app code probes it in one of two ways:</span></span>

- <span data-ttu-id="1fbce-219">En supervisant l’état des machines virtuelles Azure qui hébergent le pare-feu d’appliance virtuelle réseau</span><span class="sxs-lookup"><span data-stu-id="1fbce-219">By monitoring the state of the Azure virtual machines hosting the NVA firewall.</span></span>

- <span data-ttu-id="1fbce-220">En vérifiant si un port est ouvert entre le pare-feu et le serveur web back-end</span><span class="sxs-lookup"><span data-stu-id="1fbce-220">By testing whether there is an open port through the firewall to the back-end web server.</span></span> <span data-ttu-id="1fbce-221">Avec cette option, l’appliance virtuelle réseau doit exposer un socket via PIP pour le code de l’application de fonction à tester.</span><span class="sxs-lookup"><span data-stu-id="1fbce-221">For this option, the NVA must expose a socket via PIP for the function app code to test.</span></span>

<span data-ttu-id="1fbce-222">Vous choisissez le type de sonde que vous souhaitez utiliser au moment de configurer l’application de fonction.</span><span class="sxs-lookup"><span data-stu-id="1fbce-222">You choose the type of probe you want to use when you configure the function app.</span></span> <span data-ttu-id="1fbce-223">Pour voir la solution complète, y compris un exemple de code, consultez les fichiers du [dépôt GitHub][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="1fbce-223">To see the complete solution including sample code, see the files in the [GitHub repository][ha-nva-fo].</span></span>

## <a name="next-steps"></a><span data-ttu-id="1fbce-224">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="1fbce-224">Next steps</span></span>

- <span data-ttu-id="1fbce-225">Découvrez comment [implémenter une zone DMZ située entre Azure et votre centre de données local] [ dmz-on-prem] à l’aide des appliances virtuelles réseau de couche 7.</span><span class="sxs-lookup"><span data-stu-id="1fbce-225">Learn how to [implement a DMZ between Azure and your on-premises datacenter][dmz-on-prem] using layer-7 NVAs.</span></span>
- <span data-ttu-id="1fbce-226">Découvrez comment [implémenter une zone DMZ située entre Azure et Internet][dmz-internet] à l’aide des appliances virtuelles réseau de couche 7.</span><span class="sxs-lookup"><span data-stu-id="1fbce-226">Learn how to [implement a DMZ between Azure and the Internet][dmz-internet] using layer-7 NVAs.</span></span>
- [<span data-ttu-id="1fbce-227">Problèmes d’appliance virtuelle réseau dans Azure</span><span class="sxs-lookup"><span data-stu-id="1fbce-227">Troubleshoot network virtual appliance issues in Azure</span></span>](/azure/virtual-network/virtual-network-troubleshoot-nva)

<!-- links -->

[cloud-security]: /azure/best-practices-network-security
[dmz-on-prem]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/
[pnp-ha-nva]: https://github.com/mspnp/ha-nva
[ha-nva-fo]: https://aka.ms/ha-nva-fo

<!-- images -->

[0]: ./images/nva-ha/single-nva.png "Architecture d’appliances virtuelle réseau unique"
[1]: ./images/nva-ha/l7-ingress.png "Entrée de couche 7"
[2]: ./images/nva-ha/l7-ingress-egress.png "Sortie de couche 7"
[3]: ./images/nva-ha/active-passive.png "Cluster actif-passif"
[4]: ./images/nva-ha/l7-ingress-egress-ag.png
