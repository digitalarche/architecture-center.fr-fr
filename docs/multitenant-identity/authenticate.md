---
title: Authentification dans les applications mutualisées
description: Comment une application multilocataire peut authentifier les utilisateurs à partir d’Azure Active Directory.
author: MikeWasson
ms.date: 07/21/2017
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: tailspin
pnp.series.next: claims
ms.openlocfilehash: b4a833a18b44e40f544449a222fb082d71e4268d
ms.sourcegitcommit: 1b50810208354577b00e89e5c031b774b02736e2
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/23/2019
ms.locfileid: "54481641"
---
# <a name="authenticate-using-azure-ad-and-openid-connect"></a><span data-ttu-id="1eb29-103">S’authentifier avec Azure AD et OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="1eb29-103">Authenticate using Azure AD and OpenID Connect</span></span>

<span data-ttu-id="1eb29-104">[![GitHub](../_images/github.png) Exemple de code][sample application]</span><span class="sxs-lookup"><span data-stu-id="1eb29-104">[![GitHub](../_images/github.png) Sample code][sample application]</span></span>

<span data-ttu-id="1eb29-105">L’application Surveys utilise le protocole OpenID Connect (OIDC) pour authentifier les utilisateurs auprès d’Azure Active Directory (Azure AD).</span><span class="sxs-lookup"><span data-stu-id="1eb29-105">The Surveys application uses the OpenID Connect (OIDC) protocol to authenticate users with Azure Active Directory (Azure AD).</span></span> <span data-ttu-id="1eb29-106">L’application Surveys utilise ASP.NET Core, qui intègre un intergiciel (middleware) pour OIDC.</span><span class="sxs-lookup"><span data-stu-id="1eb29-106">The Surveys application uses ASP.NET Core, which has built-in middleware for OIDC.</span></span> <span data-ttu-id="1eb29-107">Le schéma suivant illustre globalement la succession d’événements consécutifs à une connexion de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="1eb29-107">The following diagram shows what happens when the user signs in, at a high level.</span></span>

![Flux d’authentification](./images/auth-flow.png)

1. <span data-ttu-id="1eb29-109">L’utilisateur clique sur le bouton de connexion dans l’application.</span><span class="sxs-lookup"><span data-stu-id="1eb29-109">The user clicks the "sign in" button in the app.</span></span> <span data-ttu-id="1eb29-110">Cette action est gérée par un contrôleur MVC.</span><span class="sxs-lookup"><span data-stu-id="1eb29-110">This action is handled by an MVC controller.</span></span>
2. <span data-ttu-id="1eb29-111">Le contrôleur MVC renvoie une action **ChallengeResult** .</span><span class="sxs-lookup"><span data-stu-id="1eb29-111">The MVC controller returns a **ChallengeResult** action.</span></span>
3. <span data-ttu-id="1eb29-112">Le middleware intercepte la **ChallengeResult** et génère une réponse 302 qui redirige l’utilisateur vers la page de connexion d’Azure AD.</span><span class="sxs-lookup"><span data-stu-id="1eb29-112">The middleware intercepts the **ChallengeResult** and creates a 302 response, which redirects the user to the Azure AD sign-in page.</span></span>
4. <span data-ttu-id="1eb29-113">L’utilisateur s’authentifie auprès d’Azure AD.</span><span class="sxs-lookup"><span data-stu-id="1eb29-113">The user authenticates with Azure AD.</span></span>
5. <span data-ttu-id="1eb29-114">Azure AD envoie un jeton d’ID à l’application.</span><span class="sxs-lookup"><span data-stu-id="1eb29-114">Azure AD sends an ID token to the application.</span></span>
6. <span data-ttu-id="1eb29-115">Le middleware valide le jeton d’ID.</span><span class="sxs-lookup"><span data-stu-id="1eb29-115">The middleware validates the ID token.</span></span> <span data-ttu-id="1eb29-116">À ce stade, l’utilisateur est maintenant authentifié au sein de l’application.</span><span class="sxs-lookup"><span data-stu-id="1eb29-116">At this point, the user is now authenticated inside the application.</span></span>
7. <span data-ttu-id="1eb29-117">Le middleware redirige l’utilisateur vers l’application.</span><span class="sxs-lookup"><span data-stu-id="1eb29-117">The middleware redirects the user back to application.</span></span>

## <a name="register-the-app-with-azure-ad"></a><span data-ttu-id="1eb29-118">Inscrire l’application auprès d’Azure AD</span><span class="sxs-lookup"><span data-stu-id="1eb29-118">Register the app with Azure AD</span></span>

<span data-ttu-id="1eb29-119">Pour activer OpenID Connect, le fournisseur SaaS inscrit l’application à l’intérieur de son propre client Azure AD.</span><span class="sxs-lookup"><span data-stu-id="1eb29-119">To enable OpenID Connect, the SaaS provider registers the application inside their own Azure AD tenant.</span></span>

<span data-ttu-id="1eb29-120">Pour inscrire l’application, suivez les étapes de l’article [Intégration d’applications dans Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/), dans la section [Ajout d’une application](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span><span class="sxs-lookup"><span data-stu-id="1eb29-120">To register the application, follow the steps in [Integrating Applications with Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/), in the section [Adding an Application](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span></span>

<span data-ttu-id="1eb29-121">Consultez [Exécuter l’application Surveys](./run-the-app.md) pour découvrir les étapes spécifiques de l’application Surveys.</span><span class="sxs-lookup"><span data-stu-id="1eb29-121">See [Run the Surveys application](./run-the-app.md) for the specific steps for the Surveys application.</span></span> <span data-ttu-id="1eb29-122">Notez les points suivants :</span><span class="sxs-lookup"><span data-stu-id="1eb29-122">Note the following:</span></span>

- <span data-ttu-id="1eb29-123">Pour une application multilocataire, vous devez configurer explicitement l’option multilocataire.</span><span class="sxs-lookup"><span data-stu-id="1eb29-123">For a multitenant application, you must configure the multi-tenanted option explicitly.</span></span> <span data-ttu-id="1eb29-124">Cela permet à d’autres organisations d’accéder à l’application.</span><span class="sxs-lookup"><span data-stu-id="1eb29-124">This enables other organizations to to access the application.</span></span>

- <span data-ttu-id="1eb29-125">L’URL de réponse est l’URL à laquelle Azure AD doit envoyer les réponses OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="1eb29-125">The reply URL is the URL where Azure AD will send OAuth 2.0 responses.</span></span> <span data-ttu-id="1eb29-126">En cas d’utilisation d’ASP.NET Core, elle doit correspondre au chemin que vous configurez dans le middleware (intergiciel) d’authentification (consultez la section suivante).</span><span class="sxs-lookup"><span data-stu-id="1eb29-126">When using the ASP.NET Core, this needs to match the path that you configure in the authentication middleware (see next section).</span></span>

## <a name="configure-the-auth-middleware"></a><span data-ttu-id="1eb29-127">Configurer le middleware d’authentification</span><span class="sxs-lookup"><span data-stu-id="1eb29-127">Configure the auth middleware</span></span>

<span data-ttu-id="1eb29-128">Cette section explique comment configurer le middleware d’authentification dans ASP.NET Core pour une authentification multilocataire avec OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="1eb29-128">This section describes how to configure the authentication middleware in ASP.NET Core for multitenant authentication with OpenID Connect.</span></span>

<span data-ttu-id="1eb29-129">Dans votre [classe de démarrage](/aspnet/core/fundamentals/startup), ajoutez le middleware OpenID Connect :</span><span class="sxs-lookup"><span data-stu-id="1eb29-129">In your [startup class](/aspnet/core/fundamentals/startup), add the OpenID Connect middleware:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(new OpenIdConnectOptions {
    ClientId = configOptions.AzureAd.ClientId,
    ClientSecret = configOptions.AzureAd.ClientSecret, // for code flow
    Authority = Constants.AuthEndpointPrefix,
    ResponseType = OpenIdConnectResponseType.CodeIdToken,
    PostLogoutRedirectUri = configOptions.AzureAd.PostLogoutRedirectUri,
    SignInScheme = CookieAuthenticationDefaults.AuthenticationScheme,
    TokenValidationParameters = new TokenValidationParameters { ValidateIssuer = false },
    Events = new SurveyAuthenticationEvents(configOptions.AzureAd, loggerFactory),
});
```

<span data-ttu-id="1eb29-130">Notez que certains paramètres sont tirés des options de configuration du runtime.</span><span class="sxs-lookup"><span data-stu-id="1eb29-130">Notice that some of the settings are taken from runtime configuration options.</span></span> <span data-ttu-id="1eb29-131">Les options du middleware ont la signification suivante :</span><span class="sxs-lookup"><span data-stu-id="1eb29-131">Here's what the middleware options mean:</span></span>

- <span data-ttu-id="1eb29-132">**ClientId**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-132">**ClientId**.</span></span> <span data-ttu-id="1eb29-133">ID client de l’application que vous avez obtenu lors de l’inscription de l’application dans Azure AD.</span><span class="sxs-lookup"><span data-stu-id="1eb29-133">The application's client ID, which you got when you registered the application in Azure AD.</span></span>
- <span data-ttu-id="1eb29-134">**Authority**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-134">**Authority**.</span></span> <span data-ttu-id="1eb29-135">Pour une application mutualisée, définissez ce paramètre sur `https://login.microsoftonline.com/common/`.</span><span class="sxs-lookup"><span data-stu-id="1eb29-135">For a multitenant application, set this to `https://login.microsoftonline.com/common/`.</span></span> <span data-ttu-id="1eb29-136">Il s’agit de l’URL du point de terminaison commun d’Azure AD, qui permet aux utilisateurs de n’importe quel client Azure AD de se connecter.</span><span class="sxs-lookup"><span data-stu-id="1eb29-136">This is the URL for the Azure AD common endpoint, which enables users from any Azure AD tenant to sign in.</span></span> <span data-ttu-id="1eb29-137">Pour plus d’informations sur le point de terminaison commun, consultez [ce billet de blog](https://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span><span class="sxs-lookup"><span data-stu-id="1eb29-137">For more information about the common endpoint, see [this blog post](https://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span></span>
- <span data-ttu-id="1eb29-138">Dans **TokenValidationParameters**, définissez **ValidateIssuer** avec la valeur false.</span><span class="sxs-lookup"><span data-stu-id="1eb29-138">In **TokenValidationParameters**, set **ValidateIssuer** to false.</span></span> <span data-ttu-id="1eb29-139">Cela signifie que l’application sera chargée de valider la valeur de l’émetteur dans le jeton d’ID.</span><span class="sxs-lookup"><span data-stu-id="1eb29-139">That means the app will be responsible for validating the issuer value in the ID token.</span></span> <span data-ttu-id="1eb29-140">(Le middleware continue de valider le jeton proprement dit.) Pour plus d’informations sur la validation de l’émetteur, consultez [Validation de l’émetteur](claims.md#issuer-validation).</span><span class="sxs-lookup"><span data-stu-id="1eb29-140">(The middleware still validates the token itself.) For more information about validating the issuer, see [Issuer validation](claims.md#issuer-validation).</span></span>
- <span data-ttu-id="1eb29-141">**PostLogoutRedirectUri**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-141">**PostLogoutRedirectUri**.</span></span> <span data-ttu-id="1eb29-142">Spécifiez une URL de redirection des utilisateurs après leur déconnexion. Il doit s’agir d’une page qui autorise les demandes anonymes (en règle générale, la page d’accueil).</span><span class="sxs-lookup"><span data-stu-id="1eb29-142">Specify a URL to redirect users after the sign out. This should be a page that allows anonymous requests &mdash; typically the home page.</span></span>
- <span data-ttu-id="1eb29-143">**SignInScheme**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-143">**SignInScheme**.</span></span> <span data-ttu-id="1eb29-144">Définissez cette propriété sur `CookieAuthenticationDefaults.AuthenticationScheme`.</span><span class="sxs-lookup"><span data-stu-id="1eb29-144">Set this to `CookieAuthenticationDefaults.AuthenticationScheme`.</span></span> <span data-ttu-id="1eb29-145">Ce paramètre signifie qu’une fois que l’utilisateur est authentifié, les revendications d’utilisateur sont stockées localement dans un cookie.</span><span class="sxs-lookup"><span data-stu-id="1eb29-145">This setting means that after the user is authenticated, the user claims are stored locally in a cookie.</span></span> <span data-ttu-id="1eb29-146">Ce cookie représente la façon dont l’utilisateur reste connecté pendant la session de navigateur.</span><span class="sxs-lookup"><span data-stu-id="1eb29-146">This cookie is how the user stays logged in during the browser session.</span></span>
- <span data-ttu-id="1eb29-147">**Événements :**</span><span class="sxs-lookup"><span data-stu-id="1eb29-147">**Events.**</span></span> <span data-ttu-id="1eb29-148">Rappels d’événement ; consultez la rubrique [Événements d’authentification](#authentication-events).</span><span class="sxs-lookup"><span data-stu-id="1eb29-148">Event callbacks; see [Authentication events](#authentication-events).</span></span>

<span data-ttu-id="1eb29-149">Ajoutez également le middleware Cookie Authentification au pipeline.</span><span class="sxs-lookup"><span data-stu-id="1eb29-149">Also add the Cookie Authentication middleware to the pipeline.</span></span> <span data-ttu-id="1eb29-150">Ce middleware est chargé d’écrire les revendications d’utilisateur sur un cookie et de lire ensuite le cookie au cours des prochains chargements de la page.</span><span class="sxs-lookup"><span data-stu-id="1eb29-150">This middleware is responsible for writing the user claims to a cookie, and then reading the cookie during subsequent page loads.</span></span>

```csharp
app.UseCookieAuthentication(new CookieAuthenticationOptions {
    AutomaticAuthenticate = true,
    AutomaticChallenge = true,
    AccessDeniedPath = "/Home/Forbidden",
    CookieSecure = CookieSecurePolicy.Always,

    // The default setting for cookie expiration is 14 days. SlidingExpiration is set to true by default
    ExpireTimeSpan = TimeSpan.FromHours(1),
    SlidingExpiration = true
});
```

## <a name="initiate-the-authentication-flow"></a><span data-ttu-id="1eb29-151">Initier le flux d’authentification</span><span class="sxs-lookup"><span data-stu-id="1eb29-151">Initiate the authentication flow</span></span>

<span data-ttu-id="1eb29-152">Pour démarrer le flux d’authentification dans ASP.NET MVC, vous devez renvoyer un **ChallengeResult** à partir du contrôleur :</span><span class="sxs-lookup"><span data-stu-id="1eb29-152">To start the authentication flow in ASP.NET MVC, return a **ChallengeResult** from the contoller:</span></span>

```csharp
[AllowAnonymous]
public IActionResult SignIn()
{
    return new ChallengeResult(
        OpenIdConnectDefaults.AuthenticationScheme,
        new AuthenticationProperties
        {
            IsPersistent = true,
            RedirectUri = Url.Action("SignInCallback", "Account")
        });
}
```

<span data-ttu-id="1eb29-153">Le middleware renvoie alors une réponse 302 (trouvé) qui redirige vers le point de terminaison de l’authentification.</span><span class="sxs-lookup"><span data-stu-id="1eb29-153">This causes the middleware to return a 302 (Found) response that redirects to the authentication endpoint.</span></span>

## <a name="user-login-sessions"></a><span data-ttu-id="1eb29-154">Sessions d’ouverture de session utilisateur</span><span class="sxs-lookup"><span data-stu-id="1eb29-154">User login sessions</span></span>

<span data-ttu-id="1eb29-155">Comme nous l’avons indiqué plus haut, lors de la première connexion de l’utilisateur, le middleware Cookie Authentication écrit les revendications d’utilisateur dans un cookie.</span><span class="sxs-lookup"><span data-stu-id="1eb29-155">As mentioned, when the user first signs in, the Cookie Authentication middleware writes the user claims to a cookie.</span></span> <span data-ttu-id="1eb29-156">Les requêtes HTTP sont ensuite authentifiées grâce à la lecture du cookie.</span><span class="sxs-lookup"><span data-stu-id="1eb29-156">After that, HTTP requests are authenticated by reading the cookie.</span></span>

<span data-ttu-id="1eb29-157">Par défaut, le middleware de cookie écrit un [cookie de session][session-cookie], qui est supprimé une fois que l’utilisateur ferme le navigateur.</span><span class="sxs-lookup"><span data-stu-id="1eb29-157">By default, the cookie middleware writes a [session cookie][session-cookie], which gets deleted once the user closes the browser.</span></span> <span data-ttu-id="1eb29-158">À sa prochaine visite, l’utilisateur devra donc de nouveau se connecter.</span><span class="sxs-lookup"><span data-stu-id="1eb29-158">The next time the user next visits the site, they will have to sign in again.</span></span> <span data-ttu-id="1eb29-159">Cependant, si vous définissez **IsPersistent** avec la valeur true dans **ChallengeResult**, le middleware écrit un cookie persistant, si bien que l’utilisateur reste connecté après la fermeture du navigateur.</span><span class="sxs-lookup"><span data-stu-id="1eb29-159">However, if you set **IsPersistent** to true in the **ChallengeResult**, the middleware writes a persistent cookie, so the user stays logged in after closing the browser.</span></span> <span data-ttu-id="1eb29-160">Vous pouvez configurer l’expiration du cookie ; consultez [Contrôler les options du cookie][cookie-options].</span><span class="sxs-lookup"><span data-stu-id="1eb29-160">You can configure the cookie expiration; see [Controlling cookie options][cookie-options].</span></span> <span data-ttu-id="1eb29-161">Les cookies persistants sont plus pratiques pour l’utilisateur, mais ils peuvent être inadaptés à certaines applications (par exemple, les applications bancaires) pour lesquelles il est souhaitable de demander à l’utilisateur de se connecter à chaque fois.</span><span class="sxs-lookup"><span data-stu-id="1eb29-161">Persistent cookies are more convenient for the user, but may be inappropriate for some applications (say, a banking application) where you want the user to sign in every time.</span></span>

## <a name="about-the-openid-connect-middleware"></a><span data-ttu-id="1eb29-162">À propos du middleware OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="1eb29-162">About the OpenID Connect middleware</span></span>

<span data-ttu-id="1eb29-163">Le middleware OpenID Connect dans ASP.NET masque la plupart des détails du protocole.</span><span class="sxs-lookup"><span data-stu-id="1eb29-163">The OpenID Connect middleware in ASP.NET hides most of the protocol details.</span></span> <span data-ttu-id="1eb29-164">Cette section contient des remarques relatives à l’implémentation qui peuvent vous aider à comprendre le flux du protocole.</span><span class="sxs-lookup"><span data-stu-id="1eb29-164">This section contains some notes about the implementation, that may be useful for understanding the protocol flow.</span></span>

<span data-ttu-id="1eb29-165">Commençons par examiner le flux d’authentification du point de vue d’ASP.NET (en ignorant les détails du flux de protocole OIDC entre l’application et Azure AD).</span><span class="sxs-lookup"><span data-stu-id="1eb29-165">First, let's examine the authentication flow in terms of ASP.NET (ignoring the details of the OIDC protocol flow between the app and Azure AD).</span></span> <span data-ttu-id="1eb29-166">Le schéma qui suit présente ce processus.</span><span class="sxs-lookup"><span data-stu-id="1eb29-166">The following diagram shows the process.</span></span>

![Flux de connexion](./images/sign-in-flow.png)

<span data-ttu-id="1eb29-168">Dans ce schéma, deux contrôleurs MVC sont référencés.</span><span class="sxs-lookup"><span data-stu-id="1eb29-168">In this diagram, there are two MVC controllers.</span></span> <span data-ttu-id="1eb29-169">Le contrôleur de compte gère les demandes de connexion et le contrôleur d’accueil fournit la page d’accueil.</span><span class="sxs-lookup"><span data-stu-id="1eb29-169">The Account controller handles sign-in requests, and the Home controller serves up the home page.</span></span>

<span data-ttu-id="1eb29-170">Voici comment se déroule le processus d’authentification :</span><span class="sxs-lookup"><span data-stu-id="1eb29-170">Here is the authentication process:</span></span>

1. <span data-ttu-id="1eb29-171">L’utilisateur clique sur le bouton de connexion et le navigateur envoie une demande GET.</span><span class="sxs-lookup"><span data-stu-id="1eb29-171">The user clicks the "Sign in" button, and the browser sends a GET request.</span></span> <span data-ttu-id="1eb29-172">Par exemple : `GET /Account/SignIn/`.</span><span class="sxs-lookup"><span data-stu-id="1eb29-172">For example: `GET /Account/SignIn/`.</span></span>
2. <span data-ttu-id="1eb29-173">Le contrôleur de compte renvoie un `ChallengeResult`.</span><span class="sxs-lookup"><span data-stu-id="1eb29-173">The account controller returns a `ChallengeResult`.</span></span>
3. <span data-ttu-id="1eb29-174">Le middleware OIDC renvoie une réponse HTTP 302 qui redirige l’utilisateur vers Azure AD.</span><span class="sxs-lookup"><span data-stu-id="1eb29-174">The OIDC middleware returns an HTTP 302 response, redirecting to Azure AD.</span></span>
4. <span data-ttu-id="1eb29-175">Le navigateur envoie la demande d’authentification à Azure AD.</span><span class="sxs-lookup"><span data-stu-id="1eb29-175">The browser sends the authentication request to Azure AD</span></span>
5. <span data-ttu-id="1eb29-176">L’utilisateur se connecte à Azure AD, qui à son tour renvoie une réponse d’authentification.</span><span class="sxs-lookup"><span data-stu-id="1eb29-176">The user signs in to Azure AD, and Azure AD sends back an authentication response.</span></span>
6. <span data-ttu-id="1eb29-177">Le middleware OIDC crée une entité de revendications et la transmet au middleware Cookie Authentication.</span><span class="sxs-lookup"><span data-stu-id="1eb29-177">The OIDC middleware creates a claims principal and passes it to the Cookie Authentication middleware.</span></span>
7. <span data-ttu-id="1eb29-178">Ce middleware sérialise l’entité de revendications et définit un cookie.</span><span class="sxs-lookup"><span data-stu-id="1eb29-178">The cookie middleware serializes the claims principal and sets a cookie.</span></span>
8. <span data-ttu-id="1eb29-179">Le middleware OIDC force une redirection vers l’URL de rappel de l’application.</span><span class="sxs-lookup"><span data-stu-id="1eb29-179">The OIDC middleware redirects to the application's callback URL.</span></span>
9. <span data-ttu-id="1eb29-180">Le navigateur suit la redirection en envoyant le cookie dans la demande.</span><span class="sxs-lookup"><span data-stu-id="1eb29-180">The browser follows the redirect, sending the cookie in the request.</span></span>
10. <span data-ttu-id="1eb29-181">Le middleware de cookie désérialise le cookie dans une entité de revendications et définit le paramètre `HttpContext.User` sur une valeur correspondant à l’entité de revendications.</span><span class="sxs-lookup"><span data-stu-id="1eb29-181">The cookie middleware deserializes the cookie to a claims principal and sets `HttpContext.User` equal to the claims principal.</span></span> <span data-ttu-id="1eb29-182">La demande est acheminée vers un contrôleur MVC.</span><span class="sxs-lookup"><span data-stu-id="1eb29-182">The request is routed to an MVC controller.</span></span>

### <a name="authentication-ticket"></a><span data-ttu-id="1eb29-183">Ticket d’authentification</span><span class="sxs-lookup"><span data-stu-id="1eb29-183">Authentication ticket</span></span>

<span data-ttu-id="1eb29-184">Si l’authentification réussit, le middleware OIDC crée un ticket d’authentification, qui contient une entité de revendications regroupant les revendications de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="1eb29-184">If authentication succeeds, the OIDC middleware creates an authentication ticket, which contains a claims principal that holds the user's claims.</span></span> <span data-ttu-id="1eb29-185">Vous pouvez accéder au ticket dans l’événement **AuthenticationValidated** ou **TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-185">You can access the ticket inside the **AuthenticationValidated** or **TicketReceived** event.</span></span>

> [!NOTE]
> <span data-ttu-id="1eb29-186">Tant que le flux d’authentification n’est pas entièrement terminé, `HttpContext.User` contient toujours un principal anonyme, et **non** l’utilisateur authentifié.</span><span class="sxs-lookup"><span data-stu-id="1eb29-186">Until the entire authentication flow is completed, `HttpContext.User` still holds an anonymous principal, **not** the authenticated user.</span></span> <span data-ttu-id="1eb29-187">L’entité anonyme comporte un ensemble de revendications vide.</span><span class="sxs-lookup"><span data-stu-id="1eb29-187">The anonymous principal has an empty claims collection.</span></span> <span data-ttu-id="1eb29-188">Une fois l’authentification effectuée et l’utilisateur redirigé par l’application, le middleware cookie désérialise le cookie d’authentification et définit le paramètre `HttpContext.User` sur une entité de revendications représentant l’utilisateur authentifié.</span><span class="sxs-lookup"><span data-stu-id="1eb29-188">After authentication completes and the app redirects, the cookie middleware deserializes the authentication cookie and sets `HttpContext.User` to a claims principal that represents the authenticated user.</span></span>

### <a name="authentication-events"></a><span data-ttu-id="1eb29-189">Événements d’authentification</span><span class="sxs-lookup"><span data-stu-id="1eb29-189">Authentication events</span></span>

<span data-ttu-id="1eb29-190">Pendant le processus d’authentification, le middleware OpenID Connect déclenche une série d’événements :</span><span class="sxs-lookup"><span data-stu-id="1eb29-190">During the authentication process, the OpenID Connect middleware raises a series of events:</span></span>

- <span data-ttu-id="1eb29-191">**RedirectToIdentityProvider**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-191">**RedirectToIdentityProvider**.</span></span> <span data-ttu-id="1eb29-192">Appelé juste avant que le middleware ne redirige vers le point de terminaison de l’authentification.</span><span class="sxs-lookup"><span data-stu-id="1eb29-192">Called right before the middleware redirects to the authentication endpoint.</span></span> <span data-ttu-id="1eb29-193">Vous pouvez utiliser cet événement pour modifier l’URL de redirection (par exemple, pour ajouter des paramètres de requête).</span><span class="sxs-lookup"><span data-stu-id="1eb29-193">You can use this event to modify the redirect URL; for example, to add request parameters.</span></span> <span data-ttu-id="1eb29-194">Pour un exemple, consultez [Ajout de l’invite de consentement administrateur](signup.md#adding-the-admin-consent-prompt).</span><span class="sxs-lookup"><span data-stu-id="1eb29-194">See [Adding the admin consent prompt](signup.md#adding-the-admin-consent-prompt) for an example.</span></span>
- <span data-ttu-id="1eb29-195">**AuthorizationCodeReceived**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-195">**AuthorizationCodeReceived**.</span></span> <span data-ttu-id="1eb29-196">Appelé avec le code d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="1eb29-196">Called with the authorization code.</span></span>
- <span data-ttu-id="1eb29-197">**TokenResponseReceived**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-197">**TokenResponseReceived**.</span></span> <span data-ttu-id="1eb29-198">Appelé après que le middleware obtient un jeton d’accès auprès du fournisseur d’identité, mais avant qu’il soit validé.</span><span class="sxs-lookup"><span data-stu-id="1eb29-198">Called after the middleware gets an access token from the IDP, but before it is validated.</span></span> <span data-ttu-id="1eb29-199">S’applique uniquement au flux de code d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="1eb29-199">Applies only to authorization code flow.</span></span>
- <span data-ttu-id="1eb29-200">**TokenValidated**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-200">**TokenValidated**.</span></span> <span data-ttu-id="1eb29-201">Appelé après validation du jeton d’ID par le middleware.</span><span class="sxs-lookup"><span data-stu-id="1eb29-201">Called after the middleware validates the ID token.</span></span> <span data-ttu-id="1eb29-202">À ce stade, l’application comporte un ensemble de revendications validées concernant l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="1eb29-202">At this point, the application has a set of validated claims about the user.</span></span> <span data-ttu-id="1eb29-203">Vous pouvez utiliser cet événement pour effectuer une validation supplémentaire sur les revendications, ou pour transformer les revendications.</span><span class="sxs-lookup"><span data-stu-id="1eb29-203">You can use this event to perform additional validation on the claims, or to transform claims.</span></span> <span data-ttu-id="1eb29-204">Consultez la page [Working with claims](claims.md)(Utilisation des revendications).</span><span class="sxs-lookup"><span data-stu-id="1eb29-204">See [Working with claims](claims.md).</span></span>
- <span data-ttu-id="1eb29-205">**UserInformationReceived**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-205">**UserInformationReceived**.</span></span> <span data-ttu-id="1eb29-206">Appelé si le middleware obtient le profil utilisateur à partir du point de terminaison des informations utilisateur.</span><span class="sxs-lookup"><span data-stu-id="1eb29-206">Called if the middleware gets the user profile from the user info endpoint.</span></span> <span data-ttu-id="1eb29-207">S’applique uniquement au flux de code d’autorisation et uniquement lorsque `GetClaimsFromUserInfoEndpoint = true` dans les options du middleware.</span><span class="sxs-lookup"><span data-stu-id="1eb29-207">Applies only to authorization code flow, and only when `GetClaimsFromUserInfoEndpoint = true` in the middleware options.</span></span>
- <span data-ttu-id="1eb29-208">**TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-208">**TicketReceived**.</span></span> <span data-ttu-id="1eb29-209">Appelé lorsque l’authentification est effectuée.</span><span class="sxs-lookup"><span data-stu-id="1eb29-209">Called when authentication is completed.</span></span> <span data-ttu-id="1eb29-210">Il s’agit du dernier événement, en supposant que l’authentification aboutisse.</span><span class="sxs-lookup"><span data-stu-id="1eb29-210">This is the last event, assuming that authentication succeeds.</span></span> <span data-ttu-id="1eb29-211">Une fois cet événement traité, l’utilisateur est connecté à l’application.</span><span class="sxs-lookup"><span data-stu-id="1eb29-211">After this event is handled, the user is signed into the app.</span></span>
- <span data-ttu-id="1eb29-212">**AuthenticationFailed**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-212">**AuthenticationFailed**.</span></span> <span data-ttu-id="1eb29-213">Appelé en cas d’échec de l’authentification.</span><span class="sxs-lookup"><span data-stu-id="1eb29-213">Called if authentication fails.</span></span> <span data-ttu-id="1eb29-214">Utilisez cet événement pour gérer les échecs d’authentification (par exemple, en le redirigeant vers une page d’erreur).</span><span class="sxs-lookup"><span data-stu-id="1eb29-214">Use this event to handle authentication failures &mdash; for example, by redirecting to an error page.</span></span>

<span data-ttu-id="1eb29-215">Pour fournir des rappels pour ces événements, définissez l’option **Events** sur le middleware.</span><span class="sxs-lookup"><span data-stu-id="1eb29-215">To provide callbacks for these events, set the **Events** option on the middleware.</span></span> <span data-ttu-id="1eb29-216">Il existe deux manières différentes de déclarer les gestionnaires d’événements : inline avec les expressions lambda, ou dans une classe dérivée de **OpenIdConnectEvents**.</span><span class="sxs-lookup"><span data-stu-id="1eb29-216">There are two different ways to declare the event handlers: Inline with lambdas, or in a class that derives from **OpenIdConnectEvents**.</span></span> <span data-ttu-id="1eb29-217">La deuxième approche est recommandée si vos rappels d’événement ont une logique substantielle, afin qu’ils ne viennent pas alourdir votre classe de démarrage.</span><span class="sxs-lookup"><span data-stu-id="1eb29-217">The second approach is recommended if your event callbacks have any substantial logic, so they don't clutter your startup class.</span></span> <span data-ttu-id="1eb29-218">Notre implémentation de référence utilise cette approche.</span><span class="sxs-lookup"><span data-stu-id="1eb29-218">Our reference implementation uses this approach.</span></span>

### <a name="openid-connect-endpoints"></a><span data-ttu-id="1eb29-219">Points de terminaison OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="1eb29-219">OpenID connect endpoints</span></span>

<span data-ttu-id="1eb29-220">Azure AD prend en charge la [découverte OpenID Connect](https://openid.net/specs/openid-connect-discovery-1_0.html), dans laquelle le fournisseur d’identité (IDP) retourne un document de métadonnées JSON à partir d’un [point de terminaison bien connu](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span><span class="sxs-lookup"><span data-stu-id="1eb29-220">Azure AD supports [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), wherein the identity provider (IDP) returns a JSON metadata document from a [well-known endpoint](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span></span> <span data-ttu-id="1eb29-221">Le document de métadonnées contient des informations telles que :</span><span class="sxs-lookup"><span data-stu-id="1eb29-221">The metadata document contains information such as:</span></span>

- <span data-ttu-id="1eb29-222">L’URL du point de terminaison d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="1eb29-222">The URL of the authorization endpoint.</span></span> <span data-ttu-id="1eb29-223">Il s’agit du point de redirection de l’application pour l’authentification de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="1eb29-223">This is where the app redirects to authenticate the user.</span></span>
- <span data-ttu-id="1eb29-224">L’URL du point de terminaison de « fin de session », où l’application se rend pour déconnecter l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="1eb29-224">The URL of the "end session" endpoint, where the app goes to log out the user.</span></span>
- <span data-ttu-id="1eb29-225">L’URL permettant d’obtenir les clés de signature utilisées par le client pour valider les jetons OIDC obtenus à partir du fournisseur d’identité.</span><span class="sxs-lookup"><span data-stu-id="1eb29-225">The URL to get the signing keys, which the client uses to validate the OIDC tokens that it gets from the IDP.</span></span>

<span data-ttu-id="1eb29-226">Par défaut, le middleware OIDC sait comment récupérer ces métadonnées.</span><span class="sxs-lookup"><span data-stu-id="1eb29-226">By default, the OIDC middleware knows how to fetch this metadata.</span></span> <span data-ttu-id="1eb29-227">Définissez l’option **Authority** du middleware pour permettre à celui-ci de construire l’URL des métadonnées.</span><span class="sxs-lookup"><span data-stu-id="1eb29-227">Set the **Authority** option in the middleware, and the middleware constructs the URL for the metadata.</span></span> <span data-ttu-id="1eb29-228">(Vous pouvez remplacer l’URL des métadonnées en définissant l’option **MetadataAddress**.)</span><span class="sxs-lookup"><span data-stu-id="1eb29-228">(You can override the metadata URL by setting the **MetadataAddress** option.)</span></span>

### <a name="openid-connect-flows"></a><span data-ttu-id="1eb29-229">Flux OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="1eb29-229">OpenID connect flows</span></span>

<span data-ttu-id="1eb29-230">Par défaut, le middleware OIDC utilise un flux hybride avec un mode de réponse POST de type formulaire.</span><span class="sxs-lookup"><span data-stu-id="1eb29-230">By default, the OIDC middleware uses hybrid flow with form post response mode.</span></span>

- <span data-ttu-id="1eb29-231">*flux hybride* signifie que le client peut obtenir un jeton d’ID et un code d’autorisation dans le même aller-retour vers le serveur d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="1eb29-231">*Hybrid flow* means the client can get an ID token and an authorization code in the same round-trip to the authorization server.</span></span>
- <span data-ttu-id="1eb29-232">*mode de réponse POST de type formulaire* signifie que le serveur d’autorisation utilise une demande HTTP POST pour envoyer le jeton d’ID et le code d’autorisation à l’application.</span><span class="sxs-lookup"><span data-stu-id="1eb29-232">*Form post reponse mode* means the authorization server uses an HTTP POST request to send the ID token and authorization code to the app.</span></span> <span data-ttu-id="1eb29-233">Les valeurs utilisent la méthode form-urlencode (type de contenu = "application/x-www-form-urlencoded").</span><span class="sxs-lookup"><span data-stu-id="1eb29-233">The values are form-urlencoded (content type = "application/x-www-form-urlencoded").</span></span>

<span data-ttu-id="1eb29-234">Lorsque le middleware OIDC redirige vers le point de terminaison d’autorisation, l’URL de redirection inclut tous les paramètres de chaîne de requête requis par OIDC.</span><span class="sxs-lookup"><span data-stu-id="1eb29-234">When the OIDC middleware redirects to the authorization endpoint, the redirect URL includes all of the query string parameters needed by OIDC.</span></span> <span data-ttu-id="1eb29-235">Pour un flux hybride :</span><span class="sxs-lookup"><span data-stu-id="1eb29-235">For hybrid flow:</span></span>

- <span data-ttu-id="1eb29-236">client_id.</span><span class="sxs-lookup"><span data-stu-id="1eb29-236">client_id.</span></span> <span data-ttu-id="1eb29-237">Cette valeur est définie dans l’option **ClientId**</span><span class="sxs-lookup"><span data-stu-id="1eb29-237">This value is set in the **ClientId** option</span></span>
- <span data-ttu-id="1eb29-238">scope = "openid profile", ce qui signifie qu’il s’agit bien de la requête OIDC et que nous voulons le profil de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="1eb29-238">scope = "openid profile", which means it's an OIDC request and we want the user's profile.</span></span>
- <span data-ttu-id="1eb29-239">response_type  = "code id_token".</span><span class="sxs-lookup"><span data-stu-id="1eb29-239">response_type  = "code id_token".</span></span> <span data-ttu-id="1eb29-240">Spécifie le flux hybride.</span><span class="sxs-lookup"><span data-stu-id="1eb29-240">This specifies hybrid flow.</span></span>
- <span data-ttu-id="1eb29-241">response_mode = "form_post".</span><span class="sxs-lookup"><span data-stu-id="1eb29-241">response_mode = "form_post".</span></span> <span data-ttu-id="1eb29-242">Spécifie la réponse POST du formulaire.</span><span class="sxs-lookup"><span data-stu-id="1eb29-242">This specifies form post response.</span></span>

<span data-ttu-id="1eb29-243">Pour spécifier un autre flux, définissez la propriété **ResponseType** sur les options.</span><span class="sxs-lookup"><span data-stu-id="1eb29-243">To specify a different flow, set the **ResponseType** property on the options.</span></span> <span data-ttu-id="1eb29-244">Par exemple : </span><span class="sxs-lookup"><span data-stu-id="1eb29-244">For example:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(options =>
{
    options.ResponseType = "code"; // Authorization code flow

    // Other options
}
```

<span data-ttu-id="1eb29-245">[**Suivant**][claims]</span><span class="sxs-lookup"><span data-stu-id="1eb29-245">[**Next**][claims]</span></span>

[claims]: claims.md
[cookie-options]: /aspnet/core/security/authentication/cookie#controlling-cookie-options
[session-cookie]: https://en.wikipedia.org/wiki/HTTP_cookie#Session_cookie
[sample application]: https://github.com/mspnp/multitenant-saas-guidance
