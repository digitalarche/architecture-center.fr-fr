---
title: "Exécuter des machines virtuelles à charge équilibrée dans Azure à des fins de scalabilité et de disponibilité"
description: "Découvrez comment exécuter plusieurs machines virtuelles Windows dans Azure à des fins de scalabilité et de disponibilité."
author: telmosampaio
ms.date: 09/07/2017
pnp.series.title: Windows VM workloads
pnp.series.next: n-tier
pnp.series.prev: single-vm
ms.openlocfilehash: d38cfb41255c547f1f1e87ef289c7a79033df778
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 11/14/2017
---
# <a name="run-load-balanced-vms-for-scalability-and-availability"></a><span data-ttu-id="60961-103">Exécuter des machines virtuelles à charge équilibrée à des fins de scalabilité et de disponibilité</span><span class="sxs-lookup"><span data-stu-id="60961-103">Run load-balanced VMs for scalability and availability</span></span>

<span data-ttu-id="60961-104">Cette architecture de référence présente un ensemble de pratiques éprouvées pour exécuter plusieurs machines virtuelles Windows dans un groupe identique derrière un équilibreur de charge, afin d’améliorer la disponibilité et la scalabilité.</span><span class="sxs-lookup"><span data-stu-id="60961-104">This reference architecture shows a set of proven practices for running several Windows virtual machines (VMs) in a scale set behind a load balancer, to improve availability and scalability.</span></span> <span data-ttu-id="60961-105">Vous pouvez utiliser cette architecture pour toute charge de travail sans état, telle qu’un serveur web. Il s’agit d’un module pour le déploiement d’applications multiniveaux.</span><span class="sxs-lookup"><span data-stu-id="60961-105">This architecture can be used for any stateless workload, such as a web server, and is a building block for deploying n-tier applications.</span></span> [<span data-ttu-id="60961-106">**Déployez cette solution**.</span><span class="sxs-lookup"><span data-stu-id="60961-106">**Deploy this solution**.</span></span>](#deploy-the-solution)

<span data-ttu-id="60961-107">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="60961-107">![[0]][0]</span></span>

<span data-ttu-id="60961-108">*Téléchargez un [fichier Visio][visio-download] de cette architecture.*</span><span class="sxs-lookup"><span data-stu-id="60961-108">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="60961-109">Architecture</span><span class="sxs-lookup"><span data-stu-id="60961-109">Architecture</span></span>

<span data-ttu-id="60961-110">Cette architecture repose sur celle décrite dans l’article [Exécuter une machine virtuelle Windows dans Azure][single vm].</span><span class="sxs-lookup"><span data-stu-id="60961-110">This architecture builds on the one shown in [Run a Windows VM on Azure][single vm].</span></span> <span data-ttu-id="60961-111">Les recommandations qui y sont fournies s’appliquent également à cette architecture.</span><span class="sxs-lookup"><span data-stu-id="60961-111">The recommendations there also apply to this architecture.</span></span>

<span data-ttu-id="60961-112">Dans cette architecture, une charge de travail est répartie entre plusieurs instances de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="60961-112">In this architecture, a workload is distributed across several VM instances.</span></span> <span data-ttu-id="60961-113">Il existe une seule adresse IP publique, et le trafic Internet est réparti entre les machines virtuelles à l’aide d’un équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="60961-113">There is a single public IP address, and Internet traffic is distributed to the VMs using a load balancer.</span></span> <span data-ttu-id="60961-114">Vous pouvez utiliser cette architecture pour une application à un seul niveau, telle qu’une application web sans état.</span><span class="sxs-lookup"><span data-stu-id="60961-114">This architecture can be used for a single-tier application, such as a stateless web application.</span></span>

<span data-ttu-id="60961-115">Elle comporte les composants suivants :</span><span class="sxs-lookup"><span data-stu-id="60961-115">The architecture has the following components:</span></span>

* <span data-ttu-id="60961-116">**Groupe de ressources.**</span><span class="sxs-lookup"><span data-stu-id="60961-116">**Resource group.**</span></span> <span data-ttu-id="60961-117">Les [*groupes de ressources*][resource-manager-overview] servent à regrouper des ressources afin de pouvoir les gérer en fonction de la durée de vie, du propriétaire et d’autres critères.</span><span class="sxs-lookup"><span data-stu-id="60961-117">[*Resource groups*][resource-manager-overview] are used to group resources so they can be managed by lifetime, owner, and other criteria.</span></span>
* <span data-ttu-id="60961-118">**Réseau virtuel (VNet) et sous-réseau.**</span><span class="sxs-lookup"><span data-stu-id="60961-118">**Virtual network (VNet) and subnet.**</span></span> <span data-ttu-id="60961-119">Chaque machine virtuelle dans Azure est déployée dans un réseau virtuel divisé en sous-réseaux.</span><span class="sxs-lookup"><span data-stu-id="60961-119">Every VM in Azure is deployed into a VNet that is further divided into subnets.</span></span>
* <span data-ttu-id="60961-120">**Équilibreur de charge Azure**.</span><span class="sxs-lookup"><span data-stu-id="60961-120">**Azure Load Balancer**.</span></span> <span data-ttu-id="60961-121">[L’équilibreur de charge] répartit les requêtes Internet entrantes entre les instances de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="60961-121">The [load balancer] distributes incoming Internet requests to the VM instances.</span></span> 
* <span data-ttu-id="60961-122">**Adresse IP publique**.</span><span class="sxs-lookup"><span data-stu-id="60961-122">**Public IP address**.</span></span> <span data-ttu-id="60961-123">Une adresse IP publique est nécessaire pour que l’équilibreur de charge puisse recevoir le trafic Internet.</span><span class="sxs-lookup"><span data-stu-id="60961-123">A public IP address is needed for the load balancer to receive Internet traffic.</span></span>
* <span data-ttu-id="60961-124">**Groupe de machines virtuelles identiques**.</span><span class="sxs-lookup"><span data-stu-id="60961-124">**VM scale set**.</span></span> <span data-ttu-id="60961-125">Un [groupe de machines virtuelles identiques][vm-scaleset] est un ensemble de machines virtuelles identiques utilisé pour héberger une charge de travail.</span><span class="sxs-lookup"><span data-stu-id="60961-125">A [VM scale set][vm-scaleset] is a set of identical VMs used to host a workload.</span></span> <span data-ttu-id="60961-126">Les groupes identiques permettent d’augmenter ou de réduire le nombre de machines virtuelles manuellement ou en fonction de règles prédéfinies.</span><span class="sxs-lookup"><span data-stu-id="60961-126">Scale sets allow the number of VMs to be scaled in or out manually, or based on predefined rules.</span></span>
* <span data-ttu-id="60961-127">**Groupe à haute disponibilité**.</span><span class="sxs-lookup"><span data-stu-id="60961-127">**Availability set**.</span></span> <span data-ttu-id="60961-128">Le [groupe à haute disponibilité][availability set] contient les machines virtuelles, ce qui leur permet d’être éligibles pour un [niveau contrat de service (SLA)][vm-sla] supérieur.</span><span class="sxs-lookup"><span data-stu-id="60961-128">The [availability set][availability set] contains the VMs, making the VMs eligible for a higher [service level agreement (SLA)][vm-sla].</span></span> <span data-ttu-id="60961-129">Pour appliquer le contrat SLA supérieur, vous devez ajouter au moins deux machines virtuelles dans le groupe à haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="60961-129">For the higher SLA to apply, the availability set must include a minimum of two VMs.</span></span> <span data-ttu-id="60961-130">Les groupes à haute disponibilité sont implicites dans les groupes identiques.</span><span class="sxs-lookup"><span data-stu-id="60961-130">Availability sets are implicit in scale sets.</span></span> <span data-ttu-id="60961-131">Si vous créez des machines virtuelles en dehors d’un groupe identique, vous devez créer le groupe à haute disponibilité indépendamment.</span><span class="sxs-lookup"><span data-stu-id="60961-131">If you create VMs outside a scale set, you need to create the availability set independently.</span></span>
* <span data-ttu-id="60961-132">**Disques managés**.</span><span class="sxs-lookup"><span data-stu-id="60961-132">**Managed disks**.</span></span> <span data-ttu-id="60961-133">Les disques managés Azure gèrent les fichiers de disque dur virtuel (VHD) des disques de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="60961-133">Azure Managed Disks manage the virtual hard disk (VHD) files for the VM disks.</span></span> 
* <span data-ttu-id="60961-134">**Stockage**.</span><span class="sxs-lookup"><span data-stu-id="60961-134">**Storage**.</span></span> <span data-ttu-id="60961-135">Créez un compte de stockage Azure pour stocker les journaux de diagnostic des machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="60961-135">Create an Azure Storage acount to hold diagnostic logs for the VMs.</span></span>

## <a name="recommendations"></a><span data-ttu-id="60961-136">Recommandations</span><span class="sxs-lookup"><span data-stu-id="60961-136">Recommendations</span></span>

<span data-ttu-id="60961-137">Vos exigences peuvent différer de celles de l’architecture décrite ici.</span><span class="sxs-lookup"><span data-stu-id="60961-137">Your requirements might differ from the architecture described here.</span></span> <span data-ttu-id="60961-138">Utilisez ces recommandations comme point de départ.</span><span class="sxs-lookup"><span data-stu-id="60961-138">Use these recommendations as a starting point.</span></span> 

### <a name="availability-and-scalability-recommendations"></a><span data-ttu-id="60961-139">Recommandations en matière de disponibilité et de scalabilité</span><span class="sxs-lookup"><span data-stu-id="60961-139">Availability and scalability recommendations</span></span>

<span data-ttu-id="60961-140">Une option pour la disponibilité et la scalabilité consiste à utiliser un [groupe de machines virtuelles identiques][vmss].</span><span class="sxs-lookup"><span data-stu-id="60961-140">An option for availability and scalability is to use a [virtual machine scale set][vmss].</span></span> <span data-ttu-id="60961-141">Les groupes de machines virtuelles identiques vous aident à déployer et à gérer un ensemble de machines virtuelles identiques.</span><span class="sxs-lookup"><span data-stu-id="60961-141">VM scale sets help you to deploy and manage a set of identical VMs.</span></span> <span data-ttu-id="60961-142">Les groupes identiques prennent en charge la mise à l’échelle automatique basée sur des métriques de performances.</span><span class="sxs-lookup"><span data-stu-id="60961-142">Scale sets support autoscaling based on performance metrics.</span></span> <span data-ttu-id="60961-143">À mesure que la charge sur les machines virtuelles augmente, des machines virtuelles supplémentaires sont ajoutées automatiquement à l’équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="60961-143">As the load on the VMs increases, additional VMs are automatically added to the load balancer.</span></span> <span data-ttu-id="60961-144">Les groupes identiques sont parfaits si vous devez rapidement faire monter en puissance des machines virtuelles, ou si vous avez besoin d’une mise à l’échelle automatique.</span><span class="sxs-lookup"><span data-stu-id="60961-144">Consider scale sets if you need to quickly scale out VMs, or need to autoscale.</span></span>

<span data-ttu-id="60961-145">Par défaut, les groupes identiques utilisent le « surprovisionnement », ce qui signifie qu’ils configurent initialement plus de machines virtuelles que vous ne le demandez, puis il supprime les machines virtuelles supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="60961-145">By default, scale sets use "overprovisioning," which means the scale set initially provisions more VMs than you ask for, then deletes the extra VMs.</span></span> <span data-ttu-id="60961-146">Cela permet d’améliorer le taux de réussite global lors du provisionnement des machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="60961-146">This improves the overall success rate when provisioning the VMs.</span></span> <span data-ttu-id="60961-147">Si vous n’utilisez pas de [disques managés](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-managed-disks), nous vous recommandons de ne pas utiliser plus de 20 machines virtuelles par compte de stockage quand le surprovisionnement est activé, ou plus de 40 machines virtuelles quand le surprovisionnement est désactivé.</span><span class="sxs-lookup"><span data-stu-id="60961-147">If you are not using [managed disks](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-managed-disks), we recommend no more than 20 VMs per storage account with overprovisioning enabled, or no more than 40 VMs with overprovisioning disabled.</span></span>

<span data-ttu-id="60961-148">Il existe deux façons de configurer des machines virtuelles déployées dans un groupe identique :</span><span class="sxs-lookup"><span data-stu-id="60961-148">There are two basic ways to configure VMs deployed in a scale set:</span></span>

- <span data-ttu-id="60961-149">Utiliser des extensions pour configurer la machine virtuelle après son provisionnement.</span><span class="sxs-lookup"><span data-stu-id="60961-149">Use extensions to configure the VM after it is provisioned.</span></span> <span data-ttu-id="60961-150">Avec cette approche, le démarrage des nouvelles instances de machine virtuelle peut être plus long que pour une machine virtuelle sans extension.</span><span class="sxs-lookup"><span data-stu-id="60961-150">With this approach, new VM instances may take longer to start up than a VM with no extensions.</span></span>

- <span data-ttu-id="60961-151">Déployer un [disque managé](/azure/storage/storage-managed-disks-overview) avec une image de disque personnalisée.</span><span class="sxs-lookup"><span data-stu-id="60961-151">Deploy a [managed disk](/azure/storage/storage-managed-disks-overview) with a custom disk image.</span></span> <span data-ttu-id="60961-152">Cette option peut être plus rapide à déployer.</span><span class="sxs-lookup"><span data-stu-id="60961-152">This option may be quicker to deploy.</span></span> <span data-ttu-id="60961-153">Toutefois, elle vous oblige à tenir l’image à jour.</span><span class="sxs-lookup"><span data-stu-id="60961-153">However, it requires you to keep the image up to date.</span></span>

<span data-ttu-id="60961-154">Pour plus d’informations, consultez [Considérations relatives à la conception des groupes de machines virtuelles identiques][vmss-design].</span><span class="sxs-lookup"><span data-stu-id="60961-154">For additional considerations, see [Design considerations for scale sets][vmss-design].</span></span>

> [!TIP]
> <span data-ttu-id="60961-155">Quand vous utilisez une solution de mise à l’échelle automatique, testez-la bien à l’avance avec des charges de travail de niveau production.</span><span class="sxs-lookup"><span data-stu-id="60961-155">When using any autoscale solution, test it with production-level workloads well in advance.</span></span>

<span data-ttu-id="60961-156">Si vous n’utilisez pas de groupe identique, utilisez au moins un groupe à haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="60961-156">If you do not use a scale set, consider at least using an availability set.</span></span> <span data-ttu-id="60961-157">Créez au moins deux machines virtuelles dans le groupe à haute disponibilité, afin de prendre en charge le [contrat SLA de disponibilité pour les machines virtuelles Azure][vm-sla].</span><span class="sxs-lookup"><span data-stu-id="60961-157">Create at least two VMs in the availability set, to support the [availability SLA for Azure VMs][vm-sla].</span></span> <span data-ttu-id="60961-158">L’équilibreur de charge Azure exige également que les machines virtuelles avec équilibrage de charge appartiennent au même groupe à haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="60961-158">The Azure load balancer also requires that load-balanced VMs belong to the same availability set.</span></span>

<span data-ttu-id="60961-159">Chaque abonnement Azure a des limites par défaut, notamment une quantité maximale de machines virtuelles par région.</span><span class="sxs-lookup"><span data-stu-id="60961-159">Each Azure subscription has default limits in place, including a maximum number of VMs per region.</span></span> <span data-ttu-id="60961-160">Vous pouvez augmenter la limite en créant une demande de support.</span><span class="sxs-lookup"><span data-stu-id="60961-160">You can increase the limit by filing a support request.</span></span> <span data-ttu-id="60961-161">Pour plus d’informations, consultez [Abonnement Azure et limites, quotas et contraintes de service][subscription-limits].</span><span class="sxs-lookup"><span data-stu-id="60961-161">For more information, see [Azure subscription and service limits, quotas, and constraints][subscription-limits].</span></span>

### <a name="network-recommendations"></a><span data-ttu-id="60961-162">Recommandations pour le réseau</span><span class="sxs-lookup"><span data-stu-id="60961-162">Network recommendations</span></span>

<span data-ttu-id="60961-163">Placez les machines virtuelles sur le même sous-réseau.</span><span class="sxs-lookup"><span data-stu-id="60961-163">Place the VMs within the same subnet.</span></span> <span data-ttu-id="60961-164">N’exposez pas les machines virtuelles directement à Internet. Attribuez plutôt à chaque machine virtuelle une adresse IP privée.</span><span class="sxs-lookup"><span data-stu-id="60961-164">Do not expose the VMs directly to the Internet, but instead give each VM a private IP address.</span></span> <span data-ttu-id="60961-165">Les clients se connectent à l’aide de l’adresse IP publique de l’équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="60961-165">Clients connect using the public IP address of the load balancer.</span></span>

<span data-ttu-id="60961-166">Si vous avez besoin de vous connecter aux machines virtuelles derrière l’équilibreur de charge, ajoutez une machine virtuelle comme hôte bastion/serveur de rebond (jumpbox) avec une adresse IP publique à laquelle vous pouvez vous connecter.</span><span class="sxs-lookup"><span data-stu-id="60961-166">If you need to log into the VMs behind the load balancer, consider adding a single VM as a bastion host/jumpbox with a public IP address you can log into.</span></span> <span data-ttu-id="60961-167">Ensuite, connectez-vous aux machines virtuelles derrière l’équilibreur de charge à partir du serveur de rebond.</span><span class="sxs-lookup"><span data-stu-id="60961-167">And then log into the VMs behind the load balancer from the jumpbox.</span></span> <span data-ttu-id="60961-168">Vous pouvez également configurer des règles NAT de trafic entrant dans l’équilibreur de charge dans le même but.</span><span class="sxs-lookup"><span data-stu-id="60961-168">Alternatively, configure inbound NAT rules in the load balancer for the same purpose.</span></span> <span data-ttu-id="60961-169">Toutefois, le serveur de rebond est une meilleure solution quand vous hébergez des charges de travail multiniveaux ou plusieurs charges de travail.</span><span class="sxs-lookup"><span data-stu-id="60961-169">However, having a jumpbox is a better solution when you are hosting n-tier workloads, or multiple workloads.</span></span>

### <a name="load-balancer-recommendations"></a><span data-ttu-id="60961-170">Recommandations relatives à l’équilibreur de charge</span><span class="sxs-lookup"><span data-stu-id="60961-170">Load balancer recommendations</span></span>

<span data-ttu-id="60961-171">Ajoutez toutes les machines virtuelles du groupe à haute disponibilité dans le pool d’adresses backend de l’équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="60961-171">Add all VMs in the availability set to the back-end address pool of the load balancer.</span></span>

<span data-ttu-id="60961-172">Définissez des règles d’équilibreur de charge pour diriger le trafic réseau vers les machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="60961-172">Define load balancer rules to direct network traffic to the VMs.</span></span> <span data-ttu-id="60961-173">Par exemple, pour activer le trafic HTTP, créez une règle qui mappe le port 80 de la configuration frontend au port 80 dans le pool d’adresses backend.</span><span class="sxs-lookup"><span data-stu-id="60961-173">For example, to enable HTTP traffic, create a rule that maps port 80 from the front-end configuration to port 80 on the back-end address pool.</span></span> <span data-ttu-id="60961-174">Quand un client envoie une requête HTTP au port 80, l’équilibreur de charge sélectionne une adresse IP backend en utilisant un [algorithme de hachage][load balancer hashing] qui inclut l’adresse IP source.</span><span class="sxs-lookup"><span data-stu-id="60961-174">When a client sends an HTTP request to port 80, the load balancer selects a back-end IP address by using a [hashing algorithm][load balancer hashing] that includes the source IP address.</span></span> <span data-ttu-id="60961-175">Ainsi, les requêtes des clients sont réparties entre toutes les machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="60961-175">In that way, client requests are distributed across all the VMs.</span></span>

<span data-ttu-id="60961-176">Pour acheminer le trafic vers une machine virtuelle spécifique, utilisez des règles NAT.</span><span class="sxs-lookup"><span data-stu-id="60961-176">To route traffic to a specific VM, use NAT rules.</span></span> <span data-ttu-id="60961-177">Par exemple, pour autoriser les communications RDP sur les machines virtuelles, créez une règle NAT distincte pour chaque machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="60961-177">For example, to enable RDP to the VMs, create a separate NAT rule for each VM.</span></span> <span data-ttu-id="60961-178">Chaque règle doit mapper un numéro de port distinct au port 3389, le port par défaut pour le protocole RDP.</span><span class="sxs-lookup"><span data-stu-id="60961-178">Each rule should map a distinct port number to port 3389, the default port for RDP.</span></span> <span data-ttu-id="60961-179">Par exemple, utilisez le port 50001 pour « VM1 », le port 50002 pour « VM2 », et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="60961-179">For example, use port 50001 for "VM1," port 50002 for "VM2," and so on.</span></span> <span data-ttu-id="60961-180">Affectez les règles NAT aux cartes réseau sur les machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="60961-180">Assign the NAT rules to the NICs on the VMs.</span></span>

### <a name="storage-account-recommendations"></a><span data-ttu-id="60961-181">Recommandations relatives aux comptes de stockage</span><span class="sxs-lookup"><span data-stu-id="60961-181">Storage account recommendations</span></span>

<span data-ttu-id="60961-182">Créez des comptes de stockage Azure distincts pour chaque machine virtuelle pour stocker les disques durs virtuels (VHD), afin d’éviter d’atteindre les [limites d’opérations d’entrée/sortie par seconde][vm-disk-limits] des comptes de stockage.</span><span class="sxs-lookup"><span data-stu-id="60961-182">Create separate Azure storage accounts for each VM to hold the virtual hard disks (VHDs), in order to avoid hitting the input/output operations per second [(IOPS) limits][vm-disk-limits] for storage accounts.</span></span>

<span data-ttu-id="60961-183">Nous vous recommandons d’utiliser des [disques managés](/azure/storage/storage-managed-disks-overview) avec le [stockage premium][premium].</span><span class="sxs-lookup"><span data-stu-id="60961-183">We recommend the use of [managed disks](/azure/storage/storage-managed-disks-overview) with [premium storage][premium].</span></span> <span data-ttu-id="60961-184">Les disques managés ne nécessitent pas de compte de stockage.</span><span class="sxs-lookup"><span data-stu-id="60961-184">Managed disks do not require a storage account.</span></span> <span data-ttu-id="60961-185">Il vous suffit de spécifier leur taille et leur type, puis de les déployer avec une haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="60961-185">You simply specify the size and type of disk and it is deployed in a highly available way.</span></span>

<span data-ttu-id="60961-186">Créez un compte de stockage pour les journaux de diagnostic.</span><span class="sxs-lookup"><span data-stu-id="60961-186">Create one storage account for diagnostic logs.</span></span> <span data-ttu-id="60961-187">Ce compte de stockage peut être partagé par toutes les machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="60961-187">This storage account can be shared by all the VMs.</span></span> <span data-ttu-id="60961-188">Il peut s’agir d’un compte de stockage non géré utilisant des disques standards.</span><span class="sxs-lookup"><span data-stu-id="60961-188">This can be an unmanaged storage account using standard disks.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="60961-189">Considérations relatives à la disponibilité</span><span class="sxs-lookup"><span data-stu-id="60961-189">Availability considerations</span></span>

<span data-ttu-id="60961-190">Le groupe à haute disponibilité rend votre application plus résiliente aux événements de maintenance planifiés et non planifiés.</span><span class="sxs-lookup"><span data-stu-id="60961-190">The availability set makes your application more resilient to both planned and unplanned maintenance events.</span></span>

* <span data-ttu-id="60961-191">La *maintenance planifiée* se produit quand Microsoft met à jour la plateforme sous-jacente, ce qui provoque parfois le redémarrage des machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="60961-191">*Planned maintenance* occurs when Microsoft updates the underlying platform, sometimes causing VMs to be restarted.</span></span> <span data-ttu-id="60961-192">Azure garantit que les machines virtuelles d’un groupe à haute disponibilité ne sont pas toutes redémarrées en même temps.</span><span class="sxs-lookup"><span data-stu-id="60961-192">Azure makes sure the VMs in an availability set are not all restarted at the same time.</span></span> <span data-ttu-id="60961-193">Au moins l’une d’elles continue à s’exécuter pendant que les autres redémarrent.</span><span class="sxs-lookup"><span data-stu-id="60961-193">At least one is kept running while others are restarting.</span></span>
* <span data-ttu-id="60961-194">La *maintenance non planifiée* se produit en cas de défaillance matérielle.</span><span class="sxs-lookup"><span data-stu-id="60961-194">*Unplanned maintenance* happens if there is a hardware failure.</span></span> <span data-ttu-id="60961-195">Azure garantit que les machines virtuelles d’un groupe à haute disponibilité sont provisionnées parmi plusieurs racks de serveurs.</span><span class="sxs-lookup"><span data-stu-id="60961-195">Azure makes sure that VMs in an availability set are provisioned across more than one server rack.</span></span> <span data-ttu-id="60961-196">Cela aide à réduire l’impact des défaillances matérielles, pannes réseau, coupures d’alimentation, et ainsi de suite.</span><span class="sxs-lookup"><span data-stu-id="60961-196">This helps to reduce the impact of hardware failures, network outages, power interruptions, and so on.</span></span>

<span data-ttu-id="60961-197">Pour plus d’informations, consultez [Gestion de la disponibilité des machines virtuelles][availability set].</span><span class="sxs-lookup"><span data-stu-id="60961-197">For more information, see [Manage the availability of virtual machines][availability set].</span></span> <span data-ttu-id="60961-198">La vidéo suivante offre également une bonne vue d’ensemble des groupes à haute disponibilité : [How Do I Configure an Availability Set to Scale VMs (Guide pratique pour configurer un groupe à haute disponibilité pour la mise à l’échelle des machines virtuelles)][availability set ch9].</span><span class="sxs-lookup"><span data-stu-id="60961-198">The following video also has a good overview of availability sets: [How Do I Configure an Availability Set to Scale VMs][availability set ch9].</span></span>

> [!WARNING]
> <span data-ttu-id="60961-199">N’oubliez pas de configurer le groupe à haute disponibilité quand vous provisionnez la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="60961-199">Make sure to configure the availability set when you provision the VM.</span></span> <span data-ttu-id="60961-200">Actuellement, il n’existe aucun moyen d’ajouter une machine virtuelle Resource Manager à un groupe à haute disponibilité après le provisionnement de la machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="60961-200">Currently, there is no way to add a Resource Manager VM to an availability set after the VM is provisioned.</span></span>

<span data-ttu-id="60961-201">L’équilibreur de charge utilise des [sondes d’intégrité] pour surveiller la disponibilité des instances de machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="60961-201">The load balancer uses [health probes] to monitor the availability of VM instances.</span></span> <span data-ttu-id="60961-202">Si une sonde ne peut pas atteindre une instance dans le délai imparti, l’équilibreur de charge cesse d’envoyer le trafic vers cette machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="60961-202">If a probe cannot reach an instance within a timeout period, the load balancer stops sending traffic to that VM.</span></span> <span data-ttu-id="60961-203">Toutefois, il continue à sonder, et si la machine virtuelle redevient disponible il reprend l’envoi du trafic vers cette machine virtuelle.</span><span class="sxs-lookup"><span data-stu-id="60961-203">However, the load balancer will continue to probe, and if the VM becomes available again, the load balancer resumes sending traffic to that VM.</span></span>

<span data-ttu-id="60961-204">Voici quelques recommandations concernant les sondes d’intégrité d’équilibreur de charge :</span><span class="sxs-lookup"><span data-stu-id="60961-204">Here are some recommendations on load balancer health probes:</span></span>

* <span data-ttu-id="60961-205">Les sondes peuvent tester le protocole TCP ou HTTP.</span><span class="sxs-lookup"><span data-stu-id="60961-205">Probes can test either HTTP or TCP.</span></span> <span data-ttu-id="60961-206">Si vos machines virtuelles exécutent un serveur HTTP, créez une sonde HTTP.</span><span class="sxs-lookup"><span data-stu-id="60961-206">If your VMs run an HTTP server, create an HTTP probe.</span></span> <span data-ttu-id="60961-207">Sinon, créez une sonde TCP.</span><span class="sxs-lookup"><span data-stu-id="60961-207">Otherwise create a TCP probe.</span></span>
* <span data-ttu-id="60961-208">Pour une sonde HTTP, spécifiez le chemin d’un point de terminaison HTTP.</span><span class="sxs-lookup"><span data-stu-id="60961-208">For an HTTP probe, specify the path to an HTTP endpoint.</span></span> <span data-ttu-id="60961-209">La sonde vérifie la présence d’une réponse HTTP 200 à partir de ce chemin.</span><span class="sxs-lookup"><span data-stu-id="60961-209">The probe checks for an HTTP 200 response from this path.</span></span> <span data-ttu-id="60961-210">Il peut s’agir du chemin racine (« / ») ou d’un point de terminaison de surveillance de l’intégrité qui implémente une logique personnalisée afin de vérifier l’intégrité de l’application.</span><span class="sxs-lookup"><span data-stu-id="60961-210">This can be the root path ("/"), or a health-monitoring endpoint that implements some custom logic to check the health of the application.</span></span> <span data-ttu-id="60961-211">Le point de terminaison doit autoriser les requêtes HTTP anonymes.</span><span class="sxs-lookup"><span data-stu-id="60961-211">The endpoint must allow anonymous HTTP requests.</span></span>
* <span data-ttu-id="60961-212">La sonde est envoyée à partir d’une adresse IP [connue][health-probe-ip], 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="60961-212">The probe is sent from a [known][health-probe-ip] IP address, 168.63.129.16.</span></span> <span data-ttu-id="60961-213">Veillez à ne bloquer le trafic vers ou à partir de cette adresse IP dans aucune stratégie de pare-feu ou règle de groupe de sécurité réseau.</span><span class="sxs-lookup"><span data-stu-id="60961-213">Make sure you don't block traffic to or from this IP in any firewall policies or network security group (NSG) rules.</span></span>
* <span data-ttu-id="60961-214">Utilisez des [journaux de sonde d’intégrité][health probe log] pour afficher l’état des sondes d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="60961-214">Use [health probe logs][health probe log] to view the status of the health probes.</span></span> <span data-ttu-id="60961-215">Activez la journalisation dans le portail Azure pour chaque équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="60961-215">Enable logging in the Azure portal for each load balancer.</span></span> <span data-ttu-id="60961-216">Les journaux sont écrits dans le Stockage Blob Azure.</span><span class="sxs-lookup"><span data-stu-id="60961-216">Logs are written to Azure Blob storage.</span></span> <span data-ttu-id="60961-217">Ils indiquent combien de machines virtuelles du côté backend ne reçoivent pas de trafic réseau à cause d’échecs de réponses de sonde.</span><span class="sxs-lookup"><span data-stu-id="60961-217">The logs show how many VMs on the back end are not receiving network traffic due to failed probe responses.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="60961-218">Considérations relatives à la facilité de gestion</span><span class="sxs-lookup"><span data-stu-id="60961-218">Manageability considerations</span></span>

<span data-ttu-id="60961-219">Avec plusieurs machines virtuelles, il est important d’automatiser les processus afin qu’ils soient fiables et reproductibles.</span><span class="sxs-lookup"><span data-stu-id="60961-219">With multiple VMs, it is important to automate processes so they are reliable and repeatable.</span></span> <span data-ttu-id="60961-220">Vous pouvez utiliser [Azure Automation][azure-automation] pour automatiser le déploiement, les mises à jour correctives du système d’exploitation et d’autres tâches.</span><span class="sxs-lookup"><span data-stu-id="60961-220">You can use [Azure Automation][azure-automation] to automate deployment, OS patching, and other tasks.</span></span> <span data-ttu-id="60961-221">[Azure Automation][azure-automation] est un service d’automatisation basé sur Windows Powershell.</span><span class="sxs-lookup"><span data-stu-id="60961-221">[Azure Automation][azure-automation] is an automation service based on Windows Powershell that can be used for this.</span></span> <span data-ttu-id="60961-222">Des exemples de scripts d’automatisation sont disponibles dans la [Galerie de runbooks] sur TechNet.</span><span class="sxs-lookup"><span data-stu-id="60961-222">Example automation scripts are available from the [Runbook Gallery] on TechNet.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="60961-223">Considérations relatives à la sécurité</span><span class="sxs-lookup"><span data-stu-id="60961-223">Security considerations</span></span>

<span data-ttu-id="60961-224">Les réseaux virtuels sont une limite d’isolation du trafic dans Azure.</span><span class="sxs-lookup"><span data-stu-id="60961-224">Virtual networks are a traffic isolation boundary in Azure.</span></span> <span data-ttu-id="60961-225">Les machines virtuelles d’un réseau virtuel ne peuvent pas communiquer directement avec celles d’un autre réseau virtuel.</span><span class="sxs-lookup"><span data-stu-id="60961-225">VMs in one VNet cannot communicate directly to VMs in a different VNet.</span></span> <span data-ttu-id="60961-226">Les machines virtuelles situées sur un même réseau virtuel peuvent communiquer, sauf si vous créez des [groupes de sécurité réseau][nsg] pour limiter le trafic.</span><span class="sxs-lookup"><span data-stu-id="60961-226">VMs within the same VNet can communicate, unless you create [network security groups][nsg] (NSGs) to restrict traffic.</span></span> <span data-ttu-id="60961-227">Pour plus d’informations, consultez [Services cloud Microsoft et sécurité réseau][network-security].</span><span class="sxs-lookup"><span data-stu-id="60961-227">For more information, see [Microsoft cloud services and network security][network-security].</span></span>

<span data-ttu-id="60961-228">Pour le trafic Internet entrant, les règles d’équilibreur de charge définissent le trafic qui peut atteindre le backend.</span><span class="sxs-lookup"><span data-stu-id="60961-228">For incoming Internet traffic, the load balancer rules define which traffic can reach the back end.</span></span> <span data-ttu-id="60961-229">Toutefois, les règles d’équilibreur de charge ne prennent pas en charge les listes de sécurité IP. Par conséquent, si vous souhaitez ajouter certaines adresses IP publiques à une liste verte, ajoutez un groupe de sécurité réseau au sous-réseau.</span><span class="sxs-lookup"><span data-stu-id="60961-229">However, load balancer rules don't support IP safe lists, so if you want to add certain public IP addresses to a safe list, add an NSG to the subnet.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="60961-230">Déployer la solution</span><span class="sxs-lookup"><span data-stu-id="60961-230">Deploy the solution</span></span>

<span data-ttu-id="60961-231">Un déploiement pour cette architecture est disponible sur [GitHub][github-folder].</span><span class="sxs-lookup"><span data-stu-id="60961-231">A deployment for this architecture is available on [GitHub][github-folder].</span></span> <span data-ttu-id="60961-232">Il déploie les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="60961-232">It deploys the following:</span></span>

  * <span data-ttu-id="60961-233">Un réseau virtuel avec un seul sous-réseau nommé **web** qui sert à héberger les machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="60961-233">A virtual network with a single subnet named **web** used to host the VMs.</span></span>
  * <span data-ttu-id="60961-234">Un groupe de machines virtuelles identiques qui contient des machines virtuelles exécutant la version la plus récente de Windows Server 2016 Datacenter Edition.</span><span class="sxs-lookup"><span data-stu-id="60961-234">A VM scale set that contains VMs running the latest version of Windows Server 2016 Datacenter Edition.</span></span> <span data-ttu-id="60961-235">La mise à l’échelle automatique est activée.</span><span class="sxs-lookup"><span data-stu-id="60961-235">Autoscale is enabled.</span></span>
  * <span data-ttu-id="60961-236">Un équilibreur de charge placé devant le groupe de machines virtuelles identiques.</span><span class="sxs-lookup"><span data-stu-id="60961-236">A load balancer that sits in front of the VM scale set.</span></span>
  * <span data-ttu-id="60961-237">Un groupe de sécurité réseau avec des règles de trafic entrant pour autoriser le trafic HTTP vers le groupe de machines virtuelles identiques.</span><span class="sxs-lookup"><span data-stu-id="60961-237">An NSG with incoming rules to allow HTTP traffic to the VM scale set.</span></span>

### <a name="prerequisites"></a><span data-ttu-id="60961-238">Prérequis</span><span class="sxs-lookup"><span data-stu-id="60961-238">Prerequisites</span></span>

<span data-ttu-id="60961-239">Avant de pouvoir déployer l’architecture de référence sur votre propre abonnement, vous devez effectuer les étapes suivantes.</span><span class="sxs-lookup"><span data-stu-id="60961-239">Before you can deploy the reference architecture to your own subscription, you must perform the following steps.</span></span>

1. <span data-ttu-id="60961-240">Clonez, dupliquez ou téléchargez le fichier zip pour le dépôt GitHub des [architectures de référence AzureCAT][ref-arch-repo].</span><span class="sxs-lookup"><span data-stu-id="60961-240">Clone, fork, or download the zip file for the [AzureCAT reference architectures][ref-arch-repo] GitHub repository.</span></span>

2. <span data-ttu-id="60961-241">Vérifiez qu’Azure CLI 2.0 est installé sur votre ordinateur.</span><span class="sxs-lookup"><span data-stu-id="60961-241">Make sure you have the Azure CLI 2.0 installed on your computer.</span></span> <span data-ttu-id="60961-242">Pour installer l’interface CLI, suivez les instructions fournies dans [Installer Azure CLI 2.0][azure-cli-2].</span><span class="sxs-lookup"><span data-stu-id="60961-242">To install the CLI, follow the instructions in [Install Azure CLI 2.0][azure-cli-2].</span></span>

3. <span data-ttu-id="60961-243">Installez le package npm des [modules Azure][azbb].</span><span class="sxs-lookup"><span data-stu-id="60961-243">Install the [Azure building blocks][azbb] npm package.</span></span>

4. <span data-ttu-id="60961-244">À partir d’une invite de commandes, d’une invite bash ou de l’invite de commandes PowerShell, connectez-vous à votre compte Azure à l’aide de l’une des commandes ci-dessous et suivez les invites.</span><span class="sxs-lookup"><span data-stu-id="60961-244">From a command prompt, bash prompt, or PowerShell prompt, login to your Azure account by using one of the commands below, and follow the prompts.</span></span>

  ```bash
  az login
  ```

### <a name="deploy-the-solution-using-azbb"></a><span data-ttu-id="60961-245">Déployer la solution à l’aide d’azbb</span><span class="sxs-lookup"><span data-stu-id="60961-245">Deploy the solution using azbb</span></span>

<span data-ttu-id="60961-246">Pour déployer l’exemple de charge de travail de machine virtuelle unique, effectuez les étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="60961-246">To deploy the sample single VM workload, follow these steps:</span></span>

1. <span data-ttu-id="60961-247">Accédez au dossier `virtual-machines\multi-vm\parameters\windows` pour le dépôt que vous avez téléchargé à l’étape des prérequis ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="60961-247">Navigate to the `virtual-machines\multi-vm\parameters\windows` folder for the repository you downloaded in the pre-requisites step above.</span></span>

2. <span data-ttu-id="60961-248">Ouvrez le fichier `multi-vm-v2.json` et entrez un nom d’utilisateur et un mot de passe entre les guillemets, comme illustré ci-dessous, puis enregistrez le fichier.</span><span class="sxs-lookup"><span data-stu-id="60961-248">Open the `multi-vm-v2.json` file and enter a username and password between the quotes, as shown below, then save the file.</span></span>

  ```bash
  "adminUsername": "",
  "adminPassword": "",
  ```

3. <span data-ttu-id="60961-249">Exécutez `azbb` pour déployer les machines virtuelles comme illustré ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="60961-249">Run `azbb` to deploy the VMs as shown below.</span></span>

  ```bash
  azbb -s <subscription_id> -g <resource_group_name> -l <location> -p multi-vm-v2.json --deploy
  ```

<span data-ttu-id="60961-250">Pour plus d’informations sur le déploiement de cet exemple d’architecture de référence, visitez notre [dépôt GitHub][git].</span><span class="sxs-lookup"><span data-stu-id="60961-250">For more information on deploying this sample reference architecture, visit our [GitHub repository][git].</span></span>

<!-- Links -->
[github-folder]: http://github.com/mspnp/reference-architectures/tree/master/virtual-machines/multi-vm
[ref-arch-repo]: https://github.com/mspnp/reference-architectures
[n-tier-linux]: ../virtual-machines-linux/n-tier.md
[n-tier-windows]: n-tier.md
[single vm]: single-vm.md
[premium]: /azure/storage/common/storage-premium-storage
[naming conventions]: /azure/guidance/guidance-naming-conventions
[vm-scaleset]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[availability set]: /azure/virtual-machines/virtual-machines-windows-manage-availability
[availability set ch9]: https://channel9.msdn.com/Series/Microsoft-Azure-Fundamentals-Virtual-Machines/08
[azure-automation]: https://azure.microsoft.com/documentation/services/automation/
[azure-cli]: /azure/virtual-machines-command-line-tools
[azure-automation]: /azure/automation/automation-intro
[bastion host]: https://en.wikipedia.org/wiki/Bastion_host
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/multi-vm
[health probe log]: /azure/load-balancer/load-balancer-monitor-log
[sondes d’intégrité]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[health-probe-ip]: /azure/virtual-network/virtual-networks-nsg#special-rules
[L’équilibreur de charge]: /azure/load-balancer/load-balancer-get-started-internet-arm-cli
[load balancer hashing]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[network-security]: /azure/best-practices-network-security
[nsg]: /azure/virtual-network/virtual-networks-nsg
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview 
[Galerie de runbooks]: /azure/automation/automation-runbook-gallery#runbooks-in-runbook-gallery
[subscription-limits]: /azure/azure-subscription-service-limits
[visio-download]: https://archcenter.azureedge.net/cdn/vm-reference-architectures.vsdx
[vm-disk-limits]: /azure/azure-subscription-service-limits#virtual-machine-disk-limits
[vm-sla]: https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_2/
[vmss]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[vmss-design]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-design-overview
[vmss-quickstart]: https://azure.microsoft.com/documentation/templates/?term=scale+set
[VM-sizes]: https://azure.microsoft.com/documentation/articles/virtual-machines-windows-sizes/
[0]: ./images/multi-vm-diagram.png "Architecture d’une solution à plusieurs machines virtuelles dans Azure comprenant un groupe à haute disponibilité avec deux machines virtuelles et un équilibreur de charge"
[azure-cli-2]: /azure/install-azure-cli?view=azure-cli-latest
[azbb]: https://github.com/mspnp/template-building-blocks/wiki/Install-Template-Building-Blocks-Version-2-(Windows)
[git]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/multi-vm