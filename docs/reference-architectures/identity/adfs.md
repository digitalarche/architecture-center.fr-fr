---
title: "Implémentation des services de fédération Active Directory (AD FS) dans Azure"
description: "Comment implémenter une architecture réseau hybride sécurisée avec l’autorisation de service de fédération Active Directory dans Azure.\nconseils, passerelle vpn, expressroute, équilibreur de charge, réseau virtuel, active directory"
author: telmosampaio
ms.date: 11/28/2016
pnp.series.title: Identity management
pnp.series.prev: adds-forest
cardTitle: Extend AD FS to Azure
ms.openlocfilehash: b8c9ae0621c087c68d449dd13e60046104c01513
ms.sourcegitcommit: 8ab30776e0c4cdc16ca0dcc881960e3108ad3e94
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 12/08/2017
---
# <a name="extend-active-directory-federation-services-ad-fs-to-azure"></a><span data-ttu-id="43cde-104">Étendre les services de fédération Active Directory (AD FS) dans Azure</span><span class="sxs-lookup"><span data-stu-id="43cde-104">Extend Active Directory Federation Services (AD FS) to Azure</span></span>

<span data-ttu-id="43cde-105">Cette architecture de référence implémente un réseau hybride sécurisé qui étend votre réseau local dans Azure et utilise [les services de fédération Active Directory (AD FS)][active-directory-federation-services] pour procéder à une authentification et une autorisation fédérées pour les composants en cours d’exécution dans Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-105">This reference architecture implements a secure hybrid network that extends your on-premises network to Azure and uses [Active Directory Federation Services (AD FS)][active-directory-federation-services] to perform federated authentication and authorization for components running in Azure.</span></span> [<span data-ttu-id="43cde-106">**Déployez cette solution**.</span><span class="sxs-lookup"><span data-stu-id="43cde-106">**Deploy this solution**.</span></span>](#deploy-the-solution)

<span data-ttu-id="43cde-107">[![0]][0]</span><span class="sxs-lookup"><span data-stu-id="43cde-107">[![0]][0]</span></span>

<span data-ttu-id="43cde-108">*Téléchargez un [fichier Visio][visio-download] de cette architecture.*</span><span class="sxs-lookup"><span data-stu-id="43cde-108">*Download a [Visio file][visio-download] of this architecture.*</span></span>

<span data-ttu-id="43cde-109">AD FS peut être hébergé localement, mais si votre application est une application hybride dont certaines parties sont implémentées dans Azure, il peut être plus efficace de répliquer AD FS dans le cloud.</span><span class="sxs-lookup"><span data-stu-id="43cde-109">AD FS can be hosted on-premises, but if your application is a hybrid in which some parts are implemented in Azure, it may be more efficient to replicate AD FS in the cloud.</span></span> 

<span data-ttu-id="43cde-110">Le schéma présente les scénarios suivants :</span><span class="sxs-lookup"><span data-stu-id="43cde-110">The diagram shows the following scenarios:</span></span>

* <span data-ttu-id="43cde-111">Le code d’application d’une organisation partenaire accède à une application web hébergée au sein de votre réseau virtuel Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-111">Application code from a partner organization accesses a web application hosted inside your Azure VNet.</span></span>
* <span data-ttu-id="43cde-112">Un utilisateur externe enregistré dont les informations d’identification sont stockées dans Active Directory Domain Services (DS) accède à une application web hébergée au sein de votre réseau virtuel Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-112">An external, registered user with credentials stored inside Active Directory Domain Services (DS) accesses a web application hosted inside your Azure VNet.</span></span>
* <span data-ttu-id="43cde-113">Un utilisateur connecté à votre réseau virtuel à l’aide d’un appareil autorisé exécute une application web hébergée au sein de votre réseau virtuel Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-113">A user connected to your VNet using an authorized device executes a web application hosted inside your Azure VNet.</span></span>

<span data-ttu-id="43cde-114">Utilisations courantes de cette architecture :</span><span class="sxs-lookup"><span data-stu-id="43cde-114">Typical uses for this architecture include:</span></span>

* <span data-ttu-id="43cde-115">Les applications hybrides où les charges de travail s’exécutent en partie en local et dans Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-115">Hybrid applications where workloads run partly on-premises and partly in Azure.</span></span>
* <span data-ttu-id="43cde-116">Les solutions qui utilisent l’autorisation fédérée pour exposer les applications web aux organisations partenaires.</span><span class="sxs-lookup"><span data-stu-id="43cde-116">Solutions that use federated authorization to expose web applications to partner organizations.</span></span>
* <span data-ttu-id="43cde-117">Les systèmes accessibles depuis des navigateurs web s’exécutant en dehors du pare-feu de l’organisation.</span><span class="sxs-lookup"><span data-stu-id="43cde-117">Systems that support access from web browsers running outside of the organizational firewall.</span></span>
* <span data-ttu-id="43cde-118">Les systèmes qui permettent aux utilisateurs d’accéder aux applications web en se connectant à partir d’appareils externes autorisés tels que des ordinateurs distants, des ordinateurs portables et d’autres appareils mobiles.</span><span class="sxs-lookup"><span data-stu-id="43cde-118">Systems that enable users to access to web applications by connecting from authorized external devices such as remote computers, notebooks, and other mobile devices.</span></span> 

<span data-ttu-id="43cde-119">Cette architecture de référence se concentre sur la *fédération passive* dans laquelle les serveurs de fédération décident comment et quand authentifier un utilisateur.</span><span class="sxs-lookup"><span data-stu-id="43cde-119">This reference architecture focuses on *passive federation*, in which the federation servers decide how and when to authenticate a user.</span></span> <span data-ttu-id="43cde-120">L’utilisateur fournit des informations de connexion au démarrage de l’application.</span><span class="sxs-lookup"><span data-stu-id="43cde-120">The user provides sign in information when the application is started.</span></span> <span data-ttu-id="43cde-121">Ce mécanisme est le plus couramment utilisé par les navigateurs web et implique un protocole qui redirige le navigateur vers un site sur lequel l’utilisateur s’authentifie.</span><span class="sxs-lookup"><span data-stu-id="43cde-121">This mechanism is most commonly used by web browsers and involves a protocol that redirects the browser to a site where the user authenticates.</span></span> <span data-ttu-id="43cde-122">AD FS prend également en charge la *fédération active*, où une application est chargée de fournir des informations d’identification sans intervention supplémentaire de l’utilisateur, mais ce scénario n’est pas couvert par cette architecture.</span><span class="sxs-lookup"><span data-stu-id="43cde-122">AD FS also supports *active federation*, where an application takes on responsibility for supplying credentials without further user interaction, but that scenario is outside the scope of this architecture.</span></span>

<span data-ttu-id="43cde-123">Pour plus d’informations, consultez [Choisir une solution pour intégrer l’environnement Active Directory local à Azure][considerations].</span><span class="sxs-lookup"><span data-stu-id="43cde-123">For additional considerations, see [Choose a solution for integrating on-premises Active Directory with Azure][considerations].</span></span> 

## <a name="architecture"></a><span data-ttu-id="43cde-124">Architecture</span><span class="sxs-lookup"><span data-stu-id="43cde-124">Architecture</span></span>

<span data-ttu-id="43cde-125">Cette architecture étend l’implémentation décrite dans l’article [Extending AD DS to Azure][extending-ad-to-azure] (Étendre AD DS dans Azure).</span><span class="sxs-lookup"><span data-stu-id="43cde-125">This architecture extends the implementation described in [Extending AD DS to Azure][extending-ad-to-azure].</span></span> <span data-ttu-id="43cde-126">Elle contient les éléments suivants.</span><span class="sxs-lookup"><span data-stu-id="43cde-126">It contains the followign components.</span></span>

* <span data-ttu-id="43cde-127">**Sous-réseau AD DS**.</span><span class="sxs-lookup"><span data-stu-id="43cde-127">**AD DS subnet**.</span></span> <span data-ttu-id="43cde-128">Les serveurs AD DS sont contenus dans leur propre sous-réseau avec des règles de groupe de sécurité réseau agissant comme un pare-feu.</span><span class="sxs-lookup"><span data-stu-id="43cde-128">The AD DS servers are contained in their own subnet with network security group (NSG) rules acting as a firewall.</span></span>

* <span data-ttu-id="43cde-129">**Serveurs AD DS**.</span><span class="sxs-lookup"><span data-stu-id="43cde-129">**AD DS servers**.</span></span> <span data-ttu-id="43cde-130">Des contrôleurs de domaine s’exécutant en tant que machines virtuelles dans Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-130">Domain controllers running as VMs in Azure.</span></span> <span data-ttu-id="43cde-131">Ces serveurs fournissent l’authentification des identités locales au sein du domaine.</span><span class="sxs-lookup"><span data-stu-id="43cde-131">These servers provide authentication of local identities within the domain.</span></span>

* <span data-ttu-id="43cde-132">**Sous-réseau AD FS**.</span><span class="sxs-lookup"><span data-stu-id="43cde-132">**AD FS subnet**.</span></span> <span data-ttu-id="43cde-133">Les serveurs AD FS se trouvent dans leur propre sous-réseau avec des règles de groupe de sécurité réseau agissant comme un pare-feu.</span><span class="sxs-lookup"><span data-stu-id="43cde-133">The AD FS servers are located within their own subnet with NSG rules acting as a firewall.</span></span>

* <span data-ttu-id="43cde-134">**Serveurs AD FS**.</span><span class="sxs-lookup"><span data-stu-id="43cde-134">**AD FS servers**.</span></span> <span data-ttu-id="43cde-135">Les serveurs AD FS fournissent l’authentification et l’autorisation fédérées.</span><span class="sxs-lookup"><span data-stu-id="43cde-135">The AD FS servers provide federated authorization and authentication.</span></span> <span data-ttu-id="43cde-136">Dans cette architecture, ils effectuent les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="43cde-136">In this architecture, they perform the following tasks:</span></span>
  
  * <span data-ttu-id="43cde-137">Réception des jetons de sécurité contenant les revendications d’un serveur de fédération partenaire pour le compte d’un utilisateur partenaire.</span><span class="sxs-lookup"><span data-stu-id="43cde-137">Receiving security tokens containing claims made by a partner federation server on behalf of a partner user.</span></span> <span data-ttu-id="43cde-138">AD FS vérifie que les jetons sont valides avant de transmettre les revendications à l’application web s’exécutant dans Azure pour autoriser les demandes.</span><span class="sxs-lookup"><span data-stu-id="43cde-138">AD FS verifies that the tokens are valid before passing the claims to the web application running in Azure to authorize requests.</span></span> 
  
    <span data-ttu-id="43cde-139">L’application web s’exécutant dans Azure est la *partie de confiance*.</span><span class="sxs-lookup"><span data-stu-id="43cde-139">The web application running in Azure is the *relying party*.</span></span> <span data-ttu-id="43cde-140">Le serveur de fédération partenaire doit émettre les revendications qui sont comprises par l’application web.</span><span class="sxs-lookup"><span data-stu-id="43cde-140">The partner federation server must issue claims that are understood by the web application.</span></span> <span data-ttu-id="43cde-141">Les serveurs de fédération partenaires sont appelés *partenaires de compte*, car ils envoient des demandes d’accès pour le compte de comptes authentifiés dans l’organisation partenaire.</span><span class="sxs-lookup"><span data-stu-id="43cde-141">The partner federation servers are referred to as *account partners*, because they submit access requests on behalf of authenticated accounts in the partner organization.</span></span> <span data-ttu-id="43cde-142">Les serveurs AD FS sont appelés *partenaires de ressource*, car ils fournissent l’accès aux ressources (l’application web).</span><span class="sxs-lookup"><span data-stu-id="43cde-142">The AD FS servers are called *resource partners* because they provide access to resources (the web application).</span></span>

  * <span data-ttu-id="43cde-143">Authentification et autorisation des requêtes entrantes émises par des utilisateurs externes exécutant un navigateur web ou un appareil qui a besoin d’accéder aux applications web, à l’aide des services AD DS et du [service Active Directory Device Registration][ADDRS].</span><span class="sxs-lookup"><span data-stu-id="43cde-143">Authenticating and authorizing incoming requests from external users running a web browser or device that needs access to web applications, by using AD DS and the [Active Directory Device Registration Service][ADDRS].</span></span>
    
  <span data-ttu-id="43cde-144">Les serveurs AD FS sont configurés en tant que batterie de serveurs accessible via un équilibreur de charge Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-144">The AD FS servers are configured as a farm accessed through an Azure load balancer.</span></span> <span data-ttu-id="43cde-145">Cette implémentation améliore la disponibilité et l’extensibilité.</span><span class="sxs-lookup"><span data-stu-id="43cde-145">This implementation improves availability and scalability.</span></span> <span data-ttu-id="43cde-146">Les serveurs AD FS ne sont pas exposés directement à Internet.</span><span class="sxs-lookup"><span data-stu-id="43cde-146">The AD FS servers are not exposed directly to the Internet.</span></span> <span data-ttu-id="43cde-147">Tout le trafic Internet est filtré à travers les serveurs proxy d’application web AD FS et une zone DMZ (également appelée réseau de périmètre).</span><span class="sxs-lookup"><span data-stu-id="43cde-147">All Internet traffic is filtered through AD FS web application proxy servers and a DMZ (also referred to as a perimeter network).</span></span>

  <span data-ttu-id="43cde-148">Pour plus d’informations sur le fonctionnement des services AD FS, consultez l’article [Vue d’ensemble des services AD FS][active-directory-federation-services-overview].</span><span class="sxs-lookup"><span data-stu-id="43cde-148">For more information about how AD FS works, see [Active Directory Federation Services Overview][active-directory-federation-services-overview].</span></span> <span data-ttu-id="43cde-149">De plus, l’article [Déploiement des services AD FS dans Azure][adfs-intro] contient une présentation détaillée de la procédure d’implémentation.</span><span class="sxs-lookup"><span data-stu-id="43cde-149">Also, the article [AD FS deployment in Azure][adfs-intro] contains a detailed step-by-step introduction to implementation.</span></span>

* <span data-ttu-id="43cde-150">**Sous-réseau de proxy AD FS**.</span><span class="sxs-lookup"><span data-stu-id="43cde-150">**AD FS proxy subnet**.</span></span> <span data-ttu-id="43cde-151">Les serveurs proxy AD FS peuvent être contenus dans leur propre sous-réseau, avec des règles de groupe de sécurité réseau assurant leur protection.</span><span class="sxs-lookup"><span data-stu-id="43cde-151">The AD FS proxy servers can be contained within their own subnet, with NSG rules providing protection.</span></span> <span data-ttu-id="43cde-152">Les serveurs localisés dans ce sous-réseau sont exposés à Internet via un ensemble d’appliances réseau virtuelles qui fournissent un pare-feu entre votre réseau virtuel Azure et Internet.</span><span class="sxs-lookup"><span data-stu-id="43cde-152">The servers in this subnet are exposed to the Internet through a set of network virtual appliances that provide a firewall between your Azure virtual network and the Internet.</span></span>

* <span data-ttu-id="43cde-153">**Serveurs proxy d’application web (WAP) AD FS**.</span><span class="sxs-lookup"><span data-stu-id="43cde-153">**AD FS web application proxy (WAP) servers**.</span></span> <span data-ttu-id="43cde-154">Ces machines virtuelles agissent comme des serveurs AD FS pour les demandes entrantes émises par des appareils externes et des organisations partenaires.</span><span class="sxs-lookup"><span data-stu-id="43cde-154">These VMs act as AD FS servers for incoming requests from partner organizations and external devices.</span></span> <span data-ttu-id="43cde-155">Les serveurs proxy d’application web agissent comme un filtre pour protéger les serveurs AD FS d’un accès direct à partir d’Internet.</span><span class="sxs-lookup"><span data-stu-id="43cde-155">The WAP servers act as a filter, shielding the AD FS servers from direct access from the Internet.</span></span> <span data-ttu-id="43cde-156">Comme avec les serveurs AD FS, le fait de déployer les serveurs proxy d’application web dans une batterie de serveurs avec équilibrage de charge vous offre une meilleure disponibilité et une plus grande extensibilité qu’en déployant une collection de serveurs autonomes.</span><span class="sxs-lookup"><span data-stu-id="43cde-156">As with the AD FS servers, deploying the WAP servers in a farm with load balancing gives you greater availability and scalability than deploying a collection of stand-alone servers.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="43cde-157">Pour plus d’informations sur l’installation des serveurs proxy d’application web, consultez l’article [Installer et configurer le serveur proxy d’application web][install_and_configure_the_web_application_proxy_server]</span><span class="sxs-lookup"><span data-stu-id="43cde-157">For detailed information about installing WAP servers, see [Install and Configure the Web Application Proxy Server][install_and_configure_the_web_application_proxy_server]</span></span>
  > 
  > 

* <span data-ttu-id="43cde-158">**Organisation partenaire**.</span><span class="sxs-lookup"><span data-stu-id="43cde-158">**Partner organization**.</span></span> <span data-ttu-id="43cde-159">Une organisation partenaire exécutant une application web qui demande l’accès à une application web s’exécutant dans Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-159">A partner organization running a web application that requests access to a web application running in Azure.</span></span> <span data-ttu-id="43cde-160">Le serveur de fédération au niveau de l’organisation partenaire authentifie les requêtes localement et envoie les jetons de sécurité contenant les revendications aux services AD FS s’exécutant dans Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-160">The federation server at the partner organization authenticates requests locally, and submits security tokens containing claims to AD FS running in Azure.</span></span> <span data-ttu-id="43cde-161">Dans Azure, AD FS valide les jetons de sécurité et, le cas échéant, transmet les revendications à l’application web s’exécutant dans Azure pour autoriser les jetons valides.</span><span class="sxs-lookup"><span data-stu-id="43cde-161">AD FS in Azure validates the security tokens, and if valid can pass the claims to the web application running in Azure to authorize them.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="43cde-162">Vous pouvez également configurer un tunnel VPN à l’aide de la passerelle Azure pour fournir un accès direct à AD FS pour les partenaires de confiance.</span><span class="sxs-lookup"><span data-stu-id="43cde-162">You can also configure a VPN tunnel using Azure gateway to provide direct access to AD FS for trusted partners.</span></span> <span data-ttu-id="43cde-163">Les demandes émises par ces partenaires ne passent pas par les serveurs proxy d’application web.</span><span class="sxs-lookup"><span data-stu-id="43cde-163">Requests received from these partners do not pass through the WAP servers.</span></span>
  > 
  > 

<span data-ttu-id="43cde-164">Pour plus d’informations sur les parties de l’architecture qui ne sont pas liées à AD FS, consultez les rubriques suivantes :</span><span class="sxs-lookup"><span data-stu-id="43cde-164">For more information about the parts of the architecture that are not related to AD FS, see the following:</span></span>
- <span data-ttu-id="43cde-165">[Implémentation d’une architecture réseau hybride sécurisée dans Azure][implementing-a-secure-hybrid-network-architecture]</span><span class="sxs-lookup"><span data-stu-id="43cde-165">[Implementing a secure hybrid network architecture in Azure][implementing-a-secure-hybrid-network-architecture]</span></span>
- <span data-ttu-id="43cde-166">[Implémentation d’une architecture réseau hybride sécurisée avec accès Internet dans Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access]</span><span class="sxs-lookup"><span data-stu-id="43cde-166">[Implementing a secure hybrid network architecture with Internet access in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access]</span></span>
- <span data-ttu-id="43cde-167">[Implémentation d’une architecture réseau hybride sécurisée avec identités Active Directory dans Azure][extending-ad-to-azure].</span><span class="sxs-lookup"><span data-stu-id="43cde-167">[Implementing a secure hybrid network architecture with Active Directory identities in Azure][extending-ad-to-azure].</span></span>


## <a name="recommendations"></a><span data-ttu-id="43cde-168">Recommandations</span><span class="sxs-lookup"><span data-stu-id="43cde-168">Recommendations</span></span>

<span data-ttu-id="43cde-169">Les recommandations suivantes s’appliquent à la plupart des scénarios.</span><span class="sxs-lookup"><span data-stu-id="43cde-169">The following recommendations apply for most scenarios.</span></span> <span data-ttu-id="43cde-170">Suivez ces recommandations, sauf si vous avez un besoin spécifique qui vous oblige à les ignorer.</span><span class="sxs-lookup"><span data-stu-id="43cde-170">Follow these recommendations unless you have a specific requirement that overrides them.</span></span> 

### <a name="vm-recommendations"></a><span data-ttu-id="43cde-171">Recommandations pour les machines virtuelles</span><span class="sxs-lookup"><span data-stu-id="43cde-171">VM recommendations</span></span>

<span data-ttu-id="43cde-172">Créez des machines virtuelles avec suffisamment de ressources pour gérer le volume de trafic attendu.</span><span class="sxs-lookup"><span data-stu-id="43cde-172">Create VMs with sufficient resources to handle the expected volume of traffic.</span></span> <span data-ttu-id="43cde-173">Prenez comme point de départ la taille des machines existantes qui hébergent AD FS localement.</span><span class="sxs-lookup"><span data-stu-id="43cde-173">Use the size of the existing machines hosting AD FS on premises as a starting point.</span></span> <span data-ttu-id="43cde-174">Surveillez l’utilisation des ressources.</span><span class="sxs-lookup"><span data-stu-id="43cde-174">Monitor the resource utilization.</span></span> <span data-ttu-id="43cde-175">Vous pouvez redimensionner les machines virtuelles et diminuer leur taille si nécessaire.</span><span class="sxs-lookup"><span data-stu-id="43cde-175">You can resize the VMs and scale down if they are too large.</span></span>

<span data-ttu-id="43cde-176">Suivez les recommandations de l’article [Exécution d’une machine virtuelle Windows sur Azure][vm-recommendations].</span><span class="sxs-lookup"><span data-stu-id="43cde-176">Follow the recommendations listed in [Running a Windows VM on Azure][vm-recommendations].</span></span>

### <a name="networking-recommendations"></a><span data-ttu-id="43cde-177">Recommandations pour la mise en réseau</span><span class="sxs-lookup"><span data-stu-id="43cde-177">Networking recommendations</span></span>

<span data-ttu-id="43cde-178">Configurez l’interface réseau pour chacune des machines virtuelles hébergeant des serveurs AD FS et WAP avec des adresses IP privées statiques.</span><span class="sxs-lookup"><span data-stu-id="43cde-178">Configure the network interface for each of the VMs hosting AD FS and WAP servers with static private IP addresses.</span></span>

<span data-ttu-id="43cde-179">N’attribuez pas d’adresses IP publiques aux machines virtuelles AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-179">Do not give the AD FS VMs public IP addresses.</span></span> <span data-ttu-id="43cde-180">Pour plus d’informations, consultez la section Considérations relatives à la sécurité.</span><span class="sxs-lookup"><span data-stu-id="43cde-180">For more information, see the Security considerations section.</span></span>

<span data-ttu-id="43cde-181">Définissez l’adresse IP des serveurs de nom de domaine (DNS) par défaut et secondaires pour les interfaces réseau de chaque machine virtuelle AD FS et WAP de manière à référencer les machines virtuelles Active Directory DS.</span><span class="sxs-lookup"><span data-stu-id="43cde-181">Set the IP address of the preferred and secondary domain name service (DNS) servers for the network interfaces for each AD FS and WAP VM to reference the Active Directory DS VMs.</span></span> <span data-ttu-id="43cde-182">Les machines virtuelles Active Directory DS doivent exécuter un serveur DNS.</span><span class="sxs-lookup"><span data-stu-id="43cde-182">The Active Directory DS VMS should be running DNS.</span></span> <span data-ttu-id="43cde-183">Cette étape est nécessaire pour que chaque machine virtuelle puisse rejoindre le domaine.</span><span class="sxs-lookup"><span data-stu-id="43cde-183">This step is necessary to enable each VM to join the domain.</span></span>

### <a name="ad-fs-availability"></a><span data-ttu-id="43cde-184">Disponibilité des services AD FS</span><span class="sxs-lookup"><span data-stu-id="43cde-184">AD FS availability</span></span> 

<span data-ttu-id="43cde-185">Créez une batterie AD FS comprenant au moins deux serveurs pour augmenter la disponibilité du service.</span><span class="sxs-lookup"><span data-stu-id="43cde-185">Create an AD FS farm with at least two servers to increase availability of the service.</span></span> <span data-ttu-id="43cde-186">Utilisez des comptes de stockage différents pour chaque machine virtuelle AD FS dans la batterie de serveurs.</span><span class="sxs-lookup"><span data-stu-id="43cde-186">Use different storage accounts for each AD FS VM in the farm.</span></span> <span data-ttu-id="43cde-187">Cette approche permet de s’assurer que la batterie de serveurs restera en partie accessible même en cas de panne au niveau d’un compte de stockage spécifique.</span><span class="sxs-lookup"><span data-stu-id="43cde-187">This approach helps to ensure that a failure in a single storage account does not make the entire farm inaccessible.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="43cde-188">Nous vous recommandons d’utiliser des [disques managés](/azure/storage/storage-managed-disks-overview).</span><span class="sxs-lookup"><span data-stu-id="43cde-188">We recommend the use of [managed disks](/azure/storage/storage-managed-disks-overview).</span></span> <span data-ttu-id="43cde-189">Les disques managés ne nécessitent pas de compte de stockage.</span><span class="sxs-lookup"><span data-stu-id="43cde-189">Managed disks do not require a storage account.</span></span> <span data-ttu-id="43cde-190">Il vous suffit de spécifier leur taille et leur type, puis de les déployer avec une haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="43cde-190">You simply specify the size and type of disk and it is deployed in a highly available way.</span></span> <span data-ttu-id="43cde-191">Notre [architecture de référence](/azure/architecture/reference-architectures/) ne permet pas encore de déployer des disques managés, mais les [blocs de construction de modèle](https://github.com/mspnp/template-building-blocks/wiki) seront mis à jour pour prendre en charge le déploiement de disques managés dans la version 2.</span><span class="sxs-lookup"><span data-stu-id="43cde-191">Our [reference architectures](/azure/architecture/reference-architectures/) do not currently deploy managed disks but the [template building blocks](https://github.com/mspnp/template-building-blocks/wiki) will be updated to deploy managed disks in version 2.</span></span>

<span data-ttu-id="43cde-192">Créez des groupes à haute disponibilité Azure distincts pour les machines virtuelles AD FS et WAP.</span><span class="sxs-lookup"><span data-stu-id="43cde-192">Create separate Azure availability sets for the AD FS and WAP VMs.</span></span> <span data-ttu-id="43cde-193">Chaque groupe doit contenir au moins deux machines virtuelles.</span><span class="sxs-lookup"><span data-stu-id="43cde-193">Ensure that there are at least two VMs in each set.</span></span> <span data-ttu-id="43cde-194">Chaque groupe à haute disponibilité doit avoir au moins deux domaines de mise à jour et deux domaines d’erreur.</span><span class="sxs-lookup"><span data-stu-id="43cde-194">Each availability set must have at least two update domains and two fault domains.</span></span>

<span data-ttu-id="43cde-195">Configurez les équilibreurs de charge pour les machines virtuelles AD FS et WAP tel que suit :</span><span class="sxs-lookup"><span data-stu-id="43cde-195">Configure the load balancers for the AD FS VMs and WAP VMs as follows:</span></span>

* <span data-ttu-id="43cde-196">Utilisez un équilibreur de charge Azure pour fournir un accès externe aux machines virtuelles WAP et un équilibreur de charge interne pour répartir la charge sur les serveurs AD FS au sein de la batterie de serveurs.</span><span class="sxs-lookup"><span data-stu-id="43cde-196">Use an Azure load balancer to provide external access to the WAP VMs, and an internal load balancer to distribute the load across the AD FS servers in the farm.</span></span>
* <span data-ttu-id="43cde-197">Transmettez uniquement le trafic apparaissant sur le port 443 (HTTPS) aux serveurs AD FS/WAP.</span><span class="sxs-lookup"><span data-stu-id="43cde-197">Only pass traffic appearing on port 443 (HTTPS) to the AD FS/WAP servers.</span></span>
* <span data-ttu-id="43cde-198">Attribuez une adresse IP statique à l’équilibreur de charge.</span><span class="sxs-lookup"><span data-stu-id="43cde-198">Give the load balancer a static IP address.</span></span>
* <span data-ttu-id="43cde-199">Créez une sonde d’intégrité à l’aide du protocole TCP plutôt que HTTPS.</span><span class="sxs-lookup"><span data-stu-id="43cde-199">Create a health probe using the TCP protocol rather than HTTPS.</span></span> <span data-ttu-id="43cde-200">Vous pouvez effectuer un test ping sur le port 443 pour vérifier le bon fonctionnement d’un serveur AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-200">You can ping port 443 to verify that an AD FS server is functioning.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="43cde-201">Les serveurs AD FS utilisent le protocole d’indication du nom de serveur (SNI). Par conséquent, tout test d’intégrité effectué à l’aide d’un point de terminaison HTTPS à partir de l’équilibreur de charge échouera.</span><span class="sxs-lookup"><span data-stu-id="43cde-201">AD FS servers use the Server Name Indication (SNI) protocol, so attempting to probe using an HTTPS endpoint from the load balancer fails.</span></span>
  > 
  > 
* <span data-ttu-id="43cde-202">Ajoutez un enregistrement DNS *A* au domaine pour l’équilibreur de charge AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-202">Add a DNS *A* record to the domain for the AD FS load balancer.</span></span> <span data-ttu-id="43cde-203">Spécifiez l’adresse IP de l’équilibreur de charge et donnez-lui un nom dans le domaine (par exemple, adfs.contoso.com).</span><span class="sxs-lookup"><span data-stu-id="43cde-203">Specify the IP address of the load balancer, and give it a name in the domain (such as adfs.contoso.com).</span></span> <span data-ttu-id="43cde-204">Il s’agit du nom que les clients et les serveurs WAP utiliseront pour accéder à la batterie de serveurs AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-204">This is the name clients and the WAP servers use to access the AD FS server farm.</span></span>

### <a name="ad-fs-security"></a><span data-ttu-id="43cde-205">Sécurité des services AD FS</span><span class="sxs-lookup"><span data-stu-id="43cde-205">AD FS security</span></span> 

<span data-ttu-id="43cde-206">Empêchez l’exposition directe des serveurs AD FS à Internet.</span><span class="sxs-lookup"><span data-stu-id="43cde-206">Prevent direct exposure of the AD FS servers to the Internet.</span></span> <span data-ttu-id="43cde-207">Les serveurs AD FS sont des ordinateurs joints à un domaine qui sont autorisés à octroyer des jetons de sécurité.</span><span class="sxs-lookup"><span data-stu-id="43cde-207">AD FS servers are domain-joined computers that have full authorization to grant security tokens.</span></span> <span data-ttu-id="43cde-208">Si un serveur est compromis, un utilisateur malveillant peut émettre des jetons d’accès complet à toutes les applications web et à tous les serveurs de fédération qui sont protégés par AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-208">If a server is compromised, a malicious user can issue full access tokens to all web applications and to all federation servers that are protected by AD FS.</span></span> <span data-ttu-id="43cde-209">Si votre système doit gérer des demandes d’utilisateurs externes ne se connectant pas à partir de sites de partenaires de confiance, utilisez des serveurs WAP pour gérer ces demandes.</span><span class="sxs-lookup"><span data-stu-id="43cde-209">If your system must handle requests from external users not connecting from trusted partner sites, use WAP servers to handle these requests.</span></span> <span data-ttu-id="43cde-210">Pour plus d’informations, consultez l’article [Where to Place a Federation Server Proxy][where-to-place-an-fs-proxy] (Où placer un serveur proxy de fédération).</span><span class="sxs-lookup"><span data-stu-id="43cde-210">For more information, see [Where to Place a Federation Server Proxy][where-to-place-an-fs-proxy].</span></span>

<span data-ttu-id="43cde-211">Placez les serveurs AD FS et les serveurs WAP dans des sous-réseaux distincts avec leur propre pare-feu.</span><span class="sxs-lookup"><span data-stu-id="43cde-211">Place AD FS servers and WAP servers in separate subnets with their own firewalls.</span></span> <span data-ttu-id="43cde-212">Vous pouvez utiliser des règles de groupe de sécurité réseau pour définir les règles du pare-feu.</span><span class="sxs-lookup"><span data-stu-id="43cde-212">You can use NSG rules to define firewall rules.</span></span> <span data-ttu-id="43cde-213">Si vous avez besoin d’une protection plus complète, vous pouvez implémenter un périmètre de sécurité supplémentaire autour des serveurs à l’aide d’une paire de sous-réseaux et d’appliances réseau virtuelles, comme décrit dans le document [Implémentation d’une architecture réseau hybride sécurisée avec accès Internet dans Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span><span class="sxs-lookup"><span data-stu-id="43cde-213">If you require more comprehensive protection you can implement an additional security perimeter around servers by using a pair of subnets and network virtual appliances (NVAs), as described in the document [Implementing a secure hybrid network architecture with Internet access in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span></span> <span data-ttu-id="43cde-214">Tous les pare-feu doivent autoriser le trafic sur le port 443 (HTTPS).</span><span class="sxs-lookup"><span data-stu-id="43cde-214">All firewalls should allow traffic on port 443 (HTTPS).</span></span>

<span data-ttu-id="43cde-215">Désactivez l’accès en connexion directe aux serveurs AD FS et WAP.</span><span class="sxs-lookup"><span data-stu-id="43cde-215">Restrict direct sign in access to the AD FS and WAP servers.</span></span> <span data-ttu-id="43cde-216">Seul le personnel DevOps doit être en mesure de s’y connecter.</span><span class="sxs-lookup"><span data-stu-id="43cde-216">Only DevOps staff should be able to connect.</span></span>

<span data-ttu-id="43cde-217">Ne joignez pas les serveurs WAP au domaine.</span><span class="sxs-lookup"><span data-stu-id="43cde-217">Do not join the WAP servers to the domain.</span></span>

### <a name="ad-fs-installation"></a><span data-ttu-id="43cde-218">Installation des services AD FS</span><span class="sxs-lookup"><span data-stu-id="43cde-218">AD FS installation</span></span> 

<span data-ttu-id="43cde-219">L’article [Deploying a Federation Server Farm][Deploying_a_federation_server_farm] (Déploiement d’une batterie de serveurs de fédération) fournit des instructions détaillées pour l’installation et la configuration des services AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-219">The article [Deploying a Federation Server Farm][Deploying_a_federation_server_farm] provides detailed instructions for installing and configuring AD FS.</span></span> <span data-ttu-id="43cde-220">Avant de configurer le premier serveur AD FS dans la batterie de serveurs, effectuez les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="43cde-220">Perform the following tasks before configuring the first AD FS server in the farm:</span></span>

1. <span data-ttu-id="43cde-221">Obtenez un certificat approuvé publiquement pour l’authentification du serveur.</span><span class="sxs-lookup"><span data-stu-id="43cde-221">Obtain a publicly trusted certificate for performing server authentication.</span></span> <span data-ttu-id="43cde-222">Le *nom de l’objet* doit contenir le nom utilisé par les clients pour accéder au service de fédération.</span><span class="sxs-lookup"><span data-stu-id="43cde-222">The *subject name* must contain the name clients use to access the federation service.</span></span> <span data-ttu-id="43cde-223">Cela peut être le nom DNS enregistré pour l’équilibreur de charge, par exemple, *adfs.contoso.com* (pour des raisons de sécurité, évitez d’utiliser des noms comprenant des caractères génériques tels que \**.contoso.com*).</span><span class="sxs-lookup"><span data-stu-id="43cde-223">This can be the DNS name registered for the load balancer, for example, *adfs.contoso.com* (avoid using wildcard names such as \**.contoso.com*, for security reasons).</span></span> <span data-ttu-id="43cde-224">Utilisez le même certificat sur toutes les machines virtuelles du serveur AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-224">Use the same certificate on all AD FS server VMs.</span></span> <span data-ttu-id="43cde-225">Vous pouvez acheter un certificat auprès d’une autorité de certification de confiance, mais si votre organisation utilise les services de certificats Active Directory, vous pouvez également créer votre propre certificat.</span><span class="sxs-lookup"><span data-stu-id="43cde-225">You can purchase a certificate from a trusted certification authority, but if your organization uses Active Directory Certificate Services you can create your own.</span></span> 
   
    <span data-ttu-id="43cde-226">*L’autre nom de l’objet* est utilisé par le service DRS (Device Registration Service) pour activer l’accès à partir d’appareils externes.</span><span class="sxs-lookup"><span data-stu-id="43cde-226">The *subject alternative name* is used by the device registration service (DRS) to enable access from external devices.</span></span> <span data-ttu-id="43cde-227">Il doit être au format *enterpriseregistration.contoso.com*.</span><span class="sxs-lookup"><span data-stu-id="43cde-227">This should be of the form *enterpriseregistration.contoso.com*.</span></span>
   
    <span data-ttu-id="43cde-228">Pour plus d’informations, consultez l’article [Obtain and Configure a Secure Sockets Layer (SSL) Certificate for AD FS][adfs_certificates] (Obtenir et configurer un certificat Secure Sockets Layer (SSL) pour AD FS).</span><span class="sxs-lookup"><span data-stu-id="43cde-228">For more information, see [Obtain and Configure a Secure Sockets Layer (SSL) Certificate for AD FS][adfs_certificates].</span></span>

2. <span data-ttu-id="43cde-229">Sur le contrôleur de domaine, générez une nouvelle clé racine pour le service de distribution de clés.</span><span class="sxs-lookup"><span data-stu-id="43cde-229">On the domain controller, generate a new root key for the Key Distribution Service.</span></span> <span data-ttu-id="43cde-230">Définissez l’heure effective sur l’heure actuelle à laquelle vous aurez soustrait 10 heures (cette configuration réduit le délai pouvant intervenir lors de la distribution et de la synchronisation des clés dans le domaine).</span><span class="sxs-lookup"><span data-stu-id="43cde-230">Set the effective time to the current time minus 10 hours (this configuration reduces the delay that can occur in distributing and synchronizing keys across the domain).</span></span> <span data-ttu-id="43cde-231">Cette étape est nécessaire pour prendre en charge la création du compte de service de groupe qui est utilisé pour exécuter le service AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-231">This step is necessary to support creating the group service account that is used to run the AD FS service.</span></span> <span data-ttu-id="43cde-232">La commande PowerShell suivante montre un exemple de la procédure à suivre :</span><span class="sxs-lookup"><span data-stu-id="43cde-232">The following PowerShell command shows an example of how to do this:</span></span>
   
    ```powershell
    Add-KdsRootKey -EffectiveTime (Get-Date).AddHours(-10)
    ```

3. <span data-ttu-id="43cde-233">Ajoutez chaque machine virtuelle du serveur AD FS au domaine.</span><span class="sxs-lookup"><span data-stu-id="43cde-233">Add each AD FS server VM to the domain.</span></span>

> [!NOTE]
> <span data-ttu-id="43cde-234">Pour installer AD FS, le contrôleur de domaine jouant le rôle de FSMO (Flexible Single Master Operation) de l’émulateur de contrôleur de domaine principal pour le domaine doit être en cours d’exécution et accessible depuis les machines virtuelles AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-234">To install AD FS, the domain controller running the primary domain controller (PDC) emulator flexible single master operation (FSMO) role for the domain must be running and accessible from the AD FS VMs.</span></span> <span data-ttu-id="43cde-235"><<RBC: Is there a way to make this less repetitive?>></span><span class="sxs-lookup"><span data-stu-id="43cde-235"><<RBC: Is there a way to make this less repetitive?>></span></span>
> 
> 

### <a name="ad-fs-trust"></a><span data-ttu-id="43cde-236">Approbation AD FS</span><span class="sxs-lookup"><span data-stu-id="43cde-236">AD FS trust</span></span> 

<span data-ttu-id="43cde-237">Établissez une approbation de fédération entre votre installation AD FS et les serveurs de fédération des organisations partenaires.</span><span class="sxs-lookup"><span data-stu-id="43cde-237">Establish federation trust between your AD FS installation, and the federation servers of any partner organizations.</span></span> <span data-ttu-id="43cde-238">Configurez les paramètres de mappage et de filtrage de revendications tel que requis.</span><span class="sxs-lookup"><span data-stu-id="43cde-238">Configure any claims filtering and mapping required.</span></span> 

* <span data-ttu-id="43cde-239">Le personnel DevOps de chaque organisation partenaire doit ajouter une approbation de partie de confiance pour les applications web accessibles via vos serveurs AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-239">DevOps staff at each partner organization must add a relying party trust for the web applications accessible through your AD FS servers.</span></span>
* <span data-ttu-id="43cde-240">Le personnel DevOps de votre organisation doit configurer une approbation de fournisseur de revendications pour que vos serveurs AD FS puissent approuver les revendications émanant des organisations partenaires.</span><span class="sxs-lookup"><span data-stu-id="43cde-240">DevOps staff in your organization must configure claims-provider trust to enable your AD FS servers to trust the claims that partner organizations provide.</span></span>
* <span data-ttu-id="43cde-241">Le personnel DevOps de votre organisation doit également configurer AD FS pour transmettre les revendications aux applications web de votre organisation.</span><span class="sxs-lookup"><span data-stu-id="43cde-241">DevOps staff in your organization must also configure AD FS to pass claims on to your organization's web applications.</span></span>
  
<span data-ttu-id="43cde-242">Pour plus d’informations, consultez l’article [Establishing Federation Trust][establishing-federation-trust] (Établir une approbation de fédération).</span><span class="sxs-lookup"><span data-stu-id="43cde-242">For more information, see [Establishing Federation Trust][establishing-federation-trust].</span></span>

<span data-ttu-id="43cde-243">Publiez les applications web de votre organisation et rendez-les accessibles aux partenaires externes en activant la préauthentification via les serveurs proxy d’application web (WAP).</span><span class="sxs-lookup"><span data-stu-id="43cde-243">Publish your organization's web applications and make them available to external partners by using preauthentication through the WAP servers.</span></span> <span data-ttu-id="43cde-244">Pour plus d’informations, consultez l’article [Publish Applications using AD FS Preauthentication][publish_applications_using_AD_FS_preauthentication] (Publier des applications avec la préauthentification AD FS)</span><span class="sxs-lookup"><span data-stu-id="43cde-244">For more information, see [Publish Applications using AD FS Preauthentication][publish_applications_using_AD_FS_preauthentication]</span></span>

<span data-ttu-id="43cde-245">AD FS prend en charge l’augmentation et la transformation des jetons.</span><span class="sxs-lookup"><span data-stu-id="43cde-245">AD FS supports token transformation and augmentation.</span></span> <span data-ttu-id="43cde-246">Azure Active Directory ne fournit pas cette fonctionnalité.</span><span class="sxs-lookup"><span data-stu-id="43cde-246">Azure Active Directory does not provide this feature.</span></span> <span data-ttu-id="43cde-247">Avec AD FS, lorsque vous configurez des relations d’approbation, vous pouvez :</span><span class="sxs-lookup"><span data-stu-id="43cde-247">With AD FS, when you set up the trust relationships, you can:</span></span>

* <span data-ttu-id="43cde-248">Configurer des transformations de revendication pour les règles d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="43cde-248">Configure claim transformations for authorization rules.</span></span> <span data-ttu-id="43cde-249">Par exemple, vous pouvez mapper une sécurité de groupe à partir d’une représentation utilisée par une organisation partenaire non-Microsoft sur un élément que le service Active Directory DS peut autoriser dans votre organisation.</span><span class="sxs-lookup"><span data-stu-id="43cde-249">For example, you can map group security from a representation used by a non-Microsoft partner organization to something that that Active Directory DS can authorize in your organization.</span></span>
* <span data-ttu-id="43cde-250">Convertir des revendications d’un format vers un autre.</span><span class="sxs-lookup"><span data-stu-id="43cde-250">Transform claims from one format to another.</span></span> <span data-ttu-id="43cde-251">Par exemple, vous pouvez effectuer un mappage de SAML 2.0 vers SAML 1.1 si votre application prend uniquement en charge les revendications au format SAML 1.1.</span><span class="sxs-lookup"><span data-stu-id="43cde-251">For example, you can map from SAML 2.0 to SAML 1.1 if your application only supports SAML 1.1 claims.</span></span>

### <a name="ad-fs-monitoring"></a><span data-ttu-id="43cde-252">Analyse des services AD FS</span><span class="sxs-lookup"><span data-stu-id="43cde-252">AD FS monitoring</span></span> 

<span data-ttu-id="43cde-253">Le [Pack d’administration Microsoft System Center pour les services de fédération Active Directory 2012 R2][oms-adfs-pack] fournit une analyse proactive et réactive de votre déploiement AD FS pour le serveur de fédération.</span><span class="sxs-lookup"><span data-stu-id="43cde-253">The [Microsoft System Center Management Pack for Active Directory Federation Services 2012 R2][oms-adfs-pack] provides both proactive and reactive monitoring of your AD FS deployment for the federation server.</span></span> <span data-ttu-id="43cde-254">Ce pack d’administration surveille :</span><span class="sxs-lookup"><span data-stu-id="43cde-254">This management pack monitors:</span></span>

* <span data-ttu-id="43cde-255">Les événements que le service AD FS consigne dans ses journaux d’événements.</span><span class="sxs-lookup"><span data-stu-id="43cde-255">Events that the AD FS service records in its event logs.</span></span>
* <span data-ttu-id="43cde-256">Les données de performance collectées par les compteurs de performances AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-256">The performance data that the AD FS performance counters collect.</span></span> 
* <span data-ttu-id="43cde-257">L’intégrité globale du système AD FS et des applications web (parties de confiance). Enfin, le pack fournit des alertes pour les problèmes critiques et les avertissements.</span><span class="sxs-lookup"><span data-stu-id="43cde-257">The overall health of the AD FS system and web applications (relying parties), and provides alerts for critical issues and warnings.</span></span> 

## <a name="scalability-considerations"></a><span data-ttu-id="43cde-258">Considérations relatives à l’extensibilité</span><span class="sxs-lookup"><span data-stu-id="43cde-258">Scalability considerations</span></span>

<span data-ttu-id="43cde-259">Les considérations suivantes, dont tous les détails sont présentés dans l’article [Planifier votre déploiement AD FS][plan-your-adfs-deployment], vous donnent des conseils pour redimensionner les batteries de serveurs AD FS :</span><span class="sxs-lookup"><span data-stu-id="43cde-259">The following considerations, summarized from the article [Plan your AD FS deployment][plan-your-adfs-deployment], give a starting point for sizing AD FS farms:</span></span>

* <span data-ttu-id="43cde-260">Si vous avez moins de 1 000 utilisateurs, ne créez pas de serveurs dédiés, mais installez plutôt AD FS sur chacun des serveurs Active Directory DS dans le cloud.</span><span class="sxs-lookup"><span data-stu-id="43cde-260">If you have fewer than 1000 users, do not create dedicated servers, but instead install AD FS on each of the Active Directory DS servers in the cloud.</span></span> <span data-ttu-id="43cde-261">Assurez-vous de disposer d’au moins deux serveurs Active Directory DS pour garantir la disponibilité.</span><span class="sxs-lookup"><span data-stu-id="43cde-261">Make sure that you have at least two Active Directory DS servers to maintain availability.</span></span> <span data-ttu-id="43cde-262">Créez un seul serveur WAP.</span><span class="sxs-lookup"><span data-stu-id="43cde-262">Create a single WAP server.</span></span>
* <span data-ttu-id="43cde-263">Si vous avez entre 1 000 et 15 000 utilisateurs, créez deux serveurs AD FS dédiés et deux serveurs WAP dédiés.</span><span class="sxs-lookup"><span data-stu-id="43cde-263">If you have between 1000 and 15000 users, create two dedicated AD FS servers and two dedicated WAP servers.</span></span>
* <span data-ttu-id="43cde-264">Si vous avez entre 15 000 et 60 000 utilisateurs, créez entre trois et cinq serveurs AD FS dédiés et au moins deux serveurs WAP dédiés.</span><span class="sxs-lookup"><span data-stu-id="43cde-264">If you have between 15000 and 60000 users, create between three and five dedicated AD FS servers and at least two dedicated WAP servers.</span></span>

<span data-ttu-id="43cde-265">Ces considérations supposent que vous utilisez des machines virtuelles doubles à quatre cœurs (Standard D4_v2 ou taille supérieure) dans Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-265">These considerations assume that you are using dual quad-core VM (Standard D4_v2, or better) sizes in Azure.</span></span>

<span data-ttu-id="43cde-266">Si vous utilisez la base de données interne Windows pour stocker les données de configuration AD FS, vous ne pouvez ajouter que huit serveurs AD FS dans la batterie de serveurs.</span><span class="sxs-lookup"><span data-stu-id="43cde-266">If you are using the Windows Internal Database to store AD FS configuration data, you are limited to eight AD FS servers in the farm.</span></span> <span data-ttu-id="43cde-267">Si vous pensez que vous aurez besoin de davantage de serveurs à l’avenir, utilisez SQL Server.</span><span class="sxs-lookup"><span data-stu-id="43cde-267">If you anticipate that you will need more in the future, use SQL Server.</span></span> <span data-ttu-id="43cde-268">Pour plus d’informations, consultez l’article [The Role of the AD FS Configuration Database][adfs-configuration-database] (Rôle de la base de données de configuration AD FS).</span><span class="sxs-lookup"><span data-stu-id="43cde-268">For more information, see [The Role of the AD FS Configuration Database][adfs-configuration-database].</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="43cde-269">Considérations relatives à la disponibilité</span><span class="sxs-lookup"><span data-stu-id="43cde-269">Availability considerations</span></span>

<span data-ttu-id="43cde-270">Vous pouvez utiliser SQL Server ou la base de données interne Windows pour conserver les informations de configuration AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-270">You can use either SQL Server or the Windows Internal Database to hold AD FS configuration information.</span></span> <span data-ttu-id="43cde-271">La base de données interne Windows fournit une redondance de base.</span><span class="sxs-lookup"><span data-stu-id="43cde-271">The Windows Internal Database provides basic redundancy.</span></span> <span data-ttu-id="43cde-272">Les modifications sont écrites directement dans une seule des bases de données AD FS du cluster AD FS, tandis que les autres serveurs utilisent la réplication par réception pour mettre à jour leurs bases de données.</span><span class="sxs-lookup"><span data-stu-id="43cde-272">Changes are written directly to only one of the AD FS databases in the AD FS cluster, while the other servers use pull replication to keep their databases up to date.</span></span> <span data-ttu-id="43cde-273">SQL Server peut fournir une redondance de base de données totale et une haute disponibilité grâce à la mise en miroir ou au clustering de basculement.</span><span class="sxs-lookup"><span data-stu-id="43cde-273">Using SQL Server can provide full database redundancy and high availability using failover clustering or mirroring.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="43cde-274">Considérations relatives à la facilité de gestion</span><span class="sxs-lookup"><span data-stu-id="43cde-274">Manageability considerations</span></span>

<span data-ttu-id="43cde-275">Le personnel DevOps doit savoir effectuer les tâches suivantes :</span><span class="sxs-lookup"><span data-stu-id="43cde-275">DevOps staff should be prepared to perform the following tasks:</span></span>

* <span data-ttu-id="43cde-276">Gérer les serveurs de fédération, y compris la batterie de serveurs AD FS, la stratégie d’approbation au niveau des serveurs de fédération et les certificats utilisés par les services de fédération.</span><span class="sxs-lookup"><span data-stu-id="43cde-276">Managing the federation servers, including managing the AD FS farm, managing trust policy on the federation servers, and managing the certificates used by the federation services.</span></span>
* <span data-ttu-id="43cde-277">Gérer les serveurs WAP, y compris la batterie de serveurs WAP et les certificats.</span><span class="sxs-lookup"><span data-stu-id="43cde-277">Managing the WAP servers including managing the WAP farm and certificates.</span></span>
* <span data-ttu-id="43cde-278">Gérer les applications web, notamment configurer les parties de confiance, les méthodes d’authentification et les mappages de revendications.</span><span class="sxs-lookup"><span data-stu-id="43cde-278">Managing web applications including configuring relying parties, authentication methods, and claims mappings.</span></span>
* <span data-ttu-id="43cde-279">Sauvegarder les composants des services AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-279">Backing up AD FS components.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="43cde-280">Considérations relatives à la sécurité</span><span class="sxs-lookup"><span data-stu-id="43cde-280">Security considerations</span></span>

<span data-ttu-id="43cde-281">AD FS utilise le protocole HTTPS. Par conséquent, assurez-vous que les règles du groupe de sécurité réseau pour le sous-réseau contenant les machines virtuelles de niveau web autorisent les requêtes HTTPS.</span><span class="sxs-lookup"><span data-stu-id="43cde-281">AD FS utilizes the HTTPS protocol, so make sure that the NSG rules for the subnet containing the web tier VMs permit HTTPS requests.</span></span> <span data-ttu-id="43cde-282">Ces requêtes peuvent provenir du réseau local, des sous-réseaux contenant la couche web, la couche métier, la couche Données, la zone DMZ privée, la zone DMZ publique et le sous-réseau contenant les serveurs AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-282">These requests can originate from the on-premises network, the subnets containing the web tier, business tier, data tier, private DMZ, public DMZ, and the subnet containing the AD FS servers.</span></span>

<span data-ttu-id="43cde-283">Envisagez d’utiliser un ensemble d’appliances réseau virtuelles qui enregistrent tous les détails du trafic transitant par votre réseau virtuel à des fins d’audit.</span><span class="sxs-lookup"><span data-stu-id="43cde-283">Consider using a set of network virtual appliances that logs detailed information on traffic traversing the edge of your virtual network for auditing purposes.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="43cde-284">Déployer la solution</span><span class="sxs-lookup"><span data-stu-id="43cde-284">Deploy the solution</span></span>

<span data-ttu-id="43cde-285">Vous disposez d’une solution sur [GitHub][github] pour déployer cette architecture de référence.</span><span class="sxs-lookup"><span data-stu-id="43cde-285">A solution is available on [GitHub][github] to deploy this reference architecture.</span></span> <span data-ttu-id="43cde-286">Vous avez besoin de la dernière version de [l’interface de ligne de commande Azure][azure-cli] pour exécuter le script PowerShell qui déploie la solution.</span><span class="sxs-lookup"><span data-stu-id="43cde-286">You will need the latest version of the [Azure CLI][azure-cli] to run the Powershell script that deploys the solution.</span></span> <span data-ttu-id="43cde-287">Pour déployer l’architecture de référence, effectuez les étapes suivantes :</span><span class="sxs-lookup"><span data-stu-id="43cde-287">To deploy the reference architecture, follow these steps:</span></span>

1. <span data-ttu-id="43cde-288">Téléchargez ou clonez le dossier de solution à partir de [GitHub][github] sur votre ordinateur local.</span><span class="sxs-lookup"><span data-stu-id="43cde-288">Download or clone the solution folder from [GitHub][github] to your local machine.</span></span>

2. <span data-ttu-id="43cde-289">Ouvrez l’interface de ligne de commande Azure et accédez au dossier de solution local.</span><span class="sxs-lookup"><span data-stu-id="43cde-289">Open the Azure CLI and navigate to the local solution folder.</span></span>

3. <span data-ttu-id="43cde-290">Exécutez la commande suivante :</span><span class="sxs-lookup"><span data-stu-id="43cde-290">Run the following command:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> <mode>
    ```
   
    <span data-ttu-id="43cde-291">Remplacez `<subscription id>` par l’identifiant de votre abonnement Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-291">Replace `<subscription id>` with your Azure subscription ID.</span></span>
   
    <span data-ttu-id="43cde-292">Pour `<location>`, spécifiez une région Azure, telle que `eastus` ou `westus`.</span><span class="sxs-lookup"><span data-stu-id="43cde-292">For `<location>`, specify an Azure region, such as `eastus` or `westus`.</span></span>
   
    <span data-ttu-id="43cde-293">Le paramètre `<mode>` contrôle la granularité du déploiement, et peut prendre l’une des valeurs suivantes :</span><span class="sxs-lookup"><span data-stu-id="43cde-293">The `<mode>` parameter controls the granularity of the deployment, and can be one of the following values:</span></span>
   
   * <span data-ttu-id="43cde-294">`Onpremise` : déploie un environnement local simulé.</span><span class="sxs-lookup"><span data-stu-id="43cde-294">`Onpremise`: Deploys a simulated on-premises environment.</span></span> <span data-ttu-id="43cde-295">Vous pouvez utiliser ce déploiement à des fins de test et d’expérience si vous ne disposez pas d’un réseau local, ou si vous souhaitez tester cette architecture de référence sans modifier la configuration de votre réseau local existant.</span><span class="sxs-lookup"><span data-stu-id="43cde-295">You can use this deployment to test and experiment if you do not have an existing on-premises network, or if you want to test this reference architecture without changing the configuration of your existing on-premises network.</span></span>
   * <span data-ttu-id="43cde-296">`Infrastructure` : déploie l’infrastructure du réseau virtuel et le serveur de rebond.</span><span class="sxs-lookup"><span data-stu-id="43cde-296">`Infrastructure`: deploys the VNet infrastructure and jump box.</span></span>
   * <span data-ttu-id="43cde-297">`CreateVpn` : déploie une passerelle réseau virtuelle Azure et la connecte au réseau local simulé.</span><span class="sxs-lookup"><span data-stu-id="43cde-297">`CreateVpn`: deploys an Azure virtual network gateway and connects it to the simulated on-premises network.</span></span>
   * <span data-ttu-id="43cde-298">`AzureADDS` : déploie les machines virtuelles faisant office de serveurs Active Directory DS, déploie Active Directory sur ces machines virtuelles et créé le domaine dans Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-298">`AzureADDS`: deploys the VMs acting as Active Directory DS servers, deploys Active Directory to these VMs, and creates the domain in Azure.</span></span>
   * <span data-ttu-id="43cde-299">`AdfsVm` : déploie les machines virtuelles AD FS et les joint au domaine dans Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-299">`AdfsVm`: deploys the AD FS VMs and joins them to the domain in Azure.</span></span>
   * <span data-ttu-id="43cde-300">`PublicDMZ` : déploie la zone DMZ publique dans Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-300">`PublicDMZ`: deploys the public DMZ in Azure.</span></span>
   * <span data-ttu-id="43cde-301">`ProxyVm` : déploie les machines virtuelles proxy AD FS et les joint au domaine dans Azure.</span><span class="sxs-lookup"><span data-stu-id="43cde-301">`ProxyVm`: deploys the AD FS proxy VMs and joins them to the domain in Azure.</span></span>
   * <span data-ttu-id="43cde-302">`Prepare` : déploie tous les déploiements précédents.</span><span class="sxs-lookup"><span data-stu-id="43cde-302">`Prepare`: deploys all of the preceding deployments.</span></span> <span data-ttu-id="43cde-303">**Il s’agit de l’option recommandée si vous créez un nouveau déploiement et que vous ne disposez pas encore d’une infrastructure locale.**</span><span class="sxs-lookup"><span data-stu-id="43cde-303">**This is the recommended option if you are building an entirely new deployment and you don't have an existing on-premises infrastructure.**</span></span> 
   * <span data-ttu-id="43cde-304">`Workload` : déploie de manière facultative les machines virtuelles des couches web, métier et données, ainsi que le réseau sous-jacent.</span><span class="sxs-lookup"><span data-stu-id="43cde-304">`Workload`: optionally deploys web, business, and data tier VMs and supporting network.</span></span> <span data-ttu-id="43cde-305">Non inclus dans le mode de déploiement `Prepare`.</span><span class="sxs-lookup"><span data-stu-id="43cde-305">Not included in the `Prepare` deployment mode.</span></span>
   * <span data-ttu-id="43cde-306">`PrivateDMZ` : déploie de manière facultative la zone DMZ privée dans Azure en amont des machines virtuelles `Workload` déployées ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="43cde-306">`PrivateDMZ`: optionally deploys the private DMZ in Azure in front of the `Workload` VMs deployed above.</span></span> <span data-ttu-id="43cde-307">Non inclus dans le mode de déploiement `Prepare`.</span><span class="sxs-lookup"><span data-stu-id="43cde-307">Not included in the `Prepare` deployment mode.</span></span>

4. <span data-ttu-id="43cde-308">Attendez la fin du déploiement.</span><span class="sxs-lookup"><span data-stu-id="43cde-308">Wait for the deployment to complete.</span></span> <span data-ttu-id="43cde-309">Si vous avez choisi l’option `Prepare`, le déploiement prend plusieurs heures et se termine avec le message `Preparation is completed. Please install certificate to all AD FS and proxy VMs.`</span><span class="sxs-lookup"><span data-stu-id="43cde-309">If you used the `Prepare` option, the deployment takes several hours to complete, and finishes with the message `Preparation is completed. Please install certificate to all AD FS and proxy VMs.`</span></span>

5. <span data-ttu-id="43cde-310">Redémarrez le serveur de rebond (*ra-adfs-mgmt-vm1* dans le groupe *ra-adfs-security-rg*) pour activer ses paramètres DNS.</span><span class="sxs-lookup"><span data-stu-id="43cde-310">Restart the jump box (*ra-adfs-mgmt-vm1* in the *ra-adfs-security-rg* group) to allow its DNS settings to take effect.</span></span>

6. <span data-ttu-id="43cde-311">[Récupérez un certificat SSL pour AD FS][adfs_certificates] et installez ce certificat sur les machines virtuelles AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-311">[Obtain an SSL Certificate for AD FS][adfs_certificates] and install this certificate on the AD FS VMs.</span></span> <span data-ttu-id="43cde-312">Notez que vous pouvez vous y connecter via le serveur de rebond.</span><span class="sxs-lookup"><span data-stu-id="43cde-312">Note that you can connect to them through the jump box.</span></span> <span data-ttu-id="43cde-313">Les adresses IP sont *10.0.5.4* et *10.0.5.5*.</span><span class="sxs-lookup"><span data-stu-id="43cde-313">The IP addresses are *10.0.5.4* and *10.0.5.5*.</span></span> <span data-ttu-id="43cde-314">Le nom d’utilisateur par défaut est *contoso\testuser*, et le mot de passe est *AweSome@PW*.</span><span class="sxs-lookup"><span data-stu-id="43cde-314">The default username is *contoso\testuser* with password *AweSome@PW*.</span></span>
   
   > [!NOTE]
   > <span data-ttu-id="43cde-315">À ce stade, les commentaires dans le script Deploy-ReferenceArchitecture.ps1 fournissent des instructions détaillées pour créer une autorité et un certificat de test auto-signé à l’aide de la commande `makecert`.</span><span class="sxs-lookup"><span data-stu-id="43cde-315">The comments in the Deploy-ReferenceArchitecture.ps1 script at this point provides detailed instructions for creating a self-signed test certificate and authority using the `makecert` command.</span></span> <span data-ttu-id="43cde-316">Toutefois, effectuez uniquement ces étapes dans le cadre d’un **test** et n’utilisez pas les certificats générés par MakeCert dans un environnement de production.</span><span class="sxs-lookup"><span data-stu-id="43cde-316">However, perform these steps as a **test** only and do not use the certificates generated by makecert in a production environment.</span></span>
   > 
   > 

7. <span data-ttu-id="43cde-317">Exécutez la commande PowerShell suivante pour déployer la batterie de serveurs AD FS :</span><span class="sxs-lookup"><span data-stu-id="43cde-317">Run the following PowerShell command to deploy the AD FS server farm:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Adfs
    ``` 

8. <span data-ttu-id="43cde-318">Sur le serveur de rebond, accédez à `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm` pour tester l’installation AD FS (vous pouvez recevoir un avertissement de certificat que vous pouvez ignorer dans le cadre de ce test).</span><span class="sxs-lookup"><span data-stu-id="43cde-318">On the jump box, browse to `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm` to test the AD FS installation (you may receive a certificate warning that you can ignore for this test).</span></span> <span data-ttu-id="43cde-319">Vérifiez que la page de connexion Contoso Corporation s’affiche.</span><span class="sxs-lookup"><span data-stu-id="43cde-319">Verify that the Contoso Corporation sign-in page appears.</span></span> <span data-ttu-id="43cde-320">Connectez-vous avec le nom d’utilisateur *contoso\testuser* et le mot de passe *AweS0me@PW*.</span><span class="sxs-lookup"><span data-stu-id="43cde-320">Sign in as *contoso\testuser* with password *AweS0me@PW*.</span></span>

9. <span data-ttu-id="43cde-321">Installez le certificat SSL sur les machines virtuelles proxy AD FS.</span><span class="sxs-lookup"><span data-stu-id="43cde-321">Install the SSL certificate on the AD FS proxy VMs.</span></span> <span data-ttu-id="43cde-322">Les adresses IP sont *10.0.6.4* et *10.0.6.5*.</span><span class="sxs-lookup"><span data-stu-id="43cde-322">The IP addresses are *10.0.6.4* and *10.0.6.5*.</span></span>

10. <span data-ttu-id="43cde-323">Exécutez la commande PowerShell suivante pour déployer le premier serveur proxy AD FS :</span><span class="sxs-lookup"><span data-stu-id="43cde-323">Run the following PowerShell command to deploy the first AD FS proxy server:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy1
    ```

11. <span data-ttu-id="43cde-324">Suivez les instructions qui s’affichent dans le script pour tester l’installation du premier serveur proxy.</span><span class="sxs-lookup"><span data-stu-id="43cde-324">Follow the instructions displayed by the script to test the installation of the first proxy server.</span></span>

12. <span data-ttu-id="43cde-325">Exécutez la commande PowerShell suivante pour déployer le second serveur proxy :</span><span class="sxs-lookup"><span data-stu-id="43cde-325">Run the following PowerShell command to deploy the second proxy server:</span></span>
    
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy2
    ```

13. <span data-ttu-id="43cde-326">Suivez les instructions qui s’affichent dans le script pour tester la configuration complète des serveurs proxy.</span><span class="sxs-lookup"><span data-stu-id="43cde-326">Follow the instructions displayed by the script to test the complete proxy configuration.</span></span>

## <a name="next-steps"></a><span data-ttu-id="43cde-327">étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="43cde-327">Next steps</span></span>

* <span data-ttu-id="43cde-328">En savoir plus sur [Azure Active Directory][aad].</span><span class="sxs-lookup"><span data-stu-id="43cde-328">Learn about [Azure Active Directory][aad].</span></span>
* <span data-ttu-id="43cde-329">En savoir plus sur [Azure Active Directory B2C][aadb2c].</span><span class="sxs-lookup"><span data-stu-id="43cde-329">Learn about [Azure Active Directory B2C][aadb2c].</span></span>

<!-- links -->
[extending-ad-to-azure]: adds-extend-domain.md

[vm-recommendations]: ../virtual-machines-windows/single-vm.md
[implementing-a-secure-hybrid-network-architecture]: ../dmz/secure-vnet-hybrid.md
[implementing-a-secure-hybrid-network-architecture-with-internet-access]: ../dmz/secure-vnet-dmz.md
[hybrid-azure-on-prem-vpn]: ../hybrid-networking/vpn.md

[azure-cli]: /azure/azure-resource-manager/xplat-cli-azure-resource-manager
[DRS]: https://technet.microsoft.com/library/dn280945.aspx
[where-to-place-an-fs-proxy]: https://technet.microsoft.com/library/dd807048.aspx
[ADDRS]: https://technet.microsoft.com/library/dn486831.aspx
[plan-your-adfs-deployment]: https://msdn.microsoft.com/library/azure/dn151324.aspx
[ad_network_recommendations]: #network_configuration_recommendations_for_AD_DS_VMs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[create_service_account_for_adfs_farm]: https://technet.microsoft.com/library/dd807078.aspx
[adfs-configuration-database]: https://technet.microsoft.com/library/ee913581(v=ws.11).aspx
[active-directory-federation-services]: https://technet.microsoft.com/windowsserver/dd448613.aspx
[security-considerations]: #security-considerations
[recommendations]: #recommendations
[active-directory-federation-services-overview]: https://technet.microsoft.com/library/hh831502(v=ws.11).aspx
[establishing-federation-trust]: https://blogs.msdn.microsoft.com/alextch/2011/06/27/establishing-federation-trust/
[Deploying_a_federation_server_farm]:  https://azure.microsoft.com/documentation/articles/active-directory-aadconnect-azure-adfs/
[install_and_configure_the_web_application_proxy_server]: https://technet.microsoft.com/library/dn383662.aspx
[publish_applications_using_AD_FS_preauthentication]: https://technet.microsoft.com/library/dn383640.aspx
[managing-adfs-components]: https://technet.microsoft.com/library/cc759026.aspx
[oms-adfs-pack]: https://www.microsoft.com/download/details.aspx?id=41184
[azure-powershell-download]: https://azure.microsoft.com/documentation/articles/powershell-install-configure/
[aad]: https://azure.microsoft.com/documentation/services/active-directory/
[aadb2c]: https://azure.microsoft.com/documentation/services/active-directory-b2c/
[adfs-intro]: /azure/active-directory/active-directory-aadconnect-azure-adfs
[github]: https://github.com/mspnp/reference-architectures/tree/master/identity/adfs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[considerations]: ./considerations.md
[visio-download]: https://archcenter.azureedge.net/cdn/identity-architectures.vsdx
[0]: ./images/adfs.png "Architecture réseau hybride sécurisée avec Active Directory"
